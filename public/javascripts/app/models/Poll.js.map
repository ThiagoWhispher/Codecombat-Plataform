{"version":3,"sources":["app/models/Poll.coffee"],"names":[],"mappings":";AAAA;EAAA;;;AAAA,YAAY,QAAQ,aAAR;;AACZ,SAAS,QAAQ,4BAAR;;AAET,MAAM,CAAC,OAAP,GAAuB;;;;;;;EACrB,IAAC,UAAD,GAAY;;EACZ,IAAC,OAAD,GAAS;;iBACT,UAAS;;iBAET,aAAY,SAAC,KAAD;AAGV;IAAA,YAAY;IACZ,IAAG,KAAK,CAAC,IAAT;MACE,SAAS,CAAC,IAAV,GAAiB,CAAC,CAAC,MAAF,CAAS,IAAT,EAAe,EAAf,EAAmB,KAAK,CAAC,IAAzB,EADnB;;AAEA;AAAA;;;QACE,SAAS,CAAC,UAAW;;MACrB,IAAG,CAAC,CAAC,OAAF,CAAU,aAAV,CAAH;;cACoB,gBAAgB;;AAClC;;UACE,IAAG,CAAC,CAAC,QAAF,CAAW,MAAX,CAAH;YACE,eAAe,OADjB;WAAA;YAGE,eAAe,CAAC,CAAC,MAAF,CAAS,IAAT,EAAe,EAAf,EAAmB,MAAnB;AACf;cACE,iBAAiB,SAAS,WAAW,CAAC,OAAZ,CAAoB,GAApB,EAAyB,EAAzB,CAAT,EAAuC,EAAvC;cACjB,KAAO,CAAC,CAAC,KAAF,CAAQ,cAAR,CAAP;gBACE,WAAW,IAAC,IAAD,CAAK,SAAL,CAAgB,gBAAgB;gBAC3C,aAAa,CAAC,CAAC,MAAM,CAAC,UAAT,CAAoB,WAApB,EAAiC,GAAjC;gBACb,SAAS,QAAO;gBAChB,IAAG,UAAW,CAAI,UAAlB;kBAEE,QAAQ,YAAa;AACrB;AAAA;;AACE;AAAA;;;wBACE,KAAM,aAAa;;;6BACH,mBAAmB;;AAFrC;AADF,mBAHF;iBAAA;kBAQE,QAAQ,SARV;;gBASA,YAAa,KAAb,GAAoB,MAbtB;;AAFF,aAJF;;UAoBA,SAAS,CAAC,OAAQ,aAAY,CAAC,IAA/B,CAAoC,YAApC;AArBF,SAFF;OAAA;QAyBE,SAAS,CAAC,OAAQ,aAAlB,GAAiC;QACjC,4BAAG,aAAa,CAAE,cAAlB;UACE,SAAS,CAAC,OAAQ,aAAlB,GAAiC,CAAC,CAAC,IAAF,CAAO,aAAP,EAAsB,OAAtB,EADnC;SA1BF;;AAFF;WAiCA,qCAAM,SAAN;EAvCU;;;;GALsB","file":"public/javascripts/app/models/Poll.js","sourcesContent":["CocoModel = require './CocoModel'\r\nschema = require 'schemas/models/poll.schema'\r\n\r\nmodule.exports = class Poll extends CocoModel\r\n  @className: 'Poll'\r\n  @schema: schema\r\n  urlRoot: '/db/poll'\r\n\r\n  applyDelta: (delta) ->\r\n    # Hackiest hacks ever, just manually mauling the delta (whose format I don't understand) to not overwrite votes and other languages' nested translations.\r\n    # One still must be careful about patches that accidentally delete keys from the top-level i18n object.\r\n    i18nDelta = {}\r\n    if delta.i18n\r\n      i18nDelta.i18n = $.extend true, {}, delta.i18n\r\n    for answerIndex, answerChanges of delta.answers ? {}\r\n      i18nDelta.answers ?= {}\r\n      if _.isArray answerChanges\r\n        i18nDelta.answers[answerIndex] ?= []\r\n        for change in answerChanges\r\n          if _.isNumber change\r\n            pickedChange = change\r\n          else\r\n            pickedChange = $.extend true, {}, change\r\n            for key of pickedChange\r\n              answerIndexNum = parseInt(answerIndex.replace('_', ''), 10)\r\n              unless _.isNaN answerIndexNum\r\n                oldValue = @get('answers')[answerIndexNum][key]\r\n                isDeletion = _.string.startsWith answerIndex, '_'\r\n                isI18N = key is 'i18n'\r\n                if isI18N and not isDeletion\r\n                  # Use the new change, but make sure we're not deleting any other languages' translations.\r\n                  value = pickedChange[key]\r\n                  for language, oldTranslations of oldValue ? {}\r\n                    for translationKey, translationValue of oldTranslations ? {}\r\n                      value[language] ?= {}\r\n                      value[language][translationKey] ?= translationValue\r\n                else\r\n                  value = oldValue\r\n                pickedChange[key] = value\r\n          i18nDelta.answers[answerIndex].push pickedChange\r\n      else\r\n        i18nDelta.answers[answerIndex] = answerChanges\r\n        if answerChanges?.votes\r\n          i18nDelta.answers[answerIndex] = _.omit answerChanges, 'votes'\r\n\r\n    #console.log 'got     delta', delta\r\n    #console.log 'got i18nDelta', i18nDelta\r\n    super i18nDelta\r\n"]}