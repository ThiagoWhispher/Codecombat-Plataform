{"version":3,"sources":["app/models/LevelSession.coffee"],"names":[],"mappings":"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","file":"public/javascripts/app/models/LevelSession.js","sourcesContent":["CocoModel = require './CocoModel'\r\n\r\nmodule.exports = class LevelSession extends CocoModel\r\n  @className: 'LevelSession'\r\n  @schema: require 'schemas/models/level_session'\r\n  urlRoot: '/db/level.session'\r\n\r\n  initialize: ->\r\n    super()\r\n    @on 'sync', (e) =>\r\n      state = @get('state') or {}\r\n      state.scripts ?= {}\r\n      @set('state', state)\r\n\r\n  updatePermissions: ->\r\n    permissions = @get 'permissions', true\r\n    permissions = (p for p in permissions when p.target isnt 'public')\r\n    @set 'permissions', permissions\r\n\r\n  getSourceFor: (spellKey) ->\r\n    # spellKey ex: 'tharin/plan'\r\n    code = @get('code')\r\n    parts = spellKey.split '/'\r\n    code?[parts[0]]?[parts[1]]\r\n\r\n  readyToRank: ->\r\n    return false unless @get('levelID')  # If it hasn't been denormalized, then it's not ready.\r\n    return false unless c1 = @get('code')\r\n    return false unless team = @get('team')\r\n    return true unless c2 = @get('submittedCode')\r\n    thangSpellArr = (s.split('/') for s in @get('teamSpells')[team])\r\n    for item in thangSpellArr\r\n      thang = item[0]\r\n      spell = item[1]\r\n      return true if c1[thang][spell] isnt c2[thang]?[spell]\r\n    false\r\n\r\n  isMultiplayer: ->\r\n    @get('submittedCodeLanguage')? and @get('team')?\r\n\r\n  completed: ->\r\n    @get('state')?.complete || @get('submitted') || false\r\n\r\n  shouldAvoidCorruptData: (attrs) ->\r\n    return false unless me.team is 'humans'\r\n    if _.string.startsWith (attrs?.code ? @get('code'))?.anya?.makeBid ? '', 'var __interceptThis'\r\n      noty text: \"Not saving session--it's trying to overwrite Anya's code with transpiled output. Please let us know and help us reproduce this bug!\", layout: 'topCenter', type: 'error', killer: false, timeout: 120000\r\n      return true\r\n    false\r\n\r\n  save: (attrs, options) ->\r\n    return if @shouldAvoidCorruptData attrs\r\n    super attrs, options\r\n\r\n  increaseDifficulty: (callback) ->\r\n    state = @get('state') ? {}\r\n    state.difficulty = (state.difficulty ? 0) + 1\r\n    delete state.lastUnsuccessfulSubmissionTime\r\n    @set 'state', state\r\n    @trigger 'change-difficulty'\r\n    @save null, success: callback\r\n\r\n  timeUntilResubmit: ->\r\n    state = @get('state') ? {}\r\n    return 0 unless last = state.lastUnsuccessfulSubmissionTime\r\n    last = new Date(last) if _.isString last\r\n    # Wait at least this long before allowing submit button active again.\r\n    wait = (last - new Date()) + 22 * 60 * 60 * 1000\r\n    if wait > 24 * 60 * 60 * 1000\r\n      # System clock must've gotten busted; max out at one day's wait.\r\n      wait = 24 * 60 * 60 * 1000\r\n      state.lastUnsuccessfulSubmissionTime = new Date()\r\n      @set 'state', state\r\n    wait\r\n\r\n  recordScores: (scores, level) ->\r\n    return unless scores\r\n    state = @get 'state'\r\n    oldTopScores = state.topScores ? []\r\n    newTopScores = []\r\n    now = new Date()\r\n    for scoreType in level.get('scoreTypes') ? []\r\n      oldTopScore = _.find oldTopScores, type: scoreType\r\n      newScore = scores[scoreType]\r\n      unless newScore?\r\n        newTopScores.push oldTopScore\r\n        continue\r\n      newScore *= -1 if scoreType in ['time', 'damage-taken']  # Make it so that higher is better\r\n      if not oldTopScore? or newScore > oldTopScore.score\r\n        newTopScores.push type: scoreType, date: now, score: newScore\r\n      else\r\n        newTopScores.push oldTopScore\r\n    state.topScores = newTopScores\r\n    @set 'state', state\r\n\r\n  generateSpellsObject: (options={}) ->\r\n    {level} = options\r\n    {createAetherOptions} = require 'lib/aether_utils'\r\n    aetherOptions = createAetherOptions functionName: 'plan', codeLanguage: @get('codeLanguage'), skipProtectAPI: options.level?.isType('game-dev')\r\n    spellThang = thang: {id: 'Hero Placeholder'}, aether: new Aether aetherOptions\r\n    spells = \"hero-placeholder/plan\": thang: spellThang, name: 'plan'\r\n    source = @get('code')?['hero-placeholder']?.plan ? ''\r\n    try\r\n      spellThang.aether.transpile source\r\n    catch e\r\n      console.log \"Couldn't transpile!\\n#{source}\\n\", e\r\n      spellThang.aether.transpile ''\r\n    spells\r\n\r\n  isFake: -> @id is 'A Fake Session ID'\r\n"]}