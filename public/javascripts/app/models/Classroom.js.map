{"version":3,"sources":["app/models/Classroom.coffee"],"names":[],"mappings":"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","file":"public/javascripts/app/models/Classroom.js","sourcesContent":["CocoModel = require './CocoModel'\r\nschema = require 'schemas/models/classroom.schema'\r\nutils = require '../core/utils'\r\nUser = require 'models/User'\r\n\r\nmodule.exports = class Classroom extends CocoModel\r\n  @className: 'Classroom'\r\n  @schema: schema\r\n  urlRoot: '/db/classroom'\r\n\r\n  initialize: () ->\r\n    @listenTo @, 'change:aceConfig', @capitalizeLanguageName\r\n    super(arguments...)\r\n\r\n  parse: (obj) ->\r\n    if obj._id\r\n      # It's just the classroom object\r\n      return obj\r\n    else\r\n      # It's a compound response with other stuff too\r\n      @owner = new User(obj.owner)\r\n      return obj.data\r\n\r\n  capitalizeLanguageName: ->\r\n    language = @get('aceConfig')?.language\r\n    @capitalLanguage = utils.capitalLanguages[language]\r\n\r\n  joinWithCode: (code, opts) ->\r\n    options = {\r\n      url: @urlRoot + '/~/members'\r\n      type: 'POST'\r\n      data: { code: code }\r\n      success: => @trigger 'join:success'\r\n      error: => @trigger 'join:error'\r\n    }\r\n    _.extend options, opts\r\n    @fetch(options)\r\n\r\n  fetchByCode: (code, opts) ->\r\n    options = {\r\n      url: _.result(@, 'url')\r\n      data: { code: code, \"with-owner\": true }\r\n    }\r\n    _.extend options, opts\r\n    @fetch(options)\r\n\r\n  getLevelNumber: (levelID, defaultNumber) ->\r\n    unless @levelNumberMap\r\n      @levelNumberMap = {}\r\n      language = @get('aceConfig')?.language\r\n      for course in @get('courses') ? []\r\n        levels = []\r\n        for level in course.levels when level.original\r\n          continue if language? and level.primerLanguage is language\r\n          levels.push({key: level.original, practice: level.practice ? false})\r\n        _.assign(@levelNumberMap, utils.createLevelNumberMap(levels))\r\n    @levelNumberMap[levelID] ? defaultNumber\r\n\r\n  removeMember: (userID, opts) ->\r\n    options = {\r\n      url: _.result(@, 'url') + '/members'\r\n      type: 'DELETE'\r\n      data: { userID: userID }\r\n    }\r\n    _.extend options, opts\r\n    @fetch(options)\r\n\r\n  setStudentPassword: (student, password, options) ->\r\n    classroomID = @.id\r\n    $.ajax {\r\n      url: \"/db/classroom/#{classroomID}/members/#{student.id}/reset-password\"\r\n      method: 'POST'\r\n      data: { password }\r\n      success: => @trigger 'save-password:success'\r\n      error: (response) => @trigger 'save-password:error', response.responseJSON\r\n    }\r\n\r\n  getLevels: (options={}) ->\r\n    # options: courseID, withoutLadderLevels, projectLevels\r\n    Levels = require 'collections/Levels'\r\n    courses = @get('courses')\r\n    return new Levels() unless courses\r\n    levelObjects = []\r\n    for course in courses\r\n      if options.courseID and options.courseID isnt course._id\r\n        continue\r\n      levelObjects.push(course.levels)\r\n    levels = new Levels(_.flatten(levelObjects))\r\n    language = @get('aceConfig')?.language\r\n    levels.remove(levels.filter((level) => level.get('primerLanguage') is language)) if language\r\n    if options.withoutLadderLevels\r\n      levels.remove(levels.filter((level) -> level.isLadder()))\r\n    if options.projectLevels\r\n      levels.remove(levels.filter((level) -> level.get('shareable') isnt 'project'))\r\n    return levels\r\n\r\n  getLadderLevel: (courseID) ->\r\n    Levels = require 'collections/Levels'\r\n    courses = @get('courses')\r\n    course = _.findWhere(courses, {_id: courseID})\r\n    return unless course\r\n    levels = new Levels(course.levels)\r\n    return levels.find (l) -> l.isLadder()\r\n\r\n  getProjectLevel: (courseID) ->\r\n    Levels = require 'collections/Levels'\r\n    courses = @get('courses')\r\n    course = _.findWhere(courses, {_id: courseID})\r\n    return unless course\r\n    levels = new Levels(course.levels)\r\n    return levels.find (l) -> l.isProject()\r\n\r\n  statsForSessions: (sessions, courseID) ->\r\n    return null unless sessions\r\n    sessions = sessions.models or sessions\r\n    arena = @getLadderLevel(courseID)\r\n    project = @getProjectLevel(courseID)\r\n    courseLevels = @getLevels({courseID: courseID, withoutLadderLevels: true})\r\n    levelSessionMap = {}\r\n    levelSessionMap[session.get('level').original] = session for session in sessions\r\n    currentIndex = -1\r\n    lastStarted = null\r\n    levelsTotal = 0\r\n    levelsLeft = 0\r\n    lastPlayed = null\r\n    playtime = 0\r\n    levels = []\r\n    for level, index in courseLevels.models\r\n      levelsTotal++ unless level.get('practice')\r\n      complete = false\r\n      if session = levelSessionMap[level.get('original')]\r\n        complete = session.get('state').complete ? false\r\n        playtime += session.get('playtime') ? 0\r\n        lastPlayed = level\r\n        lastPlayedNumber = index + 1\r\n        if complete\r\n          currentIndex = index\r\n        else\r\n          lastStarted = level\r\n          levelsLeft++ unless level.get('practice')\r\n      else if not level.get('practice')\r\n        levelsLeft++\r\n      levels.push\r\n        practice: level.get('practice') ? false\r\n        complete: complete\r\n    lastPlayed = lastStarted ? lastPlayed\r\n    needsPractice = false\r\n    nextIndex = 0\r\n    if currentIndex >= 0\r\n      currentLevel = courseLevels.models[currentIndex]\r\n      currentPlaytime = levelSessionMap[currentLevel.get('original')]?.get('playtime') ? 0\r\n      needsPractice = utils.needsPractice(currentPlaytime, currentLevel.get('practiceThresholdMinutes'))\r\n      nextIndex = utils.findNextLevel(levels, currentIndex, needsPractice)\r\n    nextLevel = courseLevels.models[nextIndex]\r\n    nextLevel ?= _.find courseLevels.models, (level) -> not levelSessionMap[level.get('original')]?.get('state')?.complete\r\n\r\n    lastPlayedNumber ?= 1\r\n    if courseLevels.length >= 1 and lastPlayedNumber < courseLevels.length\r\n      lastPlayedNumber = @getLevelNumber(courseLevels.models[lastPlayedNumber - 1].get('original'), lastPlayedNumber)\r\n    stats =\r\n      levels:\r\n        size: levelsTotal\r\n        left: levelsLeft\r\n        done: levelsLeft is 0\r\n        numDone: levelsTotal - levelsLeft\r\n        pctDone: (100 * (levelsTotal - levelsLeft) / levelsTotal).toFixed(1) + '%'\r\n        lastPlayed: lastPlayed\r\n        lastPlayedNumber: lastPlayedNumber\r\n        next: nextLevel\r\n        first: courseLevels.first()\r\n        arena: arena\r\n        project: project\r\n      playtime: playtime\r\n    stats\r\n\r\n  fetchForCourseInstance: (courseInstanceID, options={}) ->\r\n    return unless courseInstanceID\r\n    CourseInstance = require 'models/CourseInstance'\r\n    courseInstance = if _.isString(courseInstanceID) then new CourseInstance({_id:courseInstanceID}) else courseInstanceID\r\n    options = _.extend(options, {\r\n      url: _.result(courseInstance, 'url') + '/classroom'\r\n    })\r\n    @fetch(options)\r\n\r\n  inviteMembers: (emails, options={}) ->\r\n    options.data ?= {}\r\n    options.data.emails = emails\r\n    options.url = @url() + '/invite-members'\r\n    options.type = 'POST'\r\n    @fetch(options)\r\n\r\n  getSortedCourses: ->\r\n    utils.sortCourses(@get('courses') ? [])\r\n\r\n  updateCourses: (options={}) ->\r\n    options.url = @url() + '/update-courses'\r\n    options.type = 'POST'\r\n    @fetch(options)\r\n"]}