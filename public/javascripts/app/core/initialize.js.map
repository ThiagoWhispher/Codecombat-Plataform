{"version":3,"sources":["app/core/initialize.coffee"],"names":[],"mappings":"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","file":"public/javascripts/app/core/initialize.js","sourcesContent":["Backbone.Mediator.setValidationEnabled false\r\napp = null\r\nutils = require './utils'\r\n\r\nchannelSchemas =\r\n  'auth': require 'schemas/subscriptions/auth'\r\n  'bus': require 'schemas/subscriptions/bus'\r\n  'editor': require 'schemas/subscriptions/editor'\r\n  'errors': require 'schemas/subscriptions/errors'\r\n  'ipad': require 'schemas/subscriptions/ipad'\r\n  'misc': require 'schemas/subscriptions/misc'\r\n  'play': require 'schemas/subscriptions/play'\r\n  'surface': require 'schemas/subscriptions/surface'\r\n  'tome': require 'schemas/subscriptions/tome'\r\n  'god': require 'schemas/subscriptions/god'\r\n  'scripts': require 'schemas/subscriptions/scripts'\r\n  'web-dev': require 'schemas/subscriptions/web-dev'\r\n  'world': require 'schemas/subscriptions/world'\r\n\r\ndefinitionSchemas =\r\n  'bus': require 'schemas/definitions/bus'\r\n  'misc': require 'schemas/definitions/misc'\r\n\r\ninit = ->\r\n  return if app\r\n  if not window.userObject._id\r\n    options = { cache: false }\r\n    options.data = _.pick(utils.getQueryVariables(), 'preferredLanguage')\r\n    $.ajax('/auth/whoami', options).then (res) ->\r\n      window.userObject = res\r\n      init()\r\n    return\r\n\r\n  app = require 'core/application'\r\n  setupConsoleLogging()\r\n  watchForErrors()\r\n  setUpIOSLogging()\r\n  path = document.location.pathname\r\n  app.testing = _.string.startsWith path, '/test'\r\n  app.demoing = _.string.startsWith path, '/demo'\r\n  setUpBackboneMediator()\r\n  app.initialize()\r\n  loadOfflineFonts() unless app.isProduction()\r\n  Backbone.history.start({ pushState: true })\r\n  handleNormalUrls()\r\n  setUpMoment() # Set up i18n for moment\r\n\r\nmodule.exports.init = init\r\n\r\nhandleNormalUrls = ->\r\n  # http://artsy.github.com/blog/2012/06/25/replacing-hashbang-routes-with-pushstate/\r\n  $(document).on 'click', \"a[href^='/']\", (event) ->\r\n\r\n    href = $(event.currentTarget).attr('href')\r\n\r\n    # chain 'or's for other black list routes\r\n    passThrough = href.indexOf('sign_out') >= 0\r\n\r\n    # Allow shift+click for new tabs, etc.\r\n    if !passThrough && !event.altKey && !event.ctrlKey && !event.metaKey && !event.shiftKey\r\n      event.preventDefault()\r\n\r\n      # Remove leading slashes and hash bangs (backward compatablility)\r\n      url = href.replace(/^\\//,'').replace('\\#\\!\\/','')\r\n\r\n      # Instruct Backbone to trigger routing events\r\n      app.router.navigate url, { trigger: true }\r\n\r\n      return false\r\n\r\nsetUpBackboneMediator = ->\r\n  Backbone.Mediator.addDefSchemas schemas for definition, schemas of definitionSchemas\r\n  Backbone.Mediator.addChannelSchemas schemas for channel, schemas of channelSchemas\r\n  Backbone.Mediator.setValidationEnabled document.location.href.search(/codecombat.com/) is -1\r\n  if false  # Debug which events are being fired\r\n    originalPublish = Backbone.Mediator.publish\r\n    Backbone.Mediator.publish = ->\r\n      console.log 'Publishing event:', arguments... unless /(tick|frame-changed)/.test(arguments[0])\r\n      originalPublish.apply Backbone.Mediator, arguments\r\n\r\nsetUpMoment = ->\r\n  {me} = require 'core/auth'\r\n  moment.lang me.get('preferredLanguage', true), {}\r\n  me.on 'change:preferredLanguage', (me) ->\r\n    moment.lang me.get('preferredLanguage', true), {}\r\n\r\nsetupConsoleLogging = ->\r\n  # IE9 doesn't expose console object unless debugger tools are loaded\r\n  unless console?\r\n    window.console =\r\n      info: ->\r\n      log: ->\r\n      error: ->\r\n      debug: ->\r\n  unless console.debug\r\n    # Needed for IE10 and earlier\r\n    console.debug = console.log\r\n\r\nwatchForErrors = ->\r\n  currentErrors = 0\r\n  oldOnError = window.onerror\r\n  window.onerror = (msg, url, line, col, error) ->\r\n    oldOnError.apply window, arguments if oldOnError\r\n    return if currentErrors >= 3\r\n    return unless me.isAdmin() or document.location.href.search(/codecombat.com/) is -1 or document.location.href.search(/\\/editor\\//) isnt -1\r\n    ++currentErrors\r\n    message = \"Error: #{msg}<br>Check the JS console for more.\"\r\n    #msg += \"\\nLine: #{line}\" if line?\r\n    #msg += \"\\nColumn: #{col}\" if col?\r\n    #msg += \"\\nError: #{error}\" if error?\r\n    #msg += \"\\nStack: #{stack}\" if stack = error?.stack\r\n    unless webkit?.messageHandlers  # Don't show these notys on iPad\r\n      noty text: message, layout: 'topCenter', type: 'error', killer: false, timeout: 5000, dismissQueue: true, maxVisible: 3, callback: {onClose: -> --currentErrors}\r\n    Backbone.Mediator.publish 'application:error', message: \"Line #{line} of #{url}:\\n#{msg}\"  # For iOS app\r\n\r\nwindow.addIPadSubscription = (channel) ->\r\n  window.iPadSubscriptions[channel] = true\r\n\r\nwindow.removeIPadSubscription = (channel) ->\r\n  window.iPadSubscriptions[channel] = false\r\n\r\nsetUpIOSLogging = ->\r\n  return unless webkit?.messageHandlers\r\n  for level in ['debug', 'log', 'info', 'warn', 'error']\r\n    do (level) ->\r\n      originalLog = console[level]\r\n      console[level] = ->\r\n        originalLog.apply console, arguments\r\n        try\r\n          webkit?.messageHandlers?.consoleLogHandler?.postMessage level: level, arguments: (a?.toString?() ? ('' + a) for a in arguments)\r\n        catch e\r\n          webkit?.messageHandlers?.consoleLogHandler?.postMessage level: level, arguments: ['could not post log: ' + e]\r\n\r\nloadOfflineFonts = ->\r\n  $('head').prepend '<link rel=\"stylesheet\" type=\"text/css\" href=\"/fonts/openSansCondensed.css\">'\r\n  $('head').prepend '<link rel=\"stylesheet\" type=\"text/css\" href=\"/fonts/openSans.css\">'\r\n\r\n# This is so hacky... hopefully it's restrictive enough to not be slow.\r\n# We could also keep a list of events we are actually subscribed for and only try to send those over.\r\nseen = null\r\nwindow.serializeForIOS = serializeForIOS = (obj, depth=3) ->\r\n  return {} unless depth\r\n  root = not seen?\r\n  seen ?= []\r\n  clone = {}\r\n  keysHandled = 0\r\n  for own key, value of obj\r\n    continue if ++keysHandled > 50\r\n    if not value\r\n      clone[key] = value\r\n    else if value is window or value.firstElementChild or value.preventDefault\r\n      null  # Don't include these things\r\n    else if value in seen\r\n      null  # No circular references\r\n    else if _.isArray value\r\n      clone[key] = (serializeForIOS(child, depth - 1) for child in value)\r\n      seen.push value\r\n    else if _.isObject value\r\n      value = value.attributes if value.id and value.attributes\r\n      clone[key] = serializeForIOS value, depth - 1\r\n      seen.push value\r\n    else\r\n      clone[key] = value\r\n  seen = null if root\r\n  clone\r\n\r\nwindow.onbeforeunload = (e) ->\r\n  leavingMessage = _.result(window.currentView, 'onLeaveMessage')\r\n  if leavingMessage\r\n    return leavingMessage\r\n  else\r\n    return\r\n\r\n$ -> init()\r\n"]}