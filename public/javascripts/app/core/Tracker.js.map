{"version":3,"sources":["app/core/Tracker.coffee"],"names":[],"mappings":"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","file":"public/javascripts/app/core/Tracker.js","sourcesContent":["{me} = require 'core/auth'\r\nSuperModel = require 'models/SuperModel'\r\nutils = require 'core/utils'\r\nCocoClass = require 'core/CocoClass'\r\n\r\ndebugAnalytics = false\r\ntargetInspectJSLevelSlugs = ['cupboards-of-kithgard']\r\n\r\nmodule.exports = class Tracker extends CocoClass\r\n  subscriptions:\r\n    'application:service-loaded': 'onServiceLoaded'\r\n\r\n  constructor: ->\r\n    super()\r\n    if window.tracker\r\n      console.error 'Overwrote our Tracker!', window.tracker\r\n    window.tracker = @\r\n    @isProduction = document.location.href.search('codecombat.com') isnt -1\r\n    @trackReferrers()\r\n    @identify()\r\n    @supermodel = new SuperModel()\r\n    @updateRole() if me.get 'role'\r\n\r\n  enableInspectletJS: (levelSlug) ->\r\n    # InspectletJS loading is delayed and targeting specific levels for more focused investigations\r\n    return @disableInspectletJS() unless levelSlug in targetInspectJSLevelSlugs\r\n\r\n    scriptLoaded = =>\r\n      # Identify and track pageview here, because inspectlet is loaded too late for standard Tracker calls\r\n      @identify()\r\n      # http://www.inspectlet.com/docs#virtual_pageviews\r\n      window.__insp?.push(['virtualPage'])\r\n    window.__insp = [['wid', 2102699786]]\r\n    insp = document.createElement('script')\r\n    insp.type = 'text/javascript'\r\n    insp.async = true\r\n    insp.id = 'inspsync'\r\n    insp.src = (if 'https:' == document.location.protocol then 'https' else 'http') + '://cdn.inspectlet.com/inspectlet.js'\r\n    insp.onreadystatechange = -> scriptLoaded() if insp.readyState is 'complete'\r\n    insp.onload = scriptLoaded\r\n    x = document.getElementsByTagName('script')[0]\r\n    @inspectletScriptNode = x.parentNode.insertBefore insp, x\r\n\r\n  disableInspectletJS: ->\r\n    if @inspectletScriptNode\r\n      x = document.getElementsByTagName('script')[0]\r\n      x.parentNode.removeChild(@inspectletScriptNode)\r\n      @inspectletScriptNode = null\r\n    delete window.__insp\r\n\r\n  trackReferrers: ->\r\n    elapsed = new Date() - new Date(me.get('dateCreated'))\r\n    return unless elapsed < 5 * 60 * 1000\r\n    return if me.get('siteref') or me.get('referrer')\r\n    changed = false\r\n    if siteref = utils.getQueryVariable '_r'\r\n      me.set 'siteref', siteref\r\n      changed = true\r\n    if referrer = document.referrer\r\n      me.set 'referrer', referrer\r\n      changed = true\r\n    me.patch() if changed\r\n\r\n  identify: (traits={}) ->\r\n    return unless me\r\n\r\n    # Save explicit traits for internal tracking\r\n    @explicitTraits ?= {}\r\n    @explicitTraits[key] = value for key, value of traits\r\n\r\n    for userTrait in ['email', 'anonymous', 'dateCreated', 'hourOfCode', 'name', 'referrer', 'testGroupNumber', 'gender', 'lastLevel', 'siteref', 'ageRange', 'schoolName', 'coursePrepaidID', 'role']\r\n      traits[userTrait] ?= me.get(userTrait) if me.get(userTrait)?\r\n    if me.isTeacher()\r\n      traits.teacher = true\r\n    traits.host = document.location.host\r\n\r\n    console.log 'Would identify', me.id, traits if debugAnalytics\r\n    @trackEventInternal('Identify', {id: me.id, traits}) unless me?.isAdmin() and @isProduction\r\n    return unless @isProduction and not me.isAdmin()\r\n\r\n    # Errorception\r\n    # https://errorception.com/docs/meta\r\n    _errs?.meta = traits\r\n\r\n    # Inspectlet\r\n    # https://www.inspectlet.com/docs#identifying_users\r\n    __insp?.push ['identify', me.id]\r\n    __insp?.push ['tagSession', traits]\r\n\r\n    # Mixpanel\r\n    # https://mixpanel.com/help/reference/javascript\r\n    mixpanel?.identify(me.id)\r\n    mixpanel?.register(traits)\r\n\r\n    if me.isTeacher() and @segmentLoaded\r\n      traits.createdAt = me.get 'dateCreated'  # Intercom, at least, wants this\r\n      analytics.identify me.id, traits\r\n\r\n  trackPageView: (includeIntegrations=[]) ->\r\n    includeMixpanel = (name) ->\r\n      mixpanelIncludes = []\r\n      name in mixpanelIncludes or /courses|students|teachers/ig.test(name)\r\n\r\n    name = Backbone.history.getFragment()\r\n    url = \"/#{name}\"\r\n    console.log \"Would track analytics pageview: #{url} Mixpanel=#{includeMixpanel(name)}\" if debugAnalytics\r\n    @trackEventInternal 'Pageview', url: name, href: window.location.href unless me?.isAdmin() and @isProduction\r\n    return unless @isProduction and not me.isAdmin()\r\n\r\n    # Google Analytics\r\n    # https://developers.google.com/analytics/devguides/collection/analyticsjs/pages\r\n    ga? 'send', 'pageview', url\r\n    ga?('codeplay.send', 'pageview', url) if features.codePlay\r\n    window.snowplow 'trackPageView'\r\n    # Mixpanel\r\n    mixpanel?.track('page viewed', 'page name' : name, url : url) if includeMixpanel(name)\r\n\r\n    if me.isTeacher() and @segmentLoaded\r\n      options = {}\r\n      if includeIntegrations?.length\r\n        options.integrations = All: false\r\n        for integration in includeIntegrations\r\n          options.integrations[integration] = true\r\n      analytics.page url, {}, options\r\n\r\n  trackEvent: (action, properties={}, includeIntegrations=[]) =>\r\n    console.log 'Tracking external analytics event:', action, properties, includeIntegrations if debugAnalytics\r\n    return unless me and @isProduction and not me.isAdmin()\r\n\r\n    @trackEventInternal action, _.cloneDeep properties    \r\n    @trackSnowplow action, _.cloneDeep properties\r\n\r\n\r\n\r\n    # Google Analytics\r\n    # https://developers.google.com/analytics/devguides/collection/analyticsjs/events\r\n    gaFieldObject =\r\n      hitType: 'event'\r\n      eventCategory: properties.category ? 'All'\r\n      eventAction: action\r\n    gaFieldObject.eventLabel = properties.label if properties.label?\r\n    gaFieldObject.eventValue = properties.value if properties.value?\r\n    ga? 'send', gaFieldObject\r\n    ga? 'codeplay.send', gaFieldObject if features.codePlay\r\n    \r\n    # Inspectlet\r\n    # http://www.inspectlet.com/docs#tagging\r\n    __insp?.push ['tagSession', action: action, properies: properties]\r\n\r\n    # Mixpanel\r\n    # Only log explicit events for now\r\n    mixpanel?.track(action, properties) if 'Mixpanel' in includeIntegrations\r\n\r\n    if me.isTeacher() and @segmentLoaded\r\n      options = {}\r\n      if includeIntegrations\r\n        # https://segment.com/docs/libraries/analytics.js/#selecting-integrations\r\n        options.integrations = All: false\r\n        for integration in includeIntegrations\r\n          options.integrations[integration] = true\r\n      analytics?.track action, {}, options\r\n\r\n  trackSnowplow: (event, properties) =>\r\n\r\n    return if event in ['Simulator Result', 'Started Level Load', 'Finished Level Load']\r\n    # Trimming properties we don't use internally\r\n    # TODO: delete properites.level for 'Saw Victory' after 2/8/15.  Should be using levelID instead.\r\n    if event in ['Clicked Start Level', 'Inventory Play', 'Heard Sprite', 'Started Level', 'Saw Victory', 'Click Play', 'Choose Inventory', 'Homepage Loaded', 'Change Hero']\r\n      delete properties.label\r\n\r\n    # SnowPlow\r\n    snowplowAction = event.toLowerCase().replace(/[^a-z0-9]+/ig, '_')\r\n    properties.user = me.id\r\n    delete properties.category\r\n    #console.log \"SnowPlow\", snowplowAction, properties\r\n    window.snowplow 'trackUnstructEvent',\r\n      schema: 'iglu:com.codecombat/' + snowplowAction + '/jsonschema/1-0-0'\r\n      data: properties\r\n\r\n  trackEventInternal: (event, properties) =>\r\n    return unless @supermodel?\r\n    # Skipping heavily logged actions we don't use internally\r\n    return if event in ['Simulator Result', 'Started Level Load', 'Finished Level Load', 'View Load']\r\n    # Trimming properties we don't use internally\r\n    # TODO: delete properites.level for 'Saw Victory' after 2/8/15.  Should be using levelID instead.\r\n    if event in ['Clicked Start Level', 'Inventory Play', 'Heard Sprite', 'Started Level', 'Saw Victory', 'Click Play', 'Choose Inventory', 'Homepage Loaded', 'Change Hero']\r\n      delete properties.category\r\n      delete properties.label\r\n    else if event in ['Loaded World Map', 'Started Signup', 'Finished Signup', 'Login', 'Facebook Login', 'Google Login', 'Show subscription modal']\r\n      delete properties.category\r\n\r\n    properties[key] = value for key, value of @explicitTraits if @explicitTraits?\r\n    console.log 'Tracking internal analytics event:', event, properties if debugAnalytics\r\n\r\n    request = @supermodel.addRequestResource {\r\n      url: '/db/analytics.log.event/-/log_event'\r\n      data: {event: event, properties: properties}\r\n      method: 'POST'\r\n    }, 0\r\n    request.load()\r\n\r\n  trackTiming: (duration, category, variable, label) ->\r\n    # https://developers.google.com/analytics/devguides/collection/analyticsjs/user-timings\r\n    return console.warn \"Duration #{duration} invalid for trackTiming call.\" unless duration >= 0 and duration < 60 * 60 * 1000\r\n    console.log 'Would track timing event:', arguments if debugAnalytics\r\n    return unless me and @isProduction and not me.isAdmin()\r\n    ga? 'send', 'timing', category, variable, duration, label\r\n\r\n  updateRole: ->\r\n    return if me.isAdmin()\r\n    return unless me.isTeacher()\r\n    return require('core/services/segment')() unless @segmentLoaded\r\n    @identify()\r\n    #analytics.page()  # It looks like we don't want to call this here because it somehow already gets called once in addition to this.\r\n    # TODO: record any events and pageviews that have built up before we knew we were a teacher.\r\n\r\n  onServiceLoaded: (e) ->\r\n    return unless e.service is 'segment'\r\n    @segmentLoaded = true\r\n    @updateRole()\r\n"]}