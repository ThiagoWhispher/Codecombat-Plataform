{"version":3,"sources":["app/core/ModuleLoader.coffee"],"names":[],"mappings":"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","file":"public/javascripts/app/core/ModuleLoader.js","sourcesContent":["CocoClass = require 'core/CocoClass'\r\nlocale = require 'locale/locale'\r\n\r\nLOG = false\r\n\r\nmodule.exports = ModuleLoader = class ModuleLoader extends CocoClass\r\n\r\n  @WADS = [\r\n    'lib'\r\n    'views/play'\r\n    'views/editor'\r\n    'views/courses'\r\n  ]\r\n\r\n  constructor: ->\r\n    super()\r\n    @loaded = {}    \r\n    @loaded[f] = true for f in window.require.list()\r\n    #Load the locales present in app.js\r\n    locale.update()\r\n\r\n    @queue = new createjs.LoadQueue()\r\n    @queue.on('fileload', @onFileLoad, @)\r\n    @queue.setMaxConnections 5\r\n    wrapped = _.wrap window.require, (func, name, loaderPath) ->\r\n      # vendor libraries aren't actually wrapped with common.js, so short circuit those requires\r\n      return {} if _.string.startsWith(name, 'vendor/')\r\n      return window.esper if name is 'esper'\r\n      return window.Aether if name is 'aether'\r\n      return {} if name is 'game-libraries'\r\n      return window.ace if name is 'ace'\r\n      return {} if name is 'tests'\r\n      return {} if name is 'demo-app'\r\n      name = 'core/auth' if name is 'lib/auth' # proxy for iPad until it's been updated to use the new, refactored location. TODO: remove this\r\n      return func(name, loaderPath)\r\n    _.extend wrapped, window.require # for functions like 'list'\r\n    window.require = wrapped\r\n    @updateProgress = _.throttle _.bind(@updateProgress, @), 700\r\n    @lastShownProgress = 0\r\n\r\n  load: (path, first=true, why) ->\r\n    $('#module-load-progress').css('opacity', 1)\r\n    if first\r\n      @recentPaths = []\r\n      @recentLoadedBytes = 0\r\n      \r\n    originalPath = path\r\n    wad = _.find ModuleLoader.WADS, (wad) -> _.string.startsWith(path, wad)\r\n    path = wad if wad\r\n    return false if @loaded[path]\r\n    if wad\r\n      console.log \"Loading\", wad, \" for \", originalPath if LOG\r\n    @loaded[path] = true\r\n    @recentPaths.push(path)\r\n    uri = \"/javascripts/app/#{path}.js\"\r\n    \r\n    if path in [\"aether\", \"game-libraries\"]\r\n      uri = \"/javascripts/#{path}.js\"\r\n\r\n    else if path is \"ace\"\r\n      uri = \"/lib/ace/ace.js\"\r\n\r\n    else if path is \"esper\"\r\n      try\r\n        #Detect very modern javascript support.\r\n        indirecteval = eval\r\n        indirecteval \"'use strict'; let test = WeakMap && (class Test { *gen(a=7) { yield yield * () => true ; } });\"\r\n        console.log \"Modern javascript detected, aw yeah!\"\r\n        uri = \"/javascripts/esper.modern.js\"\r\n      catch e\r\n        console.log \"Legacy javascript detected, falling back...\", e.message\r\n        uri = \"/javascripts/esper.js\"\r\n\r\n    console.debug 'Loading js file:', uri, \"because\", why if LOG\r\n    @queue.loadFile({\r\n      id: path\r\n      src: \"/#{window.serverConfig.buildInfo.sha}#{uri}\"\r\n      type: createjs.LoadQueue.JAVASCRIPT\r\n    })\r\n    return true\r\n\r\n  loadLanguage: (langCode='en-US') ->  \r\n    loading = @load(\"locale/#{langCode}\")\r\n    firstBit = langCode[...2]\r\n    return loading if firstBit is langCode\r\n    return loading unless locale[firstBit]?\r\n    return @load(\"locale/#{firstBit}\", false) or loading\r\n\r\n  onFileLoad: (e) =>\r\n    # load dependencies if it's not a vendor library\r\n    if not /(^vendor)|game-libraries$|aether$|esper$/.test e.item.id\r\n      have = window.require.list()\r\n      haveWithIndexRemoved = _(have)\r\n        .filter (file) -> _.string.endsWith(file, 'index')\r\n        .map (file) -> file.slice(0,-6)\r\n        .value()\r\n      have = have.concat(haveWithIndexRemoved)\r\n      console.group('Dependencies', e.item.id) if LOG\r\n      @recentLoadedBytes += e.rawResult.length\r\n      dependencies = @parseDependencies(e.rawResult)\r\n      console.groupEnd() if LOG\r\n      missing = _.difference dependencies, have\r\n      @load(module, false, \"missing module of #{e.item.id}\") for module in missing\r\n\r\n    if e.item.id is 'ace'\r\n      window.ace.config.set 'basePath', '/lib/ace'\r\n      \r\n\r\n    # update locale data\r\n    if _.string.startsWith(e.item.id, 'locale')\r\n      locale.update()\r\n      \r\n    # just a bit of cleanup to get the script objects out of the body element\r\n    $(e.result).remove()\r\n\r\n    # get treema set up only when the library loads, if it loads\r\n    if e.item.id is 'vendor/treema'\r\n      treemaExt = require 'core/treema-ext'\r\n      treemaExt.setup()\r\n\r\n    # a module and its dependencies have loaded!\r\n    if @queue.progress is 1\r\n      @recentPaths.sort()\r\n#      console.debug @recentPaths.join('\\n')\r\n#      console.debug 'loaded', @recentPaths.length, 'files,', parseInt(@recentLoadedBytes/1024), 'KB'\r\n      @trigger 'load-complete'\r\n      \r\n    @trigger 'loaded', e.item\r\n    \r\n    @updateProgress()\r\n    \r\n  updateProgress: ->\r\n    return if @queue.progress < @lastShownProgress\r\n    $('#module-load-progress .progress-bar').css('width', (100*@queue.progress)+'%')\r\n    if @queue.progress is 1 \r\n      $('#module-load-progress').css('opacity', 0)\r\n\r\n  parseDependencies: (raw) ->\r\n    bits = raw.match(/(require\\(['\"](.+?)['\"])|(register\\(['\"].+?['\"])/g) or []\r\n    rootFolder = null\r\n    dependencies = []\r\n    for bit in bits\r\n      if _.string.startsWith(bit, 'register')\r\n        root = bit.slice(10, bit.length-1) # remove 'register(\"' and final double quote\r\n        console.groupEnd() if rootFolder if LOG\r\n        rootFolder = (root.match('.+/')[0] or '')[...-1]\r\n        console.group('register', rootFolder, \"(#{bit})\") if LOG\r\n      else\r\n        dep = bit.slice(9, bit.length-1) # remove \"require('\" and final single quote\r\n        dep = dep[1...] if dep[0] is '/'\r\n        dep = @expand(rootFolder, dep)\r\n        continue if dep is 'memwatch'\r\n        continue if _.string.startsWith(dep, 'ace/')\r\n        dependencies.push(dep)\r\n        console.debug dep if LOG\r\n    console.groupEnd() if LOG\r\n    return dependencies\r\n\r\n  # basically ripped out of commonjs definition\r\n  expand: (root, name) ->\r\n    results = []\r\n    if /^\\.\\.?(\\/|$)/.test(name)\r\n      parts = [root, name].join('/').split('/')\r\n    else\r\n      parts = name.split('/')\r\n    for part in parts\r\n      if part is '..' \r\n        results.pop()\r\n      else if (part isnt '.' and part isnt '')\r\n        results.push(part)\r\n    return results.join('/')\r\n\r\n"]}