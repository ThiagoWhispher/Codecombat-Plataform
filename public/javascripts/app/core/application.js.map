{"version":3,"sources":["app/core/application.coffee"],"names":[],"mappings":"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","file":"public/javascripts/app/core/application.js","sourcesContent":["FacebookHandler = require 'core/social-handlers/FacebookHandler'\r\nGPlusHandler = require 'core/social-handlers/GPlusHandler'\r\nGitHubHandler = require 'core/social-handlers/GitHubHandler'\r\nModuleLoader = require 'core/ModuleLoader'\r\nlocale = require 'locale/locale'\r\n{me} = require 'core/auth'\r\nTracker = require 'core/Tracker'\r\nCocoModel = require 'models/CocoModel'\r\n\r\nmarked.setOptions {gfm: true, sanitize: true, smartLists: true, breaks: false}\r\n\r\n# TODO, add C-style macro constants like this?\r\nwindow.SPRITE_RESOLUTION_FACTOR = 3\r\nwindow.SPRITE_PLACEHOLDER_WIDTH = 60\r\n\r\n# Prevent Ctrl/Cmd + [ / ], P, S\r\nctrlDefaultPrevented = [219, 221, 80, 83]\r\npreventBackspace = (event) ->\r\n  if event.keyCode is 8 and not elementAcceptsKeystrokes(event.srcElement or event.target)\r\n    event.preventDefault()\r\n  else if (event.ctrlKey or event.metaKey) and not event.altKey and event.keyCode in ctrlDefaultPrevented\r\n    console.debug \"Prevented keystroke\", key, event\r\n    event.preventDefault()\r\n\r\nelementAcceptsKeystrokes = (el) ->\r\n  # http://stackoverflow.com/questions/1495219/how-can-i-prevent-the-backspace-key-from-navigating-back\r\n  el ?= document.activeElement\r\n  tag = el.tagName.toLowerCase()\r\n  type = el.type?.toLowerCase()\r\n  textInputTypes = ['text', 'password', 'file', 'number', 'search', 'url', 'tel', 'email', 'date', 'month', 'week', 'time', 'datetimelocal']\r\n  # not radio, checkbox, range, or color\r\n  return (tag is 'textarea' or (tag is 'input' and type in textInputTypes) or el.contentEditable in ['', 'true']) and not (el.readOnly or el.disabled)\r\n\r\nCOMMON_FILES = ['/images/pages/base/modal_background.png', '/images/level/popover_background.png', '/images/level/code_palette_wood_background.png', '/images/level/code_editor_background_border.png']\r\npreload = (arrayOfImages) ->\r\n  $(arrayOfImages).each ->\r\n    $('<img/>')[0].src = @\r\n\r\n# IE9 doesn't expose console object unless debugger tools are loaded\r\nwindow.console ?=\r\n  info: ->\r\n  log: ->\r\n  error: ->\r\n  debug: ->\r\nconsole.debug ?= console.log  # Needed for IE10 and earlier\r\n\r\nApplication = {\r\n  initialize: ->\r\n#    if features.codePlay and me.isAnonymous()\r\n#      document.location.href = '//lenovogamestate.com/login/'\r\n    \r\n    Router = require('core/Router')\r\n    @isProduction = -> document.location.href.search('https?://localhost') is -1\r\n    @isIPadApp = webkit?.messageHandlers? and navigator.userAgent?.indexOf('CodeCombat-iPad') isnt -1\r\n    $('body').addClass 'ipad' if @isIPadApp\r\n    $('body').addClass 'picoctf' if window.serverConfig.picoCTF\r\n    if $.browser.msie and parseInt($.browser.version) is 10\r\n      $(\"html\").addClass(\"ie10\")\r\n    @tracker = new Tracker()\r\n    @facebookHandler = new FacebookHandler()\r\n    @gplusHandler = new GPlusHandler()\r\n    @githubHandler = new GitHubHandler()\r\n    @moduleLoader = new ModuleLoader()\r\n    @moduleLoader.loadLanguage(me.get('preferredLanguage', true))\r\n    $(document).bind 'keydown', preventBackspace\r\n    preload(COMMON_FILES)\r\n    CocoModel.pollAchievements()\r\n    unless me.get('anonymous')\r\n      # TODO: Remove logging later, once this system has proved stable\r\n      me.on 'change:earned', (user, newEarned) ->\r\n        newEarned ?= {}\r\n        oldEarned = user.previous('earned') ? {}\r\n        if oldEarned.gems isnt newEarned.gems\r\n          console.log 'Gems changed', oldEarned.gems, '->', newEarned.gems\r\n        newLevels = _.difference(newEarned.levels, oldEarned.levels)\r\n        if newLevels.length\r\n          console.log 'Levels added', newLevels\r\n        newItems = _.difference(newEarned.items, oldEarned.items)\r\n        if newItems.length\r\n          console.log 'Items added', newItems\r\n        newHeroes = _.difference(newEarned.heroes, oldEarned.heroes)\r\n        if newHeroes.length\r\n          console.log 'Heroes added', newHeroes\r\n      me.on 'change:points', (user, newPoints) ->\r\n        console.log 'Points changed', user.previous('points'), '->', newPoints\r\n      @checkForNewAchievement()\r\n    $.i18n.init {\r\n      lng: me.get('preferredLanguage', true)\r\n      fallbackLng: 'en'\r\n      resStore: locale\r\n      useDataAttrOptions: true\r\n      #debug: true\r\n      #sendMissing: true\r\n      #sendMissingTo: 'current'\r\n      #resPostPath: '/languages/add/__lng__/__ns__'\r\n    }, (t) =>\r\n      @router = new Router()\r\n      onIdleChanged = (to) => => Backbone.Mediator.publish 'application:idle-changed', idle: @userIsIdle = to\r\n      @idleTracker = new Idle\r\n        onAway: onIdleChanged true\r\n        onAwayBack: onIdleChanged false\r\n        onHidden: onIdleChanged true\r\n        onVisible: onIdleChanged false\r\n        awayTimeout: 5 * 60 * 1000\r\n      @idleTracker.start()\r\n      \r\n  checkForNewAchievement: ->\r\n    if me.get('lastAchievementChecked')\r\n      startFrom = new Date(me.get('lastAchievementChecked'))\r\n    else\r\n      startFrom = me.created()\r\n    \r\n    daysSince = moment.duration(new Date() - startFrom).asDays()\r\n    if daysSince > 1\r\n      me.checkForNewAchievement().then => @checkForNewAchievement()\r\n      \r\n  featureMode: {\r\n    useCodePlay: ->\r\n      $.ajax({method: 'put', url: '/admin/feature-mode/code-play'}).then(-> document.location.reload())\r\n      \r\n    usePicoCtf: ->\r\n      $.ajax({method: 'put', url: '/admin/feature-mode/pico-ctf'}).then(-> document.location.reload())\r\n\r\n    clear: ->\r\n      $.ajax({method: 'delete', url: '/admin/feature-mode'}).then(-> document.location.reload())\r\n  }\r\n      \r\n}\r\n\r\nmodule.exports = Application\r\nwindow.application = Application\r\n"]}