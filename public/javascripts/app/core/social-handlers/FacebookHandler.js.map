{"version":3,"sources":["app/core/social-handlers/FacebookHandler.coffee"],"names":[],"mappings":";AAAA;EAAA;;;AAAA,YAAY,QAAQ,gBAAR;;AACX,KAAM,QAAQ,WAAR,EAAN;;AACA,kBAAmB,QAAQ,aAAR,EAAnB;;AACD,UAAU,QAAQ,cAAR;;AAGV,kBACE;EAAA,cAAc,WAAd;EACA,aAAa,UADb;EAEA,UAAU,QAFV;EAGA,SAAS,OAHT;EAIA,MAAM,YAJN;;;AAOF,MAAM,CAAC,OAAP,GAAiB,kBAAwB;;;;;;;4BAEvC,QAAO;AAAG;oDAAa,CAAE;EAAlB;;4BAEP,iBAAgB;;4BAChB,YAAW;;4BACX,YAAW;;4BACX,SAAQ;;4BAER,UAAS;IACP,MAAM,CAAC,EAAP,GACE;MAAA,OAAO,SAAC,EAAD,EAAK,OAAL;eACL,GAAG;UAAC,QAAQ,WAAT;UAAsB,cAAc;YAAE,aAAa,MAAf;WAApC;SAAH;MADK,CAAP;MAEA,KAAK,SAAC,GAAD,EAAM,OAAN,EAAe,EAAf;eACH,GAAG;UACD,YAAY,IADX;UAED,WAAW,MAFV;UAGD,IAAI,MAHH;UAID,OAAO,gBAJN;SAAH;MADG,CAFL;;IAUF,IAAC,eAAD,GAAkB;WAClB,IAAC,UAAD,GAAa;EAbN;;4BAeT,UAAS,SAAC,OAAD;;MAAC,UAAQ;;;MAChB,OAAO,CAAC,UAAW,CAAC,CAAC;;;MACrB,OAAO,CAAC,UAAW;;IACnB,IAAG,IAAC,UAAJ;MACE,OAAO,CAAC,OAAO,CAAC,IAAhB,CAAqB,OAAO,CAAC,OAA7B,IADF;KAAA;MAGE,IAAC,KAAD,CAAM,UAAN,EAAkB,OAAO,CAAC,OAA1B,EAAmC,OAAO,CAAC,OAA3C,EAHF;;IAKA,IAAG,CAAI,IAAC,eAAR;MAEE,IAAC,eAAD,GAAkB;MAClB,CAAC,SAAC,CAAD;AACC;QAAA,KAAK;QACL,KAAK;QACL,MAAM,CAAC,CAAC,oBAAF,CAAuB,QAAvB,CAAiC;QACvC,IAAW,CAAC,CAAC,cAAF,CAAiB,EAAjB,CAAX;AAAA;;QACA,KAAK,CAAC,CAAC,aAAF,CAAgB,QAAhB;QACL,EAAE,CAAC,EAAH,GAAQ;QACR,EAAE,CAAC,KAAH,GAAW;QACX,EAAE,CAAC,GAAH,GAAS;QAGT,GAAG,CAAC,UAAU,CAAC,YAAf,CAA4B,EAA5B,EAAgC,GAAhC;MAXD,CAAD,EAaE,QAbF;aAeA,MAAM,CAAC,WAAP,GAAqB;eAAA;UACnB,EAAE,CAAC,IAAH,CAAQ;YACN,OAAO,CAAI,QAAQ,CAAC,QAAQ,CAAC,MAAlB,KAA4B,uBAA/B,GAA4D,iBAA5D,GAAmF,iBAApF,CADD;YAEN,YAAY,QAAQ,CAAC,QAAQ,CAAC,MAAlB,GAA2B,eAFjC;YAGN,QAAQ,IAHF;YAIN,OAAO,IAJD;YAKN,SAAS,MALH;WAAR;iBAOA,EAAE,CAAC,cAAH,CAAkB,SAAC,QAAD;YAChB,IAAG,QAAQ,CAAC,MAAT,KAAmB,WAAtB;cACE,KAAC,UAAD,GAAa;cACb,KAAC,aAAD,GAAgB,QAAQ,CAAC;cACzB,KAAC,QAAD,CAAS,SAAT,EAAoB;gBAAE,UAAU,QAAZ;eAApB,EAHF;;YAIA,KAAC,UAAD,GAAa;mBACb,KAAC,QAAD,CAAS,UAAT;UANgB,CAAlB;QARmB;MAAA,SAlBvB;;EARO;;4BA2CT,UAAS,SAAC,OAAD;;MAAC,UAAQ;;;MAChB,OAAO,CAAC,UAAW,CAAC,CAAC;;;MACrB,OAAO,CAAC,UAAW;;WACnB,EAAE,CAAC,KAAH,CAAS,CAAC;aAAA,SAAC,QAAD;QACR,IAAG,QAAQ,CAAC,MAAT,KAAmB,WAAtB;UACE,KAAC,UAAD,GAAa;UACb,KAAC,aAAD,GAAgB,QAAQ,CAAC;UACzB,KAAC,QAAD,CAAS,SAAT,EAAoB;YAAE,UAAU,QAAZ;WAApB;iBACA,OAAO,CAAC,OAAO,CAAC,IAAhB,CAAqB,OAAO,CAAC,OAA7B,IAJF;;MADQ;IAAA,QAAD,CAAT,EAMG;MAAA,OAAO,OAAP;KANH;EAHO;;4BAYT,aAAY,SAAC,OAAD;;MAAC,UAAQ;;;MACnB,OAAO,CAAC,UAAW,CAAC,CAAC;;;MACrB,OAAO,CAAC,UAAW;;WACnB,EAAE,CAAC,GAAH,CAAO,KAAP,EAAc;MAAC,QAAQ,mCAAT;KAAd,EAA6D;aAAA,SAAC,MAAD;AAC3D;QAAA,QAAQ;AACR;;UACE,QAAQ,MAAO;UACf,IAAG,KAAH;YACE,KAAM,UAAN,GAAkB,MADpB;;AAFF;QAIA,KAAC,QAAD,CAAS,aAAT,EAAwB,KAAxB;eACA,OAAO,CAAC,OAAO,CAAC,IAAhB,CAAqB,OAAO,CAAC,OAA7B,EAAsC,KAAtC;MAP2D;IAAA,QAA7D;EAHU;;4BAYZ,gBAAe;AACb;IAAA,+EAA2C,CAAE,uBAA7C;aAAA,WAAW,EAAE,CAAC,KAAK,CAAC,KAApB,EAA2B,EAA3B;;EADa;;;;GA3FgD","file":"public/javascripts/app/core/social-handlers/FacebookHandler.js","sourcesContent":["CocoClass = require 'core/CocoClass'\r\n{me} = require 'core/auth'\r\n{backboneFailure} = require 'core/errors'\r\nstorage = require 'core/storage'\r\n\r\n# facebook user object props to\r\nuserPropsToSave =\r\n  'first_name': 'firstName'\r\n  'last_name': 'lastName'\r\n  'gender': 'gender'\r\n  'email': 'email'\r\n  'id': 'facebookID'\r\n\r\n\r\nmodule.exports = FacebookHandler = class FacebookHandler extends CocoClass\r\n\r\n  token: -> @authResponse?.accessToken\r\n\r\n  startedLoading: false\r\n  apiLoaded: false\r\n  connected: false\r\n  person: null\r\n  \r\n  fakeAPI: ->\r\n    window.FB =\r\n      login: (cb, options) ->\r\n        cb({status: 'connected', authResponse: { accessToken: '1234' }})\r\n      api: (url, options, cb) ->\r\n        cb({\r\n          first_name: 'Mr'\r\n          last_name: 'Bean'\r\n          id: 'abcd'\r\n          email: 'some@email.com'\r\n        })\r\n\r\n    @startedLoading = true\r\n    @apiLoaded = true\r\n\r\n  loadAPI: (options={}) ->\r\n    options.success ?= _.noop\r\n    options.context ?= options\r\n    if @apiLoaded\r\n      options.success.bind(options.context)()\r\n    else\r\n      @once 'load-api', options.success, options.context\r\n    \r\n    if not @startedLoading\r\n      # Load the SDK asynchronously\r\n      @startedLoading = true\r\n      ((d) ->\r\n        js = undefined\r\n        id = 'facebook-jssdk'\r\n        ref = d.getElementsByTagName('script')[0]\r\n        return  if d.getElementById(id)\r\n        js = d.createElement('script')\r\n        js.id = id\r\n        js.async = true\r\n        js.src = '//connect.facebook.net/en_US/sdk.js'\r\n    \r\n        #js.src = '//connect.facebook.net/en_US/all/debug.js'\r\n        ref.parentNode.insertBefore js, ref\r\n        return\r\n      )(document)\r\n\r\n      window.fbAsyncInit = =>\r\n        FB.init({\r\n          appId: (if document.location.origin is 'http://localhost:3000' then '607435142676437' else '148832601965463') # App ID\r\n          channelUrl: document.location.origin + '/channel.html' # Channel File\r\n          cookie: true # enable cookies to allow the server to access the session\r\n          xfbml: true # parse XFBML\r\n          version: 'v2.8'\r\n        })\r\n        FB.getLoginStatus (response) =>\r\n          if response.status is 'connected'\r\n            @connected = true\r\n            @authResponse = response.authResponse\r\n            @trigger 'connect', { response: response }\r\n          @apiLoaded = true\r\n          @trigger 'load-api'\r\n\r\n\r\n  connect: (options={}) ->\r\n    options.success ?= _.noop\r\n    options.context ?= options\r\n    FB.login ((response) =>\r\n      if response.status is 'connected'\r\n        @connected = true\r\n        @authResponse = response.authResponse\r\n        @trigger 'connect', { response: response }\r\n        options.success.bind(options.context)()\r\n    ), scope: 'email'\r\n\r\n\r\n  loadPerson: (options={}) ->\r\n    options.success ?= _.noop\r\n    options.context ?= options\r\n    FB.api '/me', {fields: 'email,last_name,first_name,gender'}, (person) =>\r\n      attrs = {}\r\n      for fbProp, userProp of userPropsToSave\r\n        value = person[fbProp]\r\n        if value\r\n          attrs[userProp] = value\r\n      @trigger 'load-person', attrs\r\n      options.success.bind(options.context)(attrs)\r\n\r\n  renderButtons: ->\r\n    setTimeout(FB.XFBML.parse, 10) if FB?.XFBML?.parse  # Handles FB login and Like\r\n"]}