{"version":3,"sources":["app/core/social-handlers/GPlusHandler.coffee"],"names":[],"mappings":";AAAA;EAAA;;;AAAA,YAAY,QAAQ,gBAAR;;AACX,KAAM,QAAQ,WAAR,EAAN;;AACA,kBAAmB,QAAQ,aAAR,EAAnB;;AACD,UAAU,QAAQ,cAAR;;AACV,kBAAkB;;AAGlB,kBACE;EAAA,kBAAkB,WAAlB;EACA,mBAAmB,UADnB;EAEA,UAAU,QAFV;EAGA,MAAM,SAHN;;;AAKF,gBAAgB;;AAChB,UAAU,+BAA6B;;AACvC,YAAY;;AACZ,WAAW;;AACX,QAAQ;;AAER,MAAM,CAAC,OAAP,GAAiB,eAAqB;;;EACvB;IACX,IAAC,YAAD,GAAe,OAAO,CAAC,IAAR,CAAa,eAAb,EAA8B,KAA9B;IACf;EAFW;;yBAIb,QAAO;AAAG;iDAAY,CAAE;EAAjB;;yBAEP,iBAAgB;;yBAChB,YAAW;;yBACX,YAAW;;yBACX,SAAQ;;yBAER,UAAS;IACP,MAAM,CAAC,IAAP,GACE;MAAA,QACE;QAAA,MAAM,SAAC,GAAD,EAAM,OAAN,EAAe,EAAf;iBAAsB;QAAtB,CAAN;QACA,MACE;UAAA,QACE;YAAA,KAAK;qBAAG;gBACN,SAAS,SAAC,EAAD;yBACP,GAAG;oBACD,MAAM;sBACJ,WAAW,IADP;sBAEJ,YAAY,MAFR;qBADL;oBAKD,IAAI,MALH;oBAMD,QAAQ;sBAAC;wBAAC,OAAO,gBAAR;uBAAD;qBANP;mBAAH;gBADO,CADH;;YAAH,CAAL;WADF;SAFF;OADF;MAgBA,MACE;QAAA,WAAW,SAAC,IAAD,EAAO,EAAP;iBACT,GAAG;YAAC,cAAc,MAAf;WAAH;QADS,CAAX;OAjBF;;IAoBF,IAAC,eAAD,GAAkB;WAClB,IAAC,UAAD,GAAa;EAvBN;;yBAyBT,cAAa;IACX,IAAC,YAAD,GAAe;MAAC,cAAc,MAAf;;WACf,IAAC,QAAD,CAAS,SAAT;EAFW;;yBAIb,UAAS,SAAC,OAAD;AACP;;MADQ,UAAQ;;;MAChB,OAAO,CAAC,UAAW,CAAC,CAAC;;;MACrB,OAAO,CAAC,UAAW;;IACnB,IAAG,IAAC,UAAJ;MACE,OAAO,CAAC,OAAO,CAAC,IAAhB,CAAqB,OAAO,CAAC,OAA7B,IADF;KAAA;MAGE,IAAC,KAAD,CAAM,UAAN,EAAkB,OAAO,CAAC,OAA1B,EAAmC,OAAO,CAAC,OAA3C,EAHF;;IAKA,IAAG,CAAI,IAAC,eAAR;MACE,KAAK,QAAQ,CAAC,aAAT,CAAuB,QAAvB;MACL,EAAE,CAAC,IAAH,GAAU;MACV,EAAE,CAAC,KAAH,GAAW;MACX,EAAE,CAAC,GAAH,GAAS;MACT,IAAI,QAAQ,CAAC,oBAAT,CAA8B,QAA9B,CAAwC;MAC5C,CAAC,CAAC,UAAU,CAAC,YAAb,CAA0B,EAA1B,EAA8B,CAA9B;MACA,IAAC,eAAD,GAAkB;aAClB,MAAM,CAAC,aAAP,GAAuB;eAAA;AACrB;UAAA,KAAC,UAAD,GAAa;UACb,IAAG,KAAC,YAAD,IAAiB,EAAE,CAAC,GAAH,CAAO,SAAP,CAApB;YAEE,IAAI,CAAC,IAAI,CAAC,QAAV,CAAmB,OAAnB,EAA4B,KAAC,YAA7B;YACA,gBAAgB,KAAC,YAAW,CAAC;mBAC7B,IAAI,CAAC,IAAI,CAAC,iBAAV,CAA4B;cAAC,WAAW,QAAZ;cAAsB,eAAe,aAArC;aAA5B,EAAiF,SAAC,SAAD;cAC/E,KAAC,UAAD,GAAa;qBACb,KAAC,QAAD,CAAS,UAAT;YAF+E,CAAjF,EAJF;WAAA;YAQE,KAAC,UAAD,GAAa;mBACb,KAAC,QAAD,CAAS,UAAT,EATF;;QAFqB;MAAA,SARzB;;EARO;;yBA8BT,UAAS,SAAC,OAAD;AACP;;MADQ,UAAQ;;;MAChB,OAAO,CAAC,UAAW,CAAC,CAAC;;;MACrB,OAAO,CAAC,UAAW;;IACnB,cAAc;MACZ,WAAW,QADC;MAEZ,OAAO,kDAFK;;WAId,IAAI,CAAC,IAAI,CAAC,SAAV,CAAoB,WAApB,EAAiC;aAAA,SAAC,CAAD;AAC/B;QAAA,KAAc,CAAC,CAAC,YAAhB;AAAA;;QACA,KAAC,UAAD,GAAa;AACb;UAEE,IAAI,CAAC,CAAC,IAAF,CAAO,CAAP,EAAU,gBAAV;UACJ,OAAO,CAAC,IAAR,CAAa,eAAb,EAA8B,CAA9B,EAAiC,CAAjC,EAHF;SAAA;UAIM;UACJ,OAAO,CAAC,KAAR,CAAc,6BAAd,EAA6C,CAA7C,EALF;;QAMA,KAAC,YAAD,GAAe;QACf,KAAC,QAAD,CAAS,SAAT;eACA,OAAO,CAAC,OAAO,CAAC,IAAhB,CAAqB,OAAO,CAAC,OAA7B;MAX+B;IAAA,QAAjC;EAPO;;yBAqBT,aAAY,SAAC,OAAD;;MAAC,UAAQ;;;MACnB,OAAO,CAAC,UAAW,CAAC,CAAC;;;MACrB,OAAO,CAAC,UAAW;;WAEnB,IAAI,CAAC,MAAM,CAAC,IAAZ,CAAiB,MAAjB,EAAyB,IAAzB,EAA+B;aAAA;eAC7B,IAAI,CAAC,MAAM,CAAC,IAAI,CAAC,MAAM,CAAC,GAAxB,CAA4B;UAAC,QAAQ,IAAT;SAA5B,CAA2C,CAAC,OAA5C,CAAoD,SAAC,CAAD;AAClD;UAAA,QAAQ;AACR;;YACE,OAAO,MAAM,CAAC,KAAP,CAAa,GAAb;YACP,QAAQ;AACR;;cACE,QAAQ,KAAM;AADhB;YAEA,IAAG,KAAH;cACE,KAAM,UAAN,GAAkB,MADpB;;AALF;UAQA,kCAAW,CAAE,eAAb;YACE,KAAK,CAAC,KAAN,GAAc,CAAC,CAAC,MAAO,GAAE,CAAC,MAD5B;;UAEA,KAAC,QAAD,CAAS,aAAT,EAAwB,KAAxB;iBACA,OAAO,CAAC,OAAO,CAAC,IAAhB,CAAqB,OAAO,CAAC,OAA7B,EAAsC,KAAtC;QAbkD,CAApD;MAD6B;IAAA,QAA/B;EAJU;;yBAqBZ,gBAAe;AACb;IAAA,IAAoB,8EAApB;AAAA,aAAO,MAAP;;gEACY,CAAC;EAFA;;yBAMf,cAAa,SAAC,eAAD;AACX;IAAA,KAAgC,IAAC,SAAjC;AAAA,aAAO,kBAAP;;IACA,YAAe,IAAC,YAAJ,GAAqB,SAAS,IAAC,YAAW,CAAC,UAAtB,IAAwC,UAAM,CAAC,OAAP,EAAJ,GAAqB,IAA9E,GAAwF,CAAC;IACrG,iBAAiB;aAAA;eAAG,IAAI,CAAC,MAAM,CAAC,OAAZ,CAAoB;UAAC,MAAM,mCAAP;UAA4C,UAAU,eAAtD;SAApB;MAAH;IAAA;IACjB,IAAG,YAAY,CAAf;MAEE,IAAC,YAAD;aACA,IAAC,aAAD,CAAc,IAAd,EAAiB,WAAjB,EAA8B,cAA9B,EAHF;KAAA;aAKE,iBALF;;EAJW;;yBAWb,cAAa;AACX;IAAA,SACE;MAAA,aAAc,QAAd;MACA,SAAU,KADV;;WAEF,IAAI,CAAC,IAAI,CAAC,SAAV,CAAoB,MAApB,EAA4B,IAAC,aAA7B;EAJW;;;;GAlI4C","file":"public/javascripts/app/core/social-handlers/GPlusHandler.js","sourcesContent":["CocoClass = require 'core/CocoClass'\r\n{me} = require 'core/auth'\r\n{backboneFailure} = require 'core/errors'\r\nstorage = require 'core/storage'\r\nGPLUS_TOKEN_KEY = 'gplusToken'\r\n\r\n# gplus user object props to\r\nuserPropsToSave =\r\n  'name.givenName': 'firstName'\r\n  'name.familyName': 'lastName'\r\n  'gender': 'gender'\r\n  'id': 'gplusID'\r\n\r\nfieldsToFetch = 'displayName,gender,image,name(familyName,givenName),id'\r\nplusURL = '/plus/v1/people/me?fields='+fieldsToFetch\r\nrevokeUrl = 'https://accounts.google.com/o/oauth2/revoke?token='\r\nclientID = '800329290710-j9sivplv2gpcdgkrsis9rff3o417mlfa.apps.googleusercontent.com'\r\nscope = 'https://www.googleapis.com/auth/plus.login email'\r\n\r\nmodule.exports = GPlusHandler = class GPlusHandler extends CocoClass\r\n  constructor: ->\r\n    @accessToken = storage.load GPLUS_TOKEN_KEY, false\r\n    super()\r\n\r\n  token: -> @accessToken?.access_token\r\n    \r\n  startedLoading: false\r\n  apiLoaded: false\r\n  connected: false\r\n  person: null\r\n\r\n  fakeAPI: ->\r\n    window.gapi =\r\n      client:\r\n        load: (api, version, cb) -> cb()\r\n        plus:\r\n          people:\r\n            get: -> {\r\n              execute: (cb) ->\r\n                cb({\r\n                  name: {\r\n                    givenName: 'Mr'\r\n                    familyName: 'Bean'\r\n                  }\r\n                  id: 'abcd'\r\n                  emails: [{value: 'some@email.com'}]\r\n                })\r\n            }\r\n              \r\n      auth:\r\n        authorize: (opts, cb) ->\r\n          cb({access_token: '1234'})\r\n          \r\n    @startedLoading = true\r\n    @apiLoaded = true\r\n    \r\n  fakeConnect: ->\r\n    @accessToken = {access_token: '1234'}\r\n    @trigger 'connect'\r\n\r\n  loadAPI: (options={}) ->\r\n    options.success ?= _.noop\r\n    options.context ?= options\r\n    if @apiLoaded\r\n      options.success.bind(options.context)()\r\n    else\r\n      @once 'load-api', options.success, options.context\r\n    \r\n    if not @startedLoading\r\n      po = document.createElement('script')\r\n      po.type = 'text/javascript'\r\n      po.async = true\r\n      po.src = 'https://apis.google.com/js/client:platform.js?onload=onGPlusLoaded'\r\n      s = document.getElementsByTagName('script')[0]\r\n      s.parentNode.insertBefore po, s\r\n      @startedLoading = true\r\n      window.onGPlusLoaded = =>\r\n        @apiLoaded = true\r\n        if @accessToken and me.get('gplusID')\r\n          # We need to check the current state, given our access token\r\n          gapi.auth.setToken 'token', @accessToken\r\n          session_state = @accessToken.session_state\r\n          gapi.auth.checkSessionState {client_id: clientID, session_state: session_state}, (connected) =>\r\n            @connected = connected\r\n            @trigger 'load-api'\r\n        else\r\n          @connected = false\r\n          @trigger 'load-api'\r\n    \r\n\r\n  connect: (options={}) ->\r\n    options.success ?= _.noop\r\n    options.context ?= options\r\n    authOptions = {\r\n      client_id: clientID\r\n      scope: 'https://www.googleapis.com/auth/plus.login email'\r\n    }\r\n    gapi.auth.authorize authOptions, (e) =>\r\n      return unless e.access_token\r\n      @connected = true\r\n      try\r\n      # Without removing this, we sometimes get a cross-domain error\r\n        d = _.omit(e, 'g-oauth-window')\r\n        storage.save(GPLUS_TOKEN_KEY, d, 0)\r\n      catch e\r\n        console.error 'Unable to save G+ token key', e\r\n      @accessToken = e\r\n      @trigger 'connect'\r\n      options.success.bind(options.context)()\r\n      \r\n\r\n  loadPerson: (options={}) ->\r\n    options.success ?= _.noop\r\n    options.context ?= options\r\n    # email and profile data loaded separately\r\n    gapi.client.load 'plus', 'v1', =>\r\n      gapi.client.plus.people.get({userId: 'me'}).execute (r) =>\r\n        attrs = {}\r\n        for gpProp, userProp of userPropsToSave\r\n          keys = gpProp.split('.')\r\n          value = r\r\n          for key in keys\r\n            value = value[key]\r\n          if value\r\n            attrs[userProp] = value\r\n    \r\n        if r.emails?.length\r\n          attrs.email = r.emails[0].value\r\n        @trigger 'load-person', attrs\r\n        options.success.bind(options.context)(attrs)\r\n\r\n\r\n  renderButtons: ->\r\n    return false unless gapi?.plusone?\r\n    gapi.plusone.go?()  # Handles +1 button\r\n  \r\n  # Friends logic, not in use\r\n    \r\n  loadFriends: (friendsCallback) ->\r\n    return friendsCallback() unless @loggedIn\r\n    expiresIn = if @accessToken then parseInt(@accessToken.expires_at) - new Date().getTime()/1000 else -1\r\n    onReauthorized = => gapi.client.request({path: '/plus/v1/people/me/people/visible', callback: friendsCallback})\r\n    if expiresIn < 0\r\n      # TODO: this tries to open a popup window, which might not ever finish or work, so the callback may never be called.\r\n      @reauthorize()\r\n      @listenToOnce(@, 'logged-in', onReauthorized)\r\n    else\r\n      onReauthorized()\r\n\r\n  reauthorize: ->\r\n    params =\r\n      'client_id' : clientID\r\n      'scope' : scope\r\n    gapi.auth.authorize params, @onGPlusLogin\r\n"]}