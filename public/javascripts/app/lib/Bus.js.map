{"version":3,"sources":["app/lib/Bus.coffee"],"names":[],"mappings":"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","file":"public/javascripts/app/lib/Bus.js","sourcesContent":["CocoClass = require 'core/CocoClass'\r\n\r\n{me} = require 'core/auth'\r\n\r\nCHAT_SIZE_LIMIT = 500 # no more than 500 messages\r\n\r\nmodule.exports = Bus = class Bus extends CocoClass\r\n  joined: null\r\n  players: null\r\n\r\n  @get: (docName) -> return @getFromCache or new Bus docName\r\n  @getFromCache: (docName) -> return Bus.activeBuses[docName]\r\n  @activeBuses: {}\r\n  @fireHost: 'https://codecombat.firebaseio.com'\r\n\r\n  constructor: (@docName) ->\r\n    super()\r\n    @players = {}\r\n    Bus.activeBuses[@docName] = @\r\n\r\n  subscriptions:\r\n    'auth:me-synced': 'onMeSynced'\r\n\r\n  connect: ->\r\n    # Put Firebase back in bower if you want to use this\r\n    Backbone.Mediator.publish 'bus:connecting', {bus: @}\r\n    Firebase.goOnline()\r\n    @fireRef = new Firebase(Bus.fireHost + '/' + @docName)\r\n    @fireRef.once 'value', @onFireOpen\r\n\r\n  onFireOpen: (snapshot) =>\r\n    if @destroyed\r\n      console.log(\"Leaving '#{@docName}' because class has been destroyed.\")\r\n      return\r\n    @init()\r\n    Backbone.Mediator.publish 'bus:connected', {bus: @}\r\n\r\n  disconnect: ->\r\n    @fireRef?.off()\r\n    @fireRef = null\r\n    @fireChatRef?.off()\r\n    @fireChatRef = null\r\n    @firePlayersRef?.off()\r\n    @firePlayersRef = null\r\n    @myConnection?.off()\r\n    @myConnection = null\r\n    @joined = false\r\n    Backbone.Mediator.publish 'bus:disconnected', {bus: @}\r\n\r\n  init: ->\r\n    \"\"\"\r\n    Init happens when we're connected.\r\n    \"\"\"\r\n    @fireChatRef = @fireRef.child('chat')\r\n    @firePlayersRef = @fireRef.child('players')\r\n    @join()\r\n    @listenForChanges()\r\n    @sendMessage('/me joined.', true)\r\n\r\n  join: ->\r\n    @joined = true\r\n    @myConnection = @firePlayersRef.child(me.id)\r\n    @myConnection.set({id: me.id, name: me.get('name'), connected: true})\r\n    @onDisconnect = @myConnection.child('connected').onDisconnect()\r\n    @onDisconnect.set(false)\r\n\r\n  listenForChanges: ->\r\n    @fireChatRef.limit(CHAT_SIZE_LIMIT).on 'child_added', @onChatAdded\r\n    @firePlayersRef.on 'child_added', @onPlayerJoined\r\n    @firePlayersRef.on 'child_removed', @onPlayerLeft\r\n    @firePlayersRef.on 'child_changed', @onPlayerChanged\r\n\r\n  onChatAdded: (snapshot) =>\r\n    Backbone.Mediator.publish('bus:new-message', {message: snapshot.val(), bus: @})\r\n\r\n  onPlayerJoined: (snapshot) =>\r\n    player = snapshot.val()\r\n    return unless player.connected\r\n    @players[player.id] = player\r\n    Backbone.Mediator.publish('bus:player-joined', {player: player, bus: @})\r\n\r\n  onPlayerLeft: (snapshot) =>\r\n    val = snapshot.val()\r\n    return unless val\r\n    player = @players[val.id]\r\n    return unless player\r\n    delete @players[player.id]\r\n    Backbone.Mediator.publish('bus:player-left', {player: player, bus: @})\r\n\r\n  onPlayerChanged: (snapshot) =>\r\n    player = snapshot.val()\r\n    wasConnected = @players[player.id]?.connected\r\n    @players[player.id] = player\r\n    @onPlayerLeft(snapshot) if wasConnected and not player.connected\r\n    @onPlayerJoined(snapshot) if player.connected and not wasConnected\r\n    Backbone.Mediator.publish('bus:player-states-changed', {states: @players, bus: @})\r\n\r\n  onMeSynced: ->\r\n    @myConnection?.child('name').set(me.get('name'))\r\n\r\n  countPlayers: -> _.size(@players)\r\n\r\n  onPoint: ->\r\n    # simple way to elect somone to do jobs that don't need to be done by each player\r\n    ids = _.keys(@players)\r\n    ids.sort()\r\n    return ids[0] is me.id\r\n\r\n  # MESSAGING\r\n\r\n  sendSystemMessage: (content) ->\r\n    @sendMessage(content, true)\r\n\r\n  sendMessage: (content, system=false) ->\r\n    MAX_MESSAGE_LENGTH = 400\r\n    message =\r\n      content: content[... MAX_MESSAGE_LENGTH]\r\n      authorName: me.displayName()\r\n      authorID: me.id\r\n      dateMade: new Date()\r\n    message.system = system if system\r\n    @fireChatRef.push(message)\r\n\r\n  # TEARDOWN\r\n\r\n  destroy: ->\r\n    @sendMessage('/me left.', true) if @joined\r\n    delete Bus.activeBuses[@docName] if @docName of Bus.activeBuses\r\n    @disconnect()\r\n    super()\r\n"]}