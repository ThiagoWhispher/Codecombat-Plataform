{"version":3,"sources":["app/lib/LevelSetupManager.coffee"],"names":[],"mappings":";AAAA;EAAA;;;AAAA,YAAY,QAAQ,gBAAR;;AACZ,kBAAkB,QAAQ,kCAAR;;AAClB,iBAAiB,QAAQ,gCAAR;;AACjB,QAAQ,QAAQ,cAAR;;AACR,eAAe,QAAQ,qBAAR;;AACf,aAAa,QAAQ,mBAAR;;AACb,YAAY,QAAQ,kBAAR;;AAEZ,oGAA8C;;AAC9C,4GAAoD;;AAEpD,MAAM,CAAC,OAAP,GAAuB;;;EAER,2BAAC,OAAD;AACX;IADY,IAAC,WAAD;IACZ;IACA,IAAC,WAAD,qDAAwC;IACxC,IAAC,QAAD,GAAW,IAAC,QAAO,CAAC;IACpB,KAAO,KAAC,MAAD,GAAS,IAAC,QAAO,CAAC,KAAlB,CAAP;MACE,IAAC,UAAD,GADF;;IAEA,IAAG,IAAC,QAAJ;MACE,IAAC,wBAAD,GADF;KAAA;MAGE,IAAC,YAAD,GAHF;;EANW;;8BAWb,YAAW;AACT;IAAA,WAAW,eAAa,IAAC,QAAO,CAAC;IACjC,IAAC,MAAD,GAAa,WAAO,CAAC,MAAR,CAAe,QAAf;IACb,IAAC,MAAD,GAAS,IAAC,WAAU,CAAC,SAAZ,CAAsB,IAAC,MAAvB,CAA6B,CAAC;IACvC,IAAG,IAAC,MAAK,CAAC,MAAV;aAAsB,IAAC,YAAD,GAAtB;KAAA;aAA0C,IAAC,aAAD,CAAc,IAAC,MAAf,EAAsB,MAAtB,EAA8B,IAAC,YAA/B,EAA1C;;EAJS;;8BAMX,cAAa;AACX;IAAA,aAAa,eAAa,IAAC,QAAO,CAAC,OAAtB,GAA8B;IAE3C,IAAgD,IAAC,QAAO,CAAC,QAAzD;MAAA,cAAc,aAAW,IAAC,QAAO,CAAC,SAAlC;;IACA,IAAC,QAAD,GAAe,kBAAc,CAAC,MAAf,CAAsB,UAAtB;IACf,IAAC,QAAD,GAAW,IAAC,WAAU,CAAC,SAAZ,CAAsB,IAAC,QAAvB,CAA+B,CAAC;IAC3C,IAAG,IAAC,QAAO,CAAC,MAAZ;aAAwB,IAAC,cAAD,GAAxB;KAAA;aAA8C,IAAC,aAAD,CAAc,IAAC,QAAf,EAAwB,MAAxB,EAAgC,IAAC,cAAjC,EAA9C;;EANW;;8BAQb,cAAa;IACX,IAAU,IAAC,UAAX;AAAA;;IACA,IAAG,IAAC,oBAAJ;MACE,IAAC,oBAAD,GAAuB;aACvB,IAAC,WAAD,GAFF;;EAFW;;8BAMb,gBAAe;IACb,IAAU,IAAC,UAAX;AAAA;;IACA,IAAC,QAAO,CAAC,GAAT,GAAe;aAAG,uBAAuB,IAAC;IAA3B;WACf,IAAC,wBAAD;EAHa;;8BAKf,0BAAyB;AACvB;IAAA,aAAa,CAAC,CAAC,KAAF,CAAQ,EAAR,EAAY,EAAE,CAAC,GAAH,CAAO,YAAP,CAAZ,EAAkC,IAAC,QAAO,CAAC,GAAT,CAAa,YAAb,CAAlC;IACb,IAAC,QAAO,CAAC,GAAT,CAAa,YAAb,EAA2B,UAA3B;IACA,IAAG,IAAC,MAAK,CAAC,MAAV;aACE,IAAC,WAAD,GADF;KAAA;aAGE,IAAC,oBAAD,GAAuB,KAHzB;;EAHuB;;8BAQzB,aAAY;AAEV;IAAA,IAAG,IAAC,MAAK,CAAC,GAAP,CAAW,MAAX,MAAsB,UAAzB;MACE,WAAW;MACX,IAAG,IAAC,QAAO,CAAC,GAAT,CAAa,SAAb,MAA2B,0BAA9B;QACE,WAAW,2BADb;;MAEA,IAAC,QAAO,CAAC,GAAT,CAAa,YAAb,EAA2B;QAAC,aAAY,QAAb;QAAsB,aAAY;UAAC,UAAS,0BAAV;UAAqC,oBAAmB,0BAAxD;UAAmF,UAAS,0BAA5F;UAAuH,QAAO,0BAA9H;UAAyJ,cAAa,0BAAtK;UAAiM,aAAY,0BAA7M;UAAwO,UAAS,0BAAjP;UAA4Q,UAAS,0BAArR;UAAgT,SAAQ,0BAAxT;UAAmV,QAAO,0BAA1V;UAAqX,QAAO,0BAA5X;UAAuZ,QAAO,0BAA9Z;SAAlC;OAA3B;MACA,IAAC,4BAAD;AACA,aANF;;IAQA,IAAG,IAAC,MAAK,CAAC,GAAP,CAAW,MAAX,MAAsB,iBAAzB;MACE,cAAc;MACd,IAAC,QAAO,CAAC,GAAT,CAAa,YAAb,EAA2B;QAAC,aAAY,WAAb;QAAyB,aAAY;UAC9D,QAAO,0BADuD;UAE9D,QAAO,0BAFuD;UAG9D,QAAO,0BAHuD;UAI9D,SAAQ,0BAJsD;UAK9D,cAAa,0BALiD;UAM9D,oBAAmB,0BAN2C;SAArC;OAA3B;MAQA,IAAC,4BAAD;AACA,aAXF;;IAYA,IAAG,IAAC,MAAK,CAAC,GAAP,CAAW,MAAX,MAAsB,qBAAzB;MACE,cAAc;MACd,IAAC,QAAO,CAAC,GAAT,CAAa,YAAb,EAA2B;QAAC,aAAY,WAAb;QAAyB,aAAY;UAC9D,QAAQ,0BADsD;UAE9D,QAAQ,0BAFsD;UAG9D,SAAS,0BAHqD;UAI9D,cAAc,0BAJgD;UAK9D,UAAU,0BALoD;UAM9D,QAAQ,0BANsD;UAO9D,oBAAoB,0BAP0C;UAQ9D,aAAa,0BARiD;SAArC;OAA3B;MAUA,IAAC,4BAAD;AACA,aAbF;;IAcA,IAAG,IAAC,MAAK,CAAC,GAAP,CAAW,MAAX,MAAsB,eAAzB;MACE,cAAc;MACd,IAAC,QAAO,CAAC,GAAT,CAAa,YAAb,EAA2B;QAAC,aAAY,WAAb;QAAyB,aAAY;UAC9D,UAAU,0BADoD;UAE9D,QAAQ,0BAFsD;UAG9D,QAAQ,0BAHsD;UAI9D,aAAa,0BAJiD;UAK9D,cAAc,0BALgD;UAM9D,SAAS,0BANqD;UAO9D,oBAAoB,0BAP0C;UAQ9D,UAAU,0BARoD;UAS9D,QAAQ,0BATsD;UAU9D,SAAS,0BAVqD;UAW9D,QAAQ,0BAXsD;SAArC;OAA3B;MAcA,IAAC,4BAAD;AACA,aAjBF;;IAmBA,YAAG,IAAC,MAAK,CAAC,GAAP,CAAW,MAAX,OAAuB,eAAvB,aAAwC,gBAA3C;MACE,UAAU;MACV,IAAC,QAAO,CAAC,GAAT,CAAa,YAAb,EAA2B;QAAC,aAAY,OAAb;QAAqB,aAAY;UAAC,QAAO,0BAAR;UAAmC,QAAO,0BAA1C;UAAqE,UAAS,0BAA9E;UAAyG,QAAO,0BAAhH;UAA2I,UAAS,0BAApJ;UAA+K,oBAAmB,0BAAlM;SAAjC;OAA3B;MACA,IAAC,4BAAD;AACA,aAJF;;IAKA,IAAG,IAAC,MAAK,CAAC,GAAP,CAAW,MAAX,MAAsB,wBAAzB;MACE,SAAS;MACT,IAAC,QAAO,CAAC,GAAT,CAAa,YAAb,EAA2B;QACzB,aAAa,MADY;QAEzB,aAAY;UACV,QAAQ,0BADE;UAEV,QAAQ,0BAFE;UAGV,SAAS,0BAHC;UAIV,QAAQ,0BAJE;UAKV,UAAU,0BALA;UAMV,QAAQ,0BANE;UAOV,UAAU,0BAPA;UAQV,oBAAoB,0BARV;UASV,aAAa,0BATH;SAFa;OAA3B;MAcA,IAAC,4BAAD;AACA,aAjBF;;IAkBA,IAAG,IAAC,MAAK,CAAC,GAAP,CAAW,MAAX,MAAsB,gBAAzB;MACE,SAAS;MACT,IAAC,QAAO,CAAC,GAAT,CAAa,YAAb,EAA2B;QAAC,aAAY,MAAb;QAAoB,aAAY,EAAhC;OAA3B;MACA,IAAC,4BAAD;AACA,aAJF;;IAKA,IAAG,IAAC,MAAK,CAAC,MAAP,CAAc,QAAd,EAAwB,eAAxB,EAAyC,UAAzC,EAAqD,SAArD,KAAmE,MAAM,CAAC,YAAY,CAAC,OAA1F;MACE,IAAC,4BAAD;AACA,aAFF;;IAGA,IAAC,YAAD,GAAmB,oBAAgB;MAAC,YAAY,IAAC,WAAd;MAA0B,SAAS,IAAC,QAApC;MAA6C,mBAAmB,WAAhE;MAA6E,OAAO,IAAC,MAArF;MAA4F,mBAAmB,IAAC,QAAO,CAAC,iBAAxH;KAAhB;IACnB,IAAC,eAAD,GAAsB,mBAAe;MAAC,YAAY,IAAC,WAAd;MAA0B,SAAS,IAAC,QAApC;MAA6C,OAAO,IAAC,MAArD;KAAf;IACtB,IAAC,mBAAD,GAAsB,IAAC,YAAW,CAAC;IACnC,IAAC,sBAAD,GAAyB,IAAC,eAAc,CAAC;IACzC,IAAC,YAAW,CAAC,OAAb,GAAuB,IAAC,eAAc,CAAC,OAAhB,GAA0B,CAAC,CAAC;IACnD,IAAC,SAAD,CAAU,IAAC,YAAX,EAAwB,eAAxB,EAAyC,IAAC,4BAA1C;IACA,IAAC,aAAD,CAAc,IAAC,YAAf,EAA4B,aAA5B,EAA2C,IAAC,eAA5C;IACA,IAAC,SAAD,CAAU,IAAC,eAAX,EAA2B,mBAA3B,EAAgD,IAAC,oBAAjD;IACA,IAAC,SAAD,CAAU,IAAC,eAAX,EAA2B,YAA3B,EAAyC,IAAC,4BAA1C;IACA,IAAC,aAAD,GAAgB;IAChB,IAAG,IAAC,cAAJ;MACE,IAAC,cAAD,GAAiB;aACjB,IAAC,KAAD,GAFF;;EAhGU;;8BAoGZ,OAAM;AACJ;IAAA,KAAoC,IAAC,aAArC;AAAA,aAAO,IAAC,cAAD,GAAiB,KAAxB;;IACA,aAAgB,IAAC,QAAO,CAAC,iBAAZ,GAAmC,IAAC,eAApC,GAAwD,IAAC;IACtE,IAAI,CAAI,CAAC,CAAC,OAAF,CAAU,gBAAV,qFAAuD,EAAvD,CAAJ,IACA,CAAI,CAAC,CAAC,OAAF,CAAU,mBAAV,wFAA6D,EAA7D,CADR;MAEE,OAAO,CAAC,GAAR,CAAY,kEAAZ;MACA,aAAa,IAAC,aAHhB;KAAA,MAIK,IAAG,mBAAmB,IAAC,MAAK,CAAC,GAAP,CAAW,eAAX,CAAtB;MACH,KAAO,CAAC,CAAC,IAAF,CAAO,gBAAP,EAAyB,SAAC,IAAD;AAAU;eAAA,SAAS,CAAC,MAAO,MAAjB,kDAA8C,CAAE;MAA1D,CAAzB,CAAP;QACE,aAAa,IAAC,aADhB;OADG;;IAGL,sGAA8C;IAC9C,gHAAoD;IAEpD,IAAC,QAAO,CAAC,MAAM,CAAC,aAAhB,CAA8B,UAA9B;WACA,IAAC,QAAD,CAAS,MAAT;EAdI;;8BAmBN,iBAAgB,SAAC,CAAD;IACd,IAAmC,MAAM,CAAC,YAAP,KAAuB,IAAC,eAA3D;aAAA,IAAC,eAAc,CAAC,OAAhB,CAAwB,CAAC,CAAC,IAA1B;;EADc;;8BAGhB,8BAA6B,SAAC,CAAD;AAC3B;IAAA,IAAC,QAAO,CAAC,MAAM,CAAC,aAAhB,CAA8B,IAAC,eAA/B;IACA,IAAC,eAAc,CAAC,MAAhB;IACA,IAAC,eAAc,CAAC,WAAhB;IACA,IAAC,eAAc,CAAC,OAAhB;IACA,IAAmC,CAAC,CAAC,IAArC;MAAA,IAAC,eAAc,CAAC,OAAhB,CAAwB,CAAC,CAAC,IAA1B;;iDACc,CAAE,UAAhB,CAA2B,kBAA3B,EAA+C;MAAA,UAAU,YAAV;KAA/C;EAN2B;;8BAQ7B,sBAAqB;AACnB;IAAA,IAAC,QAAO,CAAC,MAAM,CAAC,aAAhB,CAA8B,IAAC,YAA/B;IACA,IAAC,YAAW,CAAC,MAAb;IACA,IAAC,YAAW,CAAC,WAAb;IACA,IAAC,eAAc,CAAC,YAAhB;iDACc,CAAE,UAAhB,CAA2B,aAA3B,EAA0C;MAAA,UAAU,YAAV;KAA1C;EALmB;;8BAOrB,8BAA6B;AAC3B;IAAA,IAAC,iBAAD,GAAoB;IACpB,gBAAgB;IAChB,aAAa;IACb,YAAe,IAAC,QAAO,CAAC,SAAT,KAAsB,QAAzB,GAAuC,UAAvC,GAAuD;IACnE,QAAQ,WAAQ,CAAC,IAAC,QAAO,CAAC,SAAT,IAAsB,OAAvB,CAAR,GAAuC,GAAvC,GAA0C,IAAC,QAAO,CAAC;IAC3D,IAA4D,IAAC,MAAK,CAAC,GAAP,CAAW,gBAAX,CAA5D;MAAA,SAAS,mBAAmB,IAAC,MAAK,CAAC,GAAP,CAAW,gBAAX,EAA5B;;WACA,QAAQ,CAAC,QAAQ,CAAC,OAAlB,CAA0B,iBAA1B,EAA6C;MAC3C,YAD2C;MACpC,oBADoC;MAE3C,UAAU;QAAC;UAAC,YAAY,IAAC,WAAd;SAAD,EAA4B,IAAC,QAAO,CAAC,OAArC;OAFiC;KAA7C;EAP2B;;8BAY7B,UAAS;AACP;IAAA,8CAA0D,CAAE,mBAA5D;;YAAmB,CAAE,IAArB,CAA0B,IAAC,YAA3B;OAAA;;IACA,iDAAmE,CAAE,mBAArE;;YAAsB,CAAE,IAAxB,CAA6B,IAAC,eAA9B;OAAA;;WACA;EAHO;;;;GAnMsC","file":"public/javascripts/app/lib/LevelSetupManager.js","sourcesContent":["CocoClass = require 'core/CocoClass'\r\nPlayHeroesModal = require 'views/play/modal/PlayHeroesModal'\r\nInventoryModal = require 'views/play/menu/InventoryModal'\r\nLevel = require 'models/Level'\r\nLevelSession = require 'models/LevelSession'\r\nSuperModel = require 'models/SuperModel'\r\nThangType = require 'models/ThangType'\r\n\r\nlastHeroesEarned = me.get('earned')?.heroes ? []\r\nlastHeroesPurchased = me.get('purchased')?.heroes ? []\r\n\r\nmodule.exports = class LevelSetupManager extends CocoClass\r\n\r\n  constructor: (@options) ->\r\n    super()\r\n    @supermodel = @options.supermodel ? new SuperModel()\r\n    @session = @options.session\r\n    unless @level = @options.level\r\n      @loadLevel()\r\n    if @session\r\n      @fillSessionWithDefaults()\r\n    else\r\n      @loadSession()\r\n\r\n  loadLevel: ->\r\n    levelURL = \"/db/level/#{@options.levelID}\"\r\n    @level = new Level().setURL levelURL\r\n    @level = @supermodel.loadModel(@level).model\r\n    if @level.loaded then @onLevelSync() else @listenToOnce @level, 'sync', @onLevelSync\r\n\r\n  loadSession: ->\r\n    sessionURL = \"/db/level/#{@options.levelID}/session\"\r\n    #sessionURL += \"?team=#{@team}\" if @options.team  # TODO: figure out how to get the teams for multiplayer PVP hero style\r\n    sessionURL += \"?course=#{@options.courseID}\" if @options.courseID\r\n    @session = new LevelSession().setURL sessionURL\r\n    @session = @supermodel.loadModel(@session).model\r\n    if @session.loaded then @onSessionSync() else @listenToOnce @session, 'sync', @onSessionSync\r\n\r\n  onLevelSync: ->\r\n    return if @destroyed\r\n    if @waitingToLoadModals\r\n      @waitingToLoadModals = false\r\n      @loadModals()\r\n\r\n  onSessionSync: ->\r\n    return if @destroyed\r\n    @session.url = -> '/db/level.session/' + @id\r\n    @fillSessionWithDefaults()\r\n\r\n  fillSessionWithDefaults: ->\r\n    heroConfig = _.merge {}, me.get('heroConfig'), @session.get('heroConfig')\r\n    @session.set('heroConfig', heroConfig)\r\n    if @level.loaded\r\n      @loadModals()\r\n    else\r\n      @waitingToLoadModals = true\r\n\r\n  loadModals: ->\r\n    # build modals and prevent them from disappearing.\r\n    if @level.get('slug') is 'zero-sum'\r\n      sorcerer = '52fd1524c7e6cf99160e7bc9'\r\n      if @session.get('creator') is '532dbc73a622924444b68ed9'  # Wizard Dude gets his own avatar\r\n        sorcerer = '53e126a4e06b897606d38bef'\r\n      @session.set 'heroConfig', {\"thangType\":sorcerer,\"inventory\":{\"misc-0\":\"53e2396a53457600003e3f0f\",\"programming-book\":\"546e266e9df4a17d0d449be5\",\"minion\":\"54eb5dbc49fa2d5c905ddf56\",\"feet\":\"53e214f153457600003e3eab\",\"right-hand\":\"54eab7f52b7506e891ca7202\",\"left-hand\":\"5463758f3839c6e02811d30f\",\"wrists\":\"54693797a2b1f53ce79443e9\",\"gloves\":\"5469425ca2b1f53ce7944421\",\"torso\":\"546d4a549df4a17d0d449a97\",\"neck\":\"54693274a2b1f53ce79443c9\",\"eyes\":\"546941fda2b1f53ce794441d\",\"head\":\"546d4ca19df4a17d0d449abf\"}}\r\n      @onInventoryModalPlayClicked()\r\n      return\r\n    # TODO: Remove post-KR\r\n    if @level.get('slug') is 'the-gauntlet-kr'\r\n      lightseeker = '583d2cca6ffa3e65d170f29f'\r\n      @session.set 'heroConfig', {\"thangType\":lightseeker,\"inventory\":{\r\n        \"feet\":\"53e237bf53457600003e3f05\",\r\n        \"head\":\"546d38269df4a17d0d4499ff\",\r\n        \"eyes\":\"53e238df53457600003e3f0b\",\r\n        \"torso\":\"53e22eac53457600003e3efc\",\r\n        \"right-hand\":\"53e218d853457600003e3ebe\",\r\n        \"programming-book\":\"53e4108204c00d4607a89f78\"\r\n      }}\r\n      @onInventoryModalPlayClicked()\r\n      return\r\n    if @level.get('slug') is 'woodland-cleaver-kr'\r\n      lightseeker = '583d2cca6ffa3e65d170f29f'\r\n      @session.set 'heroConfig', {\"thangType\":lightseeker,\"inventory\":{\r\n        \"eyes\": \"53e238df53457600003e3f0b\",\r\n        \"head\": \"546d38269df4a17d0d4499ff\",\r\n        \"torso\": \"545d3f0b2d03e700001b5a5d\",\r\n        \"right-hand\": \"544d7d1f8494308424f564a3\",\r\n        \"wrists\": \"53e2396a53457600003e3f0f\",\r\n        \"feet\": \"53e2384453457600003e3f07\",\r\n        \"programming-book\": \"546e25d99df4a17d0d449be1\",\r\n        \"left-hand\": \"544c310ae0017993fce214bf\"\r\n      }}\r\n      @onInventoryModalPlayClicked()\r\n      return\r\n    if @level.get('slug') is 'crossroads-kr'\r\n      lightseeker = '583d2cca6ffa3e65d170f29f'\r\n      @session.set 'heroConfig', {\"thangType\":lightseeker,\"inventory\":{\r\n        \"wrists\": \"53e2396a53457600003e3f0f\",\r\n        \"eyes\": \"53e2167653457600003e3eb3\",\r\n        \"feet\": \"546d4d589df4a17d0d449ac9\",\r\n        \"left-hand\": \"544d7bb88494308424f56493\",\r\n        \"right-hand\": \"54694ba3a2b1f53ce794444d\",\r\n        \"waist\": \"5437002a7beba4a82024a97d\",\r\n        \"programming-book\": \"546e25d99df4a17d0d449be1\",\r\n        \"gloves\": \"5469425ca2b1f53ce7944421\",\r\n        \"head\": \"546d390b9df4a17d0d449a0b\",\r\n        \"torso\": \"546aaf1b3777d6186329285e\",\r\n        \"neck\": \"54693140a2b1f53ce79443bc\"\r\n        }\r\n      }\r\n      @onInventoryModalPlayClicked()\r\n      return\r\n\r\n    if @level.get('slug') in ['ace-of-coders', 'elemental-wars']\r\n      goliath = '55e1a6e876cb0948c96af9f8'\r\n      @session.set 'heroConfig', {\"thangType\":goliath,\"inventory\":{\"eyes\":\"53eb99f41a100989a40ce46e\",\"neck\":\"54693274a2b1f53ce79443c9\",\"wrists\":\"54693797a2b1f53ce79443e9\",\"feet\":\"546d4d8e9df4a17d0d449acd\",\"minion\":\"54eb5bf649fa2d5c905ddf4a\",\"programming-book\":\"557871261ff17fef5abee3ee\"}}\r\n      @onInventoryModalPlayClicked()\r\n      return\r\n    if @level.get('slug') is 'the-battle-of-sky-span'\r\n      wizard = '52fc1460b2b91c0d5a7b6af3'\r\n      @session.set 'heroConfig', {\r\n        \"thangType\": wizard\r\n        \"inventory\":{\r\n          \"eyes\": \"546941fda2b1f53ce794441d\",\r\n          \"feet\": \"546d4d8e9df4a17d0d449acd\",\r\n          \"torso\": \"546d4a549df4a17d0d449a97\",\r\n          \"head\": \"546d4ca19df4a17d0d449abf\",\r\n          \"minion\": \"54eb5d1649fa2d5c905ddf52\",\r\n          \"neck\": \"54693240a2b1f53ce79443c5\",\r\n          \"wrists\": \"54693830a2b1f53ce79443f1\",\r\n          \"programming-book\": \"557871261ff17fef5abee3ee\",\r\n          \"left-ring\": \"54692d2aa2b1f53ce794438f\"\r\n        }\r\n      }\r\n      @onInventoryModalPlayClicked()\r\n      return\r\n    if @level.get('slug') is 'assembly-speed'\r\n      raider = '55527eb0b8abf4ba1fe9a107'\r\n      @session.set 'heroConfig', {\"thangType\":raider,\"inventory\":{}}\r\n      @onInventoryModalPlayClicked()\r\n      return\r\n    if @level.isType('course', 'course-ladder', 'game-dev', 'web-dev') or window.serverConfig.picoCTF\r\n      @onInventoryModalPlayClicked()\r\n      return\r\n    @heroesModal = new PlayHeroesModal({supermodel: @supermodel, session: @session, confirmButtonI18N: 'play.next', level: @level, hadEverChosenHero: @options.hadEverChosenHero})\r\n    @inventoryModal = new InventoryModal({supermodel: @supermodel, session: @session, level: @level})\r\n    @heroesModalDestroy = @heroesModal.destroy\r\n    @inventoryModalDestroy = @inventoryModal.destroy\r\n    @heroesModal.destroy = @inventoryModal.destroy = _.noop\r\n    @listenTo @heroesModal, 'confirm-click', @onHeroesModalConfirmClicked\r\n    @listenToOnce @heroesModal, 'hero-loaded', @onceHeroLoaded\r\n    @listenTo @inventoryModal, 'choose-hero-click', @onChooseHeroClicked\r\n    @listenTo @inventoryModal, 'play-click', @onInventoryModalPlayClicked\r\n    @modalsLoaded = true\r\n    if @waitingToOpen\r\n      @waitingToOpen = false\r\n      @open()\r\n\r\n  open: ->\r\n    return @waitingToOpen = true unless @modalsLoaded\r\n    firstModal = if @options.hadEverChosenHero then @inventoryModal else @heroesModal\r\n    if (not _.isEqual(lastHeroesEarned, me.get('earned')?.heroes ? []) or\r\n        not _.isEqual(lastHeroesPurchased, me.get('purchased')?.heroes ? []))\r\n      console.log 'Showing hero picker because heroes earned/purchased has changed.'\r\n      firstModal = @heroesModal\r\n    else if allowedHeroSlugs = @level.get 'allowedHeroes'\r\n      unless _.find(allowedHeroSlugs, (slug) -> ThangType.heroes[slug] is me.get('heroConfig')?.thangType)\r\n        firstModal = @heroesModal\r\n    lastHeroesEarned = me.get('earned')?.heroes ? []\r\n    lastHeroesPurchased = me.get('purchased')?.heroes ? []\r\n\r\n    @options.parent.openModalView(firstModal)\r\n    @trigger 'open'\r\n    #    @inventoryModal.onShown() # replace?\r\n\r\n  #- Modal events\r\n\r\n  onceHeroLoaded: (e) ->\r\n    @inventoryModal.setHero(e.hero) if window.currentModal is @inventoryModal\r\n\r\n  onHeroesModalConfirmClicked: (e) ->\r\n    @options.parent.openModalView(@inventoryModal)\r\n    @inventoryModal.render()\r\n    @inventoryModal.didReappear()\r\n    @inventoryModal.onShown()\r\n    @inventoryModal.setHero(e.hero) if e.hero\r\n    window.tracker?.trackEvent 'Choose Inventory', category: 'Play Level'\r\n\r\n  onChooseHeroClicked: ->\r\n    @options.parent.openModalView(@heroesModal)\r\n    @heroesModal.render()\r\n    @heroesModal.didReappear()\r\n    @inventoryModal.endHighlight()\r\n    window.tracker?.trackEvent 'Change Hero', category: 'Play Level'\r\n\r\n  onInventoryModalPlayClicked: ->\r\n    @navigatingToPlay = true\r\n    PlayLevelView = 'views/play/level/PlayLevelView'\r\n    LadderView = 'views/ladder/LadderView'\r\n    viewClass = if @options.levelPath is 'ladder' then LadderView else PlayLevelView\r\n    route = \"/play/#{@options.levelPath || 'level'}/#{@options.levelID}\"\r\n    route += \"?codeLanguage=\" + @level.get('primerLanguage') if @level.get('primerLanguage')\r\n    Backbone.Mediator.publish 'router:navigate', {\r\n      route, viewClass\r\n      viewArgs: [{supermodel: @supermodel}, @options.levelID]\r\n    }\r\n\r\n  destroy: ->\r\n    @heroesModalDestroy?.call @heroesModal unless @heroesModal?.destroyed\r\n    @inventoryModalDestroy?.call @inventoryModal unless @inventoryModal?.destroyed\r\n    super()\r\n"]}