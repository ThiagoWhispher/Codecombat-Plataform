{"version":3,"sources":["app/lib/world/world_utils.coffee"],"names":[],"mappings":"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","file":"public/javascripts/app/lib/world/world_utils.js","sourcesContent":["Vector = require './vector'\r\nRectangle = require './rectangle'\r\nEllipse = require './ellipse'\r\nLineSegment = require './line_segment'\r\nGrid = require './Grid'\r\n\r\nmodule.exports.typedArraySupport = typedArraySupport = Float32Array?  # Not in IE until IE 10; we'll fall back to normal arrays\r\n#module.exports.typedArraySupport = typedArraySupport = false  # imitate IE9 (and in God.coffee)\r\n\r\nunless ArrayBufferView?\r\n  # https://code.google.com/p/chromium/issues/detail?id=60449\r\n  if typedArraySupport\r\n    # We have it, it's just not exposed\r\n    someArray = new Uint8Array(0)\r\n    if someArray.__proto__\r\n      # Most browsers\r\n      ArrayBufferView = someArray.__proto__.__proto__.constructor\r\n    else\r\n      # IE before 11\r\n      ArrayBufferView = Object.getPrototypeOf(Object.getPrototypeOf(someArray)).constructor\r\n  else\r\n    # If we don't have typed arrays, we don't need an ArrayBufferView\r\n    ArrayBufferView = null\r\n\r\nmodule.exports.clone = clone = (obj, skipThangs=false) ->\r\n  # http://coffeescriptcookbook.com/chapters/classes_and_objects/cloning\r\n  if not obj? or typeof obj isnt 'object'\r\n    return obj\r\n\r\n  if obj instanceof Date\r\n    return new Date(obj.getTime())\r\n\r\n  if obj instanceof RegExp\r\n    flags = ''\r\n    flags += 'g' if obj.global?\r\n    flags += 'i' if obj.ignoreCase?\r\n    flags += 'm' if obj.multiline?\r\n    flags += 'y' if obj.sticky?\r\n    return new RegExp(obj.source, flags)\r\n\r\n  if (obj instanceof Vector) or (obj instanceof Rectangle) or (obj instanceof Ellipse) or (obj instanceof LineSegment)\r\n    return obj.copy()\r\n\r\n  if skipThangs and obj.isThang\r\n    return obj\r\n\r\n  if _.isArray obj\r\n    return obj.slice()\r\n\r\n  if ArrayBufferView and obj instanceof ArrayBufferView\r\n    return new obj.constructor obj\r\n\r\n  newInstance = new obj.constructor()\r\n  for key of obj\r\n    newInstance[key] = clone obj[key], skipThangs\r\n\r\n  newInstance\r\n\r\n# Walk a key chain down to the value. Can optionally set newValue instead.\r\nmodule.exports.downTheChain = downTheChain = (obj, keyChain, newValue=undefined) ->\r\n  return null unless obj\r\n  return obj[keyChain] unless _.isArray keyChain\r\n  value = obj\r\n  while keyChain.length and value\r\n    if newValue isnt undefined and keyChain.length is 1\r\n      value[keyChain[0]] = newValue\r\n      return newValue\r\n    value = value[keyChain[0]]\r\n    keyChain = keyChain[1..]\r\n  return value\r\n\r\nmodule.exports.now = (if window?.performance?.now? then (-> window.performance.now()) else (-> new Date()))\r\n\r\nmodule.exports.consolidateThangs = consolidateThangs = (thangs) ->\r\n  # We can gain a performance increase by consolidating all regular walls into a minimal covering, non-intersecting set a la Gridmancer.\r\n  debug = false\r\n  isStructural = (t) ->\r\n    t.stateless and t.collides and t.collisionCategory is 'obstacles' and t.shape in ['box', 'sheet'] and  # Can only do wall-like obstacle Thangs.\r\n    t.spriteName isnt 'Ice Wall' and t.restitution is 1.0 and  # Fixed restitution value on 2016-03-15, but it causes discrepancies, so disabled for Kelvintaph levels.\r\n    /Wall/.test(t.spriteName) and  # Not useful to do Thangs that aren't actually walls because they're usually not on a grid\r\n    (t.pos.x - t.width / 2 >= 0) and (t.pos.y - t.height / 2 >= 0)  # Grid doesn't handle negative numbers, so don't coalesce walls below/left of 0, 0.\r\n  structural = _.remove thangs, isStructural\r\n  return unless structural.length\r\n  rightmost = _.max structural, (t) -> t.pos.x + t.width / 2\r\n  topmost = _.max structural, (t) -> t.pos.y + t.height / 2\r\n  leftmost = _.min structural, (t) -> t.pos.x - t.width / 2\r\n  bottommost = _.min structural, (t) -> t.pos.y - t.height / 2\r\n  console.log 'got rightmost', rightmost.id, 'topmost', topmost.id, 'lefmostmost', leftmost.id, 'bottommost', bottommost.id, 'out of', structural.length, 'structural thangs' if debug\r\n  left = Math.min 0, leftmost.pos.x - leftmost.width / 2\r\n  bottom = Math.min 0, bottommost.pos.y - bottommost.height / 2\r\n  if (left < 0) or (bottom < 0)\r\n    console.error 'Negative structural Thangs aren\\'t supported, sorry!'  # TODO: largestRectangle, AI System, and anything else that accesses grid directly need updating to finish this\r\n  left = 0\r\n  bottom = 0\r\n  width = rightmost.pos.x + rightmost.width / 2 - left\r\n  height = topmost.pos.y + topmost.height / 2 - bottom\r\n  padding = 0\r\n  console.log 'got max width', width, 'height', height, 'left', left, 'bottom', bottom, 'of thangs', thangs.length, 'structural', structural.length if debug\r\n  grid = new Grid structural, width, height, padding, left, bottom\r\n\r\n  dissection = []\r\n  addStructuralThang = (rect) ->\r\n    thang = structural[dissection.length]  # Grab one we already know is configured properly.\r\n    console.error 'Hmm, our dissection has more Thangs than the original structural Thangs?', dissection.length unless thang\r\n    thang.pos.x = rect.x\r\n    thang.pos.y = rect.y\r\n    thang.width = rect.width\r\n    thang.height = rect.height\r\n    thang.destroyBody()\r\n    thang.createBodyDef()\r\n    thang.createBody()\r\n    dissection.push thang\r\n\r\n  dissectRectangles grid, addStructuralThang, false, debug\r\n\r\n  # Now add the new structural thangs back to thangs and return the ones not in the dissection.\r\n  console.log 'Turned', structural.length, 'structural Thangs into', dissection.length, 'dissecting Thangs.'\r\n  thangs.push dissection...\r\n  structural[dissection.length ... structural.length]\r\n\r\n\r\nmodule.exports.dissectRectangles = dissectRectangles = (grid, rectangleCallback, wantEmpty, debug) ->\r\n  # Mark Maxham's fast sweeper approach: https://github.com/codecombat/codecombat/issues/1090\r\n  console.log grid.toString() if debug\r\n  for x in grid.rows grid.left, grid.left + grid.width\r\n    y = grid.clampColumn grid.bottom\r\n    while y < grid.clampColumn grid.bottom + grid.height\r\n      y2 = y  # Note our current y.\r\n      ++y2 until occ x, y2, grid, wantEmpty  # Sweep through y to expand 1xN rect.\r\n      if y2 > y  # If we get a hit, sweep X with that swath.\r\n        x2 = x + 1\r\n        ++x2 until occCol x2, y, y2, grid, wantEmpty\r\n        w = x2 - x\r\n        h = y2 - y\r\n        rect = addRect grid, x, y, w, h, wantEmpty\r\n        rectangleCallback rect\r\n        console.log grid.toString() if debug\r\n        y = y2\r\n      ++y\r\n\r\nocc = (x, y, grid, wantEmpty) ->\r\n  return true if y > grid.bottom + grid.height or x > grid.left + grid.width\r\n  console.error 'trying to check invalid coordinates', x, y, 'from grid', grid.bottom, grid.left, grid.width, grid.height unless grid.grid[y]?[x]\r\n  Boolean(grid.grid[y][x].length) is wantEmpty\r\n\r\noccCol = (x, y1, y2, grid, wantEmpty) ->\r\n  for j in [y1 ... y2]\r\n    if occ(x, j, grid, wantEmpty)\r\n      return true\r\n  false\r\n\r\naddRect = (grid, leftX, bottomY, width, height, wantEmpty) ->\r\n  for x in [leftX ... leftX + width]\r\n    for y in [bottomY ... bottomY + height]\r\n      grid.grid[y][x] = if wantEmpty then [true] else []\r\n  new Rectangle leftX + width / 2, bottomY + height / 2, width, height\r\n"]}