{"version":3,"sources":["app/lib/world/thang_state.coffee"],"names":[],"mappings":"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","file":"public/javascripts/app/lib/world/thang_state.js","sourcesContent":["{clone, typedArraySupport} = require './world_utils'\r\nVector = require './vector'\r\n\r\nif typedArraySupport\r\n  FloatArrayType = Float32Array  # Better performance than Float64Array\r\n  bytesPerFloat = FloatArrayType.BYTES_PER_ELEMENT ? FloatArrayType.prototype.BYTES_PER_ELEMENT\r\nelse\r\n  bytesPerFloat = 4\r\n\r\nmodule.exports = class ThangState\r\n  @className: 'ThangState'\r\n  @trackedPropertyTypes: [\r\n    'boolean'\r\n    'number'\r\n    'string'\r\n    'array'  # will turn everything into strings\r\n    'object'  # grrr\r\n    'Vector'\r\n    'Thang'  # serialized as ids, like strings\r\n  ]\r\n\r\n  hasRestored: false\r\n  constructor: (thang) ->\r\n    @props = []  # parallel array to @thang's trackedPropertiesKeys/Types\r\n    return unless thang\r\n    @thang = thang\r\n    for prop, propIndex in thang.trackedPropertiesKeys\r\n      type = thang.trackedPropertiesTypes[propIndex]\r\n      value = thang[prop]\r\n      if type is 'Vector'\r\n        @props.push value?.copy()  # could try storing [x, y, z] or {x, y, z} here instead if this is expensive\r\n      else if type is 'object' or type is 'array'\r\n        @props.push clone(value, true)\r\n      else\r\n        @props.push value\r\n\r\n  # Either pass storage and type, or don't pass either of them\r\n  getStoredProp: (propIndex, type, storage) ->\r\n    # Optimize it\r\n    unless type\r\n      type = @trackedPropertyTypes[propIndex]\r\n      storage = @trackedPropertyValues[propIndex]\r\n    if type is 'Vector'\r\n      value = new Vector storage[3 * @frameIndex], storage[3 * @frameIndex + 1], storage[3 * @frameIndex + 2]\r\n    else if type is 'string'\r\n      specialKey = storage[@frameIndex]\r\n      value = @specialKeysToValues[specialKey]\r\n    else if type is 'Thang'\r\n      specialKey = storage[@frameIndex]\r\n      value = @thang.world.getThangByID @specialKeysToValues[specialKey]\r\n    else if type is 'array'\r\n      specialKey = storage[@frameIndex]\r\n      valueString = @specialKeysToValues[specialKey]\r\n      if valueString and valueString.length > 1\r\n        # Trim leading Group Separator and trailing Record Separator, split by Record Separators, restore string array.\r\n        value = valueString.substring(1, valueString.length - 1).split '\\x1E'\r\n      else\r\n        value = []\r\n    else\r\n      value = storage[@frameIndex]\r\n    value\r\n\r\n  getStateForProp: (prop) ->\r\n    # Get the property, whether we have it stored in @props or in @trackedPropertyValues. Optimize it.\r\n    # Figured based on http://jsperf.com/object-vs-array-vs-native-linked-list/13 that it should be faster with small arrays to do the indexOf reads (each up to 24x faster) than to do a single object read, and then we don't have to maintain an extra @props object; just keep array\r\n    propIndex = @trackedPropertyKeys.indexOf prop\r\n    if propIndex is -1\r\n      initialPropIndex = @thang.unusedTrackedPropertyKeys.indexOf prop\r\n      return null if initialPropIndex is -1\r\n      return @thang.unusedTrackedPropertyValues[initialPropIndex]\r\n    value = @props[propIndex]\r\n    return value if value isnt undefined or @hasRestored\r\n    return @props[propIndex] = @getStoredProp propIndex\r\n\r\n  restore: ->\r\n    # Restore trackedProperties' values to @thang, retrieving them from @trackedPropertyValues if needed. Optimize it.\r\n    return @ if @thang._state is @ and not @thang.partialState\r\n    unless @hasRestored  # Restoring in a deserialized World for first time\r\n      for prop, propIndex in @thang.unusedTrackedPropertyKeys when @trackedPropertyKeys.indexOf(prop) is -1\r\n        @thang[prop] = @thang.unusedTrackedPropertyValues[propIndex]\r\n      props = []\r\n      for prop, propIndex in @trackedPropertyKeys\r\n        type = @trackedPropertyTypes[propIndex]\r\n        storage = @trackedPropertyValues[propIndex]\r\n        props.push @thang[prop] = @getStoredProp propIndex, type, storage\r\n        #console.log @frameIndex, @thang.id, prop, propIndex, type, storage, 'got', @thang[prop]\r\n      @props = props\r\n      @trackedPropertyTypes = @trackedPropertyValues = @specialKeysToValues = null  # leave @trackedPropertyKeys for indexing\r\n      @hasRestored = true\r\n    else  # Restoring later times\r\n      for prop, propIndex in @thang.unusedTrackedPropertyKeys when @trackedPropertyKeys.indexOf(prop) is -1\r\n        @thang[prop] = @thang.unusedTrackedPropertyValues[propIndex]\r\n      for prop, propIndex in @trackedPropertyKeys\r\n        @thang[prop] = @props[propIndex]\r\n    @thang.partialState = false\r\n    @thang.stateChanged = true\r\n    @\r\n\r\n  restorePartial: (ratio) ->\r\n    # Don't think we need to worry about unusedTrackedPropertyValues here.\r\n    # If it's not tracked yet, it'll very rarely partially change between frames; we can afford to miss the first one.\r\n    inverse = 1 - ratio\r\n    for prop, propIndex in @trackedPropertyKeys when prop is 'pos' or prop is 'rotation'\r\n      if @hasRestored\r\n        value = @props[propIndex]\r\n      else\r\n        type = @trackedPropertyTypes[propIndex]\r\n        storage = @trackedPropertyValues[propIndex]\r\n        value = @getStoredProp propIndex, type, storage\r\n      if prop is 'pos'\r\n        if (@thang.teleport and @thang.pos.distanceSquared(value) > 900) or (@thang.pos.x is 0 and @thang.pos.y is 0)\r\n          # Don't interpolate; it was probably a teleport. https://github.com/codecombat/codecombat/issues/738\r\n          @thang.pos = value\r\n        else\r\n          @thang.pos = @thang.pos.copy()\r\n          @thang.pos.x = inverse * @thang.pos.x + ratio * value.x\r\n          @thang.pos.y = inverse * @thang.pos.y + ratio * value.y\r\n          @thang.pos.z = inverse * @thang.pos.z + ratio * value.z\r\n      else if prop is 'rotation'\r\n        @thang.rotation = inverse * @thang.rotation + ratio * value\r\n      @thang.partialState = true\r\n    @thang.stateChanged = true\r\n    @\r\n\r\n  serialize: (frameIndex, trackedPropertyIndices, trackedPropertyTypes, trackedPropertyValues, specialValuesToKeys, specialKeysToValues) ->\r\n    # Performance hotspot--called once per tracked property per Thang per frame. Optimize the crap out of it.\r\n    for type, newPropIndex in trackedPropertyTypes\r\n      originalPropIndex = trackedPropertyIndices[newPropIndex]\r\n      storage = trackedPropertyValues[newPropIndex]\r\n      value = @props[originalPropIndex]\r\n      if value\r\n        # undefined, null, false, 0 won't trigger in this serialization code scheme anyway, so we can't differentiate between them when deserializing\r\n        if type is 'Vector'\r\n          storage[3 * frameIndex] = value.x\r\n          storage[3 * frameIndex + 1] = value.y\r\n          storage[3 * frameIndex + 2] = value.z\r\n        else if type is 'string'\r\n          specialKey = specialValuesToKeys[value]\r\n          unless specialKey\r\n            specialKey = specialKeysToValues.length\r\n            specialValuesToKeys[value] = specialKey\r\n            specialKeysToValues.push value\r\n            storage[frameIndex] = specialKey\r\n          storage[frameIndex] = specialKey\r\n        else if type is 'Thang'\r\n          value = value.id\r\n          specialKey = specialValuesToKeys[value]\r\n          unless specialKey\r\n            specialKey = specialKeysToValues.length\r\n            specialValuesToKeys[value] = specialKey\r\n            specialKeysToValues.push value\r\n            storage[frameIndex] = specialKey\r\n          storage[frameIndex] = specialKey\r\n        else if type is 'array'\r\n          # We make sure the array keys won't collide with any string keys by using some unprintable characters.\r\n          stringPieces = ['\\x1D']  # Group Separator\r\n          for element in value\r\n            if element and element.id  # Was checking element.isThang, but we can't store non-strings anyway\r\n              element = element.id\r\n            stringPieces.push element, '\\x1E'  # Record Separator(s)\r\n          value = stringPieces.join('')\r\n          specialKey = specialValuesToKeys[value]\r\n          unless specialKey\r\n            specialKey = specialKeysToValues.length\r\n            specialValuesToKeys[value] = specialKey\r\n            specialKeysToValues.push value\r\n            storage[frameIndex] = specialKey\r\n          storage[frameIndex] = specialKey\r\n        else\r\n          storage[frameIndex] = value\r\n        #console.log @thang.id, 'assigned prop', originalPropIndex, newPropIndex, value, type, 'at', frameIndex, 'to', storage[frameIndex]\r\n    null\r\n\r\n  @deserialize: (world, frameIndex, thang, trackedPropertyKeys, trackedPropertyTypes, trackedPropertyValues, specialKeysToValues) ->\r\n    # Optimize like no tomorrow--most performance-sensitive part of the whole app, called once per WorldFrame per Thang per trackedProperty, blocking the UI\r\n    ts = new ThangState\r\n    ts.thang = thang\r\n    ts.frameIndex = frameIndex\r\n    ts.trackedPropertyKeys = trackedPropertyKeys\r\n    ts.trackedPropertyTypes = trackedPropertyTypes\r\n    ts.trackedPropertyValues = trackedPropertyValues\r\n    ts.specialKeysToValues = specialKeysToValues\r\n    ts\r\n\r\n  @transferableBytesNeededForType: (type, nFrames) ->\r\n    bytes = switch type\r\n      when 'boolean' then 1\r\n      when 'number' then bytesPerFloat\r\n      when 'Vector' then bytesPerFloat * 3\r\n      when 'string' then 4\r\n      when 'Thang' then 4  # turn them into strings of their ids\r\n      when 'array'  then 4  # turn them into strings and hope it doesn't explode?\r\n      else 0\r\n    # We need to be a multiple of bytesPerFloat otherwise bigger-byte array (Float64Array, etc.) offsets won't work\r\n    # http://www.kirupa.com/forum/showthread.php?378737-Typed-Arrays-Y-U-No-offset-at-values-other-than-multiples-of-element-size\r\n    bytesPerFloat * Math.ceil(nFrames * bytes / bytesPerFloat)\r\n\r\n  @createArrayForType: (type, nFrames, buffer, offset) ->\r\n    bytes = @transferableBytesNeededForType type, nFrames\r\n    storage = switch type\r\n      when 'boolean'\r\n        new Uint8Array(buffer, offset, nFrames)\r\n      when 'number'\r\n        new FloatArrayType(buffer, offset, nFrames)\r\n      when 'Vector'\r\n        new FloatArrayType(buffer, offset, nFrames * 3)\r\n      when 'string'\r\n        new Uint32Array(buffer, offset, nFrames)\r\n      when 'Thang'\r\n        new Uint32Array(buffer, offset, nFrames)\r\n      when 'array'\r\n        new Uint32Array(buffer, offset, nFrames)\r\n      else\r\n        []\r\n    [storage, bytes]\r\n\r\nunless typedArraySupport\r\n  # Fall back to normal arrays in IE 9\r\n  ThangState.createArrayForType = (type, nFrames, buffer, offset) ->\r\n    bytes = @transferableBytesNeededForType type, nFrames\r\n    elementsPerFrame = if type is 'Vector' then 3 else 1\r\n    storage = (0 for i in [0 ... nFrames * elementsPerFrame])\r\n    [storage, bytes]\r\n"]}