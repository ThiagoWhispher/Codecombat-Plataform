{"version":3,"sources":["app/lib/world/world.coffee"],"names":[],"mappings":"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","file":"public/javascripts/app/lib/world/world.js","sourcesContent":["Vector = require './vector'\r\nRectangle = require './rectangle'\r\nEllipse = require './ellipse'\r\nLineSegment = require './line_segment'\r\nWorldFrame = require './world_frame'\r\nThang = require './thang'\r\nThangState = require './thang_state'\r\nRand = require './rand'\r\nWorldScriptNote = require './world_script_note'\r\n{now, consolidateThangs, typedArraySupport} = require './world_utils'\r\nComponent = require 'lib/world/component'\r\nSystem = require 'lib/world/system'\r\nPROGRESS_UPDATE_INTERVAL = 100\r\nDESERIALIZATION_INTERVAL = 10\r\nREAL_TIME_BUFFER_MIN = 2 * PROGRESS_UPDATE_INTERVAL\r\nREAL_TIME_BUFFER_MAX = 3 * PROGRESS_UPDATE_INTERVAL\r\nREAL_TIME_BUFFERED_WAIT_INTERVAL = 0.5 * PROGRESS_UPDATE_INTERVAL\r\nREAL_TIME_COUNTDOWN_DELAY = 3000  # match CountdownScreen\r\nITEM_ORIGINAL = '53e12043b82921000051cdf9'\r\nEXISTS_ORIGINAL = '524b4150ff92f1f4f8000024'\r\nCOUNTDOWN_LEVELS = ['sky-span']\r\n\r\nmodule.exports = class World\r\n  @className: 'World'\r\n  age: 0\r\n  ended: false\r\n  preloading: false  # Whether we are just preloading a world in case we soon cast it\r\n  debugging: false  # Whether we are just rerunning to debug a world we've already cast\r\n  headless: false  # Whether we are just simulating for goal states instead of all serialized results\r\n  framesSerializedSoFar: 0\r\n  framesClearedSoFar: 0\r\n  apiProperties: ['age', 'dt']\r\n  realTimeBufferMax: REAL_TIME_BUFFER_MAX / 1000\r\n  constructor: (@userCodeMap, classMap) ->\r\n    # classMap is needed for deserializing Worlds, Thangs, and other classes\r\n    @classMap = classMap ? {Vector: Vector, Rectangle: Rectangle, Thang: Thang, Ellipse: Ellipse, LineSegment: LineSegment}\r\n    Thang.resetThangIDs()\r\n\r\n    @userCodeMap ?= {}\r\n    @thangs = []\r\n    @thangMap = {}\r\n    @systems = []\r\n    @systemMap = {}\r\n    @scriptNotes = []\r\n    @rand = new Rand 0  # Existence System may change this seed\r\n    @frames = [new WorldFrame(@, 0)]\r\n\r\n  destroy: ->\r\n    @goalManager?.destroy()\r\n    thang.destroy() for thang in @thangs\r\n    @[key] = undefined for key of @\r\n    @destroyed = true\r\n    @destroy = ->\r\n\r\n  getFrame: (frameIndex) ->\r\n    # Optimize it a bit--assume we have all if @ended and are at the previous frame otherwise\r\n    frames = @frames\r\n    if @ended\r\n      frame = frames[frameIndex]\r\n    else if frameIndex\r\n      frame = frames[frameIndex - 1].getNextFrame()\r\n      frames.push frame\r\n    else\r\n      frame = frames[0]\r\n    @age = frameIndex * @dt\r\n    frame\r\n\r\n  getThangByID: (id) ->\r\n    @thangMap[id]\r\n\r\n  setThang: (thang) ->\r\n    thang.stateChanged = true\r\n    for old, i in @thangs\r\n      if old.id is thang.id\r\n        @thangs[i] = thang\r\n        break\r\n    @thangMap[thang.id] = thang\r\n\r\n  thangDialogueSounds: (startFrame=0) ->\r\n    return [] unless startFrame < @frames.length\r\n    [sounds, seen] = [[], {}]\r\n    for frameIndex in [startFrame ... @frames.length]\r\n      frame = @frames[frameIndex]\r\n      for thangID, state of frame.thangStateMap\r\n        continue unless state.thang.say and sayMessage = state.getStateForProp 'sayMessage'\r\n        soundKey = state.thang.spriteName + ':' + sayMessage\r\n        unless seen[soundKey]\r\n          sounds.push [state.thang.spriteName, sayMessage]\r\n          seen[soundKey] = true\r\n    sounds\r\n\r\n  setGoalManager: (@goalManager) ->\r\n\r\n  addError: (error) ->\r\n    (@runtimeErrors ?= []).push error\r\n    (@unhandledRuntimeErrors ?= []).push error\r\n\r\n  loadFrames: (loadedCallback, errorCallback, loadProgressCallback, preloadedCallback, skipDeferredLoading, loadUntilFrame) ->\r\n    return if @aborted\r\n    @totalFrames = 2 if @justBegin\r\n    console.log 'Warning: loadFrames called on empty World (no thangs).' unless @thangs.length\r\n    continueLaterFn = =>\r\n      @loadFrames(loadedCallback, errorCallback, loadProgressCallback, preloadedCallback, skipDeferredLoading, loadUntilFrame) unless @destroyed\r\n    if @realTime and not @countdownFinished\r\n      @realTimeSpeedFactor = 1\r\n      unless @showsCountdown\r\n        if @levelID in ['woodland-cleaver', 'village-guard', 'shield-rush']\r\n          @realTimeSpeedFactor = 2\r\n        else if @levelID in ['thornbush-farm', 'back-to-back', 'ogre-encampment', 'peasant-protection', 'munchkin-swarm', 'munchkin-harvest', 'swift-dagger', 'shrapnel', 'arcane-ally', 'touch-of-death', 'bonemender']\r\n          @realTimeSpeedFactor = 3\r\n      if @showsCountdown\r\n        return setTimeout @finishCountdown(continueLaterFn), REAL_TIME_COUNTDOWN_DELAY\r\n      else\r\n        @finishCountdown continueLaterFn\r\n    t1 = now()\r\n    @t0 ?= t1\r\n    @worldLoadStartTime ?= t1\r\n    @lastRealTimeUpdate ?= 0\r\n    frameToLoadUntil = if loadUntilFrame then loadUntilFrame + 1 else @totalFrames  # Might stop early if debugging.\r\n    i = @frames.length\r\n    while true\r\n      if @indefiniteLength\r\n        break if not @realTime # realtime has been stopped\r\n        break if @victory? # game won or lost  # TODO: give a couple seconds of buffer after victory is set instead of ending instantly\r\n      else\r\n        break if i >= frameToLoadUntil\r\n        break if i >= @totalFrames\r\n      return unless @shouldContinueLoading t1, loadProgressCallback, skipDeferredLoading, continueLaterFn\r\n      @adjustFlowSettings loadUntilFrame if @debugging\r\n      try\r\n        @getFrame(i)\r\n        ++i  # Increment this after we have succeeded in getting the frame, otherwise we'll have to do that frame again\r\n      catch error\r\n        @addError error  # Not an Aether.errors.UserCodeError; maybe we can't recover\r\n      unless @preloading or @debugging\r\n        for error in (@unhandledRuntimeErrors ? [])\r\n          return unless errorCallback error  # errorCallback tells us whether the error is recoverable\r\n        @unhandledRuntimeErrors = []\r\n    @finishLoadingFrames loadProgressCallback, loadedCallback, preloadedCallback\r\n\r\n  finishLoadingFrames: (loadProgressCallback, loadedCallback, preloadedCallback) ->\r\n    unless @debugging\r\n      @ended = true\r\n      system.finish @thangs for system in @systems\r\n    if @preloading\r\n      preloadedCallback()\r\n    else\r\n      loadProgressCallback? 1\r\n      loadedCallback()\r\n\r\n  finishCountdown: (continueLaterFn) -> =>\r\n    return if @destroyed\r\n    @countdownFinished = true\r\n    continueLaterFn()\r\n\r\n  shouldDelayRealTimeSimulation: (t) ->\r\n    return false unless @realTime\r\n    timeSinceStart = (t - @worldLoadStartTime) * @realTimeSpeedFactor\r\n    timeLoaded = @frames.length * @dt * 1000\r\n    timeBuffered = timeLoaded - timeSinceStart\r\n    if @indefiniteLength\r\n      return timeBuffered > 0\r\n    else\r\n      return timeBuffered > REAL_TIME_BUFFER_MAX * @realTimeSpeedFactor\r\n\r\n  shouldUpdateRealTimePlayback: (t) ->\r\n    return false unless @realTime\r\n    return false if @frames.length * @dt is @lastRealTimeUpdate\r\n    timeLoaded = @frames.length * @dt * 1000\r\n    timeSinceStart = (t - @worldLoadStartTime) * @realTimeSpeedFactor\r\n    remainingBuffer = @lastRealTimeUpdate * 1000 - timeSinceStart\r\n    if @indefiniteLength\r\n      return remainingBuffer <= 0\r\n    else\r\n      return remainingBuffer < REAL_TIME_BUFFER_MIN * @realTimeSpeedFactor\r\n\r\n  shouldContinueLoading: (t1, loadProgressCallback, skipDeferredLoading, continueLaterFn) ->\r\n    t2 = now()\r\n    chunkSize = @frames.length - @framesSerializedSoFar\r\n    simedTime = @frames.length / @frameRate\r\n\r\n    chunkTime = switch\r\n      when simedTime > 15 then 7\r\n      when simedTime > 10 then 5\r\n      when simedTime > 5 then 3\r\n      when simedTime > 2 then 1\r\n      else 0.5\r\n\r\n    bailoutTime = Math.max(2000*chunkTime, 10000)\r\n\r\n    dt = t2 - t1\r\n\r\n    if @realTime\r\n      shouldUpdateProgress = @shouldUpdateRealTimePlayback t2\r\n      shouldDelayRealTimeSimulation = not shouldUpdateProgress and @shouldDelayRealTimeSimulation t2\r\n    else\r\n      shouldUpdateProgress = (dt > PROGRESS_UPDATE_INTERVAL and (chunkSize / @frameRate >= chunkTime) or dt > bailoutTime)\r\n      shouldDelayRealTimeSimulation = false\r\n    return true unless shouldUpdateProgress or shouldDelayRealTimeSimulation\r\n    # Stop loading frames for now; continue in a moment.\r\n    if shouldUpdateProgress\r\n      @lastRealTimeUpdate = @frames.length * @dt if @realTime\r\n      #console.log 'we think it is now', (t2 - @worldLoadStartTime) / 1000, 'so delivering', @lastRealTimeUpdate\r\n      loadProgressCallback? @frames.length / @totalFrames unless @preloading\r\n    t1 = t2\r\n    if t2 - @t0 > 1000\r\n      console.log '  Loaded', @frames.length, 'of', @totalFrames, '(+' + (t2 - @t0).toFixed(0) + 'ms)' unless @realTime\r\n      @t0 = t2\r\n    if skipDeferredLoading\r\n      continueLaterFn()\r\n    else\r\n      delay = 0\r\n      if shouldDelayRealTimeSimulation\r\n        if @indefiniteLength\r\n          delay = 1000 / 30\r\n        else\r\n          delay = REAL_TIME_BUFFERED_WAIT_INTERVAL\r\n      setTimeout continueLaterFn, delay\r\n    false\r\n\r\n  adjustFlowSettings: (loadUntilFrame) ->\r\n    for thang in @thangs when thang.isProgrammable\r\n      userCode = @userCodeMap[thang.id] ? {}\r\n      for methodName, aether of userCode\r\n        framesToLoadFlowBefore = if methodName is 'plan' or methodName is 'makeBid' then 200 else 1  # Adjust if plan() is taking even longer\r\n        aether._shouldSkipFlow = @frames.length < loadUntilFrame - framesToLoadFlowBefore\r\n\r\n  finalizePreload: (loadedCallback) ->\r\n    @preloading = false\r\n    loadedCallback() if @ended\r\n\r\n  abort: ->\r\n    @aborted = true\r\n\r\n  addFlagEvent: (flagEvent) ->\r\n    @flagHistory.push flagEvent\r\n\r\n  addRealTimeInputEvent: (realTimeInputEvent) ->\r\n    @realTimeInputEvents.push realTimeInputEvent\r\n\r\n  loadFromLevel: (level, willSimulate=true) ->\r\n    @levelID = level.slug\r\n    @levelComponents = level.levelComponents\r\n    @thangTypes = level.thangTypes\r\n    @loadScriptsFromLevel level\r\n    @loadSystemsFromLevel level\r\n    @loadThangsFromLevel level, willSimulate\r\n    @showsCountdown = @levelID in COUNTDOWN_LEVELS or _.any(@thangs, (t) -> (t.programmableProperties and 'findFlags' in t.programmableProperties) or t.inventory?.flag)\r\n    @picoCTFProblem = level.picoCTFProblem if level.picoCTFProblem\r\n    if @picoCTFProblem?.instances and not @picoCTFProblem.flag_sha1\r\n      @picoCTFProblem = _.merge @picoCTFProblem, @picoCTFProblem.instances[0]\r\n    system.start @thangs for system in @systems\r\n\r\n  loadSystemsFromLevel: (level) ->\r\n    # Remove old Systems\r\n    @systems = []\r\n    @systemMap = {}\r\n\r\n    # Load new Systems\r\n    for levelSystem in level.systems\r\n      systemModel = levelSystem.model\r\n      config = levelSystem.config\r\n      systemClass = @loadClassFromCode systemModel.js, systemModel.name, 'system'\r\n      #console.log \"using db system class ---\\n\", systemClass, \"\\n--- from code ---n\", systemModel.js, \"\\n---\"\r\n      system = new systemClass @, config\r\n      @addSystems system\r\n    null\r\n\r\n  loadThangsFromLevel: (level, willSimulate) ->\r\n    # Remove old Thangs\r\n    @thangs = []\r\n    @thangMap = {}\r\n\r\n    # Load new Thangs\r\n    toAdd = (@loadThangFromLevel thangConfig, level.levelComponents, level.thangTypes for thangConfig in level.thangs ? [])\r\n    @extraneousThangs = consolidateThangs toAdd if willSimulate  # Combine walls, for example; serialize the leftovers later\r\n    @addThang thang for thang in toAdd\r\n    null\r\n\r\n  loadThangFromLevel: (thangConfig, levelComponents, thangTypes, equipBy=null) ->\r\n    components = []\r\n    for component, componentIndex in thangConfig.components\r\n      componentModel = _.find levelComponents, (c) ->\r\n        c.original is component.original and c.version.major is (component.majorVersion ? 0)\r\n      componentClass = @loadClassFromCode componentModel.js, componentModel.name, 'component'\r\n      components.push [componentClass, component.config]\r\n      if component.original is ITEM_ORIGINAL\r\n        isItem = true\r\n        component.config.ownerID = equipBy if equipBy\r\n      else if component.original is EXISTS_ORIGINAL\r\n        existsConfigIndex = componentIndex\r\n    if isItem and existsConfigIndex?\r\n      # For memory usage performance, make sure these don't get any tracked properties assigned.\r\n      components[existsConfigIndex][1] = {exists: false, stateless: true}\r\n    thangTypeOriginal = thangConfig.thangType\r\n    thangTypeModel = _.find thangTypes, (t) -> t.original is thangTypeOriginal\r\n    return console.error thangConfig.id ? equipBy, 'could not find ThangType for', thangTypeOriginal unless thangTypeModel\r\n    thangTypeName = thangTypeModel.name\r\n    thang = new Thang @, thangTypeName, thangConfig.id\r\n    try\r\n      thang.addComponents components...\r\n    catch e\r\n      console.error 'couldn\\'t load components for', thangTypeOriginal, thangConfig.id, 'because', e.toString(), e.stack\r\n    thang\r\n\r\n  addThang: (thang) ->\r\n    @thangs.unshift thang  # Interactions happen in reverse order of specification/drawing\r\n    @setThang thang\r\n    @updateThangState thang\r\n    thang.updateRegistration()\r\n    thang\r\n\r\n  loadScriptsFromLevel: (level) ->\r\n    @scriptNotes = []\r\n    @scripts = []\r\n    @addScripts level.scripts...\r\n\r\n  loadClassFromCode: (js, name, kind='component') ->\r\n    # Cache them based on source code so we don't have to worry about extra compilations\r\n    @componentCodeClassMap ?= {}\r\n    @systemCodeClassMap ?= {}\r\n    map = if kind is 'component' then @componentCodeClassMap else @systemCodeClassMap\r\n    c = map[js]\r\n    return c if c\r\n    try\r\n      c = map[js] = eval js\r\n    catch err\r\n      console.error \"Couldn't compile #{kind} code:\", err, \"\\n\", js\r\n      c = map[js] = {}\r\n    c.className = name\r\n    c\r\n\r\n  updateThangState: (thang) ->\r\n    @frames[@frames.length-1].thangStateMap[thang.id] = thang.getState()\r\n\r\n  size: ->\r\n    @calculateBounds() unless @width? and @height?\r\n    return [@width, @height] if @width? and @height?\r\n\r\n  getBounds: ->\r\n    @calculateBounds() unless @bounds?\r\n    return @bounds\r\n\r\n  calculateBounds: ->\r\n    bounds = {left: 0, top: 0, right: 0, bottom: 0}\r\n    hasLand = _.some @thangs, 'isLand'\r\n    for thang in @thangs when thang.isLand or (not hasLand and thang.rectangle)  # Look at Lands only\r\n      rect = thang.rectangle().axisAlignedBoundingBox()\r\n      bounds.left = Math.min(bounds.left, rect.x - rect.width / 2)\r\n      bounds.right = Math.max(bounds.right, rect.x + rect.width / 2)\r\n      bounds.bottom = Math.min(bounds.bottom, rect.y - rect.height / 2)\r\n      bounds.top = Math.max(bounds.top, rect.y + rect.height / 2)\r\n    @width = bounds.right - bounds.left\r\n    @height = bounds.top - bounds.bottom\r\n    @bounds = bounds\r\n    [@width, @height]\r\n\r\n  publishNote: (channel, event) ->\r\n    event ?= {}\r\n    channel = 'world:' + channel\r\n    for script in @scripts ? []\r\n      continue if script.channel isnt channel\r\n      scriptNote = new WorldScriptNote script, event\r\n      continue if scriptNote.invalid\r\n      @scriptNotes.push scriptNote\r\n    return unless @goalManager\r\n    @goalManager.submitWorldGenerationEvent(channel, event, @frames.length)\r\n\r\n  getGoalState: (goalID) ->\r\n    @goalManager.getGoalState(goalID)\r\n\r\n  setGoalState: (goalID, status) ->\r\n    @goalManager.setGoalState(goalID, status)\r\n\r\n  endWorld: (victory=false, delay=3, tentative=false) ->\r\n    @totalFrames = Math.min(@totalFrames, @frames.length + Math.floor(delay / @dt))  # end a few seconds later\r\n    @victory = victory  # TODO: should just make this signify the winning superteam\r\n    @victoryIsTentative = tentative\r\n    status = if @victory then 'won' else 'lost'\r\n    @publishNote status\r\n    console.log \"The world ended in #{status} on frame #{@totalFrames}\"\r\n\r\n  addSystems: (systems...) ->\r\n    @systems = @systems.concat systems\r\n    for system in systems\r\n      @systemMap[system.constructor.className] = system\r\n  getSystem: (systemClassName) ->\r\n    @systemMap?[systemClassName]\r\n\r\n  addScripts: (scripts...) ->\r\n    @scripts = (@scripts ? []).concat scripts\r\n\r\n  addTrackedProperties: (props...) ->\r\n    @trackedProperties = (@trackedProperties ? []).concat props\r\n\r\n  serialize: ->\r\n    # Code hotspot; optimize it\r\n    @freeMemoryBeforeFinalSerialization() if @ended\r\n    startFrame = @framesSerializedSoFar\r\n    endFrame = @frames.length\r\n    if @indefiniteLength\r\n      toClear = Math.max(@framesSerializedSoFar-10, 0)\r\n      for i in _.range(@framesClearedSoFar, toClear)\r\n        @frames[i] = null\r\n      @framesClearedSoFar = @framesSerializedSoFar\r\n    #console.log \"... world serializing frames from\", startFrame, \"to\", endFrame, \"of\", @totalFrames\r\n    [transferableObjects, nontransferableObjects] = [0, 0]\r\n    serializedFlagHistory = (_.omit(_.clone(flag), 'processed') for flag in @flagHistory)\r\n    o = {totalFrames: @totalFrames, maxTotalFrames: @maxTotalFrames, frameRate: @frameRate, dt: @dt, victory: @victory, userCodeMap: {}, trackedProperties: {}, flagHistory: serializedFlagHistory, difficulty: @difficulty, scores: @getScores(), randomSeed: @randomSeed, picoCTFFlag: @picoCTFFlag}\r\n    o.trackedProperties[prop] = @[prop] for prop in @trackedProperties or []\r\n\r\n    for thangID, methods of @userCodeMap\r\n      serializedMethods = o.userCodeMap[thangID] = {}\r\n      for methodName, method of methods\r\n        serializedMethods[methodName] = method.serialize?() ? method # serialize the method again if it has been deserialized\r\n\r\n    t0 = now()\r\n    o.trackedPropertiesThangIDs = []\r\n    o.trackedPropertiesPerThangIndices = []\r\n    o.trackedPropertiesPerThangKeys = []\r\n    o.trackedPropertiesPerThangTypes = []\r\n    trackedPropertiesPerThangValues = []  # We won't send these, just the offsets and the storage buffer\r\n    o.trackedPropertiesPerThangValuesOffsets = []  # Needed to reconstruct ArrayBufferViews on other end, since Firefox has bugs transfering those: https://bugzilla.mozilla.org/show_bug.cgi?id=841904 and https://bugzilla.mozilla.org/show_bug.cgi?id=861925  # Actually, as of January 2014, it should be fixed. So we could try to undo the workaround.\r\n    transferableStorageBytesNeeded = 0\r\n    nFrames = endFrame - startFrame\r\n    for thang in @thangs\r\n      # Don't serialize empty trackedProperties for stateless Thangs which haven't changed (like obstacles).\r\n      # Check both, since sometimes people mark stateless Thangs but then change them, and those should still be tracked, and the inverse doesn't work on the other end (we'll just think it doesn't exist then).\r\n      # If streaming the world, a thang marked stateless that actually change will get messed up. I think.\r\n      continue if thang.stateless and not _.some(thang.trackedPropertiesUsed, Boolean)\r\n      o.trackedPropertiesThangIDs.push thang.id\r\n      trackedPropertiesIndices = []\r\n      trackedPropertiesKeys = []\r\n      trackedPropertiesTypes = []\r\n      for used, propIndex in thang.trackedPropertiesUsed\r\n        continue unless used\r\n        trackedPropertiesIndices.push propIndex\r\n        trackedPropertiesKeys.push thang.trackedPropertiesKeys[propIndex]\r\n        trackedPropertiesTypes.push thang.trackedPropertiesTypes[propIndex]\r\n      o.trackedPropertiesPerThangIndices.push trackedPropertiesIndices\r\n      o.trackedPropertiesPerThangKeys.push trackedPropertiesKeys\r\n      o.trackedPropertiesPerThangTypes.push trackedPropertiesTypes\r\n      trackedPropertiesPerThangValues.push []\r\n      o.trackedPropertiesPerThangValuesOffsets.push []\r\n      for type in trackedPropertiesTypes\r\n        transferableStorageBytesNeeded += ThangState.transferableBytesNeededForType(type, nFrames)\r\n    if typedArraySupport\r\n      o.storageBuffer = new ArrayBuffer(transferableStorageBytesNeeded)\r\n    else\r\n      o.storageBuffer = []\r\n    storageBufferOffset = 0\r\n    for trackedPropertiesValues, thangIndex in trackedPropertiesPerThangValues\r\n      trackedPropertiesValuesOffsets = o.trackedPropertiesPerThangValuesOffsets[thangIndex]\r\n      for type, propIndex in o.trackedPropertiesPerThangTypes[thangIndex]\r\n        [storage, bytesStored] = ThangState.createArrayForType type, nFrames, o.storageBuffer, storageBufferOffset\r\n        trackedPropertiesValues.push storage\r\n        trackedPropertiesValuesOffsets.push storageBufferOffset\r\n        ++transferableObjects if bytesStored\r\n        ++nontransferableObjects unless bytesStored\r\n        if typedArraySupport\r\n          storageBufferOffset += bytesStored\r\n        else\r\n          # Instead of one big array with each storage as a view into it, they're all separate, so let's keep 'em around for flattening.\r\n          storageBufferOffset += storage.length\r\n          o.storageBuffer.push storage\r\n\r\n    o.specialKeysToValues = [null, Infinity, NaN]\r\n    # Whatever is in specialKeysToValues index 0 will be default for anything missing, so let's make sure it's null.\r\n    # Don't think we can include undefined or it'll be treated as a sparse array; haven't tested performance.\r\n    o.specialValuesToKeys = {}\r\n    for specialValue, i in o.specialKeysToValues\r\n      o.specialValuesToKeys[specialValue] = i\r\n\r\n    t1 = now()\r\n    o.frameHashes = []\r\n    for frameIndex in [startFrame ... endFrame]\r\n      o.frameHashes.push @frames[frameIndex].serialize(frameIndex - startFrame, o.trackedPropertiesThangIDs, o.trackedPropertiesPerThangIndices, o.trackedPropertiesPerThangTypes, trackedPropertiesPerThangValues, o.specialValuesToKeys, o.specialKeysToValues)\r\n    t2 = now()\r\n\r\n    unless typedArraySupport\r\n      flattened = []\r\n      for storage in o.storageBuffer\r\n        for value in storage\r\n          flattened.push value\r\n      o.storageBuffer = flattened\r\n\r\n    #console.log 'Allocating memory:', (t1 - t0).toFixed(0), 'ms; assigning values:', (t2 - t1).toFixed(0), 'ms, so', ((t2 - t1) / nFrames).toFixed(3), 'ms per frame for', nFrames, 'frames'\r\n    #console.log 'Got', transferableObjects, 'transferable objects and', nontransferableObjects, 'nontransferable; stored', transferableStorageBytesNeeded, 'bytes transferably'\r\n\r\n    o.thangs = (t.serialize() for t in @thangs.concat(@extraneousThangs ? []))\r\n    o.scriptNotes = (sn.serialize() for sn in @scriptNotes)\r\n    if o.scriptNotes.length > 200\r\n      console.log 'Whoa, serializing a lot of WorldScriptNotes here:', o.scriptNotes.length\r\n    @freeMemoryAfterEachSerialization() unless @ended\r\n    {serializedWorld: o, transferableObjects: [o.storageBuffer], startFrame: startFrame, endFrame: endFrame}\r\n\r\n  @deserialize: (o, classMap, oldSerializedWorldFrames, finishedWorldCallback, startFrame, endFrame, level, streamingWorld) ->\r\n    # Code hotspot; optimize it\r\n    #console.log 'Deserializing', o, 'length', JSON.stringify(o).length\r\n    #console.log JSON.stringify(o)\r\n    #console.log 'Got special keys and values:', o.specialValuesToKeys, o.specialKeysToValues\r\n    perf = {}\r\n    perf.t0 = now()\r\n    nFrames = endFrame - startFrame\r\n    if streamingWorld\r\n      w = streamingWorld\r\n      # Make sure we get any Aether updates from the new frames into the already-deserialized streaming world Aethers.\r\n      for thangID, methods of o.userCodeMap\r\n        for methodName, serializedAether of methods\r\n          for aetherStateKey in ['flow', 'metrics', 'style', 'problems']\r\n            w.userCodeMap[thangID] ?= {}\r\n            w.userCodeMap[thangID][methodName] ?= {}\r\n            w.userCodeMap[thangID][methodName][aetherStateKey] = serializedAether[aetherStateKey]\r\n    else\r\n      w = new World o.userCodeMap, classMap\r\n    [w.totalFrames, w.maxTotalFrames, w.frameRate, w.dt, w.scriptNotes, w.victory, w.flagHistory, w.difficulty, w.scores, w.randomSeed, w.picoCTFFlag] = [o.totalFrames, o.maxTotalFrames, o.frameRate, o.dt, o.scriptNotes ? [], o.victory, o.flagHistory, o.difficulty, o.scores, o.randomSeed, o.picoCTFFlag]\r\n    w[prop] = val for prop, val of o.trackedProperties\r\n\r\n    perf.t1 = now()\r\n    if w.thangs.length\r\n      for thangConfig in o.thangs\r\n        if thang = w.thangMap[thangConfig.id]\r\n          for prop, val of thangConfig.finalState\r\n            thang[prop] = val\r\n        else\r\n          w.thangs.push thang = Thang.deserialize(thangConfig, w, classMap, level.levelComponents)\r\n          w.setThang thang\r\n    else\r\n      w.thangs = (Thang.deserialize(thang, w, classMap, level.levelComponents) for thang in o.thangs)\r\n      w.setThang thang for thang in w.thangs\r\n    w.scriptNotes = (WorldScriptNote.deserialize(sn, w, classMap) for sn in o.scriptNotes)\r\n    perf.t2 = now()\r\n\r\n    o.trackedPropertiesThangs = (w.getThangByID thangID for thangID in o.trackedPropertiesThangIDs)\r\n    o.trackedPropertiesPerThangValues = []\r\n    for trackedPropertyTypes, thangIndex in o.trackedPropertiesPerThangTypes\r\n      o.trackedPropertiesPerThangValues.push (trackedPropertiesValues = [])\r\n      trackedPropertiesValuesOffsets = o.trackedPropertiesPerThangValuesOffsets[thangIndex]\r\n      for type, propIndex in trackedPropertyTypes\r\n        storage = ThangState.createArrayForType(type, nFrames, o.storageBuffer, trackedPropertiesValuesOffsets[propIndex])[0]\r\n        unless typedArraySupport\r\n          # This could be more efficient\r\n          i = trackedPropertiesValuesOffsets[propIndex]\r\n          storage = o.storageBuffer.slice i, i + storage.length\r\n        trackedPropertiesValues.push storage\r\n    perf.t3 = now()\r\n\r\n    perf.batches = 0\r\n    perf.framesCPUTime = 0\r\n    w.frames = [] unless streamingWorld\r\n    clearTimeout @deserializationTimeout if @deserializationTimeout\r\n\r\n    if w.indefiniteLength\r\n      clearTo = Math.max(w.frames.length - 100, 0)\r\n      if clearTo > w.framesClearedSoFar\r\n        for i in _.range(w.framesClearedSoFar, clearTo)\r\n          w.frames[i] = null\r\n      w.framesClearedSoFar = clearTo\r\n\r\n    @deserializationTimeout = _.delay @deserializeSomeFrames, 1, o, w, finishedWorldCallback, perf, startFrame, endFrame\r\n    w  # Return in-progress deserializing world\r\n\r\n  # Spread deserialization out across multiple calls so the interface stays responsive\r\n  @deserializeSomeFrames: (o, w, finishedWorldCallback, perf, startFrame, endFrame) =>\r\n    ++perf.batches\r\n    startTime = now()\r\n    for frameIndex in [w.frames.length ... endFrame]\r\n      w.frames.push WorldFrame.deserialize(w, frameIndex - startFrame, o.trackedPropertiesThangIDs, o.trackedPropertiesThangs, o.trackedPropertiesPerThangKeys, o.trackedPropertiesPerThangTypes, o.trackedPropertiesPerThangValues, o.specialKeysToValues, o.frameHashes[frameIndex - startFrame], w.dt * frameIndex)\r\n      elapsed = now() - startTime\r\n      if elapsed > DESERIALIZATION_INTERVAL and frameIndex < endFrame - 1\r\n        #console.log \"  Deserialization not finished, let's do it again soon. Have:\", w.frames.length, \", wanted from\", startFrame, \"to\", endFrame\r\n        perf.framesCPUTime += elapsed\r\n        @deserializationTimeout = _.delay @deserializeSomeFrames, 1, o, w, finishedWorldCallback, perf, startFrame, endFrame\r\n        return\r\n    @deserializationTimeout = null\r\n    perf.framesCPUTime += elapsed\r\n    @finishDeserializing w, finishedWorldCallback, perf, startFrame, endFrame\r\n\r\n  @finishDeserializing: (w, finishedWorldCallback, perf, startFrame, endFrame) ->\r\n    perf.t4 = now()\r\n    w.ended = true\r\n    nFrames = endFrame - startFrame\r\n    totalCPUTime = perf.t3 - perf.t0 + perf.framesCPUTime\r\n    #console.log 'Deserialization:', totalCPUTime.toFixed(0) + 'ms (' + (totalCPUTime / nFrames).toFixed(3) + 'ms per frame).', perf.batches, 'batches. Did', startFrame, 'to', endFrame, 'in', (perf.t4 - perf.t0).toFixed(0) + 'ms wall clock time.'\r\n    if false\r\n      console.log '  Deserializing--constructing new World:', (perf.t1 - perf.t0).toFixed(2) + 'ms'\r\n      console.log '  Deserializing--Thangs and ScriptNotes:', (perf.t2 - perf.t1).toFixed(2) + 'ms'\r\n      console.log '  Deserializing--reallocating memory:', (perf.t3 - perf.t2).toFixed(2) + 'ms'\r\n      console.log '  Deserializing--WorldFrames:', (perf.t4 - perf.t3).toFixed(2) + 'ms wall clock time,', (perf.framesCPUTime).toFixed(2) + 'ms CPU time'\r\n    finishedWorldCallback w\r\n\r\n  findFirstChangedFrame: (oldWorld) ->\r\n    return 0 unless oldWorld\r\n    for newFrame, i in @frames\r\n      oldFrame = oldWorld.frames[i]\r\n      break unless oldFrame and ((newFrame.hash is oldFrame.hash) or not newFrame.hash? or not oldFrame.hash?)  # undefined gets in there when streaming at the last frame of each batch for some reason\r\n    firstChangedFrame = i\r\n    if @frames.length is @totalFrames\r\n      if @frames[i]\r\n        console.log 'First changed frame is', firstChangedFrame, 'with hash', @frames[i].hash, 'compared to', oldWorld.frames[i]?.hash\r\n      else\r\n        console.log 'No frames were changed out of all', @frames.length\r\n    firstChangedFrame\r\n\r\n  freeMemoryBeforeFinalSerialization: ->\r\n    @levelComponents = null\r\n    @thangTypes = null\r\n\r\n  freeMemoryAfterEachSerialization: ->\r\n    @frames[i] = null for frame, i in @frames when i < @frames.length - 1\r\n\r\n  pointsForThang: (thangID, camera=null) ->\r\n    # Optimized\r\n    @pointsForThangCache ?= {}\r\n    cacheKey = thangID\r\n    allPoints = @pointsForThangCache[cacheKey]\r\n    unless allPoints\r\n      allPoints = []\r\n      lastFrameIndex = @frames.length - 1\r\n      lastPos = x: null, y: null\r\n      for frameIndex in [lastFrameIndex .. 0] by -1\r\n        frame = @frames[frameIndex]\r\n        continue unless frame # may have been evicted for game dev levels\r\n        if pos = frame.thangStateMap[thangID]?.getStateForProp 'pos'\r\n          pos = camera.worldToSurface {x: pos.x, y: pos.y} if camera  # without z\r\n          if not lastPos.x? or (Math.abs(lastPos.x - pos.x) + Math.abs(lastPos.y - pos.y)) > 1\r\n            lastPos = pos\r\n        allPoints.push lastPos.y, lastPos.x unless lastPos.y is 0 and lastPos.x is 0\r\n      allPoints.reverse()\r\n      @pointsForThangCache[cacheKey] = allPoints\r\n\r\n    return allPoints\r\n\r\n  actionsForThang: (thangID, keepIdle=false) ->\r\n    # Optimized\r\n    @actionsForThangCache ?= {}\r\n    cacheKey = thangID + '_' + Boolean(keepIdle)\r\n    cached = @actionsForThangCache[cacheKey]\r\n    return cached if cached\r\n    states = (frame.thangStateMap[thangID] for frame in @frames)\r\n    actions = []\r\n    lastAction = ''\r\n    for state, i in states\r\n      action = state?.getStateForProp 'action'\r\n      continue unless action and (action isnt lastAction or state.actionActivated)\r\n      continue unless state.action isnt 'idle' or keepIdle\r\n      actions.push {frame: i, pos: state.pos, name: action}\r\n      lastAction = action\r\n    @actionsForThangCache[cacheKey] = actions\r\n    return actions\r\n\r\n  getTeamColors: ->\r\n    teamConfigs = @teamConfigs or {}\r\n    colorConfigs = {}\r\n    colorConfigs[teamName] = config.color for teamName, config of teamConfigs\r\n    colorConfigs\r\n\r\n  teamForPlayer: (n) ->\r\n    playableTeams = @playableTeams ? ['humans']\r\n    playableTeams[n % playableTeams.length]\r\n\r\n  getScores: ->\r\n    time: @age\r\n    'damage-taken': @getSystem('Combat')?.damageTakenForTeam 'humans'\r\n    'damage-dealt': @getSystem('Combat')?.damageDealtForTeam 'humans'\r\n    'gold-collected': @getSystem('Inventory')?.teamGold.humans?.collected\r\n    'difficulty': @difficulty\r\n"]}