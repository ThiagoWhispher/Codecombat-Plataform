{"version":3,"sources":["app/lib/AudioPlayer.coffee"],"names":[],"mappings":";AAAA;EAAA;;;;;AAAA,YAAY,QAAQ,gBAAR;;AACZ,QAAQ;;AACP,KAAM,QAAQ,WAAR,EAAN;;AAID,QAAQ,SAAC,CAAD;SAAO,CAAC,CAAC,OAAF,CAAU,QAAV,EAAoB,SAAC,CAAD;WAAO,MAAM,CAAC,YAAP,CAAoB,CAAC,CAAC,UAAF,CAAa,CAAb,IAAkB,CAAI,CAAC,CAAC,WAAF,MAAmB,GAAtB,GAA+B,EAA/B,GAAuC,CAAC,EAAzC,CAAtC;EAAP,CAApB;AAAP;;AACR;;AAAU;AAAA;OAAA;;iBAAA,MAAM,CAAN;AAAA;;;;AAIV,IAAG,4BAAH;EACE,eAAe,CAAC,QAAQ,CAAC,cAAV,EAA0B,QAAQ,CAAC,WAAnC,EAAgD,QAAQ,CAAC,eAAzD,EADjB;CAAA;EAGE,eAAe,CAAC,QAAQ,CAAC,cAAV,EAA0B,QAAQ,CAAC,eAAnC,EAHjB;;;AAIA,QAAQ,CAAC,KAAK,CAAC,eAAf,CAA+B,YAA/B;;AAEM;EACS;IAAG,IAAC,QAAD,GAAW;EAAd;;qBAEb,MAAK,SAAC,QAAD,EAAW,KAAX;AACH;;MADc,QAAM;;IACpB,OAAO,QAAQ;IACf,IAA4B,2BAA5B;MAAA,IAAC,QAAQ,OAAT,GAAkB,GAAlB;;IACA,IAAU,aAAY,IAAC,QAAQ,OAArB,gBAAV;AAAA;;WACA,IAAC,QAAQ,OAAM,CAAC,IAAhB,CAAqB,QAArB;EAJG;;qBAML,kBAAiB,SAAC,QAAD;WAAc,IAAC,IAAD,CAAK,QAAL,EAAe,eAAf;EAAd;;qBACjB,oBAAmB,SAAC,QAAD;WAAc,IAAC,IAAD,CAAK,QAAL,EAAe,iBAAf;EAAd;;qBACnB,UAAS;AAAG,WAAO,IAAC;EAAX;;;;;;AAEL;EACS,eAAC,IAAD;IAAU,IAAgB,IAAhB;MAAA,IAAC,KAAD,GAAQ,KAAR;;EAAV;;kBAEb,SAAQ;;kBACR,OAAM;;kBACN,WAAU;;kBACV,QAAO;;kBACP,OAAM;;;;;;AAEF;;;wBACJ,gBACE;IAAA,2BAA2B,SAAC,CAAD;aAAO,IAAC,mBAAD,CAAoB,CAAC,CAAC,OAAtB,EAA+B,CAAC,CAAC,MAAjC;IAAP,CAA3B;;;EAEW;;;IACX;IACA,IAAC,IAAD,GAAU,QAAQ,CAAC,KAAK,CAAC,aAAf,CAA6B,KAA7B,CAAH,GAA4C,MAA5C,GAAwD;IAC/D,IAAC,OAAD,GAAU;IACV,IAAC,cAAD;IACA,IAAC,kBAAD;IACA,IAAC,uBAAD,GAA0B;EANf;;wBAQb,oBAAmB;WACjB,IAAC,SAAD,GAAgB;EADC;;wBAGnB,gBAAe;WAIb,QAAQ,CAAC,KAAK,CAAC,EAAf,CAAkB,UAAlB,EAA8B,IAAC,cAA/B;EAJa;;wBAMf,eAAc,SAAC,OAAD,EAAU,GAAV;AACZ;IAAA,MAAM,IAAC,OAAM,CAAC,cAAR,CAAuB,GAAvB;IACN,MAAM,IAAC,OAAM,CAAC;IACd,MAAM,IAAI,CAAC,GAAL,CAAS,CAAC,CAAV,EAAa,IAAI,CAAC,GAAL,CAAS,CAAT,EAAY,CAAC,CAAC,GAAG,CAAC,CAAJ,GAAQ,GAAG,CAAC,CAAb,IAAkB,GAAG,CAAC,KAAJ,GAAY,CAA/B,IAAoC,GAAG,CAAC,KAApD,CAAb;IACN,IAAW,CAAC,CAAC,KAAF,CAAQ,GAAR,CAAX;MAAA,MAAM,EAAN;;IACA,MAAM,IAAC,OAAM,CAAC,eAAR,CAAwB,GAAxB;IACN,IAAa,CAAC,CAAC,KAAF,CAAQ,GAAR,CAAb;MAAA,MAAM,IAAN;;IACA,MAAM,IAAI,CAAC,GAAL,CAAS,CAAT,EAAY,OAAO,CAAC,MAAR,GAAiB,IAAI,CAAC,GAAL,CAAU,MAAM,GAAhB,EAAsB,CAAtB,CAA7B;WACN;MAAA,QAAQ,OAAO,CAAC,MAAhB;MAAwB,OAAO,OAAO,CAAC,KAAvC;MAA8C,KAAK,GAAnD;;EARY;;wBAYd,mBAAkB,SAAC,OAAD,EAAU,aAAV;AAChB;IAAA,IAAG,CAAC,CAAC,OAAF,CAAU,OAAV,CAAH;MAA0B,UAAU,OAAO,CAAC,IAAR,CAAa,GAAb,EAApC;;IACA,KAAsB,CAAC,CAAC,QAAF,CAAW,OAAX,CAAtB;AAAA,aAAO,QAAP;;IACA,KAAmB,+BAAM,aAAa,CAAE,YAArB,CAAnB;AAAA,aAAO,KAAP;;IACA,UAAU,CAAC,CAAC,MAAM,CAAC,OAAT,CAAiB,OAAjB;IACV,IAAgB,QAAQ,GAAI,SAA5B;AAAA,aAAO,MAAP;;IACA,IAAG,CAAC,CAAC,MAAM,CAAC,UAAT,CAAoB,OAApB,EAA6B,QAA7B,CAAH;MACE,IAAgB,QAAQ,GAAG,CAAC,MAA5B;AAAA,eAAO,MAAP;OADF;;IAEA,IAAG,OAAO,CAAC,OAAR,CAAgB,mBAAhB,MAA0C,CAAC,CAA9C;MACE,IAAgB,QAAQ,GAAI,qBAA5B;AAAA,eAAO,MAAP;OADF;;IAEA,IAAG,OAAO,CAAC,OAAR,CAAgB,WAAhB,MAAkC,CAAC,CAAtC;MACE,IAAgB,QAAQ,GAAI,aAA5B;AAAA,eAAO,MAAP;OADF;;IAEA,IAAG,OAAO,CAAC,OAAR,CAAgB,gBAAhB,MAAuC,CAAC,CAA3C;MACE,IAAgB,QAAQ,GAAI,kBAA5B;AAAA,eAAO,MAAP;OADF;;IAEA,IAAG,0BAA0B,CAAC,IAA3B,CAAgC,OAAhC,CAAH;MACE,IAAgB,QAAQ,GAAI,WAAQ,OAAQ,SAAhB,CAA5B;AAAA,eAAO,MAAP;OADF;;IAEA,WAAW,GAAG,CAAC;IACf,8CAAsB,CAAE,gBAArB,IAAgC,CAAC,CAAC,IAAF,CAAO,MAAP,EAAe,SAAC,CAAD;aAAO,OAAO,CAAC,MAAR,CAAe,CAAf,MAAuB,CAAC;IAA/B,CAAf,CAAnC;MACE,WAAW,GAAG,CAAC,gBADjB;;IAEA,yBAAmB,QAAQ,CAAE,gBAA7B;AAAA,aAAO,KAAP;;AACA,WAAO,QAAS,QAAO,CAAC,MAAR,GAAiB,QAAQ,CAAC,MAA1B;EApBA;;wBAsBlB,yBAAwB,SAAC,KAAD;AACtB;IAAA,KAAc,EAAE,CAAC,GAAH,CAAO,QAAP,CAAd;AAAA;;AACA;SAAA;;MACE,WAAW,qBAAmB,IAAnB,GAA0B,IAAC;mBACtC,IAAC,aAAD,CAAc,QAAd,EAAwB,IAAxB;AAFF;;EAFsB;;wBAMxB,qBAAoB,SAAC,IAAD,EAAO,MAAP;AAClB;;MADyB,SAAO;;IAChC,MAAc,UAAW,EAAE,CAAC,GAAH,CAAO,QAAP,CAAzB;AAAA;;IACA,WAAW,qBAAmB,IAAnB,GAA0B,IAAC;IACtC,IAAG,IAAC,eAAD,CAAgB,QAAhB,CAAH;aACE,IAAC,UAAD,CAAW,IAAX,EAAiB,MAAjB,EADF;KAAA;MAGE,MAAsC,YAAY,KAAlD;QAAA,IAAC,uBAAD,CAAwB,CAAC,IAAD,CAAxB;;aACA,IAAC,uBAAuB,MAAxB,GAAgC,OAJlC;;EAHkB;;wBASpB,YAAW,SAAC,IAAD,EAAO,MAAP,EAAiB,KAAjB,EAA0B,GAA1B;AACT;;MADgB,SAAO;;;MAAG,QAAM;;;MAAG,MAAI;;IACvC,KAA0D,IAA1D;AAAA,aAAO,OAAO,CAAC,KAAR,CAAc,6BAAd,EAAP;;IACA,MAAc,UAAW,EAAE,CAAC,GAAH,CAAO,QAAP,CAAzB;AAAA;;IACA,eAAe;MAAC,QAAQ,MAAT;MAAiB,OAAO,KAAxB;;IACf,WAAc,CAAC,CAAC,MAAM,CAAC,UAAT,CAAoB,IAApB,EAA0B,QAA1B,CAAH,GAA4C,IAA5C,GAAsD,WAAW;IAC5E,KAAO,IAAC,eAAD,CAAgB,QAAhB,CAAP;MACE,IAAC,uBAAuB,MAAxB,GAAgC,YAAY,CAAC,OAD/C;;IAEA,IAAkD,IAAC,OAAD,IAAY,CAAI,IAAC,OAAM,CAAC,SAAxB,IAAsC,GAAxF;MAAA,eAAe,IAAC,aAAD,CAAc,YAAd,EAA4B,GAA5B,EAAf;;IACA,WAAW,QAAQ,CAAC,KAAK,CAAC,IAAf,CAAoB,IAApB,EAA0B,YAA1B;WACX;EATS;;wBAWX,iBAAgB,SAAC,QAAD,EAAW,IAAX;IACd,MAAoB,YAAY,KAAhC;AAAA,aAAO,MAAP;;IACA,KAAoB,QAAQ,CAAC,KAAK,CAAC,YAAf,CAA4B,QAA5B,CAApB;AAAA,aAAO,MAAP;;WACA;EAHc;;wBAKhB,wBAAuB,SAAC,KAAD;AACrB;IAAA,KAAc,EAAE,CAAC,GAAH,CAAO,QAAP,CAAd;AAAA;;IACA,KAAc,QAAO,IAAC,sBAAD,CAAuB,KAAvB,CAAP,CAAd;AAAA;;IACA,WAAW,WAAW;IACtB,IAAC,aAAD,CAAc,QAAd,EAAwB,IAAxB;WACA;EALqB;;wBAOvB,wBAAuB,SAAC,KAAD;WACrB,KAAM,KAAC,IAAG,CAAC,KAAL,CAAW,CAAX;EADe;;wBAGvB,eAAc,SAAC,QAAD,EAAW,IAAX;AACZ;IAAA,KAAc,QAAd;AAAA;;IACA,IAAU,YAAY,KAAtB;AAAA;;;MACA,OAAQ;;IAER,SAAS,QAAQ,CAAC,KAAK,CAAC,aAAf,CAA6B,QAA7B,EAAuC,IAAvC,EAA6C,CAA7C;WACT,KAAM,UAAN,GAAsB,UAAM,IAAN;EANV;;wBAUd,gBAAe,SAAC,CAAD;AACb;IAAA,QAAQ,KAAM,EAAC,CAAC,GAAF;IACd,IAAU,CAAI,KAAd;AAAA;;IACA,KAAK,CAAC,MAAN,GAAe;IACf,KAAK,CAAC,QAAN,GAAiB;IACjB,IAAG,SAAS,IAAC,uBAAuB,MAAK,CAAC,IAAN,CAApC;MACE,IAAC,UAAD,CAAW,KAAK,CAAC,IAAjB,EAAuB,MAAvB;MACA,IAAC,uBAAuB,MAAK,CAAC,IAAN,CAAxB,GAAsC,MAFxC;;WAGA,IAAC,sBAAD;EARa;;wBAUf,mBAAkB,SAAC,CAAD;WAChB,OAAO,CAAC,KAAR,CAAc,sBAAd,EAAsC,CAAtC;EADgB;;wBAGlB,wBAAuB;WACrB,QAAQ,CAAC,QAAQ,CAAC,OAAlB,CAA0B,qBAA1B,EAAiD;MAAC,QAAQ,IAAT;KAAjD;EADqB;;wBAGvB,YAAW,SAAC,GAAD;AACT,WAAO,KAAM,KAAN,IAAc;EADZ;;;;GA1Ha;;AA8H1B,MAAM,CAAC,OAAP,GAAqB","file":"public/javascripts/app/lib/AudioPlayer.js","sourcesContent":["CocoClass = require 'core/CocoClass'\r\ncache = {}\r\n{me} = require 'core/auth'\r\n\r\n# Top 20 obscene words (plus 'fiddlesticks') will trigger swearing Simlish with *beeps*.\r\n# Didn't like leaving so much profanity lying around in the source, so rot13'd.\r\nrot13 = (s) -> s.replace /[A-z]/g, (c) -> String.fromCharCode c.charCodeAt(0) + (if c.toUpperCase() <= 'M' then 13 else -13)\r\nswears = (rot13 s for s in ['nefrubyr', 'nffubyr', 'onfgneq', 'ovgpu', 'oybbql', 'obyybpxf', 'ohttre', 'pbpx', 'penc', 'phag', 'qnza', 'qnea', 'qvpx', 'qbhpur', 'snt', 'shpx', 'cvff', 'chffl', 'fuvg', 'fyhg', 'svqqyrfgvpxf'])\r\n\r\n# IE(11, 10, 9) throws an exception if createjs.FlashPlugin is undefined\r\n# Chrome and Firefox don't seem to care that it's undefined\r\nif createjs.FlashPlugin?\r\n  soundPlugins = [createjs.WebAudioPlugin, createjs.FlashPlugin, createjs.HTMLAudioPlugin]\r\nelse\r\n  soundPlugins = [createjs.WebAudioPlugin, createjs.HTMLAudioPlugin]\r\ncreatejs.Sound.registerPlugins(soundPlugins)\r\n\r\nclass Manifest\r\n  constructor: -> @storage = {}\r\n\r\n  add: (filename, group='misc') ->\r\n    name = name or filename\r\n    @storage[group] = [] unless @storage[group]?\r\n    return if filename in @storage[group]\r\n    @storage[group].push(filename)\r\n\r\n  addPrimarySound: (filename) -> @add(filename, 'primarySounds')\r\n  addSecondarySound: (filename) -> @add(filename, 'secondarySounds')\r\n  getData: -> return @storage\r\n\r\nclass Media\r\n  constructor: (name) -> @name = name if name\r\n\r\n  loaded: false\r\n  data: null\r\n  progress: 0.0\r\n  error: null\r\n  name: ''\r\n\r\nclass AudioPlayer extends CocoClass\r\n  subscriptions:\r\n    'audio-player:play-sound': (e) -> @playInterfaceSound e.trigger, e.volume\r\n\r\n  constructor: () ->\r\n    super()\r\n    @ext = if createjs.Sound.getCapability('mp3') then '.mp3' else '.ogg'\r\n    @camera = null\r\n    @listenToSound()\r\n    @createNewManifest()\r\n    @soundsToPlayWhenLoaded = {}\r\n\r\n  createNewManifest: ->\r\n    @manifest = new Manifest()\r\n\r\n  listenToSound: ->\r\n    # I would like to go through PreloadJS to organize loading by queue, but\r\n    # when I try to set it up, I get an error with the Sound plugin.\r\n    # So for now, we'll just load through SoundJS instead.\r\n    createjs.Sound.on 'fileload', @onSoundLoaded\r\n\r\n  applyPanning: (options, pos) ->\r\n    sup = @camera.worldToSurface pos\r\n    svp = @camera.surfaceViewport\r\n    pan = Math.max -1, Math.min 1, ((sup.x - svp.x) - svp.width / 2) / svp.width\r\n    pan = 0 if _.isNaN pan\r\n    dst = @camera.distanceRatioTo pos\r\n    dst = 0.8 if _.isNaN dst\r\n    vol = Math.min 1, options.volume / Math.pow (dst + 0.2), 2\r\n    volume: options.volume, delay: options.delay, pan: pan\r\n\r\n  # PUBLIC LOADING METHODS\r\n\r\n  soundForDialogue: (message, soundTriggers) ->\r\n    if _.isArray message then message = message.join ' '\r\n    return message unless _.isString message\r\n    return null unless say = soundTriggers?.say\r\n    message = _.string.slugify message\r\n    return sound if sound = say[message]\r\n    if _.string.startsWith message, 'attack'\r\n      return sound if sound = say.attack\r\n    if message.indexOf(\"i-dont-see-anyone\") isnt -1\r\n      return sound if sound = say['i-dont-see-anyone']\r\n    if message.indexOf(\"i-see-you\") isnt -1\r\n      return sound if sound = say['i-see-you']\r\n    if message.indexOf(\"repeating-loop\") isnt -1\r\n      return sound if sound = say['repeating-loop']\r\n    if /move(up|down|left|right)/.test message\r\n      return sound if sound = say[\"move-#{message[4...]}\"]\r\n    defaults = say.defaultSimlish\r\n    if say.swearingSimlish?.length and _.find(swears, (s) -> message.search(s) isnt -1)\r\n      defaults = say.swearingSimlish\r\n    return null unless defaults?.length\r\n    return defaults[message.length % defaults.length]\r\n\r\n  preloadInterfaceSounds: (names) ->\r\n    return unless me.get 'volume'\r\n    for name in names\r\n      filename = \"/file/interface/#{name}#{@ext}\"\r\n      @preloadSound filename, name\r\n\r\n  playInterfaceSound: (name, volume=1) ->\r\n    return unless volume and me.get 'volume'\r\n    filename = \"/file/interface/#{name}#{@ext}\"\r\n    if @hasLoadedSound filename\r\n      @playSound name, volume\r\n    else\r\n      @preloadInterfaceSounds [name] unless filename of cache\r\n      @soundsToPlayWhenLoaded[name] = volume\r\n\r\n  playSound: (name, volume=1, delay=0, pos=null) ->\r\n    return console.error 'Trying to play empty sound?' unless name\r\n    return unless volume and me.get 'volume'\r\n    audioOptions = {volume: volume, delay: delay}\r\n    filename = if _.string.startsWith(name, '/file/') then name else '/file/' + name\r\n    unless @hasLoadedSound filename\r\n      @soundsToPlayWhenLoaded[name] = audioOptions.volume\r\n    audioOptions = @applyPanning audioOptions, pos if @camera and not @camera.destroyed and pos\r\n    instance = createjs.Sound.play name, audioOptions\r\n    instance\r\n\r\n  hasLoadedSound: (filename, name) ->\r\n    return false unless filename of cache\r\n    return false unless createjs.Sound.loadComplete filename\r\n    true\r\n\r\n  preloadSoundReference: (sound) ->\r\n    return unless me.get 'volume'\r\n    return unless name = @nameForSoundReference sound\r\n    filename = '/file/' + name\r\n    @preloadSound filename, name\r\n    filename\r\n\r\n  nameForSoundReference: (sound) ->\r\n    sound[@ext.slice(1)]  # mp3 or ogg\r\n\r\n  preloadSound: (filename, name) ->\r\n    return unless filename\r\n    return if filename of cache\r\n    name ?= filename\r\n    # SoundJS flips out if you try to register the same file twice\r\n    result = createjs.Sound.registerSound(filename, name, 1)  # 1: 1 channel\r\n    cache[filename] = new Media(name)\r\n\r\n  # PROGRESS CALLBACKS\r\n\r\n  onSoundLoaded: (e) =>\r\n    media = cache[e.src]\r\n    return if not media\r\n    media.loaded = true\r\n    media.progress = 1.0\r\n    if volume = @soundsToPlayWhenLoaded[media.name]\r\n      @playSound media.name, volume\r\n      @soundsToPlayWhenLoaded[media.name] = false\r\n    @notifyProgressChanged()\r\n\r\n  onSoundLoadError: (e) =>\r\n    console.error 'Could not load sound', e\r\n\r\n  notifyProgressChanged: ->\r\n    Backbone.Mediator.publish('audio-player:loaded', {sender: @})\r\n\r\n  getStatus: (src) ->\r\n    return cache[src] or null\r\n\r\n\r\nmodule.exports = new AudioPlayer()\r\n"]}