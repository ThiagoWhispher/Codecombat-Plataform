{"version":3,"sources":["app/lib/surface/SegmentedSprite.coffee"],"names":[],"mappings":"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","file":"public/javascripts/app/lib/surface/SegmentedSprite.js","sourcesContent":["SpriteBuilder = require 'lib/sprites/SpriteBuilder'\r\n\r\n# Put this on MovieClips\r\nspecialGoToAndStop = (frame) ->\r\n  if frame is @currentFrame and @childrenCopy\r\n    @addChild(@childrenCopy...)\r\n  else\r\n    @gotoAndStop(frame)\r\n    @childrenCopy = @children.slice(0)\r\n\r\nmodule.exports = class SegmentedSprite extends createjs.SpriteContainer\r\n  childMovieClips: null\r\n\r\n  constructor: (@spriteSheet, @thangType, @spriteSheetPrefix, @resolutionFactor=SPRITE_RESOLUTION_FACTOR) ->\r\n    @spriteSheet.mcPool ?= {}\r\n    super(@spriteSheet)\r\n    @addEventListener 'tick', @handleTick\r\n\r\n  destroy: ->\r\n    @handleTick = undefined\r\n    @baseMovieClip.inUse = false if @baseMovieClip\r\n    @removeAllEventListeners()\r\n\r\n  # CreateJS.Sprite-like interface\r\n\r\n  play: -> @paused = false unless @baseMovieClip and @animLength > 1\r\n  stop: -> @paused = true\r\n  gotoAndPlay: (actionName) -> @goto(actionName, false)\r\n  gotoAndStop: (actionName) -> @goto(actionName, true)\r\n\r\n  goto: (actionName, @paused=true) ->\r\n    @removeAllChildren()\r\n    @currentAnimation = actionName\r\n    @baseMovieClip.inUse = false if @baseMovieClip\r\n    if @childMovieClips\r\n      mc.inUse = false for mc in @childMovieClips\r\n    @childMovieClips = @baseMovieClip = @framerate = @animLength = null\r\n    @actionNotSupported = false\r\n\r\n    action = @thangType.getActions()[actionName]\r\n    randomStart = _.string.startsWith(actionName, 'move')\r\n\r\n    # because the resulting segmented image is set to the size of the movie clip, you can use\r\n    # the raw registration data without scaling it.\r\n    reg = action.positions?.registration or @thangType.get('positions')?.registration or {x:0, y:0}\r\n\r\n    if action.animation\r\n      @regX = -reg.x\r\n      @regY = -reg.y\r\n      @framerate = (action.framerate ? 20) * (action.speed ? 1)\r\n      @childMovieClips = []\r\n      @baseMovieClip = @buildMovieClip(action.animation)\r\n      @baseMovieClip.inUse = true\r\n      @frames = action.frames\r\n      @frames = (parseInt(f) for f in @frames.split(',')) if @frames\r\n      @animLength = if @frames then @frames.length else @baseMovieClip.timeline.duration\r\n      @paused = true if @animLength is 1\r\n\r\n      if @frames\r\n        if randomStart\r\n          @currentFrame = @frames[_.random(@frames.length - 1)]\r\n        else\r\n          @currentFrame = @frames[0]\r\n      else\r\n        if randomStart\r\n          @currentFrame = then Math.floor(Math.random() * @animLength)\r\n        else\r\n          @currentFrame = 0\r\n\r\n      @baseMovieClip.specialGoToAndStop(@currentFrame)\r\n      for movieClip in @childMovieClips\r\n        if movieClip.mode is 'single'\r\n          movieClip.specialGoToAndStop(movieClip.startPosition)\r\n        else\r\n          movieClip.specialGoToAndStop(@currentFrame)\r\n\r\n      @takeChildrenFromMovieClip(@baseMovieClip, @)\r\n      @loop = action.loops isnt false\r\n      @goesTo = action.goesTo\r\n      @notifyActionNeedsRender(action) if @actionNotSupported\r\n      @scaleX = @scaleY = action.scale ? @thangType.get('scale') ? 1\r\n\r\n    else if action.container\r\n      # All transformations will be done to the child sprite\r\n      @regX = @regY = 0\r\n      @scaleX = @scaleY = 1\r\n\r\n      @childMovieClips = []\r\n      containerName = @spriteSheetPrefix + action.container\r\n      sprite = new createjs.Sprite(@spriteSheet)\r\n      sprite.gotoAndStop(containerName)\r\n      if sprite.currentFrame is 0 or @usePlaceholders\r\n        sprite.gotoAndStop(0)\r\n        @notifyActionNeedsRender(action)\r\n        bounds = @thangType.get('raw').containers[action.container].b\r\n        actionScale = (action.scale ? @thangType.get('scale') ? 1)\r\n        sprite.scaleX = actionScale * bounds[2] / (SPRITE_PLACEHOLDER_WIDTH * @resolutionFactor)\r\n        sprite.scaleY = actionScale * bounds[3] / (SPRITE_PLACEHOLDER_WIDTH * @resolutionFactor)\r\n        sprite.regX = (SPRITE_PLACEHOLDER_WIDTH * @resolutionFactor) * ((-reg.x - bounds[0]) / bounds[2])\r\n        sprite.regY = (SPRITE_PLACEHOLDER_WIDTH * @resolutionFactor) * ((-reg.y - bounds[1]) / bounds[3])\r\n      else\r\n        scale = @resolutionFactor * (action.scale ? @thangType.get('scale') ? 1)\r\n        sprite.regX = -reg.x * scale\r\n        sprite.regY = -reg.y * scale\r\n        sprite.scaleX = sprite.scaleY = 1 / @resolutionFactor\r\n      @children = []\r\n      @addChild(sprite)\r\n\r\n    else if action.goesTo\r\n      @goto(action.goesTo, @paused)\r\n      return\r\n\r\n    @scaleX *= -1 if action.flipX\r\n    @scaleY *= -1 if action.flipY\r\n    @baseScaleX = @scaleX\r\n    @baseScaleY = @scaleY\r\n    return\r\n\r\n  notifyActionNeedsRender: (action) ->\r\n    @lank?.trigger('action-needs-render', @lank, action)\r\n\r\n  buildMovieClip: (animationName, mode, startPosition, loops) ->\r\n    key = JSON.stringify([@spriteSheetPrefix].concat(arguments))\r\n    @spriteSheet.mcPool[key] ?= []\r\n    for mc in @spriteSheet.mcPool[key]\r\n      if not mc.inUse\r\n        mc.gotoAndStop(mc.currentFrame+0.01) # just to make sure it has its children back\r\n        @childMovieClips = mc.childMovieClips\r\n        return mc\r\n\r\n    raw = @thangType.get('raw')\r\n    animData = raw.animations[animationName]\r\n    @lastAnimData = animData\r\n\r\n    locals = {}\r\n    _.extend locals, @buildMovieClipContainers(animData.containers)\r\n    _.extend locals, @buildMovieClipAnimations(animData.animations)\r\n\r\n    toSkip = {}\r\n    toSkip[shape.bn] = true for shape in animData.shapes\r\n    toSkip[graphic.bn] = true for graphic in animData.graphics\r\n\r\n    anim = new createjs.MovieClip()\r\n    anim.initialize(mode ? createjs.MovieClip.INDEPENDENT, startPosition ? 0, loops ? true)\r\n    anim.specialGoToAndStop = specialGoToAndStop\r\n\r\n    for tweenData, i in animData.tweens\r\n      stopped = false\r\n      tween = createjs.Tween\r\n      for func in tweenData\r\n        args = $.extend(true, [], (func.a))\r\n        if @dereferenceArgs(args, locals, toSkip) is false\r\n#          console.debug 'Did not dereference args:', args\r\n          stopped = true\r\n          break\r\n        if tween[func.n]\r\n          tween = tween[func.n](args...)\r\n        else\r\n          # If we, say, skipped a shadow get(), then the wait() may not be present\r\n          stopped = true\r\n          break\r\n      continue if stopped\r\n      anim.timeline.addTween(tween)\r\n\r\n    anim.nominalBounds = new createjs.Rectangle(animData.bounds...)\r\n    if animData.frameBounds\r\n      anim.frameBounds = (new createjs.Rectangle(bounds...) for bounds in animData.frameBounds)\r\n\r\n    anim.childMovieClips = @childMovieClips\r\n\r\n    @spriteSheet.mcPool[key].push(anim)\r\n    return anim\r\n\r\n  buildMovieClipContainers: (localContainers) ->\r\n    map = {}\r\n    for localContainer in localContainers\r\n      outerContainer = new createjs.SpriteContainer(@spriteSheet)\r\n      innerContainer = new createjs.Sprite(@spriteSheet)\r\n      innerContainer.gotoAndStop(@spriteSheetPrefix + localContainer.gn)\r\n      if innerContainer.currentFrame is 0 or @usePlaceholders\r\n        innerContainer.gotoAndStop(0)\r\n        @actionNotSupported = true\r\n        bounds = @thangType.get('raw').containers[localContainer.gn].b\r\n        innerContainer.x = bounds[0]\r\n        innerContainer.y = bounds[1]\r\n        innerContainer.scaleX = bounds[2] / (SPRITE_PLACEHOLDER_WIDTH * @resolutionFactor)\r\n        innerContainer.scaleY = bounds[3] / (SPRITE_PLACEHOLDER_WIDTH * @resolutionFactor)\r\n      else\r\n        innerContainer.scaleX = innerContainer.scaleY = 1 / (@resolutionFactor * (@thangType.get('scale') or 1))\r\n      outerContainer.addChild(innerContainer)\r\n      outerContainer.setTransform(localContainer.t...)\r\n      outerContainer._off = localContainer.o if localContainer.o?\r\n      outerContainer.alpha = localContainer.al if localContainer.al?\r\n      map[localContainer.bn] = outerContainer\r\n    return map\r\n\r\n  buildMovieClipAnimations: (localAnimations) ->\r\n    map = {}\r\n    for localAnimation in localAnimations\r\n      animation = @buildMovieClip(localAnimation.gn, localAnimation.a...)\r\n      animation.inUse = true\r\n      animation.setTransform(localAnimation.t...)\r\n      map[localAnimation.bn] = animation\r\n      @childMovieClips.push(animation)\r\n    return map\r\n\r\n  dereferenceArgs: (args, locals, toSkip) ->\r\n    for key, val of args\r\n      if locals[val]\r\n        args[key] = locals[val]\r\n      else if val is null\r\n        args[key] = {}\r\n      else if _.isString(val) and val.indexOf('createjs.') is 0\r\n        args[key] = eval(val) # TODO: Security risk\r\n      else if _.isObject(val) or _.isArray(val)\r\n        res = @dereferenceArgs(val, locals, toSkip)\r\n        return res if res is false\r\n      else if _.isString(val) and toSkip[val]\r\n        return false\r\n    return args\r\n\r\n  handleTick: (e) =>\r\n    if @lastTimeStamp\r\n      @tick(e.timeStamp - @lastTimeStamp)\r\n    @lastTimeStamp = e.timeStamp\r\n\r\n  tick: (delta) ->\r\n    return if @paused or not @baseMovieClip\r\n    return @paused = true if @animLength is 1\r\n    newFrame = @currentFrame + @framerate * delta / 1000\r\n\r\n    if newFrame > @animLength\r\n      if @goesTo\r\n        @gotoAndPlay(@goesTo)\r\n        return\r\n      else if not @loop\r\n        @paused = true\r\n        newFrame = @animLength - 1\r\n        _.defer => @dispatchEvent('animationend')\r\n      else\r\n        newFrame = newFrame % @animLength\r\n\r\n    translatedFrame = newFrame\r\n\r\n    if @frames\r\n      prevFrame = Math.floor(newFrame)\r\n      nextFrame = Math.ceil(newFrame)\r\n      if prevFrame is nextFrame\r\n        translatedFrame = @frames[newFrame]\r\n      else if nextFrame is @frames.length\r\n        translatedFrame = @frames[prevFrame]\r\n      else\r\n        # interpolate between frames\r\n        pct = newFrame % 1\r\n        newFrameIndex = @frames[prevFrame] + (pct * (@frames[nextFrame] - @frames[prevFrame]))\r\n        translatedFrame = newFrameIndex\r\n\r\n    @currentFrame = newFrame\r\n    return if translatedFrame is @baseMovieClip.currentFrame\r\n\r\n    @baseMovieClip.specialGoToAndStop(translatedFrame)\r\n    for movieClip in @childMovieClips\r\n      movieClip.specialGoToAndStop(if movieClip.mode is 'single' then movieClip.startPosition else newFrame)\r\n\r\n    @children = []\r\n    @takeChildrenFromMovieClip(@baseMovieClip, @)\r\n\r\n  takeChildrenFromMovieClip: (movieClip, recipientContainer) ->\r\n    for child in movieClip.childrenCopy\r\n      if child instanceof createjs.MovieClip\r\n        childRecipient = new createjs.SpriteContainer(@spriteSheet)\r\n        @takeChildrenFromMovieClip(child, childRecipient)\r\n        for prop in ['regX', 'regY', 'rotation', 'scaleX', 'scaleY', 'skewX', 'skewY', 'x', 'y']\r\n          childRecipient[prop] = child[prop]\r\n        recipientContainer.addChild(childRecipient)\r\n      else\r\n        recipientContainer.addChild(child)\r\n\r\n\r\n#  _getBounds: createjs.SpriteContainer.prototype.getBounds\r\n#  getBounds: -> @baseMovieClip?.getBounds() or @children[0]?.getBounds() or @_getBounds()\r\n"]}