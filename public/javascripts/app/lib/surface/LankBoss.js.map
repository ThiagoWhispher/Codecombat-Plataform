{"version":3,"sources":["app/lib/surface/LankBoss.coffee"],"names":[],"mappings":";AAAA;EAAA;;;;AAAA,YAAY,QAAQ,gBAAR;;AACX,KAAM,QAAQ,WAAR,EAAN;;AACD,eAAe,QAAQ,gBAAR;;AACf,WAAW,QAAQ,sBAAR;;AACX,OAAO,QAAQ,kBAAR;;AACP,OAAO,QAAQ,QAAR;;AACP,OAAO,QAAQ,gBAAR;;AACP,QAAQ,QAAQ,YAAR;;AAER,MAAM,CAAC,OAAP,GAAuB;;;qBACrB,gBACE;IAAA,mBAAmB,YAAnB;IACA,4BAA4B,oBAD5B;IAEA,4BAA4B,kBAF5B;IAGA,uBAAuB,gBAHvB;IAIA,mCAAmC,2BAJnC;IAKA,qBAAqB,iBALrB;IAMA,mBAAmB,kBANnB;IAOA,yBAAyB,YAPzB;IAQA,+BAA+B,YAR/B;IASA,kBAAkB,iBATlB;IAUA,iBAAiB;aAAG,IAAC,OAAD,CAAQ,IAAR;IAAH,CAVjB;IAWA,6BAA6B,qBAX7B;IAYA,sBAAsB,eAZtB;IAaA,yBAAyB,gBAbzB;IAcA,gCAAgC,sBAdhC;;;EAgBW,kBAAC,QAAD;AACX;IADY,IAAC,8BAAD,WAAS;IACrB;IACA,IAAC,aAAD,GAAgB,IAAC,QAAO,CAAC;IACzB,IAAC,YAAD,GAAe,IAAC,QAAO,CAAC;IACxB,IAAC,QAAD,GAAW;IACX,IAAC,OAAD,GAAU,IAAC,QAAO,CAAC;IACnB,IAAC,WAAD,GAAc,IAAC,QAAO,CAAC;IACvB,IAAC,iBAAD,GAAoB,IAAC,QAAO,CAAC;IAC7B,IAAC,MAAD,GAAS,IAAC,QAAO,CAAC;;UACV,CAAC,aAAc;;IACvB,IAAC,MAAD,GAAS;IACT,IAAC,UAAD,GAAa;IACb,IAAC,aAAD;IACA,IAAC,aAAD,GAAgB;IAChB,IAAG,CAAI,IAAC,aAAR;MACE,IAAC,SAAD,CAAU,IAAC,YAAX,EAAwB,iBAAxB,EAA2C,IAAC,iBAA5C,EADF;;EAdW;;qBAiBb,UAAS;AACP;AAAA;AAAA;;MAAA,IAAC,WAAD,CAAY,IAAZ;AAAA;;UACW,CAAE,OAAb;;;UACc,CAAE,OAAhB;;AACA;AAAA;;MAAA,SAAS,CAAC,OAAV;AAAA;WACA;EALO;;qBAOT,WAAU;WAAG,gBAAc,IAAC,UAAS,CAAC,MAAzB,GAAgC;EAAnC;;qBAEV,eAAc,SAAC,IAAD;WACZ,CAAC,CAAC,IAAF,CAAO,IAAC,QAAO,CAAC,UAAhB,EAA4B,SAAC,CAAD;aAAO,CAAC,CAAC,GAAF,CAAM,UAAN,MAAqB,IAArB,IAA6B,CAAC,CAAC,GAAF,CAAM,MAAN,MAAiB;IAArD,CAA5B;EADY;;qBAGd,eAAc;AACZ;IAAA,IAAC,cAAD,GAAiB;AACjB;AAAA;qBAAK,gBAAM;MAQT,IAAC,cAAc,MAAf,GAA2B,iBAAa;QAAA,MAAM,IAAN;QAAY,OAAO,IAAnB;QAAyB,eAAe,QAAxC;QAAkD,WAAW,YAAY,CAAC,iBAA1E;QAA6F,QAAQ,IAAC,OAAtG;OAAb;AAR7B;WASA,YAAC,WAAD,CAAW,CAAC,QAAZ;;AAAsB;AAAA;WAAA;;qBAAA,SAAS,CAAC;AAAV;;iBAAtB;EAXY;;qBAad,gBAAe,SAAC,KAAD,EAAQ,IAAR;AACb;IAAA,IAAO,2BAAP;MACE,IAAG,uBAAQ,IAAI,CAAE,cAAjB;QACE,KAAK,CAAC,aAAN,GAAsB,KAAK,CAAC;QAC5B,IAA4B,KAAK,CAAC,YAAlC;;YAAA,KAAK,CAAC,gBAAiB;WAAvB;;QACA,IAA8B,KAAK,CAAC,MAApC;;YAAA,KAAK,CAAC,gBAAiB,CAAC;WAAxB;SAHF;OADF;;;MAKA,KAAK,CAAC,gBAAiB;;IACvB,KAAwC,KAAK,CAAC,aAA9C;AAAA,aAAO,IAAC,cAAc,YAAtB;;IACA,QAAQ,CAAC,CAAC,QAAF,CAAW,IAAC,cAAZ,EAA2B,SAAC,KAAD,EAAQ,IAAR;aACjC,KAAK,CAAC,aAAN,IAAuB,KAAK,CAAC;IADI,CAA3B;IAER,IAAmC,KAAK,CAAC,aAAN,GAAsB,CAAC,EAA1D;;QAAA,QAAS,IAAC,cAAc;OAAxB;;2BACA,QAAQ,IAAC,cAAc;EAXV;;qBAaf,UAAS,SAAC,IAAD,EAAO,EAAP,EAAgB,KAAhB;AACP;;MADc,KAAG;;;MAAM,QAAM;;;MAC7B,KAAM,IAAI,CAAC,KAAK,CAAC;;IACjB,IAAqD,IAAC,MAAM,IAA5D;MAAA,OAAO,CAAC,KAAR,CAAc,+BAAd,EAA+C,EAA/C;;IACA,IAAC,MAAM,IAAP,GAAa;IACb,IAAC,UAAS,CAAC,IAAX,CAAgB,IAAhB;IACA,qCAAiD,CAAE,UAAU,CAAC,MAAvB,CAA8B,yCAA9B,gBAA8E,CAAC,CAAtH;;QAAA,QAAS,IAAC,cAAc;OAAxB;;;MACA,QAAS,IAAC,cAAD,CAAe,IAAI,CAAC,MAApB,EAA4B,IAA5B;;IACT,KAAK,CAAC,OAAN,CAAc,IAAd;IACA,KAAK,CAAC,gBAAN;WACA;EATO;;qBAWT,cAAa;IACX,IAAC,WAAD,GAAkB,SAAK;MAAA,MAAM,QAAN;MAAgB,QAAQ,IAAC,OAAzB;MAAiC,OAAO,IAAC,cAAc,UAAvD;MAAkE,WAAW,QAA7E;KAAL;WAClB,IAAC,cAAD,GAAqB,SAAK;MAAA,MAAM,WAAN;MAAmB,QAAQ,IAAC,OAA5B;MAAoC,OAAO,IAAC,cAAc,UAA1D;MAAqE,WAAW,WAAhF;KAAL;EAFV;;qBAIb,oBAAmB,SAAC,OAAD;WACjB,CAAC,CAAC,MAAF,CAAS,OAAT,EAAkB;MACf,QAAD,IAAC,OADe;MAEhB,kBAAkB,wBAFF;MAGhB,aAAa,IAAC,cAAc,UAHZ;MAIhB,WAAW,IAAC,iBAJI;MAKhB,eAAe,IAAC,cAAc,YALd;MAMhB,eAAe,IAAC,QAAO,CAAC,aANR;MAOf,aAAD,IAAC,YAPe;MAQf,cAAD,IAAC,aARe;KAAlB;EADiB;;qBAYnB,aAAY,SAAC,CAAD;AACV;IAAA,IAAU,CAAC,CAAC,KAAF,KAAW,IAAC,MAAtB;AAAA;;IACA,IAAC,MAAD,GAAS,CAAC,CAAC;AACX;AAAA;SAAA;;mBAAA,IAAI,CAAC,QAAL,CAAc,IAAC,MAAf;AAAA;;EAHU;;qBAKZ,qBAAoB,SAAC,CAAD;AAClB;IAAA,iBAAiB,CAAC,CAAC,QAAF,IAAc;AAC/B;AAAA;SAAA;;6DACE,IAAI,CAAC,aAAc,aAAW,cAAX,iBAA2B,CAAC,CAAC;AADlD;;EAFkB;;qBAKpB,kBAAiB,SAAC,KAAD,EAAQ,KAAR;AACf;;MADuB,QAAM;;IAC7B,IAAqF,IAAC,MAAM,MAAK,CAAC,EAAN,CAA5F;AAAA,aAAO,OAAO,CAAC,IAAR,CAAa,mDAAb,EAAkE,KAAK,CAAC,EAAxE,EAAP;;IACA,YAAY,CAAC,CAAC,IAAF,CAAO,IAAC,QAAO,CAAC,UAAhB,EAA4B,SAAC,CAAD;MACtC,MAAoB,CAAC,CAAC,GAAF,CAAM,SAAN,KAAoB,CAAC,CAAC,GAAF,CAAM,QAAN,CAAxC;AAAA,eAAO,MAAP;;AACA,aAAO,CAAC,CAAC,GAAF,CAAM,MAAN,MAAiB,KAAK,CAAC;IAFQ,CAA5B;;MAGZ,YAAa,CAAC,CAAC,IAAF,CAAO,IAAC,QAAO,CAAC,UAAhB,EAA4B,SAAC,CAAD;AAAO,eAAO,CAAC,CAAC,GAAF,CAAM,MAAN,MAAiB,KAAK,CAAC;MAArC,CAA5B;;IACb,KAAiE,SAAjE;AAAA,aAAO,OAAO,CAAC,KAAR,CAAc,6BAAd,EAA6C,KAA7C,EAAP;;IAEA,UAAU,IAAC,kBAAD,CAAmB;MAAA,OAAO,KAAP;KAAnB;IACV,OAAO,CAAC,gBAAR,GAA8B,SAAS,CAAC,GAAV,CAAc,MAAd,MAAyB,OAA5B,GAAyC,CAAzC,GAAgD;IAC3E,IAAG,IAAC,QAAO,CAAC,WAAT,IAAyB,kBAAkB,CAAC,IAAnB,CAAwB,KAAK,CAAC,EAA9B,CAA5B;MACE,OAAO,CAAC,UAAR,GAAqB,IAAC,QAAO,CAAC,WAAY,MAAK,CAAC,IAAN,EAD5C;;IAEA,OAAW,SAAK,SAAL,EAAgB,OAAhB;IACX,IAAC,SAAD,CAAU,IAAV,EAAgB,iBAAhB,EAAmC,IAAC,cAApC;IACA,IAAC,QAAD,CAAS,IAAT,EAAe,IAAf,EAAqB,KAArB;IACA,IAAI,CAAC,QAAL,CAAc,IAAC,MAAf;WACA;EAhBe;;qBAkBjB,aAAY,SAAC,IAAD;AACV;IAAA,IAAI,CAAC,KAAK,CAAC,UAAX,CAAsB,IAAtB;IACA,QAAQ,IAAI,CAAC;IACb,OAAO,IAAC,MAAM,KAAI,CAAC,KAAK,CAAC,EAAX;IACd,IAAC,UAAS,CAAC,MAAX,CAAkB,IAAC,UAAS,CAAC,OAAX,CAAmB,IAAnB,CAAlB,EAA4C,CAA5C;IACA,IAAC,cAAD,CAAe,IAAf;IACA,IAAI,CAAC,OAAL;WACA,IAAI,CAAC,KAAL,GAAa;EAPH;;qBASZ,eAAc;AACZ;AAAA;AAAA;SAAA;;mBAAA,IAAI,CAAC,UAAL;AAAA;;EADY;;qBAGd,SAAQ,SAAC,YAAD;AACN;IAAA,IAA0B,YAA1B;MAAA,IAAC,oBAAD;;AACA;AAAA;;MAAA,IAAI,CAAC,MAAL,CAAY,YAAZ;AAAA;IACA,IAAC,gBAAD;IACA,IAAC,cAAc,WAAU,CAAC,gBAA1B;WACA,IAAC,eAAD;EALM;;qBAOR,sBAAqB;AAEnB;IAAA,mBAAmB;IACnB,oBAAoB;AACpB;AAAA;;YAAgC,KAAK,CAAC,MAAN,IAAiB,KAAK,CAAC;;;MACrD,IAAqE,KAAK,CAAC,KAA3E;QAAA,oBAAoB,iBAAiB,CAAC,MAAlB,CAAyB,IAAC,cAAD,CAAe,KAAf,CAAzB,EAApB;;MACA,IAAG,OAAO,IAAC,MAAM,MAAK,CAAC,EAAN,CAAjB;QACE,IAAI,CAAC,QAAL,CAAc,KAAd,EADF;OAAA;QAGE,OAAO,IAAC,gBAAD,CAAiB,KAAjB;QACP,QAAQ,CAAC,QAAQ,CAAC,OAAlB,CAA0B,yBAA1B,EAAqD;UAAA,OAAO,KAAP;UAAc,QAAQ,IAAtB;SAArD;QACA,IAA8B,IAAI,CAAC,MAAM,CAAC,MAAZ,KAAsB,IAAC,cAAc,YAAnE;UAAA,gBAAgB,CAAC,IAAjB,CAAsB,IAAtB;;QACA,IAAI,CAAC,UAAL,GANF;;AAFF;AASA;;MAAA,IAAI,CAAC,WAAL;AAAA;AACA;AAAA;;MACE,UAAU,CAAI,CAAC,IAAI,CAAC,cAAL,yDAA+C,CAAE,gBAAlD;MACd,aAAa,IAAI,CAAC,MAAM,CAAC,MAAZ,KAAsB,IAAC,cAAc;MAClD,IAA8B,cAAe,CAAC,WAAW,IAAI,CAAC,QAAjB,CAA7C;QAAA,gBAAgB,CAAC,IAAjB,CAAsB,IAAtB;;MACA,IAAI,CAAC,QAAL,GAAgB;MAChB,IAAoB,OAApB;QAAA,IAAC,WAAD,CAAY,IAAZ;;AALF;IAMA,IAAoC,gBAAgB,CAAC,MAAjB,IAA4B,IAAC,gBAAjE;MAAA,IAAC,eAAD,CAAgB,gBAAhB;;IAGA,IAAG,IAAC,gBAAD,IAAqB,IAAC,MAAM,KAAC,gBAAgB,GAAjB,CAA/B;MACE,IAAC,YAAD,aAAa,IAAC,gBAAd,EADF;;WAGA,IAAC,mBAAD;EA1BmB;;qBA4BrB,qBAAoB;AAElB;IAAA,IAAc,EAAE,CAAC,GAAH,CAAO,MAAP,MAAkB,SAAhC;AAAA;;IACA,QAAQ,EAAE,gBAAF;IACR;;AAAU;AAAA;WAAA;;qBAAA,IAAI,CAAC;AAAL;;;IACV,OAAW,SAAK,MAAL,EAAa,IAAC,MAAK,CAAC,KAApB,EAA2B,IAAC,MAAK,CAAC,MAAlC,EAA0C,CAA1C,EAA6C,CAA7C,EAAgD,CAAhD,EAAmD,IAAnD;IACX,KAAK,CAAC,WAAN,CAAkB,KAAlB,EAAyB,IAAI,CAAC,QAAL,CAAc,IAAd,CAAzB;IACA,KAAK,CAAC,GAAN,CAAU,WAAV,EAAuB,SAAvB;IACA,YAAY,KAAK,CAAC,UAAN;IACZ,aAAa,KAAK,CAAC,WAAN;IACb,iBAAiB,KAAK,CAAC,MAAN,EAAc,CAAC,UAAf;IACjB,kBAAkB,KAAK,CAAC,MAAN,EAAc,CAAC,WAAf;IAClB,QAAQ,iBAAiB;IACzB,QAAQ,IAAI,CAAC,GAAL,CAAS,KAAT,EAAgB,kBAAkB,UAAlC;WACR,KAAK,CAAC,GAAN,CAAU,WAAV,EAAuB,WAAS,KAAT,GAAe,GAAtC;EAdkB;;qBAgBpB,gBAAe,SAAC,KAAD;AACb;IAAA,oBAAoB;IACpB,IAAG,KAAK,CAAC,KAAN,IAAgB,CAAI,KAAK,CAAC,QAA7B;MACE,KAAK,CAAC,KAAN;MACA,iBAAiB,CAAC,IAAlB,CAAuB,KAAvB,EAFF;;IAGA,IAAG,KAAK,CAAC,YAAT;AAEE;AAAA;;QACE,OAAO,IAAC,MAAK,CAAC,YAAP,CAAoB,MAApB;QACP,KAAO,IAAI,CAAC,QAAZ;UACE,KAAuG,IAAI,CAAC,KAA5G;YAAA,OAAO,CAAC,GAAR,CAAY,KAAK,CAAC,EAAlB,EAAsB,WAAtB,EAAmC,IAAnC,EAAyC,IAAzC,EAA+C,KAAK,CAAC,IAArD,EAA2D,oCAA3D;;;YACA,IAAI,CAAC;;UACL,IAA+B,IAAI,CAAC,KAApC;YAAA,iBAAiB,CAAC,IAAlB,CAAuB,IAAvB;WAHF;;AAFF,OAFF;;AAQA,WAAO;EAbM;;qBAef,iBAAgB,SAAC,gBAAD;AACd;;MADe,mBAAiB;;IAChC,IAAU,IAAC,gBAAD,IAAqB,CAAI,gBAAnC;AAAA;;IACA,YAAY,IAAC;IACb;;AAAa;WAAA;;iDAA8C,CAAE,GAAhB,CAAoB,MAApB,CAA2B,CAAC,MAA5B,CAAmC,yCAAnC,gBAAmF,CAAC;uBAApH;;AAAA;;;IACb,IAAU,CAAC,CAAC,GAAF;;AAAO;WAAA;;qBAAA,CAAC,CAAC;AAAF;;QAAP,CAAV;AAAA;;IACA;;AAAS;WAAA;;qBAAA,IAAI,CAAC;AAAL;;;IACT,IAAC,MAAK,CAAC,eAAP;IACA,WAAe,SAAK,KAAL,EAAY,IAAC,MAAK,CAAC,KAAnB,EAA0B,IAAC,MAAK,CAAC,MAAjC;IACf,IAAG,gBAAH;MACE;;AAA4B;aAAA;;cAAgC,CAAC,CAAC,IAAF,CAAO,gBAAP,EAAyB,SAAC,EAAD;mBAAQ,SAAQ,EAAR,IAAc,CAAC,IAAI,CAAC,GAAL,CAAS,IAAI,CAAC,KAAK,CAAC,GAAG,CAAC,CAAf,GAAmB,EAAE,CAAC,KAAK,CAAC,GAAG,CAAC,CAAzC,IAA8C,IAAI,CAAC,GAAL,CAAS,IAAI,CAAC,KAAK,CAAC,GAAG,CAAC,CAAf,GAAmB,EAAE,CAAC,KAAK,CAAC,GAAG,CAAC,CAAzC,CAA/C,KAA+F;UAArH,CAAzB;yBAAhC;;AAAA;;WAD9B;KAAA;MAGE,2BAA2B,UAH7B;;AAKA;;MACE,IAA+B,CAAI,QAAQ,CAAC,iBAA5C;QAAA,QAAQ,CAAC,WAAT,CAAqB,MAArB;;MACA,QAAQ,CAAC,UAAT,CAAoB,KAApB;MACA,QAAQ,CAAC,qBAAT,CAA+B,QAA/B;MACA,QAAQ,CAAC,UAAT,CAAoB,IAApB;MACA,QAAQ,CAAC,WAAT;MACA,QAAQ,CAAC,cAAT;AANF;WAQA,IAAC,gBAAD,GAAmB;EArBL;;qBAuBhB,UAAS,SAAC,OAAD;WAAa,IAAC,MAAM;EAApB;;qBAET,aAAY,SAAC,CAAD;IACV,IAAC,MAAD,GAAS,IAAC,QAAO,CAAC,KAAT,GAAiB,CAAC,CAAC;IAE5B,IAA4B,CAAC,CAAC,QAAF,IAAe,kBAAkB,CAAC,IAAnB,CAAwB,MAAM,CAAC,QAAQ,CAAC,IAAxC,CAA3C;aAAA,IAAC,gBAAD,GAAmB,MAAnB;;EAHU;;qBAKZ,OAAM;AACJ;AAAA;AAAA;;MAAA,IAAI,CAAC,IAAL;AAAA;;UACc,CAAE,IAAhB;;kDACW,CAAE,IAAb;EAHI;;qBAKN,OAAM;AACJ;AAAA;AAAA;;MAAA,IAAI,CAAC,IAAL;AAAA;;UACc,CAAE,IAAhB;;kDACW,CAAE,IAAb;EAHI;;qBAON,4BAA2B,SAAC,CAAD;WAAO,IAAC,wBAAD,GAA2B,CAAC,CAAC;EAApC;;qBAC3B,kBAAiB,SAAC,CAAD;WAAO,IAAC,aAAD,GAAgB,CAAC,CAAC;EAAzB;;qBACjB,mBAAkB,SAAC,CAAD;IAChB,IAAC,aAAD,GAAgB;WAChB,IAAC,WAAD,CAAY,CAAZ,EAAe,IAAf;EAFgB;;qBAIlB,iBAAgB,SAAC,CAAD;WACd,IAAC,YAAD,CAAa,CAAC,CAAC,OAAf,EAAwB,CAAC,CAAC,SAA1B;EADc;;qBAGhB,kBAAiB;WACf,IAAC,QAAD,IAAY;EADG;;qBAGjB,gBAAe,SAAC,CAAD;AACb;IAAA,KAAc,IAAC,aAAf;AAAA;;IACA,IAAU,GAAG,CAAC,KAAd;AAAA;;IACA,IAAuB,IAAC,QAAD,GAAW,CAAlC;AAAA,aAAO,IAAC,QAAD,GAAW,EAAlB;;IACA,IAAC,QAAD,GAAW;IACX,oEAAyB,CAAE,+BAApB,GAAsC,CAAC,CAAC,MAAxC,GAAoD;IAC3D,IAAU,IAAC,eAAD,oBAAoB,IAAI,CAAE,SAAS,CAAC,GAAhB,CAAoB,MAApB,gBAA+B,MAA7D;AAAA;;WACA,IAAC,WAAD,CAAY,CAAZ,EAAe,IAAf;EAPa;;qBASf,mBAAkB,SAAC,CAAD;IAChB,KAAc,IAAC,aAAf;AAAA;;IACA,IAAU,GAAG,CAAC,KAAd;AAAA;;IACA,IAAiB,CAAC,CAAC,YAAnB;aAAA,IAAC,WAAD,CAAY,CAAZ;;EAHgB;;qBAKlB,mBAAkB,SAAC,WAAD,EAAc,QAAd;AAChB;IAAA;;AAAY;AAAA;WAAA;;qBAAA,CAAC,CAAC;AAAF;;;IACZ;;AAAY;AAAA;WAAA;;qBAAA,CAAC,CAAC;AAAF;;;IACZ,aAAa,CAAC,CAAC,UAAF,CAAa,QAAb,EAAuB,QAAvB;IACb,eAAe,CAAC,CAAC,UAAF,CAAa,QAAb,EAAuB,QAAvB;AAEf;;MACE,QAAW,IAAI,CAAC,MAAM,CAAC,MAAZ,KAAwB,IAAC,cAAa,CAAC,OAAO,CAAC,SAAlD,GAAiE,IAAC,cAAa,CAAC,OAAhF,GAA6F,IAAC,cAAa,CAAC;MACpH,OAAW,SAAK;QAAA,MAAM,WAAN;QAAmB,QAAQ,IAAC,OAA5B;QAAoC,OAAO,KAA3C;QAAkD,WAAW,WAA7D;OAAL;MACX,IAAI,CAAC,MAAL,CAAY,IAAZ;MACA,IAAI,CAAC,OAAL,CAAa,IAAb;MACA,IAAI,CAAC,MAAL;MACA,IAAI,CAAC,KAAK,CAAC,SAAX,GAAuB;AANzB;AAQA;SAAA;;2DACE,IAAI,CAAC,WAAY;AADnB;;EAdgB;;qBAiBlB,cAAa,SAAC,OAAD,EAAU,SAAV,EAA0B,mBAA1B;;MAAU,YAAU;;;MAAM,sBAAsB;;IAC3D,KAAsD,IAAC,MAAM,SAA7D;AAAA,aAAO,IAAC,gBAAD,GAAmB,CAAC,OAAD,EAAU,SAAV,EAA1B;;WACA,IAAC,WAAD,CAAY,IAAZ,EAAkB,IAAC,MAAM,SAAzB,EAAmC,SAAnC,EAA8C,mBAA9C;EAFW;;qBAIb,aAAY,SAAC,CAAD,EAAI,IAAJ,EAAe,SAAf,EAA+B,mBAA/B;AACV;;MADc,OAAK;;;MAAM,YAAU;;;MAAM,sBAAsB;;IAC/D,IAAU,KAAM,CAAC,IAAC,SAAD,IAAa,IAAC,aAAf,CAAhB;AAAA;;IACA,0DAAsB,CAAE;IACxB,gBAAwF,CAAC,CAAE,sBAA3F;;QAAA,WAAY,IAAC,OAAM,CAAC,aAAR,CAAsB;UAAC,GAAG,CAAC,CAAC,aAAa,CAAC,IAApB;UAA0B,GAAG,CAAC,CAAC,aAAa,CAAC,IAA7C;SAAtB;OAAZ;;IACA,IAAG,IAAC,aAAJ;MACE,IAAG,CAAC,CAAI,IAAC,iBAAN,KAA4B,QAA5B,IAAyC,CAAC,IAAC,QAAO,CAAC,mBAAT,IAAgC,CAAI,IAApC,IAA4C,mBAA7C,CAAzC,4FAA4I,CAAE,iCAA/B,KAA0C,CAA5J;QACE,IAAC,OAAM,CAAC,MAAR,iBAAe,IAAI,CAAE,gBAAN,IAAgB,IAAC,OAAM,CAAC,cAAR,CAAuB,QAAvB,CAA/B,EAAiE,IAAC,OAAM,CAAC,IAAzE,EAA+E,IAA/E,EAAqF,IAArF,EADF;OADF;;IAGA,IAAe,IAAC,QAAO,CAAC,QAAxB;MAAA,OAAO,KAAP;;IACA,IAAG,SAAU,IAAC,aAAd;;YACe,CAAE,QAAf,GAA0B;;;QAC1B,IAAI,CAAE,QAAN,GAAiB;;MACjB,IAAC,aAAD,GAAgB,KAHlB;;IAIA,QAAQ,QAAS,CAAI,CAAC,IAAI,CAAC,KAAK,CAAC,MAAX,GAAoB,CAArB;IAErB,QAAQ,CAAC,QAAQ,CAAC,OAAlB,CAA0B,yBAA1B,EACE;MAAA,OAAU,IAAH,GAAa,IAAI,CAAC,KAAlB,GAA6B,IAApC;MACA,QAAQ,IADR;MAEA,+BAAW,wBAAY,CAAC,CAAE,kBAF1B;MAGA,eAAe,CAHf;MAIA,UAAU,QAJV;KADF;IAOA,IAA2B,IAA3B;MAAA,IAAC,gBAAD,GAAmB,KAAnB;;IAEA,IAAG,SAAU,CAAI,IAAC,wBAAlB;MACE,WAAW,IAAI,CAAC,SAAL,CAAe,UAAf;MACX,wBAAG,QAAQ,CAAE,mBAAV,KAAuB,eAA1B;QACE,QAAQ,CAAC,QAAQ,CAAC,OAAlB,CAA0B,4BAA1B,EAAwD;UAAA,sBAAO,IAAI,CAAE,cAAb;SAAxD;eACA,QAAQ,CAAC,gBAAT,CAA0B,UAA1B,EAAsC;iBACpC,QAAQ,CAAC,QAAQ,CAAC,OAAlB,CAA0B,+BAA1B,EAA2D;YAAA,sBAAO,IAAI,CAAE,cAAb;WAA3D;QADoC,CAAtC,EAFF;OAFF;;EAvBU;;qBA8BZ,sBAAqB,SAAC,CAAD;AACnB;IAAA,IAA+B,IAAC,eAAhC;MAAA,IAAC,WAAD,CAAY,IAAC,eAAb;;IACA,IAAC,eAAD,GAAkB;AAClB;AAAA;;UAAgC,QAAQ,CAAC,SAAS,CAAC,GAAnB,CAAuB,MAAvB,MAAkC;QAChE,QAAQ,CAAC,MAAM,CAAC,MAAhB,GAA4B,CAAC,CAAC,KAAL,GAAgB,WAAhB,GAAiC;;AAD5D;IAEA,KAAc,CAAC,CAAC,KAAhB;AAAA;;IACA,IAAC,eAAD,GAAsB,aAAS,IAAC,aAAD,CAAc,MAAd,CAAT,EAAgC,IAAC,kBAAD,CAAmB;MAAA,SAAS,aAAT;MAAwB,OAAO,CAAC,CAAC,KAAjC;MAAwC,MAAM,EAAE,CAAC,IAAjD;MAAuD,UAAU,IAAjE;MAAuE,KAAK,CAAC,CAAC,GAA9E;KAAnB,CAAhC;WACtB,IAAC,QAAD,CAAS,IAAC,eAAV,EAA0B,IAAC,eAAc,CAAC,KAAK,CAAC,EAAhD,EAAoD,IAAC,cAAc,YAAnE;EAPmB;;qBASrB,gBAAe,SAAC,CAAD;AACb;IAAA,KAAc,CAAC,CAAC,MAAhB;AAAA;;IACA,cAAkB,aAAS,IAAC,aAAD,CAAc,MAAd,CAAT,EAAgC,IAAC,kBAAD,CAAmB;MAAA,SAAS,kBAAkB,IAAI,CAAC,MAAL,EAA3B;MAA0C,OAAO,CAAC,CAAC,KAAnD;MAA0D,MAAM,CAAC,CAAC,IAAlE;MAAwE,UAAU,KAAlF;MAAyF,KAAK,CAAC,CAAC,GAAhG;KAAnB,CAAhC;IAClB,IAAC,QAAD,CAAS,WAAT,EAAsB,WAAW,CAAC,KAAK,CAAC,EAAxC,EAA4C,IAAC,cAAc,YAA3D;WACA,IAAC,aAAY,CAAC,IAAd,CAAmB,WAAnB;EAJa;;qBAMf,iBAAgB,SAAC,CAAD;AAEd;IAAA,KAAK,CAAC,CAAC,MAAM,CAAC;IACd,UAAU,2CAAiB,EAAjB,CAAoB,CAAC,KAArB;IACV,kBAAkB;AAClB,SAAS,sDAAT;MACE,cAAc,OAAQ;MACtB,KAAK,WAAW,CAAC;MACjB,cAAc,EAAE,CAAC,KAAH,KAAY,EAAE,CAAC,KAAf,IAAyB,EAAE,CAAC,IAAH,KAAW,EAAE,CAAC;MACrD,UAAU,eAAgB,CAAC,mBAAmB,IAAI,CAAC,GAAL,CAAS,EAAE,CAAC,GAAG,CAAC,CAAP,GAAW,EAAE,CAAC,GAAG,CAAC,CAA3B,IAAgC,OAAnD,IAA+D,IAAI,CAAC,GAAL,CAAS,EAAE,CAAC,GAAG,CAAC,CAAP,GAAW,EAAE,CAAC,GAAG,CAAC,CAA3B,IAAgC,OAAhG;MAC1B,IAAG,OAAH;QACE,kBAAkB;QAClB,IAAC,aAAY,CAAC,MAAd,CAAqB,CAArB,EAAwB,CAAxB;QACA,IAAC,WAAD,CAAY,WAAZ,EAHF;;AALF;;UASe,CAAE,MAAjB,GAA6B,IAAC,eAAJ,GAAwB,WAAxB,GAAyC;;WACnE;EAfc;;qBAiBhB,uBAAsB,SAAC,CAAD;AAEpB;IAAA,WAAW,CAAC,CAAC,IAAF,CAAO,CAAC,IAAC,aAAF,CAAe,CAAC,MAAhB,CAAuB,IAAC,UAAxB,CAAP,EAA2C,SAAC,IAAD;aACpD,QAAS,IAAI,CAAC,SAAS,CAAC,GAAf,CAAmB,MAAnB,MAA8B,MAAvC,IAAkD,IAAI,CAAC,KAAK,CAAC,IAAX,KAAmB,EAAE,CAAC,IAAxE,IAAiF,CAAC,IAAI,CAAC,KAAK,CAAC,KAAX,KAAoB,CAAC,CAAC,KAAtB,IAA+B,CAAI,CAAC,CAAC,KAAtC,CAAjF,IAAkI,CAAI,IAAI,CAAC;IADvF,CAA3C;IAEX,KAAc,QAAd;AAAA;;WACA,QAAQ,CAAC,QAAQ,CAAC,OAAlB,CAA0B,qBAA1B,EAAiD;MAAA,OAAO,QAAQ,CAAC,KAAK,CAAC,KAAtB;KAAjD;EALoB;;qBAStB,kBAAiB;AACf;IAAA,4CAAgB,CAAE,eAAf,IAAyB,CAAC,CAAI,IAAC,aAAY,CAAC,KAAK,CAAC,MAAxB,IAAkC,CAAI,IAAC,MAAK,CAAC,YAAP,CAAoB,IAAC,aAAY,CAAC,KAAK,CAAC,EAAxC,CAAvC,CAA5B;MACE,UAAU,IAAC,aAAY,CAAC,KAAK,CAAC;MAC9B,IAAC,aAAD,GAAgB;;YACF,CAAE,MAAhB,CAAuB,KAAvB;;MACA,IAAC,gBAAD,GAAmB,CAAC,OAAD,EAAU,IAAV,EAJrB;;IAKA,IAAC,aAAD;IACA,KAAc,IAAC,cAAf;AAAA;;IACA,IAAwB,IAAC,aAAD,IAAkB,CAAC,IAAC,aAAY,CAAC,SAAd,IAA2B,CAAI,IAAC,aAAY,CAAC,KAA9C,CAA1C;MAAA,IAAC,aAAD,GAAgB,KAAhB;;IAEA,IAAG,IAAC,aAAD,IAAkB,IAAC,aAAY,CAAC,MAAM,CAAC,MAArB,KAAiC,IAAC,cAAa,CAAC,OAAO,CAAC,SAA7E;MACE,IAAC,cAAa,CAAC,QAAf,CAAwB,IAAC,cAAa,CAAC,OAAvC,EADF;KAAA,MAEK,IAAG,IAAC,aAAJ;MACH,IAAC,cAAa,CAAC,QAAf,CAAwB,IAAC,cAAa,CAAC,MAAvC,EADG;;IAEL,IAAC,cAAa,CAAC,MAAf,CAAsB,yBAAtB;IACA,IAAC,cAAa,CAAC,OAAf,CAAuB,IAAC,aAAxB;WACA,IAAC,cAAa,CAAC,MAAf;EAhBe;;qBAkBjB,eAAc;AACZ;IAAA,KAAc,IAAC,WAAf;AAAA;;IACA,+CAAqB,CAAE;IACvB,yBAAS,KAAK,CAAE;IAChB,4BAAY,KAAK,CAAE;IACnB,iEAAoB,SAAS,CAAE,0BAA/B;MAAA,YAAY,KAAZ;;IACA,IAAC,WAAU,CAAC,OAAZ,CAAuB,MAAH,GAAe,IAAC,MAAM,OAAM,CAAC,EAAP,CAAtB,GAAsC,IAA1D;IACA,IAAC,WAAU,CAAC,MAAZ,CAAmB,IAAC,WAAU,CAAC,IAAZ,IAAoB,SAAvC;WACA,IAAC,WAAU,CAAC,MAAZ,CAAsB,SAAH,GAAkB,IAAC,OAAM,CAAC,cAAR,CAAuB,SAAvB,CAAlB,GAAwD,IAA3E;EARY;;;;GAhYwB","file":"public/javascripts/app/lib/surface/LankBoss.js","sourcesContent":["CocoClass = require 'core/CocoClass'\r\n{me} = require 'core/auth'\r\nLayerAdapter = require './LayerAdapter'\r\nFlagLank = require 'lib/surface/FlagLank'\r\nLank = require 'lib/surface/Lank'\r\nMark = require './Mark'\r\nGrid = require 'lib/world/Grid'\r\nutils = require 'core/utils'\r\n\r\nmodule.exports = class LankBoss extends CocoClass\r\n  subscriptions:\r\n    'level:set-debug': 'onSetDebug'\r\n    'sprite:highlight-sprites': 'onHighlightSprites'\r\n    'surface:stage-mouse-down': 'onStageMouseDown'\r\n    'level:select-sprite': 'onSelectSprite'\r\n    'level:suppress-selection-sounds': 'onSuppressSelectionSounds'\r\n    'level:lock-select': 'onSetLockSelect'\r\n    'level:restarted': 'onLevelRestarted'\r\n    'god:new-world-created': 'onNewWorld'\r\n    'god:streaming-world-updated': 'onNewWorld'\r\n    'camera:dragged': 'onCameraDragged'\r\n    'sprite:loaded': -> @update(true)\r\n    'level:flag-color-selected': 'onFlagColorSelected'\r\n    'level:flag-updated': 'onFlagUpdated'\r\n    'surface:flag-appeared': 'onFlagAppeared'\r\n    'surface:remove-selected-flag': 'onRemoveSelectedFlag'\r\n\r\n  constructor: (@options={}) ->\r\n    super()\r\n    @handleEvents = @options.handleEvents\r\n    @gameUIState = @options.gameUIState\r\n    @dragged = 0\r\n    @camera = @options.camera\r\n    @webGLStage = @options.webGLStage\r\n    @surfaceTextLayer = @options.surfaceTextLayer\r\n    @world = @options.world\r\n    @options.thangTypes ?= []\r\n    @lanks = {}\r\n    @lankArray = []  # Mirror @lanks, but faster for when we just need to iterate\r\n    @createLayers()\r\n    @pendingFlags = []\r\n    if not @handleEvents\r\n      @listenTo @gameUIState, 'change:selected', @onChangeSelected\r\n\r\n  destroy: ->\r\n    @removeLank lank for thangID, lank of @lanks\r\n    @targetMark?.destroy()\r\n    @selectionMark?.destroy()\r\n    lankLayer.destroy() for lankLayer in _.values @layerAdapters\r\n    super()\r\n\r\n  toString: -> \"<LankBoss: #{@lankArray.length} lanks>\"\r\n\r\n  thangTypeFor: (type) ->\r\n    _.find @options.thangTypes, (m) -> m.get('original') is type or m.get('name') is type\r\n\r\n  createLayers: ->\r\n    @layerAdapters = {}\r\n    for [name, priority] in [\r\n      ['Land', -40]\r\n      ['Ground', -30]\r\n      ['Obstacle', -20]\r\n      ['Path', -10]\r\n      ['Default', 0]\r\n      ['Floating', 10]\r\n    ]\r\n      @layerAdapters[name] = new LayerAdapter name: name, webGL: true, layerPriority: priority, transform: LayerAdapter.TRANSFORM_SURFACE, camera: @camera\r\n    @webGLStage.addChild (lankLayer.container for lankLayer in _.values(@layerAdapters))...\r\n\r\n  layerForChild: (child, lank) ->\r\n    unless child.layerPriority?\r\n      if thang = lank?.thang\r\n        child.layerPriority = thang.layerPriority\r\n        child.layerPriority ?= 0 if thang.isSelectable\r\n        child.layerPriority ?= -40 if thang.isLand\r\n    child.layerPriority ?= 0\r\n    return @layerAdapters['Default'] unless child.layerPriority\r\n    layer = _.findLast @layerAdapters, (layer, name) ->\r\n      layer.layerPriority <= child.layerPriority\r\n    layer ?= @layerAdapters['Land'] if child.layerPriority < -40\r\n    layer ? @layerAdapters['Default']\r\n\r\n  addLank: (lank, id=null, layer=null) ->\r\n    id ?= lank.thang.id\r\n    console.error 'Lank collision! Already have:', id if @lanks[id]\r\n    @lanks[id] = lank\r\n    @lankArray.push lank\r\n    layer ?= @layerAdapters['Obstacle'] if lank.thang?.spriteName.search(/(dungeon|indoor|ice|classroom|vr).wall/i) isnt -1\r\n    layer ?= @layerForChild lank.sprite, lank\r\n    layer.addLank lank\r\n    layer.updateLayerOrder()\r\n    lank\r\n\r\n  createMarks: ->\r\n    @targetMark = new Mark name: 'target', camera: @camera, layer: @layerAdapters['Ground'], thangType: 'target'\r\n    @selectionMark = new Mark name: 'selection', camera: @camera, layer: @layerAdapters['Ground'], thangType: 'selection'\r\n\r\n  createLankOptions: (options) ->\r\n    _.extend options, {\r\n      @camera\r\n      resolutionFactor: SPRITE_RESOLUTION_FACTOR\r\n      groundLayer: @layerAdapters['Ground']\r\n      textLayer: @surfaceTextLayer\r\n      floatingLayer: @layerAdapters['Floating']\r\n      showInvisible: @options.showInvisible\r\n      @gameUIState\r\n      @handleEvents\r\n    }\r\n\r\n  onSetDebug: (e) ->\r\n    return if e.debug is @debug\r\n    @debug = e.debug\r\n    lank.setDebug @debug for lank in @lankArray\r\n\r\n  onHighlightSprites: (e) ->\r\n    highlightedIDs = e.thangIDs or []\r\n    for thangID, lank of @lanks\r\n      lank.setHighlight? thangID in highlightedIDs, e.delay\r\n\r\n  addThangToLanks: (thang, layer=null) ->\r\n    return console.warn 'Tried to add Thang to the surface it already has:', thang.id if @lanks[thang.id]\r\n    thangType = _.find @options.thangTypes, (m) ->\r\n      return false unless m.get('actions') or m.get('raster')\r\n      return m.get('name') is thang.spriteName\r\n    thangType ?= _.find @options.thangTypes, (m) -> return m.get('name') is thang.spriteName\r\n    return console.error \"Couldn't find ThangType for\", thang unless thangType\r\n\r\n    options = @createLankOptions thang: thang\r\n    options.resolutionFactor = if thangType.get('kind') is 'Floor' then 2 else SPRITE_RESOLUTION_FACTOR\r\n    if @options.playerNames and /Hero Placeholder/.test thang.id\r\n      options.playerName = @options.playerNames[thang.team]\r\n    lank = new Lank thangType, options\r\n    @listenTo lank, 'sprite:mouse-up', @onLankMouseUp\r\n    @addLank lank, null, layer\r\n    lank.setDebug @debug\r\n    lank\r\n\r\n  removeLank: (lank) ->\r\n    lank.layer.removeLank(lank)\r\n    thang = lank.thang\r\n    delete @lanks[lank.thang.id]\r\n    @lankArray.splice @lankArray.indexOf(lank), 1\r\n    @stopListening lank\r\n    lank.destroy()\r\n    lank.thang = thang  # Keep around so that we know which thang the destroyed thang was for\r\n\r\n  updateSounds: ->\r\n    lank.playSounds() for lank in @lankArray  # hmm; doesn't work for lanks which we didn't add yet in adjustLankExistence\r\n\r\n  update: (frameChanged) ->\r\n    @adjustLankExistence() if frameChanged\r\n    lank.update frameChanged for lank in @lankArray\r\n    @updateSelection()\r\n    @layerAdapters['Default'].updateLayerOrder()\r\n    @cacheObstacles()\r\n\r\n  adjustLankExistence: ->\r\n    # Add anything new, remove anything old, update everything current\r\n    updatedObstacles = []\r\n    itemsJustEquipped = []\r\n    for thang in @world.thangs when thang.exists and thang.pos\r\n      itemsJustEquipped = itemsJustEquipped.concat @equipNewItems thang if thang.equip\r\n      if lank = @lanks[thang.id]\r\n        lank.setThang thang  # make sure Lank has latest Thang\r\n      else\r\n        lank = @addThangToLanks(thang)\r\n        Backbone.Mediator.publish 'surface:new-thang-added', thang: thang, sprite: lank\r\n        updatedObstacles.push lank if lank.sprite.parent is @layerAdapters['Obstacle']\r\n        lank.playSounds()\r\n    item.modifyStats() for item in itemsJustEquipped\r\n    for thangID, lank of @lanks\r\n      missing = not (lank.notOfThisWorld or @world.thangMap[thangID]?.exists)\r\n      isObstacle = lank.sprite.parent is @layerAdapters['Obstacle']\r\n      updatedObstacles.push lank if isObstacle and (missing or lank.hasMoved)\r\n      lank.hasMoved = false\r\n      @removeLank lank if missing\r\n    @cacheObstacles updatedObstacles if updatedObstacles.length and @cachedObstacles\r\n\r\n    # mainly for handling selecting thangs from session when the thang is not always in existence\r\n    if @willSelectThang and @lanks[@willSelectThang[0]]\r\n      @selectThang @willSelectThang...\r\n\r\n    @updateScreenReader()\r\n\r\n  updateScreenReader: ->\r\n    # Testing ASCII map for screen readers\r\n    return unless me.get('name') is 'zersiax'  #in ['zersiax', 'Nick']\r\n    ascii = $('#ascii-surface')\r\n    thangs = (lank.thang for lank in @lankArray)\r\n    grid = new Grid thangs, @world.width, @world.height, 0, 0, 0, true\r\n    utils.replaceText ascii, grid.toString true\r\n    ascii.css 'transform', 'initial'\r\n    fullWidth = ascii.innerWidth()\r\n    fullHeight = ascii.innerHeight()\r\n    availableWidth = ascii.parent().innerWidth()\r\n    availableHeight = ascii.parent().innerHeight()\r\n    scale = availableWidth / fullWidth\r\n    scale = Math.min scale, availableHeight / fullHeight\r\n    ascii.css 'transform', \"scale(#{scale})\"\r\n\r\n  equipNewItems: (thang) ->\r\n    itemsJustEquipped = []\r\n    if thang.equip and not thang.equipped\r\n      thang.equip()  # Pretty hacky, but needed since initialize may not be called if we're not running Systems.\r\n      itemsJustEquipped.push thang\r\n    if thang.inventoryIDs\r\n      # Even hackier: these items were only created/equipped during simulation, so we reequip here.\r\n      for slot, itemID of thang.inventoryIDs\r\n        item = @world.getThangByID itemID\r\n        unless item.equipped\r\n          console.log thang.id, 'equipping', item, 'in', thang.slot, 'Surface-side, but it cannot equip?' unless item.equip\r\n          item.equip?()\r\n          itemsJustEquipped.push item if item.equip\r\n    return itemsJustEquipped\r\n\r\n  cacheObstacles: (updatedObstacles=null) ->\r\n    return if @cachedObstacles and not updatedObstacles\r\n    lankArray = @lankArray\r\n    wallLanks = (lank for lank in lankArray when lank.thangType?.get('name').search(/(dungeon|indoor|ice|classroom|vr).wall/i) isnt -1)\r\n    return if _.any (s.stillLoading for s in wallLanks)\r\n    walls = (lank.thang for lank in wallLanks)\r\n    @world.calculateBounds()\r\n    wallGrid = new Grid walls, @world.width, @world.height\r\n    if updatedObstacles\r\n      possiblyUpdatedWallLanks = (lank for lank in wallLanks when _.find updatedObstacles, (w2) -> lank is w2 or (Math.abs(lank.thang.pos.x - w2.thang.pos.x) + Math.abs(lank.thang.pos.y - w2.thang.pos.y)) <= 16)\r\n    else\r\n      possiblyUpdatedWallLanks = wallLanks\r\n#    console.log 'updating up to', possiblyUpdatedWallLanks.length, 'of', wallLanks.length, 'wall lanks from updatedObstacles', updatedObstacles\r\n    for wallLank in possiblyUpdatedWallLanks\r\n      wallLank.queueAction 'idle' if not wallLank.currentRootAction\r\n      wallLank.lockAction(false)\r\n      wallLank.updateActionDirection wallGrid\r\n      wallLank.lockAction(true)\r\n      wallLank.updateScale()\r\n      wallLank.updatePosition()\r\n#    console.log wallGrid.toString()\r\n    @cachedObstacles = true\r\n\r\n  lankFor: (thangID) -> @lanks[thangID]\r\n\r\n  onNewWorld: (e) ->\r\n    @world = @options.world = e.world\r\n    # Clear obstacle cache for this level, since we are spawning walls dynamically\r\n    @cachedObstacles = false if e.finished and /kithgard-mastery/.test window.location.href\r\n\r\n  play: ->\r\n    lank.play() for lank in @lankArray\r\n    @selectionMark?.play()\r\n    @targetMark?.play()\r\n\r\n  stop: ->\r\n    lank.stop() for lank in @lankArray\r\n    @selectionMark?.stop()\r\n    @targetMark?.stop()\r\n\r\n  # Selection\r\n\r\n  onSuppressSelectionSounds: (e) -> @suppressSelectionSounds = e.suppress\r\n  onSetLockSelect: (e) -> @selectLocked = e.lock\r\n  onLevelRestarted: (e) ->\r\n    @selectLocked = false\r\n    @selectLank e, null\r\n\r\n  onSelectSprite: (e) ->\r\n    @selectThang e.thangID, e.spellName\r\n\r\n  onCameraDragged: ->\r\n    @dragged += 1\r\n\r\n  onLankMouseUp: (e) ->\r\n    return unless @handleEvents\r\n    return if key.shift #and @options.choosing\r\n    return @dragged = 0 if @dragged > 3\r\n    @dragged = 0\r\n    lank = if e.sprite?.thang?.isSelectable then e.sprite else null\r\n    return if @flagCursorLank and lank?.thangType.get('name') is 'Flag'\r\n    @selectLank e, lank\r\n\r\n  onStageMouseDown: (e) ->\r\n    return unless @handleEvents\r\n    return if key.shift #and @options.choosing\r\n    @selectLank e if e.onBackground\r\n\r\n  onChangeSelected: (gameUIState, selected) ->\r\n    oldLanks = (s.sprite for s in gameUIState.previousAttributes().selected or [])\r\n    newLanks = (s.sprite for s in selected or [])\r\n    addedLanks = _.difference(newLanks, oldLanks)\r\n    removedLanks = _.difference(oldLanks, newLanks)\r\n\r\n    for lank in addedLanks\r\n      layer = if lank.sprite.parent isnt @layerAdapters.Default.container then @layerAdapters.Default else @layerAdapters.Ground\r\n      mark = new Mark name: 'selection', camera: @camera, layer: layer, thangType: 'selection'\r\n      mark.toggle true\r\n      mark.setLank(lank)\r\n      mark.update()\r\n      lank.marks.selection = mark # TODO: Figure out how to non-hackily assign lank this mark\r\n      \r\n    for lank in removedLanks\r\n      lank.removeMark?('selection')\r\n\r\n  selectThang: (thangID, spellName=null, treemaThangSelected = null) ->\r\n    return @willSelectThang = [thangID, spellName] unless @lanks[thangID]\r\n    @selectLank null, @lanks[thangID], spellName, treemaThangSelected\r\n\r\n  selectLank: (e, lank=null, spellName=null, treemaThangSelected = null) ->\r\n    return if e and (@disabled or @selectLocked)  # Ignore clicks for selection/panning/wizard movement while disabled or select is locked\r\n    worldPos = lank?.thang?.pos\r\n    worldPos ?= @camera.screenToWorld {x: e.originalEvent.rawX, y: e.originalEvent.rawY} if e?.originalEvent\r\n    if @handleEvents\r\n      if (not @reallyStopMoving) and worldPos and (@options.navigateToSelection or not lank or treemaThangSelected) and e?.originalEvent?.nativeEvent?.which isnt 3\r\n        @camera.zoomTo(lank?.sprite or @camera.worldToSurface(worldPos), @camera.zoom, 1000, true)\r\n    lank = null if @options.choosing  # Don't select lanks while choosing\r\n    if lank isnt @selectedLank\r\n      @selectedLank?.selected = false\r\n      lank?.selected = true\r\n      @selectedLank = lank\r\n    alive = lank and not (lank.thang.health < 0)\r\n\r\n    Backbone.Mediator.publish 'surface:sprite-selected',\r\n      thang: if lank then lank.thang else null\r\n      sprite: lank\r\n      spellName: spellName ? e?.spellName\r\n      originalEvent: e\r\n      worldPos: worldPos\r\n\r\n    @willSelectThang = null if lank  # Now that we've done a real selection, don't reselect some other Thang later.\r\n\r\n    if alive and not @suppressSelectionSounds\r\n      instance = lank.playSound 'selected'\r\n      if instance?.playState is 'playSucceeded'\r\n        Backbone.Mediator.publish 'sprite:thang-began-talking', thang: lank?.thang\r\n        instance.addEventListener 'complete', ->\r\n          Backbone.Mediator.publish 'sprite:thang-finished-talking', thang: lank?.thang\r\n\r\n  onFlagColorSelected: (e) ->\r\n    @removeLank @flagCursorLank if @flagCursorLank\r\n    @flagCursorLank = null\r\n    for flagLank in @lankArray when flagLank.thangType.get('name') is 'Flag'\r\n      flagLank.sprite.cursor = if e.color then 'crosshair' else 'pointer'\r\n    return unless e.color\r\n    @flagCursorLank = new FlagLank @thangTypeFor('Flag'), @createLankOptions(thangID: 'Flag Cursor', color: e.color, team: me.team, isCursor: true, pos: e.pos)\r\n    @addLank @flagCursorLank, @flagCursorLank.thang.id, @layerAdapters['Floating']\r\n\r\n  onFlagUpdated: (e) ->\r\n    return unless e.active\r\n    pendingFlag = new FlagLank @thangTypeFor('Flag'), @createLankOptions(thangID: 'Pending Flag ' + Math.random(), color: e.color, team: e.team, isCursor: false, pos: e.pos)\r\n    @addLank pendingFlag, pendingFlag.thang.id, @layerAdapters['Floating']\r\n    @pendingFlags.push pendingFlag\r\n\r\n  onFlagAppeared: (e) ->\r\n    # Remove the pending flag that matches this one's color/team/position, and any color/team matches placed earlier.\r\n    t1 = e.sprite.thang\r\n    pending = (@pendingFlags ? []).slice()\r\n    foundExactMatch = false\r\n    for i in [pending.length - 1 .. 0] by -1\r\n      pendingFlag = pending[i]\r\n      t2 = pendingFlag.thang\r\n      matchedType = t1.color is t2.color and t1.team is t2.team\r\n      matched = matchedType and (foundExactMatch or Math.abs(t1.pos.x - t2.pos.x) < 0.00001 and Math.abs(t1.pos.y - t2.pos.y) < 0.00001)\r\n      if matched\r\n        foundExactMatch = true\r\n        @pendingFlags.splice(i, 1)\r\n        @removeLank pendingFlag\r\n    e.sprite.sprite?.cursor = if @flagCursorLank then 'crosshair' else 'pointer'\r\n    null\r\n\r\n  onRemoveSelectedFlag: (e) ->\r\n    # Remove the selected lank if it's a flag, or any flag of the given color if a color is given.\r\n    flagLank = _.find [@selectedLank].concat(@lankArray), (lank) ->\r\n      lank and lank.thangType.get('name') is 'Flag' and lank.thang.team is me.team and (lank.thang.color is e.color or not e.color) and not lank.notOfThisWorld\r\n    return unless flagLank\r\n    Backbone.Mediator.publish 'surface:remove-flag', color: flagLank.thang.color\r\n\r\n  # Marks\r\n\r\n  updateSelection: ->\r\n    if @selectedLank?.thang and (not @selectedLank.thang.exists or not @world.getThangByID @selectedLank.thang.id)\r\n      thangID = @selectedLank.thang.id\r\n      @selectedLank = null  # Don't actually trigger deselection, but remove the selected lank.\r\n      @selectionMark?.toggle false\r\n      @willSelectThang = [thangID, null]\r\n    @updateTarget()\r\n    return unless @selectionMark\r\n    @selectedLank = null if @selectedLank and (@selectedLank.destroyed or not @selectedLank.thang)\r\n    # The selection mark should be on the ground layer, unless we're not a normal lank (like a wall), in which case we'll place it higher so we can see it.\r\n    if @selectedLank and @selectedLank.sprite.parent isnt @layerAdapters.Default.container\r\n      @selectionMark.setLayer @layerAdapters.Default\r\n    else if @selectedLank\r\n      @selectionMark.setLayer @layerAdapters.Ground\r\n    @selectionMark.toggle @selectedLank?\r\n    @selectionMark.setLank @selectedLank\r\n    @selectionMark.update()\r\n\r\n  updateTarget: ->\r\n    return unless @targetMark\r\n    thang = @selectedLank?.thang\r\n    target = thang?.target\r\n    targetPos = thang?.targetPos\r\n    targetPos = null if targetPos?.isZero?()  # Null targetPos get serialized as (0, 0, 0)\r\n    @targetMark.setLank if target then @lanks[target.id] else null\r\n    @targetMark.toggle @targetMark.lank or targetPos\r\n    @targetMark.update if targetPos then @camera.worldToSurface targetPos else null\r\n"]}