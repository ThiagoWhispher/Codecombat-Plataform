{"version":3,"sources":["app/lib/surface/TrailMaster.coffee"],"names":[],"mappings":"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","file":"public/javascripts/app/lib/surface/TrailMaster.js","sourcesContent":["PAST_PATH_ALPHA = 0.75\r\nPAST_PATH_WIDTH = 5\r\nFUTURE_PATH_ALPHA = 0.75\r\nFUTURE_PATH_WIDTH = 4\r\nTARGET_ALPHA = 1\r\nTARGET_WIDTH = 10\r\nFUTURE_PATH_INTERVAL_DIVISOR = 4\r\nPAST_PATH_INTERVAL_DIVISOR = 2\r\n\r\nCamera = require './Camera'\r\nCocoClass = require 'core/CocoClass'\r\n\r\nmodule.exports = class TrailMaster extends CocoClass\r\n  world: null\r\n\r\n  constructor: (@camera, @layerAdapter) ->\r\n    super()\r\n    @tweenedSprites = []\r\n    @tweens = []\r\n    @listenTo @layerAdapter, 'new-spritesheet', -> @generatePaths(@world, @thang)\r\n\r\n  generatePaths: (@world, @thang) ->\r\n    return if @generatingPaths\r\n    @generatingPaths = true\r\n    @cleanUp()\r\n    @createGraphics()\r\n    pathDisplayObject = new createjs.SpriteContainer(@layerAdapter.spriteSheet)\r\n    pathDisplayObject.mouseEnabled = pathDisplayObject.mouseChildren = false\r\n    pathDisplayObject.addChild @createFuturePath()\r\n#    pathDisplayObject.addChild @createPastPath() # Just made the animated path the full path... do we want to have past and future look different again?\r\n    pathDisplayObject.addChild @createTargets()\r\n    @generatingPaths = false\r\n    return pathDisplayObject\r\n\r\n  cleanUp: ->\r\n    createjs.Tween.removeTweens(sprite) for sprite in @tweenedSprites\r\n    @tweenedSprites = []\r\n    @tweens = []\r\n\r\n  createGraphics: ->\r\n    @targetDotKey = @cachePathDot(TARGET_WIDTH, @colorForThang(@thang.team, TARGET_ALPHA), [0, 0, 0, 1])\r\n    @pastDotKey = @cachePathDot(PAST_PATH_WIDTH, @colorForThang(@thang.team, PAST_PATH_ALPHA), [0, 0, 0, 1])\r\n    @futureDotKey = @cachePathDot(FUTURE_PATH_WIDTH, [255, 255, 255, FUTURE_PATH_ALPHA], @colorForThang(@thang.team, 1))\r\n\r\n  cachePathDot: (width, fillColor, strokeColor) ->\r\n    key = \"path-dot-#{width}-#{fillColor}-#{strokeColor}\"\r\n    fillColor = createjs.Graphics.getRGB(fillColor...)\r\n    strokeColor = createjs.Graphics.getRGB(strokeColor...)\r\n    unless key in @layerAdapter.spriteSheet.getAnimations()\r\n      circle = new createjs.Shape()\r\n      radius = width/2\r\n      circle.graphics.setStrokeStyle(width/5).beginFill(fillColor).beginStroke(strokeColor).drawCircle(0, 0, radius)\r\n      @layerAdapter.addCustomGraphic(key, circle, [-radius*1.5, -radius*1.5, radius*3, radius*3])\r\n    return key\r\n\r\n  colorForThang: (team, alpha=1.0) ->\r\n    rgb = [0, 255, 0]\r\n    rgb = [255, 0, 0] if team is 'humans'\r\n    rgb = [0, 0, 255] if team is 'ogres'\r\n    rgb.push(alpha)\r\n    return rgb\r\n\r\n  createPastPath: ->\r\n    return unless points = @world.pointsForThang @thang.id, @camera\r\n    interval = Math.max(1, parseInt(@world.frameRate / PAST_PATH_INTERVAL_DIVISOR))\r\n    params = { interval: interval, frameKey: @pastDotKey }\r\n    return @createPath(points, params)\r\n\r\n  createFuturePath: ->\r\n    return unless points = @world.pointsForThang @thang.id, @camera\r\n    interval = Math.max(1, parseInt(@world.frameRate / FUTURE_PATH_INTERVAL_DIVISOR))\r\n    params = { interval: interval, animate: true, frameKey: @futureDotKey }\r\n    return @createPath(points, params)\r\n\r\n  createTargets: ->\r\n    return unless @thang.allTargets\r\n    container = new createjs.SpriteContainer(@layerAdapter.spriteSheet)\r\n    for x, i in @thang.allTargets by 2\r\n      y = @thang.allTargets[i + 1]\r\n      sup = @camera.worldToSurface x: x, y: y\r\n      sprite = new createjs.Sprite(@layerAdapter.spriteSheet)\r\n      sprite.scaleX = sprite.scaleY = 1 / @layerAdapter.resolutionFactor\r\n      sprite.scaleY *= @camera.y2x\r\n      sprite.gotoAndStop(@targetDotKey)\r\n      sprite.x = sup.x\r\n      sprite.y = sup.y\r\n      container.addChild(sprite)\r\n    return container\r\n\r\n  createPath: (points, options={}) ->\r\n    options = options or {}\r\n    interval = options.interval or 8\r\n    key = options.frameKey or @pastDotKey\r\n    container = new createjs.SpriteContainer(@layerAdapter.spriteSheet)\r\n\r\n    for x, i in points by interval * 2\r\n      y = points[i + 1]\r\n      sprite = new createjs.Sprite(@layerAdapter.spriteSheet)\r\n      sprite.scaleX = sprite.scaleY = 1 / @layerAdapter.resolutionFactor\r\n      sprite.scaleY *= @camera.y2x\r\n      sprite.gotoAndStop(key)\r\n      sprite.x = x\r\n      sprite.y = y\r\n      container.addChild(sprite)\r\n      if lastSprite and options.animate\r\n        tween = createjs.Tween.get(lastSprite, {loop: true}).to({x:x, y:y}, 1000)\r\n        @tweenedSprites.push lastSprite\r\n        @tweens.push tween\r\n      lastSprite = sprite\r\n\r\n    @logged = true\r\n    container\r\n\r\n  play: ->\r\n    tween.setPaused(false) for tween in @tweens\r\n\r\n  stop: ->\r\n    tween.setPaused(true) for tween in @tweens\r\n\r\n  destroy: ->\r\n    @cleanUp()\r\n    super()\r\n"]}