{"version":3,"sources":["app/lib/surface/Mark.coffee"],"names":[],"mappings":"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","file":"public/javascripts/app/lib/surface/Mark.js","sourcesContent":["CocoClass = require 'core/CocoClass'\r\nCamera = require './Camera'\r\nThangType = require 'models/ThangType'\r\nmarkThangTypes = {}\r\n\r\nmodule.exports = class Mark extends CocoClass\r\n  subscriptions: {}\r\n  alpha: 1\r\n\r\n  constructor: (options) ->\r\n    super()\r\n    options ?= {}\r\n    @name = options.name\r\n    @lank = options.lank\r\n    @camera = options.camera\r\n    @layer = options.layer\r\n    @thangType = options.thangType\r\n    @listenTo @layer, 'new-spritesheet', @onLayerMadeSpriteSheet\r\n    console.error @toString(), 'needs a name.' unless @name\r\n    console.error @toString(), 'needs a camera.' unless @camera\r\n    console.error @toString(), 'needs a layer.' unless @layer\r\n    @build()\r\n\r\n  destroy: ->\r\n    createjs.Tween.removeTweens @sprite if @sprite\r\n    @sprite?.parent?.removeChild @sprite\r\n    if @markLank\r\n      @layer.removeLank(@markLank)\r\n      @markLank.destroy()\r\n    @lank = null\r\n    super()\r\n\r\n  toString: -> \"<Mark #{@name}: Sprite #{@lank?.thang?.id ? 'None'}>\"\r\n\r\n  onLayerMadeSpriteSheet: ->\r\n    return unless @sprite\r\n    return @update() if @markLank\r\n    # rebuild sprite for new sprite sheet\r\n    @layer.removeChild @sprite\r\n    @sprite = null\r\n    @build()\r\n    @layer.addChild @sprite\r\n    @layer.updateLayerOrder()\r\n#    @updatePosition()\r\n    @update()\r\n\r\n  toggle: (to) ->\r\n    to = !!to\r\n    return @ if to is @on\r\n    return @toggleTo = to unless @sprite\r\n    @on = to\r\n    delete @toggleTo\r\n    if @on\r\n      if @markLank\r\n        @layer.addLank(@markLank)\r\n      else\r\n        @layer.addChild @sprite\r\n        @layer.updateLayerOrder()\r\n    else\r\n      if @markLank\r\n        @layer.removeLank(@markLank)\r\n      else\r\n        @layer.removeChild @sprite\r\n      if @highlightTween\r\n        @highlightDelay = @highlightTween = null\r\n        createjs.Tween.removeTweens @sprite\r\n        @sprite.visible = true\r\n    @\r\n\r\n  setLayer: (layer) ->\r\n    return if layer is @layer\r\n    wasOn = @on\r\n    @toggle false\r\n    @layer = layer\r\n    @toggle true if wasOn\r\n\r\n  setLank: (lank) ->\r\n    return if lank is @lank\r\n    @lank = lank\r\n    @build()\r\n    @\r\n\r\n  build: ->\r\n    unless @sprite\r\n      if @name is 'bounds' then @buildBounds()\r\n      else if @name is 'shadow' then @buildShadow()\r\n      else if @name is 'debug' then @buildDebug()\r\n      else if @name.match(/.+(Range|Distance|Radius)$/) then @buildRadius(@name)\r\n      else if @thangType then @buildSprite()\r\n      else console.error 'Don\\'t know how to build mark for', @name\r\n      @sprite?.mouseEnabled = false\r\n    @\r\n\r\n  buildBounds: ->\r\n    @sprite = new createjs.Container()\r\n    @sprite.mouseChildren = false\r\n    style = @lank.thang.drawsBoundsStyle\r\n    @drawsBoundsIndex = @lank.thang.drawsBoundsIndex\r\n    return if style is 'corner-text' and @lank.thang.world.age is 0\r\n\r\n    # Confusingly make some semi-random colors that'll be consistent based on the drawsBoundsIndex\r\n    colors = (128 + Math.floor(('0.'+Math.sin(3 * @drawsBoundsIndex + i).toString().substr(6)) * 128) for i in [1 ... 4])\r\n    color = \"rgba(#{colors[0]}, #{colors[1]}, #{colors[2]}, 0.5)\"\r\n    [w, h] = [@lank.thang.width * Camera.PPM, @lank.thang.height * Camera.PPM * @camera.y2x]\r\n\r\n    if style in ['border-text', 'corner-text']\r\n      @drawsBoundsBorderShape = shape = new createjs.Shape()\r\n      shape.graphics.setStrokeStyle 5\r\n      shape.graphics.beginStroke color\r\n      if style is 'border-text'\r\n        shape.graphics.beginFill color.replace('0.5', '0.25')\r\n      else\r\n        shape.graphics.beginFill color\r\n      if @lank.thang.shape in ['ellipsoid', 'disc']\r\n        shape.drawEllipse 0, 0, w, h\r\n      else\r\n        shape.graphics.drawRect -w / 2, -h / 2, w, h\r\n      shape.graphics.endStroke()\r\n      shape.graphics.endFill()\r\n      @sprite.addChild shape\r\n\r\n    if style is 'border-text'\r\n      text = new createjs.Text '' + @drawsBoundsIndex, '20px Arial', color.replace('0.5', '1')\r\n      text.regX = text.getMeasuredWidth() / 2\r\n      text.regY = text.getMeasuredHeight() / 2\r\n      text.shadow = new createjs.Shadow('#000000', 1, 1, 0)\r\n      @sprite.addChild text\r\n    else if style is 'corner-text'\r\n      return if @lank.thang.world.age is 0\r\n      letter = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ'[@drawsBoundsIndex % 26]\r\n      text = new createjs.Text letter, '14px Arial', '#333333'   # color.replace('0.5', '1')\r\n      text.x = -w / 2 + 2\r\n      text.y = -h / 2 + 2\r\n      @sprite.addChild text\r\n    else\r\n      console.warn @lank.thang.id, 'didn\\'t know how to draw bounds style:', style\r\n\r\n    if w > 0 and h > 0 and style is 'border-text'\r\n      @sprite.cache -w / 2, -h / 2, w, h, 2\r\n    @lastWidth = @lank.thang.width\r\n    @lastHeight = @lank.thang.height\r\n\r\n  buildShadow: ->\r\n    shapeName = if @lank.thang.shape in ['ellipsoid', 'disc'] then 'ellipse' else 'rect'\r\n    key = \"#{shapeName}-shadow\"\r\n    SHADOW_SIZE = 10\r\n    unless key in @layer.spriteSheet.getAnimations()\r\n      shape = new createjs.Shape()\r\n      shape.graphics.beginFill \"rgba(0,0,0)\"\r\n      bounds = [-SHADOW_SIZE/2, - SHADOW_SIZE/2, SHADOW_SIZE, SHADOW_SIZE]\r\n      if shapeName is 'ellipse'\r\n        shape.graphics.drawEllipse bounds...\r\n      else\r\n        shape.graphics.drawRect bounds...\r\n      shape.graphics.endFill()\r\n      @layer.addCustomGraphic(key, shape, bounds)\r\n    alpha = @lank.thang?.alpha ? 1\r\n    width = (@lank.thang?.width ? 0) + 0.5\r\n    height = (@lank.thang?.height ? 0) + 0.5\r\n    longest = Math.max width, height\r\n    actualLongest = @lank.thangType.get('shadow') ? longest\r\n    width = width * actualLongest / longest\r\n    height = height * actualLongest / longest\r\n    width *= Camera.PPM\r\n    height *= Camera.PPM * @camera.y2x  # TODO: doesn't work with rotation\r\n    @sprite = new createjs.Sprite(@layer.spriteSheet)\r\n    @sprite.gotoAndStop(key)\r\n    @sprite.mouseEnabled = false\r\n    @sprite.alpha = alpha\r\n    @baseScaleX = @sprite.scaleX = width / (@layer.resolutionFactor * SHADOW_SIZE)\r\n    @baseScaleY = @sprite.scaleY = height / (@layer.resolutionFactor * SHADOW_SIZE)\r\n\r\n  buildRadius: (range) ->\r\n    alpha = 0.15\r\n    colors =\r\n      voiceRange: \"rgba(0,145,0,#{alpha})\"\r\n      visualRange: \"rgba(0,0,145,#{alpha})\"\r\n      attackRange: \"rgba(145,0,0,#{alpha})\"\r\n\r\n    # Fallback colors which work on both dungeon and grass tiles\r\n    extraColors = [\r\n      \"rgba(145,0,145,#{alpha})\"\r\n      \"rgba(0,145,145,#{alpha})\"\r\n      \"rgba(145,105,0,#{alpha})\"\r\n      \"rgba(225,125,0,#{alpha})\"\r\n    ]\r\n\r\n    # Find the index of this range, to find the next-smallest radius\r\n    rangeNames = @lank.ranges.map((range, index) ->\r\n      range['name']\r\n    )\r\n    i = rangeNames.indexOf(range)\r\n\r\n    @sprite = new createjs.Shape()\r\n\r\n    fillColor = colors[range] ? extraColors[i]\r\n    @sprite.graphics.beginFill fillColor\r\n\r\n    # Draw the outer circle\r\n    @sprite.graphics.drawCircle 0, 0, @lank.thang[range] * Camera.PPM\r\n\r\n    # Cut out the hollow part if necessary\r\n    if i+1 < @lank.ranges.length\r\n      @sprite.graphics.arc 0, 0, @lank.ranges[i+1]['radius'], Math.PI*2, 0, true\r\n\r\n    @sprite.graphics.endFill()\r\n\r\n    strokeColor = fillColor.replace '' + alpha, '0.75'\r\n    @sprite.graphics.setStrokeStyle 2\r\n    @sprite.graphics.beginStroke strokeColor\r\n    @sprite.graphics.arc 0, 0, @lank.thang[range] * Camera.PPM, Math.PI*2, 0, true\r\n    @sprite.graphics.endStroke()\r\n\r\n    # Add perspective\r\n    @sprite.scaleY *= @camera.y2x\r\n\r\n  buildDebug: ->\r\n    shapeName = if @lank.thang.shape in ['ellipsoid', 'disc'] then 'ellipse' else 'rect'\r\n    key = \"#{shapeName}-debug-#{@lank.thang.collisionCategory}\"\r\n    DEBUG_SIZE = 10\r\n    unless key in @layer.spriteSheet.getAnimations()\r\n      shape = new createjs.Shape()\r\n      debugColor = {\r\n        none: 'rgba(224,255,239,0.25)'\r\n        ground: 'rgba(239,171,205,0.5)'\r\n        air: 'rgba(131,205,255,0.5)'\r\n        ground_and_air: 'rgba(2391,140,239,0.5)'\r\n        obstacles: 'rgba(88,88,88,0.5)'\r\n        dead: 'rgba(89,171,100,0.25)'\r\n      }[@lank.thang.collisionCategory] or 'rgba(171,205,239,0.5)'\r\n      shape.graphics.beginFill debugColor\r\n      bounds = [-DEBUG_SIZE / 2, -DEBUG_SIZE / 2, DEBUG_SIZE, DEBUG_SIZE]\r\n      if shapeName is 'ellipse'\r\n        shape.graphics.drawEllipse bounds...\r\n      else\r\n        shape.graphics.drawRect bounds...\r\n      shape.graphics.endFill()\r\n      @layer.addCustomGraphic(key, shape, bounds)\r\n\r\n    @sprite = new createjs.Sprite(@layer.spriteSheet)\r\n    @sprite.gotoAndStop(key)\r\n    PX = 3\r\n    w = Math.max(PX, @lank.thang.width  * Camera.PPM) * (@camera.y2x + (1 - @camera.y2x) * Math.abs Math.cos @lank.thang.rotation)\r\n    h = Math.max(PX, @lank.thang.height * Camera.PPM) * (@camera.y2x + (1 - @camera.y2x) * Math.abs Math.sin @lank.thang.rotation)\r\n    @sprite.scaleX = w / (@layer.resolutionFactor * DEBUG_SIZE)\r\n    @sprite.scaleY = h / (@layer.resolutionFactor * DEBUG_SIZE)\r\n    @sprite.rotation = -@lank.thang.rotation * 180 / Math.PI\r\n\r\n  buildSprite: ->\r\n    if _.isString @thangType\r\n      thangType = markThangTypes[@thangType]\r\n      return @loadThangType() if not thangType\r\n      @thangType = thangType\r\n\r\n    return @listenToOnce(@thangType, 'sync', @onLoadedThangType) if not @thangType.loaded\r\n    Lank = require './Lank'\r\n    # don't bother with making these render async for now, but maybe later for fun and more complexity of code\r\n    markLank = new Lank @thangType\r\n    markLank.queueAction 'idle'\r\n    @sprite = markLank.sprite\r\n    @markLank = markLank\r\n    @listenTo @markLank, 'new-sprite', (@sprite) ->\r\n\r\n  loadThangType: ->\r\n    name = @thangType\r\n    @thangType = new ThangType()\r\n    @thangType.url = -> \"/db/thang.type/#{name}\"\r\n    @listenToOnce(@thangType, 'sync', @onLoadedThangType)\r\n    @thangType.fetch()\r\n    markThangTypes[name] = @thangType\r\n\r\n  onLoadedThangType: ->\r\n    @build()\r\n    @update() if @markLank\r\n    @toggle(@toggleTo) if @toggleTo?\r\n    Backbone.Mediator.publish 'sprite:loaded', {sprite: @}\r\n\r\n  update: (pos=null) ->\r\n    return false unless @on and @sprite\r\n    return false if @lank? and not @lank.thangType.isFullyLoaded()\r\n    @sprite.visible = not @hidden\r\n    @updatePosition pos\r\n    @updateRotation()\r\n    @updateScale()\r\n    if @name is 'highlight' and @highlightDelay and not @highlightTween\r\n      @sprite.visible = false\r\n      @highlightTween = createjs.Tween.get(@sprite).to({}, @highlightDelay).call =>\r\n        return if @destroyed\r\n        @sprite.visible = true\r\n        @highlightDelay = @highlightTween = null\r\n    @updateAlpha @alpha if @name in ['shadow', 'bounds']\r\n    true\r\n\r\n  updatePosition: (pos) ->\r\n    if @lank?.thang and @name in ['shadow', 'debug', 'target', 'selection', 'repair']\r\n      pos = @camera.worldToSurface x: @lank.thang.pos.x, y: @lank.thang.pos.y\r\n    else\r\n      pos ?= @lank?.sprite\r\n    return unless pos\r\n    @sprite.x = pos.x\r\n    @sprite.y = pos.y\r\n    if @statusEffect or @name is 'highlight'\r\n      offset = @lank.getOffset 'aboveHead'\r\n      @sprite.x += offset.x\r\n      @sprite.y += offset.y\r\n      @sprite.y -= 3 if @statusEffect\r\n\r\n  updateAlpha: (@alpha) ->\r\n    return if not @sprite or @name is 'debug'\r\n    if @name is 'shadow'\r\n      worldZ = @lank.thang.pos.z - @lank.thang.depth / 2 + @lank.getBobOffset()\r\n      @sprite.alpha = @alpha * 0.451 / Math.sqrt(worldZ / 2 + 1)\r\n    else if @name is 'bounds'\r\n      @drawsBoundsBorderShape?.alpha = Math.floor @lank.thang.alpha  # Stop drawing bounds as soon as alpha is reduced at all\r\n    else\r\n      @sprite.alpha = @alpha\r\n\r\n  updateRotation: ->\r\n    if @name is 'debug' or (@name is 'shadow' and @lank.thang?.shape in ['rectangle', 'box'])\r\n      @sprite.rotation = -@lank.thang.rotation * 180 / Math.PI\r\n\r\n  updateScale: ->\r\n    if @name is 'bounds' and ((@lank.thang.width isnt @lastWidth or @lank.thang.height isnt @lastHeight) or (@lank.thang.drawsBoundsIndex isnt @drawsBoundsIndex))\r\n      oldMark = @sprite\r\n      @buildBounds()\r\n      oldMark.parent.addChild @sprite\r\n      oldMark.parent.swapChildren oldMark, @sprite\r\n      oldMark.parent.removeChild oldMark\r\n\r\n    if @markLank?\r\n      @markLank.scaleFactor = 1.2\r\n      @markLank.updateScale()\r\n\r\n    if @name is 'shadow' and thang = @lank.thang\r\n      @sprite.scaleX = @baseScaleX * (thang.scaleFactor ? thang.scaleFactorX ? 1)\r\n      @sprite.scaleY = @baseScaleY * (thang.scaleFactor ? thang.scaleFactorY ? 1)\r\n\r\n    return unless @name in ['selection', 'target', 'repair', 'highlight']\r\n\r\n    # scale these marks to 10m (100px). Adjust based on lank size.\r\n    factor = 0.3 # default size: 3m width, most commonly for target when pointing to a location\r\n\r\n    if @lank?.sprite\r\n      width = @lank.sprite.getBounds()?.width or 0\r\n      width /= @lank.options.resolutionFactor\r\n      # all targets should be set to have a width of 100px, and then be scaled accordingly\r\n      factor = width / 100 # normalize\r\n      factor *= 1.1 # add margin\r\n      factor = Math.max(factor, 0.3) # lower bound\r\n    @sprite.scaleX *= factor\r\n    @sprite.scaleY *= factor\r\n\r\n    if @name in ['selection', 'target', 'repair']\r\n      @sprite.scaleY *= @camera.y2x  # code applies perspective\r\n\r\n  stop: -> @markLank?.stop()\r\n  play: -> @markLank?.play()\r\n  hide: -> @hidden = true\r\n  show: -> @hidden = false\r\n"]}