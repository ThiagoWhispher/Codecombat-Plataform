{"version":3,"sources":["app/lib/surface/CoordinateDisplay.coffee"],"names":[],"mappings":"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","file":"public/javascripts/app/lib/surface/CoordinateDisplay.js","sourcesContent":["module.exports = class CoordinateDisplay extends createjs.Container\r\n  layerPriority: -10\r\n  subscriptions:\r\n    'surface:mouse-moved': 'onMouseMove'\r\n    'surface:mouse-out': 'onMouseOut'\r\n    'surface:mouse-over': 'onMouseOver'\r\n    'surface:stage-mouse-down': 'onMouseDown'\r\n    'camera:zoom-updated': 'onZoomUpdated'\r\n    'level:flag-color-selected': 'onFlagColorSelected'\r\n\r\n  constructor: (options) ->\r\n    super()\r\n    @initialize()\r\n    @camera = options.camera\r\n    @layer = options.layer\r\n    console.error @toString(), 'needs a camera.' unless @camera\r\n    console.error @toString(), 'needs a layer.' unless @layer\r\n    @build()\r\n    @performShow = @show\r\n    @show = _.debounce @show, 125\r\n    Backbone.Mediator.subscribe(channel, @[func], @) for channel, func of @subscriptions\r\n\r\n  destroy: ->\r\n    Backbone.Mediator.unsubscribe(channel, @[func], @) for channel, func of @subscriptions\r\n    @show = null\r\n    @destroyed = true\r\n\r\n  toString: -> '<CoordinateDisplay>'\r\n\r\n  build: ->\r\n    @mouseEnabled = @mouseChildren = false\r\n    @addChild @background = new createjs.Shape()\r\n    @addChild @label = new createjs.Text('', 'bold 16px Arial', '#FFFFFF')\r\n    @addChild @pointMarker = new createjs.Shape()\r\n    @label.name = 'Coordinate Display Text'\r\n    @label.shadow = new createjs.Shadow('#000000', 1, 1, 0)\r\n    @background.name = 'Coordinate Display Background'\r\n    @pointMarker.name = 'Point Marker'\r\n    @layer.addChild @\r\n\r\n  onMouseOver: (e) -> @mouseInBounds = true\r\n  onMouseOut: (e) -> @mouseInBounds = false\r\n\r\n  onMouseMove: (e) ->\r\n    wop = @camera.screenToWorld x: e.x, y: e.y\r\n    wop.x = Math.round(wop.x)\r\n    wop.y = Math.round(wop.y)\r\n    return if wop.x is @lastPos?.x and wop.y is @lastPos?.y\r\n    @lastPos = wop\r\n    @lastScreenPos = x: e.x, y: e.y\r\n    @hide()\r\n    @show()  # debounced\r\n\r\n  onMouseDown: (e) ->\r\n    return unless key.shift\r\n    wop = @camera.screenToWorld x: e.x, y: e.y\r\n    wop.x = Math.round wop.x\r\n    wop.y = Math.round wop.y\r\n    Backbone.Mediator.publish 'tome:focus-editor', {}\r\n    Backbone.Mediator.publish 'surface:coordinate-selected', wop\r\n\r\n  onZoomUpdated: (e) ->\r\n    return unless @lastPos\r\n    wop = @camera.screenToWorld @lastScreenPos\r\n    @lastPos.x = Math.round wop.x\r\n    @lastPos.y = Math.round wop.y\r\n    @performShow() if @label.parent\r\n\r\n  onFlagColorSelected: (e) ->\r\n    @placingFlag = Boolean e.color\r\n\r\n  hide: ->\r\n    return unless @label.parent\r\n    @removeChild @label\r\n    @removeChild @background\r\n    @removeChild @pointMarker\r\n    @uncache()\r\n\r\n  updateSize: ->\r\n    margin = 3\r\n    contentWidth = @label.getMeasuredWidth() + (2 * margin)\r\n    contentHeight = @label.getMeasuredHeight() + (2 * margin)\r\n\r\n    # Shift pointmarker up so it centers at pointer (affects container cache position)\r\n    @pointMarker.regY = contentHeight\r\n\r\n    pointMarkerStroke = 2\r\n    pointMarkerLength = 8\r\n    fullPointMarkerLength = pointMarkerLength + (pointMarkerStroke / 2)\r\n    contributionsToTotalSize = []\r\n    contributionsToTotalSize = contributionsToTotalSize.concat @updateCoordinates contentWidth, contentHeight, fullPointMarkerLength\r\n    contributionsToTotalSize = contributionsToTotalSize.concat @updatePointMarker 0, contentHeight, pointMarkerLength, pointMarkerStroke\r\n\r\n    totalWidth = contentWidth + contributionsToTotalSize.reduce (a, b) -> a + b\r\n    totalHeight = contentHeight + contributionsToTotalSize.reduce (a, b) -> a + b\r\n\r\n    if @isNearTopEdge()\r\n      verticalEdge =\r\n        startPos: -fullPointMarkerLength\r\n        posShift: -contentHeight + 4\r\n    else\r\n      verticalEdge =\r\n        startPos: -totalHeight + fullPointMarkerLength\r\n        posShift: contentHeight\r\n\r\n    if @isNearRightEdge()\r\n      horizontalEdge =\r\n        startPos: -totalWidth + fullPointMarkerLength\r\n        posShift: totalWidth\r\n    else\r\n      horizontalEdge =\r\n        startPos: -fullPointMarkerLength\r\n        posShift: 0\r\n\r\n    @orient verticalEdge, horizontalEdge, totalHeight, totalWidth\r\n\r\n  isNearTopEdge: ->\r\n    yRatio = 1 - (@camera.worldViewport.y - @lastPos.y) / @camera.worldViewport.height\r\n    yRatio > 0.9\r\n\r\n  isNearRightEdge: ->\r\n    xRatio = (@lastPos.x - @camera.worldViewport.x) / @camera.worldViewport.width\r\n    xRatio > 0.85\r\n\r\n  orient: (verticalEdge, horizontalEdge, totalHeight, totalWidth) ->\r\n    @label.regY = @background.regY = verticalEdge.posShift\r\n    @label.regX = @background.regX = horizontalEdge.posShift\r\n    @cache horizontalEdge.startPos, verticalEdge.startPos, totalWidth, totalHeight\r\n\r\n  updateCoordinates: (contentWidth, contentHeight, offset) ->\r\n    # Center label horizontally and vertically\r\n    @label.x = contentWidth / 2 - (@label.getMeasuredWidth() / 2) + offset\r\n    @label.y = contentHeight / 2 - (@label.getMeasuredHeight() / 2) - offset\r\n\r\n    @background.graphics\r\n      .clear()\r\n      .beginFill('rgba(0,0,0,0.4)')\r\n      .beginStroke('rgba(0,0,0,0.6)')\r\n      .setStrokeStyle(backgroundStroke = 1)\r\n      .drawRoundRect(offset, -offset, contentWidth, contentHeight, radius = 2.5)\r\n      .endFill()\r\n      .endStroke()\r\n    contributionsToTotalSize = [offset, backgroundStroke]\r\n\r\n  updatePointMarker: (centerX, centerY, length, strokeSize) ->\r\n    strokeStyle = 'square'\r\n    @pointMarker.graphics\r\n      .beginStroke('rgb(255, 255, 255)')\r\n      .setStrokeStyle(strokeSize, strokeStyle)\r\n      .moveTo(centerX, centerY - length)\r\n      .lineTo(centerX, centerY + length)\r\n      .moveTo(centerX - length, centerY)\r\n      .lineTo(centerX + length, centerY)\r\n      .endStroke()\r\n    contributionsToTotalSize = [strokeSize, length]\r\n\r\n  show: =>\r\n    return unless @mouseInBounds and @lastPos and not @destroyed\r\n    @label.text = \"{x: #{@lastPos.x}, y: #{@lastPos.y}}\"\r\n    @updateSize()\r\n    sup = @camera.worldToSurface @lastPos\r\n    @x = sup.x\r\n    @y = sup.y\r\n    @addChild @background\r\n    @addChild @label\r\n    @addChild @pointMarker unless @placingFlag\r\n    @updateCache()\r\n    Backbone.Mediator.publish 'surface:coordinates-shown', {}\r\n"]}