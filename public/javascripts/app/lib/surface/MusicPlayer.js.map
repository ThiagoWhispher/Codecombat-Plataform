{"version":3,"sources":["app/lib/surface/MusicPlayer.coffee"],"names":[],"mappings":"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","file":"public/javascripts/app/lib/surface/MusicPlayer.js","sourcesContent":["CocoClass = require 'core/CocoClass'\r\nAudioPlayer = require 'lib/AudioPlayer'\r\n{me} = require 'core/auth'\r\n\r\nCROSSFADE_LENGTH = 1500\r\nMUSIC_VOLUME = 0.6\r\n\r\nmodule.exports = class MusicPlayer extends CocoClass\r\n  currentMusic: null\r\n  standingBy: null\r\n\r\n  subscriptions:\r\n    'music-player:play-music': 'onPlayMusic'\r\n    'audio-player:loaded': 'onAudioLoaded'\r\n    'playback:real-time-playback-started': 'onRealTimePlaybackStarted'\r\n    'playback:real-time-playback-ended': 'onRealTimePlaybackEnded'\r\n    'music-player:enter-menu': 'onEnterMenu'\r\n    'music-player:exit-menu': 'onExitMenu'\r\n    'level:set-volume': 'onSetVolume'\r\n\r\n  constructor: ->\r\n    super arguments...\r\n    me.on 'change:music', @onMusicSettingChanged, @\r\n\r\n  onAudioLoaded: ->\r\n    @onPlayMusic(@standingBy) if @standingBy\r\n\r\n  onPlayMusic: (e) ->\r\n    return if application.isIPadApp  # Hard to measure, but just guessing this will save memory.\r\n    unless me.get 'volume'\r\n      @lastMusicEventIgnoredWhileMuted = e\r\n      return\r\n    src = e.file\r\n    src = \"/file#{src}#{AudioPlayer.ext}\"\r\n    if (not e.file) or src is @currentMusic?.src\r\n      if e.play then @restartCurrentMusic() else @fadeOutCurrentMusic()\r\n      return\r\n\r\n    media = AudioPlayer.getStatus(src)\r\n    if not media?.loaded\r\n      AudioPlayer.preloadSound(src)\r\n      @standingBy = e\r\n      return\r\n\r\n    delay = e.delay ? 0\r\n    @standingBy = null\r\n    @fadeOutCurrentMusic()\r\n    @startNewMusic(src, delay) if e.play\r\n\r\n  restartCurrentMusic: ->\r\n    return unless @currentMusic\r\n    @currentMusic.play('none', 0, 0, -1, 0.3)\r\n    @updateMusicVolume()\r\n\r\n  fadeOutCurrentMusic: ->\r\n    return unless @currentMusic\r\n    createjs.Tween.removeTweens(@currentMusic)\r\n    f = -> @stop()\r\n    createjs.Tween.get(@currentMusic).to({volume: 0.0}, CROSSFADE_LENGTH).call(f)\r\n\r\n  startNewMusic: (src, delay) ->\r\n    @currentMusic = createjs.Sound.play(src, 'none', 0, 0, -1, 0.3) if src\r\n    return unless @currentMusic\r\n    @currentMusic.volume = 0.0\r\n    if me.get('music', true)\r\n      createjs.Tween.get(@currentMusic).wait(delay).to({volume: MUSIC_VOLUME}, CROSSFADE_LENGTH)\r\n\r\n  onMusicSettingChanged: ->\r\n    @updateMusicVolume()\r\n\r\n  updateMusicVolume: ->\r\n    return unless @currentMusic\r\n    createjs.Tween.removeTweens(@currentMusic)\r\n    @currentMusic.volume = if me.get('music', true) then MUSIC_VOLUME else 0.0\r\n\r\n  onRealTimePlaybackStarted: (e) ->\r\n    @previousMusic = @currentMusic\r\n    trackNumber = _.random 0, 2\r\n    Backbone.Mediator.publish 'music-player:play-music', file: \"/music/music_real_time_#{trackNumber}\", play: true\r\n\r\n  onRealTimePlaybackEnded: (e) ->\r\n    @fadeOutCurrentMusic()\r\n    if @previousMusic\r\n      @currentMusic = @previousMusic\r\n      @restartCurrentMusic()\r\n      if @currentMusic.volume\r\n        createjs.Tween.get(@currentMusic).wait(5000).to({volume: MUSIC_VOLUME}, CROSSFADE_LENGTH)\r\n\r\n  onEnterMenu: (e) ->\r\n    return if @inMenu\r\n    @inMenu = true\r\n    @previousMusic = @currentMusic\r\n    file = \"/music/music-menu\"\r\n    Backbone.Mediator.publish 'music-player:play-music', file: file, play: true, delay: 1000\r\n\r\n  onExitMenu: (e) ->\r\n    return unless @inMenu\r\n    @inMenu = false\r\n    @fadeOutCurrentMusic()\r\n    if @previousMusic\r\n      @currentMusic = @previousMusic\r\n      @restartCurrentMusic()\r\n\r\n  onSetVolume: (e) ->\r\n    return unless e.volume and @lastMusicEventIgnoredWhileMuted\r\n    @onPlayMusic @lastMusicEventIgnoredWhileMuted\r\n    @lastMusicEventIgnoredWhileMuted = null\r\n\r\n  destroy: ->\r\n    me.off 'change:music', @onMusicSettingChanged, @\r\n    @fadeOutCurrentMusic()\r\n    super()\r\n"]}