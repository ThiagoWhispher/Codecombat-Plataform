{"version":3,"sources":["app/lib/surface/Label.coffee"],"names":[],"mappings":"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","file":"public/javascripts/app/lib/surface/Label.js","sourcesContent":["CocoClass = require 'core/CocoClass'\r\n\r\nmodule.exports = class Label extends CocoClass\r\n  @STYLE_DIALOGUE = 'dialogue'  # A speech bubble from a script\r\n  @STYLE_SAY = 'say'  # A piece of text generated from the world\r\n  @STYLE_NAME = 'name'  # A name like Scott set up for the Wizard\r\n  # We might want to combine 'say' and 'name'; they're very similar\r\n  # Nick designed 'say' based off of Scott's 'name' back when they were using two systems\r\n  @STYLE_VAR = 'variable' \r\n\r\n  subscriptions: {}\r\n\r\n  constructor: (options) ->\r\n    super()\r\n    options ?= {}\r\n    @sprite = options.sprite\r\n    @camera = options.camera\r\n    @layer = options.layer\r\n    @style = options.style ? (@sprite?.thang?.labelStyle || Label.STYLE_SAY)\r\n    console.error @toString(), 'needs a sprite.' unless @sprite\r\n    console.error @toString(), 'needs a camera.' unless @camera\r\n    console.error @toString(), 'needs a layer.' unless @layer\r\n    @setText options.text if options.text\r\n\r\n  destroy: ->\r\n    @setText null\r\n    super()\r\n\r\n  toString: -> \"<Label for #{@sprite?.thang?.id ? 'None'}: #{@text?.substring(0, 10) ? ''}>\"\r\n\r\n  setText: (text) ->\r\n    # Returns whether an update was actually performed\r\n    return false if text is @text\r\n    @text = text\r\n    @build()\r\n    true\r\n\r\n  build: ->\r\n    if @layer and not @layer.destroyed\r\n      @layer.removeChild @background if @background\r\n      @layer.removeChild @label if @label\r\n    @label = null\r\n    @background = null\r\n    return unless @text  # null or '' should both be skipped\r\n    o = @buildLabelOptions()\r\n    @layer.addChild @label = @buildLabel o\r\n    @layer.addChild @background = @buildBackground o\r\n    @layer.updateLayerOrder()\r\n\r\n  update: ->\r\n    return unless @text and @sprite.sprite\r\n    offset = @sprite.getOffset? (if @style in ['dialogue', 'say'] then 'mouth' else 'aboveHead')\r\n    offset ?= x: 0, y: 0  # temp (if not Lank)\r\n    offset.y += 10 if @style is 'variable'\r\n    rotation = @sprite.getRotation()\r\n    offset.x *= -1 if rotation >= 135 or rotation <= -135\r\n    @label.x = @background.x = @sprite.sprite.x + offset.x\r\n    @label.y = @background.y = @sprite.sprite.y + offset.y\r\n    null\r\n\r\n  show: ->\r\n    return unless @label\r\n    @layer.addChild @label\r\n    @layer.addChild @background\r\n    @layer.updateLayerOrder()\r\n\r\n  hide: ->\r\n    return unless @label\r\n    @layer.removeChild @background\r\n    @layer.removeChild @label\r\n\r\n  buildLabelOptions: ->\r\n    o = {}\r\n    st = {dialogue: 'D', say: 'S', name: 'N', variable: 'V'}[@style]\r\n    o.marginX = {D: 5, S: 6, N: 3, V: 0}[st]\r\n    o.marginY = {D: 6, S: 4, N: 3, V: 0}[st]\r\n    o.fontWeight = {D: 'bold', S: 'bold', N: 'bold', V: 'bold'}[st]\r\n    o.shadow = {D: false, S: true, N: true, V: true}[st]\r\n    o.shadowColor = {D: '#FFF', S: '#000', N: '#000', V: \"#000\"}[st]\r\n    o.fontSize = {D: 25, S: 12, N: 24, V:18}[st]\r\n    fontFamily = {D: 'Arial', S: 'Arial', N: 'Arial', B: 'Arial', V: 'Arial'}[st]\r\n    o.fontDescriptor = \"#{o.fontWeight} #{o.fontSize}px #{fontFamily}\"\r\n    o.fontColor = {D: '#000', S: '#FFF', N: '#6c6', V:'#6c6'}[st]\r\n    if @style is 'name' and @sprite?.thang?.team is 'humans'\r\n      o.fontColor = '#c66'\r\n    else if @style is 'name' and @sprite?.thang?.team is 'ogres'\r\n      o.fontColor = '#66c'\r\n    else if @style is 'variable'\r\n      o.fontColor = '#fff'\r\n\r\n    o.backgroundFillColor = {D: 'white', S: 'rgba(0,0,0,0.4)', N: 'rgba(0,0,0,0.7)', V: 'rgba(0,0,0,0.7)'}[st]\r\n    o.backgroundStrokeColor = {D: 'black', S: 'rgba(0,0,0,0.6)', N: 'rgba(0,0,0,0)', V: 'rgba(0,0,0,0)'}[st]\r\n    o.backgroundStrokeStyle = {D: 2, S: 1, N: 1, V: 1}[st]\r\n    o.backgroundBorderRadius = {D: 10, S: 3, N: 3, V: 3}[st]\r\n    o.layerPriority = {D: 10, S: 5, N: 5, V: 5}[st]\r\n    maxWidth = {D: 300, S: 300, N: 180, V: 100}[st]\r\n    maxWidth = Math.max @camera.canvasWidth / 2 - 100, maxWidth  # Does this do anything?\r\n    maxLength = {D: 100, S: 100, N: 30, V:30}[st]\r\n    multiline = @addNewLinesToText _.string.prune(@text, maxLength), o.fontDescriptor, maxWidth\r\n    o.text = multiline.text\r\n    o.textWidth = multiline.textWidth\r\n    o\r\n\r\n  buildLabel: (o) ->\r\n    label = new createjs.Text o.text, o.fontDescriptor, o.fontColor\r\n    label.lineHeight = o.fontSize + 2\r\n    label.x = o.marginX\r\n    label.y = o.marginY\r\n    label.shadow = new createjs.Shadow o.shadowColor, 1, 1, 0 if o.shadow\r\n    label.layerPriority = o.layerPriority\r\n    label.name = \"Sprite Label - #{@style}\"\r\n    bounds = label.getBounds()\r\n    label.cache(bounds.x, bounds.y, bounds.width, bounds.height)\r\n    o.textHeight = label.getMeasuredHeight()\r\n    o.label = label\r\n    label\r\n\r\n  buildBackground: (o) ->\r\n    w = o.textWidth + 2 * o.marginX\r\n    h = o.textHeight + 2 * o.marginY + 1  # Is this +1 needed?\r\n\r\n    background = new createjs.Shape()\r\n    background.name = \"Sprite Label Background - #{@style}\"\r\n    g = background.graphics\r\n    g.beginFill o.backgroundFillColor\r\n    g.beginStroke o.backgroundStrokeColor\r\n    g.setStrokeStyle o.backgroundStrokeStyle\r\n\r\n    if @style is 'dialogue'\r\n      radius = o.backgroundBorderRadius  # Rounded rectangle border radius\r\n      pointerHeight = 10  # Height of pointer triangle\r\n      pointerWidth = 8  # Actual width of pointer triangle\r\n      pointerWidth += radius  # Convenience value including pointer width and border radius\r\n\r\n      # Figure out the position of the pointer for the bubble\r\n      sup = x: @sprite.sprite.x, y: @sprite.sprite.y  # a little more accurate to aim for mouth--how?\r\n      cap = @camera.surfaceToCanvas sup\r\n      hPos = if cap.x / @camera.canvasWidth > 0.53 then 'right' else 'left'\r\n      vPos = if cap.y / @camera.canvasHeight > 0.53 then 'bottom' else 'top'\r\n      pointerPos = \"#{vPos}-#{hPos}\"\r\n      # TODO: we should redo this when the Thang moves enough, not just when we change its text\r\n      #return if pointerPos is @lastBubblePos and blurb is @lastBlurb\r\n\r\n      # Draw a rounded rectangle with the pointer coming out of it\r\n      g.moveTo(radius, 0)\r\n      if pointerPos is 'top-left'\r\n        g.lineTo(radius / 2, -pointerHeight)\r\n        g.lineTo(pointerWidth, 0)\r\n      else if pointerPos is 'top-right'\r\n        g.lineTo(w - pointerWidth, 0)\r\n        g.lineTo(w - radius / 2, -pointerHeight)\r\n\r\n      # Draw top and right edges\r\n      g.lineTo(w - radius, 0)\r\n      g.quadraticCurveTo(w, 0, w, radius)\r\n      g.lineTo(w, h - radius)\r\n      g.quadraticCurveTo(w, h, w - radius, h)\r\n\r\n      if pointerPos is 'bottom-right'\r\n        g.lineTo(w - radius / 2, h + pointerHeight)\r\n        g.lineTo(w - pointerWidth, h)\r\n      else if pointerPos is 'bottom-left'\r\n        g.lineTo(pointerWidth, h)\r\n        g.lineTo(radius / 2, h + pointerHeight)\r\n\r\n      # Draw bottom and left edges\r\n      g.lineTo(radius, h)\r\n      g.quadraticCurveTo(0, h, 0, h - radius)\r\n      g.lineTo(0, radius)\r\n      g.quadraticCurveTo(0, 0, radius, 0)\r\n\r\n      # Center the container where the mouth of the speaker will be\r\n      background.regX = if hPos is 'left' then 3 else o.textWidth + 3\r\n      background.regY = if vPos is 'bottom' then h + pointerHeight else -pointerHeight\r\n\r\n    else\r\n      # Just draw a rounded rectangle\r\n      background.regX = w / 2\r\n      background.regY = h + 2  # Just above health bar, say\r\n      g.drawRoundRect(o.label.x - o.marginX, o.label.y - o.marginY, w, h, o.backgroundBorderRadius)\r\n\r\n    o.label.regX = background.regX - o.marginX\r\n    o.label.regY = background.regY - o.marginY\r\n    background.cache(-10, -10, w+20, h+20) # give a wide berth for speech box pointers\r\n\r\n    g.endStroke()\r\n    g.endFill()\r\n    background.layerPriority = o.layerPriority - 1\r\n    background\r\n\r\n  addNewLinesToText: (originalText, fontDescriptor, maxWidth=400) ->\r\n    rows = []\r\n    row = []\r\n    words = _.string.words originalText\r\n    textWidth = 0\r\n    for word in words\r\n      row.push(word)\r\n      text = new createjs.Text(_.string.join(' ', row...), fontDescriptor, '#000')\r\n      width = text.getMeasuredWidth()\r\n      if width > maxWidth\r\n        if row.length is 1 # one long word, truncate it\r\n          row[0] = _.string.truncate(row[0], 40)\r\n          text.text = row[0]\r\n          textWidth = Math.max(text.getMeasuredWidth(), textWidth)\r\n          rows.push(row)\r\n          row = []\r\n        else\r\n          row.pop()\r\n          rows.push(row)\r\n          row = [word]\r\n      else\r\n        textWidth = Math.max(textWidth, width)\r\n    rows.push(row) if row.length\r\n    for row, i in rows\r\n      rows[i] = _.string.join(' ', row...)\r\n    text: _.string.join(\"\\n\", rows...), textWidth: textWidth\r\n"]}