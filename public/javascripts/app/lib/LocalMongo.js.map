{"version":3,"sources":["app/lib/LocalMongo.coffee"],"names":[],"mappings":"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","file":"public/javascripts/app/lib/LocalMongo.js","sourcesContent":["LocalMongo = module.exports\r\n\r\n# Checks whether func(l, r) is true for at least one value of left for at least one value of right\r\nmapred = (left, right, func) ->\r\n  _.reduce(left, ((result, singleLeft) ->\r\n    result or (_.reduce (_.map right, (singleRight) -> func(singleLeft, singleRight)),\r\n      ((intermediate, value) -> intermediate or value), false)), false)\r\n\r\ndoQuerySelector = (originalValue, operatorObj) ->\r\n  value = if _.isArray originalValue then originalValue else [originalValue] # left hand can be an array too\r\n  for operator, originalBody of operatorObj\r\n    body = if _.isArray originalBody then originalBody else [originalBody] # right hand can be an array too\r\n    switch operator\r\n      when '$gt' then return false unless mapred value, body, (l, r) -> l > r\r\n      when '$gte' then return false unless mapred value, body, (l, r) -> l >= r\r\n      when '$lt' then return false unless mapred value, body, (l, r) -> l < r\r\n      when '$lte' then return false unless mapred value, body, (l, r) -> l <= r\r\n      when '$ne' then return false if mapred value, body, (l, r) -> l == r\r\n      when '$in' then return false unless _.reduce value, ((result, val) -> result or val in body), false\r\n      when '$nin' then return false if _.reduce value, ((result, val) -> result or val in body), false\r\n      when '$exists' then return false if value[0]? isnt body[0]\r\n      else \r\n        trimmedOperator = _.pick(operatorObj, operator)\r\n        return false unless _.isObject(originalValue) and matchesQuery(originalValue, trimmedOperator)\r\n  true\r\n\r\nmatchesQuery = (target, queryObj) ->\r\n  return true unless queryObj\r\n  throw new Error 'Expected an object to match a query against, instead got null' unless target\r\n  for prop, query of queryObj\r\n    if prop[0] == '$'\r\n      switch prop\r\n        when '$or' then return false unless _.reduce query, ((res, obj) -> res or matchesQuery target, obj), false\r\n        when '$and' then return false unless _.reduce query, ((res, obj) -> res and matchesQuery target, obj), true\r\n        else return false\r\n    else\r\n      # Do nested properties\r\n      pieces = prop.split('.')\r\n      obj = target\r\n      for piece in pieces\r\n        unless piece of obj\r\n          obj = null\r\n          break\r\n        obj = obj[piece]\r\n      if typeof query != 'object' or _.isArray query\r\n        return false unless obj == query or (query in obj if _.isArray obj)\r\n      else return false unless doQuerySelector obj, query\r\n  true\r\n\r\nLocalMongo.matchesQuery = matchesQuery\r\n"]}