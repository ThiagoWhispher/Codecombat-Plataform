{"version":3,"sources":["app/lib/Angel.coffee"],"names":[],"mappings":"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","file":"public/javascripts/app/lib/Angel.js","sourcesContent":["# Every Angel has one web worker attached to it. It will call methods inside the worker and kill it if it times out.\r\n# God is the public API; Angels are an implementation detail. Each God can have one or more Angels.\r\n\r\n{now} = require 'lib/world/world_utils'\r\nWorld = require 'lib/world/world'\r\nCocoClass = require 'core/CocoClass'\r\nGoalManager = require 'lib/world/GoalManager'\r\n{sendContactMessage} = require 'core/contact'\r\nerrors = require 'core/errors'\r\n\r\nreportedLoadErrorAlready = false\r\n\r\nmodule.exports = class Angel extends CocoClass\r\n  @nicks: ['Archer', 'Lana', 'Cyril', 'Pam', 'Cheryl', 'Woodhouse', 'Ray', 'Krieger']\r\n\r\n  infiniteLoopIntervalDuration: 10000  # check this often; must be longer than other two combined\r\n  infiniteLoopTimeoutDuration: 7500  # wait this long for a response when checking\r\n  abortTimeoutDuration: 500  # give in-process or dying workers this long to give up\r\n\r\n  subscriptions:\r\n    'level:flag-updated': 'onFlagEvent'\r\n    'playback:stop-real-time-playback': 'onStopRealTimePlayback'\r\n    'level:escape-pressed': 'onEscapePressed'\r\n\r\n  constructor: (@shared) ->\r\n    super()\r\n    @say 'Got my wings.'\r\n    isIE = window.navigator and (window.navigator.userAgent.search('MSIE') isnt -1 or window.navigator.appName is 'Microsoft Internet Explorer')\r\n    slowerSimulations = isIE  #or @shared.headless\r\n    # Since IE is so slow to serialize without transferable objects, we can't trust it.\r\n    # We also noticed the headless_client simulator needing more time. (This does both Simulators, though.) If we need to use lots of headless clients, enable this.\r\n    if slowerSimulations\r\n      @infiniteLoopIntervalDuration *= 10\r\n      @infiniteLoopTimeoutDuration *= 10\r\n      @abortTimeoutDuration *= 10\r\n    @initialized = false\r\n    @running = false\r\n    @allLogs = []\r\n    @hireWorker()\r\n    @shared.angels.push @\r\n    @listenTo @shared.gameUIState.get('realTimeInputEvents'), 'add', @onAddRealTimeInputEvent\r\n\r\n  destroy: ->\r\n    @fireWorker false\r\n    _.remove @shared.angels, @\r\n    super()\r\n\r\n  workIfIdle: ->\r\n    @doWork() unless @running\r\n\r\n  # say: debugging stuff, usually off; log: important performance indicators, keep on\r\n  say: (args...) -> #@log args...\r\n  log: ->\r\n    # console.info.apply is undefined in IE9, CoffeeScript splats invocation won't work.\r\n    # http://stackoverflow.com/questions/5472938/does-ie9-support-console-log-and-is-it-a-real-function\r\n    message = \"|#{@shared.godNick}'s #{@nick}|\"\r\n    message += \" #{arg}\" for arg in arguments\r\n    console.info message\r\n    @allLogs.push message\r\n\r\n  testWorker: =>\r\n    return if @destroyed\r\n    clearTimeout @condemnTimeout\r\n    @condemnTimeout = _.delay @infinitelyLooped, @infiniteLoopTimeoutDuration\r\n    @say 'Let\\'s give it', @infiniteLoopTimeoutDuration, 'to not loop.'\r\n    @worker.postMessage func: 'reportIn'\r\n\r\n  onWorkerMessage: (event) =>\r\n    return @say 'Currently aborting old work.' if @aborting and event.data.type isnt 'abort'\r\n\r\n    switch event.data.type\r\n      # First step: worker has to load the scripts.\r\n      when 'worker-initialized'\r\n        unless @initialized\r\n          @log \"Worker initialized after #{(new Date()) - @worker.creationTime}ms\"\r\n          @initialized = true\r\n          @doWork()\r\n\r\n      # We watch over the worker as it loads the world frames to make sure it doesn't infinitely loop.\r\n      when 'start-load-frames'\r\n        clearTimeout @condemnTimeout\r\n      when 'report-in'\r\n        @say 'Worker reported in.'\r\n        clearTimeout @condemnTimeout\r\n      when 'end-load-frames'\r\n        clearTimeout @condemnTimeout\r\n        @beholdGoalStates {goalStates: event.data.goalStates, overallStatus: event.data.overallStatus, preload: false, totalFrames: event.data.totalFrames, lastFrameHash: event.data.lastFrameHash, simulationFrameRate: event.data.simulationFrameRate}  # Work ends here if we're headless.\r\n      when 'end-preload-frames'\r\n        clearTimeout @condemnTimeout\r\n        @beholdGoalStates {goalStates: event.data.goalStates, overallStatus: event.data.overallStatus, preload: true, simulationFrameRate: event.data.simulationFrameRate}\r\n\r\n      # We have to abort like an infinite loop if we see one of these; they're not really recoverable\r\n      when 'non-user-code-problem'\r\n        @publishGodEvent 'non-user-code-problem', problem: event.data.problem\r\n        if @shared.firstWorld\r\n          @infinitelyLooped(false, true)  # For now, this should do roughly the right thing if it happens during load.\r\n        else\r\n          @fireWorker()\r\n\r\n      # If it didn't finish simulating successfully, or we abort the worker.\r\n      when 'abort'\r\n        @say 'Aborted.', event.data\r\n        clearTimeout @abortTimeout\r\n        @aborting = false\r\n        @running = false\r\n        _.remove @shared.busyAngels, @\r\n        @doWork()\r\n\r\n      # We pay attention to certain progress indicators as the world loads.\r\n      when 'console-log'\r\n        @log event.data.args...\r\n      when 'user-code-problem'\r\n        @publishGodEvent 'user-code-problem', problem: event.data.problem\r\n      when 'world-load-progress-changed'\r\n        progress = event.data.progress\r\n        progress = Math.min(progress, 0.9) if @work.indefiniteLength\r\n        @publishGodEvent 'world-load-progress-changed', { progress }\r\n        unless event.data.progress is 1 or @work.preload or @work.headless or @work.synchronous or @deserializationQueue.length or (@shared.firstWorld and not @shared.spectate)\r\n          @worker.postMessage func: 'serializeFramesSoFar'  # Stream it!\r\n\r\n      # We have some or all of the frames serialized, so let's send the (partially?) simulated world to the Surface.\r\n      when 'some-frames-serialized', 'new-world'\r\n        deserializationArgs = [event.data.serialized, event.data.goalStates, event.data.startFrame, event.data.endFrame, @streamingWorld]\r\n        @deserializationQueue.push deserializationArgs\r\n        if @deserializationQueue.length is 1\r\n          @beholdWorld deserializationArgs...\r\n\r\n      else\r\n        @log 'Received unsupported message:', event.data\r\n\r\n  beholdGoalStates: ({goalStates, overallStatus, preload, totalFrames, lastFrameHash, simulationFrameRate}) ->\r\n    return if @aborting\r\n    event = goalStates: goalStates, preload: preload ? false, overallStatus: overallStatus\r\n    event.totalFrames = totalFrames if totalFrames?\r\n    event.lastFrameHash = lastFrameHash if lastFrameHash?\r\n    event.simulationFrameRate = simulationFrameRate if simulationFrameRate?\r\n    @publishGodEvent 'goals-calculated', event\r\n    @finishWork() if @shared.headless\r\n\r\n  beholdWorld: (serialized, goalStates, startFrame, endFrame, streamingWorld) ->\r\n    return if @aborting\r\n    # Toggle BOX2D_ENABLED during deserialization so that if we have box2d in the namespace, the Collides Components still don't try to create bodies for deserialized Thangs upon attachment.\r\n    window.BOX2D_ENABLED = false\r\n    streamingWorld?.indefiniteLength = @work.indefiniteLength\r\n    @streamingWorld = World.deserialize serialized, @shared.worldClassMap, @shared.lastSerializedWorldFrames, @finishBeholdingWorld(goalStates), startFrame, endFrame, @work.level, streamingWorld\r\n    window.BOX2D_ENABLED = true\r\n    @shared.lastSerializedWorldFrames = serialized.frames\r\n\r\n  finishBeholdingWorld: (goalStates) -> (world) =>\r\n    return if @aborting or @destroyed\r\n    finished = world.frames.length is world.totalFrames\r\n    if @work?.indefiniteLength and world.victory?\r\n      finished = true\r\n      world.totalFrames = world.frames.length\r\n    firstChangedFrame = if @work?.indefiniteLength then 0 else world.findFirstChangedFrame @shared.world\r\n    eventType = if finished then 'new-world-created' else 'streaming-world-updated'\r\n    if finished\r\n      @shared.world = world\r\n    @publishGodEvent eventType, world: world, firstWorld: @shared.firstWorld, goalStates: goalStates, team: me.team, firstChangedFrame: firstChangedFrame, finished: finished\r\n    if finished\r\n      for scriptNote in @shared.world.scriptNotes\r\n        Backbone.Mediator.publish scriptNote.channel, scriptNote.event\r\n      @shared.goalManager?.world = world\r\n      @finishWork()\r\n    else\r\n      @deserializationQueue.shift()  # Finished with this deserialization.\r\n      if deserializationArgs = @deserializationQueue[0]  # Start another?\r\n        @beholdWorld deserializationArgs...\r\n\r\n  finishWork: ->\r\n    @streamingWorld = null\r\n    @shared.firstWorld = false\r\n    @deserializationQueue = []\r\n    @running = false\r\n    _.remove @shared.busyAngels, @\r\n    clearTimeout @condemnTimeout\r\n    clearInterval @purgatoryTimer\r\n    @condemnTimeout = @purgatoryTimer = null\r\n    @doWork()\r\n\r\n  finalizePreload: ->\r\n    @say 'Finalize preload.'\r\n    @worker.postMessage func: 'finalizePreload'\r\n    @work.preload = false\r\n\r\n  infinitelyLooped: (escaped=false, nonUserCodeProblem=false) =>\r\n    @say 'On infinitely looped! Aborting?', @aborting\r\n    return if @aborting\r\n    problem = type: 'runtime', level: 'error', id: 'runtime_InfiniteLoop', message: 'Code never finished. It\\'s either really slow or has an infinite loop.'\r\n    problem.message = 'Escape pressed; code aborted.' if escaped\r\n    @publishGodEvent 'user-code-problem', problem: problem\r\n    @publishGodEvent 'infinite-loop', firstWorld: @shared.firstWorld, nonUserCodeProblem: nonUserCodeProblem\r\n    @reportLoadError() if nonUserCodeProblem\r\n    @fireWorker()\r\n\r\n  publishGodEvent: (channel, e) ->\r\n    # For Simulator. TODO: refactor all the god:* Mediator events to be local events.\r\n    @shared.god.trigger channel, e\r\n    e.god = @shared.god\r\n    Backbone.Mediator.publish 'god:' + channel, e\r\n\r\n  reportLoadError: ->\r\n    return if me.isAdmin() or /dev=true/.test(window.location?.href ? '') or reportedLoadErrorAlready\r\n    reportedLoadErrorAlready = true\r\n    context = email: me.get('email')\r\n    context.message = \"Automatic Report - Unable to Load Level\\nLogs:\\n\" + @allLogs.join('\\n')\r\n    if $.browser\r\n      context.browser = \"#{$.browser.platform} #{$.browser.name} #{$.browser.versionNumber}\"\r\n    context.screenSize = \"#{screen?.width ? $(window).width()} x #{screen?.height ? $(window).height()}\"\r\n    context.subject = \"Level Load Error: #{@work?.level?.name or 'Unknown Level'}\"\r\n    context.levelSlug = @work?.level?.slug\r\n    sendContactMessage context\r\n\r\n  doWork: ->\r\n    return if @aborting\r\n    return @say 'Not initialized for work yet.' unless @initialized\r\n    if @shared.workQueue.length\r\n      @work = @shared.workQueue.shift()\r\n      return _.defer @simulateSync, @work if @work.synchronous\r\n      @say 'Running world...'\r\n      @running = true\r\n      @shared.busyAngels.push @\r\n      @deserializationQueue = []\r\n      @worker.postMessage func: 'runWorld', args: @work\r\n      clearTimeout @purgatoryTimer\r\n      @say 'Infinite loop timer started at interval of', @infiniteLoopIntervalDuration\r\n      @purgatoryTimer = setInterval @testWorker, @infiniteLoopIntervalDuration\r\n    else\r\n      @say 'No work to do.'\r\n      @hireWorker()\r\n\r\n  abort: ->\r\n    return unless @worker and @running\r\n    @say 'Aborting...'\r\n    @running = false\r\n    @work = null\r\n    @streamingWorld = null\r\n    @deserializationQueue = []\r\n    _.remove @shared.busyAngels, @\r\n    @abortTimeout = _.delay @fireWorker, @abortTimeoutDuration\r\n    @aborting = true\r\n    @worker.postMessage func: 'abort'\r\n\r\n  fireWorker: (rehire=true) =>\r\n    return if @destroyed\r\n    @aborting = false\r\n    @running = false\r\n    _.remove @shared.busyAngels, @\r\n    @worker?.removeEventListener 'message', @onWorkerMessage\r\n    @worker?.terminate()\r\n    @worker = null\r\n    clearTimeout @condemnTimeout\r\n    clearInterval @purgatoryTimer\r\n    @say 'Fired worker.'\r\n    @initialized = false\r\n    @work = null\r\n    @streamingWorld = null\r\n    @deserializationQueue = []\r\n    @hireWorker() if rehire\r\n\r\n  hireWorker: ->\r\n    unless Worker?\r\n      unless @initialized\r\n        @initialized = true\r\n        @doWork()\r\n      return null\r\n    return if @worker\r\n    @say 'Hiring worker.'\r\n    @worker = new Worker @shared.workerCode\r\n    @worker.addEventListener 'error', errors.onWorkerError\r\n    @worker.addEventListener 'message', @onWorkerMessage\r\n    @worker.creationTime = new Date()\r\n\r\n  onFlagEvent: (e) ->\r\n    return unless @running and @work.realTime\r\n    @worker.postMessage func: 'addFlagEvent', args: e\r\n\r\n  onAddRealTimeInputEvent: (realTimeInputEvent) ->\r\n    return unless @running and @work.realTime\r\n    @worker.postMessage func: 'addRealTimeInputEvent', args: realTimeInputEvent.toJSON()\r\n\r\n  onStopRealTimePlayback: (e) ->\r\n    return unless @running and @work.realTime\r\n    @work.realTime = false\r\n    @lastRealTimeWork = new Date()\r\n    @worker.postMessage func: 'stopRealTimePlayback'\r\n\r\n  onEscapePressed: (e) ->\r\n    return unless @running and not @work.realTime\r\n    return if (new Date() - @lastRealTimeWork) < 1000  # Fires right after onStopRealTimePlayback\r\n    @infinitelyLooped true\r\n\r\n  #### Synchronous code for running worlds on main thread (profiling / IE9) ####\r\n  simulateSync: (work) =>\r\n    console?.profile? \"World Generation #{(Math.random() * 1000).toFixed(0)}\" if imitateIE9?\r\n    work.t0 = now()\r\n    work.world = testWorld = new World work.userCodeMap\r\n    work.world.levelSessionIDs = work.levelSessionIDs\r\n    work.world.submissionCount = work.submissionCount\r\n    work.world.fixedSeed = work.fixedSeed\r\n    work.world.flagHistory = work.flagHistory ? []\r\n    work.world.difficulty = work.difficulty\r\n    work.world.loadFromLevel work.level\r\n    work.world.preloading = work.preload\r\n    work.world.headless = work.headless\r\n    work.world.realTime = work.realTime\r\n    if @shared.goalManager\r\n      testGM = new GoalManager(testWorld)\r\n      testGM.setGoals work.goals\r\n      testGM.setCode work.userCodeMap\r\n      testGM.worldGenerationWillBegin()\r\n      testWorld.setGoalManager testGM\r\n    @doSimulateWorld work\r\n    console?.profileEnd?() if imitateIE9?\r\n    console.log 'Construction:', (work.t1 - work.t0).toFixed(0), 'ms. Simulation:', (work.t2 - work.t1).toFixed(0), 'ms --', ((work.t2 - work.t1) / testWorld.frames.length).toFixed(3), 'ms per frame, profiled.'\r\n\r\n    # If performance was really a priority in IE9, we would rework things to be able to skip this step.\r\n    goalStates = testGM?.getGoalStates()\r\n    work.world.goalManager.worldGenerationEnded() if work.world.ended\r\n\r\n    if work.headless\r\n      simulationFrameRate = work.world.frames.length / (work.t2 - work.t1) * 1000 * 30 / work.world.frameRate\r\n      @beholdGoalStates {goalStates, overallStatus: testGM.checkOverallStatus(), preload: false, totalFrames: work.world.totalFrames, lastFrameHash: work.world.frames[work.world.totalFrames - 2]?.hash, simulationFrameRate: simulationFrameRate}\r\n      return\r\n\r\n    serialized = world.serialize()\r\n    window.BOX2D_ENABLED = false\r\n    World.deserialize serialized.serializedWorld, @shared.worldClassMap, @shared.lastSerializedWorldFrames, @finishBeholdingWorld(goalStates), serialized.startFrame, serialized.endFrame, work.level\r\n    window.BOX2D_ENABLED = true\r\n    @shared.lastSerializedWorldFrames = serialized.serializedWorld.frames\r\n\r\n  doSimulateWorld: (work) ->\r\n    work.t1 = now()\r\n    Math.random = work.world.rand.randf  # so user code is predictable\r\n    Aether.replaceBuiltin('Math', Math)\r\n    replacedLoDash = _.runInContext(window)\r\n    _[key] = replacedLoDash[key] for key, val of replacedLoDash\r\n    i = 0\r\n    while i < work.world.totalFrames\r\n      frame = work.world.getFrame i++\r\n    @publishGodEvent 'world-load-progress-changed', progress: 1\r\n    work.world.ended = true\r\n    system.finish work.world.thangs for system in work.world.systems\r\n    work.t2 = now()\r\n"]}