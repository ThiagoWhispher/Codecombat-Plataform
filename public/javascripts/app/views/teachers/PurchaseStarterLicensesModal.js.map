{"version":3,"sources":["app/templates/teachers/purchase-starter-licenses-modal.jade","app/views/teachers/PurchaseStarterLicensesModal.coffee"],"names":[],"mappings":"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","file":"public/javascripts/app/views/teachers/PurchaseStarterLicensesModal.js","sourcesContent":["var __templateData = function anonymous(locals\n/**/) {\nvar buf = [];\nvar locals_ = (locals || {}),view = locals_.view,state = locals_.state;buf.push(\"<div class=\\\"modal-dialog\\\"><div class=\\\"modal-content style-flat\\\"><div class=\\\"modal-header\\\">\");\nif ( view.closeButton)\n{\nbuf.push(\"<div type=\\\"button\\\" data-dismiss=\\\"modal\\\" aria-hidden=\\\"true\\\" class=\\\"button close\\\">&times;</div>\");\n}\nbuf.push(\"<div class=\\\"text-center\\\"><h3 data-i18n=\\\"special_offer.purchase_starter_licenses\\\"></h3></div></div><div class=\\\"modal-body\\\"><p data-i18n=\\\"special_offer.starter_licenses_can_be_used\\\"></p><div class=\\\"text-center input-row m-t-3 m-b-3\\\"><input\" + (jade.attrs({ 'name':(\"quantity\"), 'type':(\"number\"), 'min':(0), 'max':(state.get('quantityAllowedToPurchase')), 'value':(state.get('quantityToBuy')) }, {\"name\":true,\"type\":true,\"min\":true,\"max\":true,\"value\":true})) + \"/><span>x</span><span class=\\\"dollar-value render\\\">\" + (jade.escape(null == (jade.interp = view.getDollarsPerStudentString()) ? \"\" : jade.interp)) + \"</span><span>=</span><span class=\\\"dollar-value render\\\">\" + (jade.escape(null == (jade.interp = view.getTotalPriceString()) ? \"\" : jade.interp)) + \"</span></div><div class=\\\"text-center render\\\">\");\nvar quantityIsValid = (state.get('quantityToBuy') > 0)\nbuf.push(\"<button\" + (jade.attrs({ 'disabled':(!quantityIsValid), 'className':((quantityIsValid ? 'disabled' : '')), \"class\": [('pay-now-btn'),('btn-lg'),('btn-navy')] }, {\"disabled\":true,\"className\":true})) + \"><span data-i18n=\\\"special_offer.pay_now\\\"></span></button></div><p data-i18n=\\\"special_offer.we_accept_all_major_credit_cards\\\" class=\\\"text-center m-t-1\\\"></p><p class=\\\"text-center purchase-progress-message render\\\">\" + (jade.escape(null == (jade.interp = state.get('purchaseProgressMessage')) ? \"\" : jade.interp)) + \"</p><p class=\\\"small m-t-5\\\"><span\" + (jade.attrs({ 'data-i18n':(\"[html]special_offer.license_limit_description\"), 'data-i18n-options':(JSON.stringify(view.i18nData())) }, {\"data-i18n\":true,\"data-i18n-options\":true})) + \"></span></p></div><div class=\\\"modal-body wait secret\\\"><h3>Reticulating Splines...</h3><div class=\\\"progress progress-striped active\\\"><div class=\\\"progress-bar\\\"></div></div></div></div></div>\");;return buf.join(\"\");\n};\nif (typeof define === 'function' && define.amd) {\n  define([], function() {\n    return __templateData;\n  });\n} else if (typeof module === 'object' && module && module.exports) {\n  module.exports = __templateData;\n} else {\n  __templateData;\n}","ModalView = require 'views/core/ModalView'\r\nState = require 'models/State'\r\nutils = require 'core/utils'\r\nProducts = require 'collections/Products'\r\nPrepaids = require 'collections/Prepaids'\r\nstripeHandler = require 'core/services/stripe'\r\n\r\nmodule.exports = class PurchaseStarterLicensesModal extends ModalView\r\n  id: 'purchase-starter-licenses-modal'\r\n  template: require 'templates/teachers/purchase-starter-licenses-modal'\r\n  \r\n  maxQuantityStarterLicenses: 75\r\n  i18nData: -> {\r\n    @maxQuantityStarterLicenses,\r\n    starterLicenseLengthMonths: 6,\r\n    quantityAlreadyPurchased: @state.get('quantityAlreadyPurchased')\r\n    supportEmail: \"<a href='mailto:support@codecombat.com'>support@codecombat.com</a>\"\r\n  }\r\n  \r\n  events:\r\n    'input input[name=\"quantity\"]': 'onInputQuantity'\r\n    'change input[name=\"quantity\"]': 'onInputQuantity'\r\n    'click .pay-now-btn': 'onClickPayNowButton'\r\n\r\n  initialize: (options) ->\r\n    window.tracker?.trackEvent 'Purchase Starter License: Modal Opened', category: 'Teachers', ['Mixpanel']\r\n    @listenTo stripeHandler, 'received-token', @onStripeReceivedToken\r\n    @state = new State({\r\n      quantityToBuy: 10\r\n      centsPerStudent: undefined\r\n      dollarsPerStudent: undefined\r\n      quantityAlreadyPurchased: undefined\r\n      quantityAllowedToPurchase: undefined\r\n    })\r\n    @products = new Products()\r\n    @supermodel.loadCollection(@products, 'products')\r\n    @listenTo @products, 'sync change update', ->\r\n      starterLicense = @products.findWhere({ name: 'starter_license' })\r\n      @state.set {\r\n        centsPerStudent: starterLicense.get('amount')\r\n        dollarsPerStudent: starterLicense.get('amount')/100\r\n      }\r\n    @prepaids = new Prepaids()\r\n    @supermodel.trackRequest @prepaids.fetchByCreator(me.id)\r\n    @listenTo @prepaids, 'sync change update', ->\r\n      starterLicenses = new Prepaids(@prepaids.where({ type: 'starter_license' }))\r\n      quantityAlreadyPurchased = starterLicenses.totalMaxRedeemers()\r\n      quantityAllowedToPurchase = @maxQuantityStarterLicenses - quantityAlreadyPurchased\r\n      @state.set {\r\n        quantityAlreadyPurchased\r\n        quantityAllowedToPurchase\r\n        quantityToBuy: Math.min(@state.get('quantityToBuy'), quantityAllowedToPurchase)\r\n      }\r\n    @listenTo @state, 'change', => @renderSelectors('.render')\r\n    super(options)\r\n  \r\n  onLoaded: ->\r\n    super()\r\n    \r\n  getDollarsPerStudentString: -> utils.formatDollarValue(@state.get('dollarsPerStudent'))\r\n  getTotalPriceString: -> utils.formatDollarValue(@state.get('dollarsPerStudent') * @state.get('quantityToBuy'))\r\n  \r\n  boundedValue: (value) ->\r\n    Math.max(Math.min(value, @state.get('quantityAllowedToPurchase')), 0)\r\n    \r\n  onInputQuantity: (e) ->\r\n    $input = $(e.currentTarget)\r\n    inputValue = parseFloat($input.val()) or 0\r\n    boundedValue = inputValue\r\n    if $input.val() isnt ''\r\n      boundedValue = @boundedValue(inputValue)\r\n      if boundedValue isnt inputValue\r\n        $input.val(boundedValue)\r\n    @state.set { quantityToBuy: boundedValue }\r\n    \r\n  onClickPayNowButton: ->\r\n    window.tracker?.trackEvent 'Purchase Starter License: Pay Now Clicked', category: 'Teachers', ['Mixpanel']\r\n    @state.set({\r\n      purchaseProgress: undefined\r\n      purchaseProgressMessage: undefined\r\n    })\r\n    \r\n    application.tracker?.trackEvent 'Started course prepaid purchase', {\r\n      price: @state.get('centsPerStudent'), students: @state.get('quantityToBuy')\r\n    }\r\n    stripeHandler.open\r\n      amount: @state.get('quantityToBuy') * @state.get('centsPerStudent')\r\n      description: \"Starter course access for #{@state.get('quantityToBuy')} students\"\r\n      bitcoin: true\r\n      alipay: if me.get('country') is 'china' or (me.get('preferredLanguage') or 'en-US')[...2] is 'zh' then true else 'auto'\r\n    \r\n  onStripeReceivedToken: (e) ->\r\n    @state.set({ purchaseProgress: 'purchasing' })\r\n    @render?()\r\n\r\n    data =\r\n      maxRedeemers: @state.get('quantityToBuy')\r\n      type: 'starter_license'\r\n      stripe:\r\n        token: e.token.id\r\n        timestamp: new Date().getTime()\r\n\r\n    $.ajax({\r\n      url: '/db/starter-license-prepaid',\r\n      data: data,\r\n      method: 'POST',\r\n      context: @\r\n      success: ->\r\n        application.tracker?.trackEvent 'Finished starter license purchase', {price: @state.get('centsPerStudent'), seats: @state.get('quantityToBuy')}\r\n        @state.set({ purchaseProgress: 'purchased' })\r\n        application.router.navigate('/teachers/licenses', { trigger: true })\r\n\r\n      error: (jqxhr, textStatus, errorThrown) ->\r\n        application.tracker?.trackEvent 'Failed starter license purchase', status: textStatus\r\n        if jqxhr.status is 402\r\n          @state.set({\r\n            purchaseProgress: 'error'\r\n            purchaseProgressMessage: arguments[2]\r\n          })\r\n        else\r\n          @state.set({\r\n            purchaseProgress: 'error'\r\n            purchaseProgressMessage: \"#{jqxhr.status}: #{jqxhr.responseJSON?.message or 'Unknown Error'}\"\r\n          })\r\n        @render?()\r\n    })\r\n"]}