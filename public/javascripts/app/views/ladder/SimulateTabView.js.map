{"version":3,"sources":["app/views/ladder/SimulateTabView.coffee"],"names":[],"mappings":"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","file":"public/javascripts/app/views/ladder/SimulateTabView.js","sourcesContent":["CocoView = require 'views/core/CocoView'\r\nCocoClass = require 'core/CocoClass'\r\nSimulatorsLeaderboardCollection = require 'collections/SimulatorsLeaderboardCollection'\r\nSimulator = require 'lib/simulator/Simulator'\r\n{me} = require 'core/auth'\r\n\r\nmodule.exports = class SimulateTabView extends CocoView\r\n  id: 'simulate-tab-view'\r\n  template: require 'templates/play/ladder/simulate_tab'\r\n\r\n  events:\r\n    'click #simulate-button': 'onSimulateButtonClick'\r\n\r\n  initialize: ->\r\n    @simulatorsLeaderboardData = new SimulatorsLeaderboardData(me)\r\n    @simulatorsLeaderboardDataRes = @supermodel.addModelResource(@simulatorsLeaderboardData, 'top_simulators', {cache: false})\r\n    @simulatorsLeaderboardDataRes.load()\r\n    require 'vendor/aether-javascript'\r\n    require 'vendor/aether-python'\r\n    require 'vendor/aether-coffeescript'\r\n    require 'vendor/aether-lua'\r\n    require 'vendor/aether-java'\r\n\r\n  onLoaded: ->\r\n    super()\r\n    @render()\r\n    if (document.location.hash is '#simulate' or @options.level.isType('course-ladder')) and not @simulator\r\n      @startSimulating()\r\n\r\n  afterRender: ->\r\n    super()\r\n\r\n  # Simulations\r\n\r\n  onSimulateButtonClick: (e) ->\r\n    application.tracker?.trackEvent 'Simulate Button Click'\r\n    @startSimulating()\r\n\r\n  startSimulating: ->\r\n    @simulationPageRefreshTimeout = _.delay @refreshAndContinueSimulating, 30 * 60 * 1000\r\n    @simulateNextGame()\r\n    $('#simulate-button').prop 'disabled', true\r\n    $('#simulate-button').text 'Simulating...'\r\n\r\n  refreshAndContinueSimulating: =>\r\n    # We refresh the page every now and again to make sure simulations haven't gotten derailed by bogus games, and that simulators don't hang on to old, stale code or data.\r\n    document.location.hash = '#simulate'\r\n    document.location.reload()\r\n\r\n  simulateNextGame: ->\r\n    unless @simulator\r\n      @simulator = new Simulator levelID: @options.level.get('slug'), leagueID: @options.leagueID\r\n      @listenTo @simulator, 'statusUpdate', @updateSimulationStatus\r\n      # Work around simulator getting super slow on Chrome\r\n      fetchAndSimulateTaskOriginal = @simulator.fetchAndSimulateTask\r\n      @simulator.fetchAndSimulateTask = =>\r\n        return if @destroyed\r\n        if @simulator.simulatedByYou >= 20\r\n          console.log '------------------- Destroying  Simulator and making a new one -----------------'\r\n          @simulator.destroy()\r\n          @simulator = null\r\n          @simulateNextGame()\r\n        else\r\n          fetchAndSimulateTaskOriginal.apply @simulator\r\n    @simulator.fetchAndSimulateTask()\r\n\r\n  refresh: ->\r\n    return  # Queue-based scoring is currently not active anyway, so don't keep checking this until we fix it.\r\n    success = (numberOfGamesInQueue) ->\r\n      $('#games-in-queue').text numberOfGamesInQueue\r\n    $.ajax '/queue/messagesInQueueCount', cache: false, success: success\r\n\r\n  updateSimulationStatus: (simulationStatus, sessions) ->\r\n    if simulationStatus is 'Fetching simulation data!'\r\n      @simulationMatchDescription = ''\r\n      @simulationSpectateLink = ''\r\n    @simulationStatus = _.string.escapeHTML(simulationStatus)\r\n    try\r\n      if sessions?\r\n        @simulationMatchDescription = ''\r\n        @simulationSpectateLink = \"/play/spectate/#{@simulator.level.get('slug')}?\"\r\n        for session, index in sessions\r\n          # TODO: Fetch names from Redis, the creatorName is denormalized\r\n          @simulationMatchDescription += \"#{if index then ' vs ' else ''}#{session.creatorName or 'Anonymous'} (#{sessions[index].team})\"\r\n          @simulationSpectateLink += \"session-#{if index then 'two' else 'one'}=#{session.sessionID}\"\r\n        @simulationMatchDescription += \" on #{@simulator.level.get('name')}\"\r\n    catch e\r\n      console.log \"There was a problem with the named simulation status: #{e}\"\r\n    link = if @simulationSpectateLink then \"<a href=#{@simulationSpectateLink}>#{_.string.escapeHTML(@simulationMatchDescription)}</a>\" else ''\r\n    $('#simulation-status-text').html \"<h3>#{@simulationStatus}</h3>#{link}\"\r\n\r\n  destroy: ->\r\n    clearTimeout @simulationPageRefreshTimeout\r\n    @simulator?.destroy()\r\n    super()\r\n\r\nclass SimulatorsLeaderboardData extends CocoClass\r\n  ###\r\n  Consolidates what you need to load for a leaderboard into a single Backbone Model-like object.\r\n  ###\r\n\r\n  constructor: (@me) ->\r\n    super()\r\n\r\n  fetch: ->\r\n    @topSimulators = new SimulatorsLeaderboardCollection({order: -1, scoreOffset: -1, limit: 20})\r\n    promises = []\r\n    promises.push @topSimulators.fetch()\r\n    unless @me.get('anonymous')\r\n      score = @me.get('simulatedBy') or 0\r\n      queueSuccess = (@numberOfGamesInQueue) =>\r\n      promises.push $.ajax '/queue/messagesInQueueCount', {success: queueSuccess, cache: false}\r\n      @playersAbove = new SimulatorsLeaderboardCollection({order: 1, scoreOffset: score, limit: 4})\r\n      promises.push @playersAbove.fetch()\r\n      if score\r\n        @playersBelow = new SimulatorsLeaderboardCollection({order: -1, scoreOffset: score, limit: 4})\r\n        promises.push @playersBelow.fetch()\r\n      success = (@myRank) =>\r\n      promises.push $.ajax(\"/db/user/me/simulator_leaderboard_rank?scoreOffset=#{score}\", cache: false, success: success)\r\n\r\n    @promise = $.when(promises...)\r\n    @promise.then @onLoad\r\n    @promise.fail @onFail\r\n    @promise\r\n\r\n  onLoad: =>\r\n    return if @destroyed\r\n    @loaded = true\r\n    @trigger 'sync', @\r\n\r\n  onFail: (resource, jqxhr) =>\r\n    return if @destroyed\r\n    @trigger 'error', @, jqxhr\r\n\r\n  inTopSimulators: ->\r\n    return me.id in (user.id for user in @topSimulators.models)\r\n\r\n  nearbySimulators: ->\r\n    return [] if not @playersAbove?.models\r\n    l = []\r\n    above = @playersAbove.models\r\n    l = l.concat(above)\r\n    l.reverse()\r\n    l.push @me\r\n    l = l.concat(@playersBelow.models) if @playersBelow\r\n    if @myRank\r\n      startRank = @myRank - 4\r\n      user.rank = startRank + i for user, i in l\r\n    l\r\n\r\n  allResources: ->\r\n    resources = [@topSimulators, @playersAbove, @playersBelow]\r\n    return (r for r in resources when r)\r\n"]}