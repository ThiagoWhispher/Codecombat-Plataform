{"version":3,"sources":["app/views/ladder/LadderView.coffee"],"names":[],"mappings":"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","file":"public/javascripts/app/views/ladder/LadderView.js","sourcesContent":["RootView = require 'views/core/RootView'\r\nLevel = require 'models/Level'\r\nLevelSession = require 'models/LevelSession'\r\nCocoCollection = require 'collections/CocoCollection'\r\n{teamDataFromLevel} = require './utils'\r\n{me} = require 'core/auth'\r\napplication = require 'core/application'\r\n\r\nLadderTabView = require './LadderTabView'\r\nMyMatchesTabView = require './MyMatchesTabView'\r\nSimulateTabView = require './SimulateTabView'\r\nLadderPlayModal = require './LadderPlayModal'\r\nCocoClass = require 'core/CocoClass'\r\n\r\nClan = require 'models/Clan'\r\nCourseInstance = require 'models/CourseInstance'\r\nCourse = require 'models/Course'\r\n\r\nHIGHEST_SCORE = 1000000\r\n\r\nclass LevelSessionsCollection extends CocoCollection\r\n  url: ''\r\n  model: LevelSession\r\n\r\n  constructor: (levelID) ->\r\n    super()\r\n    @url = \"/db/level/#{levelID}/my_sessions\"\r\n\r\nmodule.exports = class LadderView extends RootView\r\n  id: 'ladder-view'\r\n  template: require 'templates/play/ladder/ladder'\r\n  usesSocialMedia: true\r\n\r\n  subscriptions:\r\n    'application:idle-changed': 'onIdleChanged'\r\n\r\n  events:\r\n    'click .play-button': 'onClickPlayButton'\r\n    'click a:not([data-toggle])': 'onClickedLink'\r\n    'click .spectate-button': 'onClickSpectateButton'\r\n\r\n  initialize: (options, @levelID, @leagueType, @leagueID) ->\r\n    @level = @supermodel.loadModel(new Level(_id: @levelID)).model\r\n    onLoaded = =>\r\n      return if @destroyed\r\n      @levelDescription = marked(@level.get('description')) if @level.get('description')\r\n      @teams = teamDataFromLevel @level\r\n\r\n    if @level.loaded then onLoaded() else @level.once('sync', onLoaded) \r\n    @sessions = @supermodel.loadCollection(new LevelSessionsCollection(@levelID), 'your_sessions', {cache: false}).model\r\n    @winners = require('./tournament_results')[@levelID]\r\n\r\n    if tournamentEndDate = {greed: 1402444800000, 'criss-cross': 1410912000000, 'zero-sum': 1428364800000, 'ace-of-coders': 1444867200000}[@levelID]\r\n      @tournamentTimeLeft = moment(new Date(tournamentEndDate)).fromNow()\r\n    if tournamentStartDate = {'zero-sum': 1427472000000, 'ace-of-coders': 1442417400000}[@levelID]\r\n      @tournamentTimeElapsed = moment(new Date(tournamentStartDate)).fromNow()\r\n\r\n    @loadLeague()\r\n\r\n  loadLeague: ->\r\n    @leagueID = @leagueType = null unless @leagueType in ['clan', 'course']\r\n    return unless @leagueID\r\n    modelClass = if @leagueType is 'clan' then Clan else CourseInstance\r\n    @league = @supermodel.loadModel(new modelClass(_id: @leagueID)).model\r\n    if @leagueType is 'course'\r\n      if @league.loaded\r\n        @onCourseInstanceLoaded @league\r\n      else\r\n        @listenToOnce @league, 'sync', @onCourseInstanceLoaded\r\n\r\n  onCourseInstanceLoaded: (courseInstance) ->\r\n    return if @destroyed\r\n    course = new Course({_id: courseInstance.get('courseID')})\r\n    @course = @supermodel.loadModel(course).model\r\n    @listenToOnce @course, 'sync', @render\r\n\r\n  afterRender: ->\r\n    super()\r\n    return unless @supermodel.finished()\r\n    @insertSubView(@ladderTab = new LadderTabView({league: @league}, @level, @sessions))\r\n    @insertSubView(@myMatchesTab = new MyMatchesTabView({league: @league}, @level, @sessions))\r\n    @insertSubView(@simulateTab = new SimulateTabView(league: @league, level: @level, leagueID: @leagueID))\r\n    highLoad = true\r\n    @refreshDelay = switch\r\n      when not application.isProduction() then 10  # Refresh very quickly in develompent.\r\n      when @league then 20                         # Refresh quickly when looking at a league ladder.\r\n      when not highLoad then 30                    # Refresh slowly when in production.\r\n      when not me.isAnonymous() then 60            # Refresh even more slowly during HoC scaling.\r\n      else 300                                     # Refresh super slowly if anonymous during HoC scaling.\r\n    @refreshInterval = setInterval(@fetchSessionsAndRefreshViews.bind(@), @refreshDelay * 1000)\r\n    hash = document.location.hash[1..] if document.location.hash\r\n    if hash and not (hash in ['my-matches', 'simulate', 'ladder', 'prizes', 'rules', 'winners'])\r\n      @showPlayModal(hash) if @sessions.loaded\r\n\r\n  fetchSessionsAndRefreshViews: ->\r\n    return if @destroyed or application.userIsIdle or (new Date() - 2000 < @lastRefreshTime) or not @supermodel.finished()\r\n    @sessions.fetch success: @refreshViews, cache: false\r\n\r\n  refreshViews: =>\r\n    return if @destroyed or application.userIsIdle\r\n    @lastRefreshTime = new Date()\r\n    @ladderTab.refreshLadder()\r\n    @myMatchesTab.refreshMatches @refreshDelay\r\n    @simulateTab.refresh()\r\n\r\n  onIdleChanged: (e) ->\r\n    @fetchSessionsAndRefreshViews() unless e.idle\r\n\r\n  onClickPlayButton: (e) ->\r\n    @showPlayModal($(e.target).closest('.play-button').data('team'))\r\n\r\n  onClickSpectateButton: (e) ->\r\n    humanSession = @ladderTab.spectateTargets?.humans\r\n    ogreSession = @ladderTab.spectateTargets?.ogres\r\n    return unless humanSession and ogreSession\r\n    e.preventDefault()\r\n    e.stopImmediatePropagation()\r\n    url = \"/play/spectate/#{@level.get('slug')}?session-one=#{humanSession}&session-two=#{ogreSession}\"\r\n    url += '&league=' + @league.id if @league\r\n    url += '&autoplay=false' if key.command\r\n    window.open url, if key.command then '_blank' else 'spectate'  # New tab for spectating specific matches\r\n    #Backbone.Mediator.publish 'router:navigate', route: url\r\n\r\n  showPlayModal: (teamID) ->\r\n    session = (s for s in @sessions.models when s.get('team') is teamID)[0]\r\n    modal = new LadderPlayModal({league: @league}, @level, session, teamID)\r\n    @openModalView modal\r\n\r\n  onClickedLink: (e) ->\r\n    link = $(e.target).closest('a').attr('href')\r\n    if link and /#rules$/.test link\r\n      @$el.find('a[href=\"#rules\"]').tab('show')\r\n    if link and /#prizes/.test link\r\n      @$el.find('a[href=\"#prizes\"]').tab('show')\r\n    if link and /#winners/.test link\r\n      @$el.find('a[href=\"#winners\"]').tab('show')\r\n\r\n  destroy: ->\r\n    clearInterval @refreshInterval\r\n    super()\r\n"]}