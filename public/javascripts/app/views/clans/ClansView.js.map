{"version":3,"sources":["app/views/clans/ClansView.coffee"],"names":[],"mappings":"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","file":"public/javascripts/app/views/clans/ClansView.js","sourcesContent":["app = require 'core/application'\r\nCreateAccountModal = require 'views/core/CreateAccountModal'\r\nRootView = require 'views/core/RootView'\r\ntemplate = require 'templates/clans/clans'\r\nCocoCollection = require 'collections/CocoCollection'\r\nClan = require 'models/Clan'\r\nSubscribeModal = require 'views/core/SubscribeModal'\r\n\r\n# TODO: Waiting for async messages\r\n# TODO: Invalid clan name message\r\n# TODO: Refresh data instead of page\r\n\r\nmodule.exports = class ClansView extends RootView\r\n  id: 'clans-view'\r\n  template: template\r\n  \r\n\r\n  events:\r\n    'click .create-clan-btn': 'onClickCreateClan'\r\n    'click .join-clan-btn': 'onJoinClan'\r\n    'click .leave-clan-btn': 'onLeaveClan'\r\n    'click .private-clan-checkbox': 'onClickPrivateCheckbox'\r\n\r\n  initialize: ->\r\n    @publicClansArray = []\r\n    @myClansArray = []    \r\n    @idNameMap = {}\r\n    @loadData()\r\n\r\n  destroy: ->\r\n    @stopListening?()\r\n\r\n  afterRender: ->\r\n    super()\r\n    @setupPrivateInfoPopover()\r\n\r\n  onLoaded: ->\r\n    super()\r\n    @publicClansArray = _.filter(@publicClans.models, (clan) -> clan.get('type') is 'public')\r\n    @myClansArray = @myClans.models\r\n\r\n  loadData: ->\r\n    sortClanList = (a, b) ->\r\n      if a.get('memberCount') isnt b.get('memberCount')\r\n        if a.get('memberCount') < b.get('memberCount') then 1 else -1\r\n      else\r\n        b.id.localeCompare(a.id)\r\n    @publicClans = new CocoCollection([], { url: '/db/clan/-/public', model: Clan, comparator: sortClanList })\r\n    @listenTo @publicClans, 'sync', =>\r\n      @refreshNames @publicClans.models\r\n      @render?()\r\n    @supermodel.loadCollection(@publicClans, 'public_clans', {cache: false})\r\n\r\n    @myClans = new CocoCollection([], { url: \"/db/user/#{me.id}/clans\", model: Clan, comparator: sortClanList })\r\n    @listenTo @myClans, 'sync', =>\r\n      @refreshNames @myClans.models\r\n      @render?()\r\n    @supermodel.loadCollection(@myClans, 'my_clans', {cache: false})\r\n\r\n    @listenTo me, 'sync', => @render?()\r\n    @myClanIDs = me.get('clans') ? []\r\n\r\n  refreshNames: (clans) ->\r\n    clanIDs = _.filter(clans, (clan) -> clan.get('type') is 'public')\r\n    clanIDs = _.map(clans, (clan) -> clan.get('ownerID'))\r\n    options =\r\n      url: '/db/user/-/names'\r\n      method: 'POST'\r\n      data: {ids: clanIDs}\r\n      success: (models, response, options) =>\r\n        @idNameMap[userID] = models[userID].name for userID of models\r\n        @render?()\r\n    @supermodel.addRequestResource('user_names', options, 0).load()\r\n\r\n  setupPrivateInfoPopover: ->\r\n    popoverTitle = \"<h3>\" + $.i18n.t('clans.private_clans') + \"</h3>\"\r\n    popoverContent = \"<ul>\"\r\n    popoverContent += \"<li><span style='font-weight:bold;'>\" + $.i18n.t('clans.track_concepts1') + \"</span> \" + $.i18n.t('clans.track_concepts2b')\r\n    popoverContent += \"<li>\" + $.i18n.t('clans.track_concepts3b')\r\n    popoverContent += \"<li>\" + $.i18n.t('clans.track_concepts4b') + \" <span style='font-weight:bold;'>\" + $.i18n.t('clans.track_concepts5') + \"</span>\"\r\n    popoverContent += \"<li>\" + $.i18n.t('clans.track_concepts6b')\r\n    popoverContent += \"<li><span style='font-weight:bold;'>\" + $.i18n.t('clans.track_concepts7') + \"</span> \" + $.i18n.t('clans.track_concepts8')\r\n    popoverContent += \"</ul>\"\r\n    popoverContent += \"<p><img src='/images/pages/clans/dashboard_preview.png' height='400'></p>\"\r\n    popoverContent += \"<p>\" + $.i18n.t('clans.private_require_sub') + \"</p>\"\r\n    @$el.find('.private-more-info').popover(\r\n      animation: true\r\n      html: true\r\n      placement: 'right'\r\n      trigger: 'hover'\r\n      title: popoverTitle\r\n      content: popoverContent\r\n      container: @$el\r\n    )\r\n\r\n  onClickCreateClan: (e) ->\r\n    return @openModalView new CreateAccountModal() if me.isAnonymous()\r\n    clanType = if $('.private-clan-checkbox').prop('checked') then 'private' else 'public'\r\n    if clanType is 'private' and not me.isPremium()\r\n      @openModalView new SubscribeModal()\r\n      window.tracker?.trackEvent 'Show subscription modal', category: 'Subscription', label: 'create clan'\r\n      return\r\n    if name = $('.create-clan-name').val()\r\n      clan = new Clan()\r\n      clan.set 'type', clanType\r\n      clan.set 'name', name\r\n      clan.set 'description', description if description = $('.create-clan-description').val()\r\n      clan.save {},\r\n        error: (model, response, options) =>\r\n          console.error 'Error saving clan', response.status\r\n        success: (model, response, options) =>\r\n          app.router.navigate \"/clans/#{model.id}\"\r\n          window.location.reload()\r\n    else\r\n      console.log 'Invalid name'\r\n\r\n  onJoinClan: (e) ->\r\n    return @openModalView(new CreateAccountModal()) if me.isAnonymous()\r\n    if clanID = $(e.target).data('id')\r\n      options =\r\n        url: \"/db/clan/#{clanID}/join\"\r\n        method: 'PUT'\r\n        error: (model, response, options) =>\r\n          console.error 'Error joining clan', response\r\n        success: (model, response, options) =>\r\n          app.router.navigate \"/clans/#{clanID}\"\r\n          window.location.reload()\r\n      @supermodel.addRequestResource( 'join_clan', options).load()\r\n    else\r\n      console.error \"No clan ID attached to join button.\"\r\n\r\n  onLeaveClan: (e) ->\r\n    if clanID = $(e.target).data('id')\r\n      options =\r\n        url: \"/db/clan/#{clanID}/leave\"\r\n        method: 'PUT'\r\n        error: (model, response, options) =>\r\n          console.error 'Error leaving clan', response\r\n        success: (model, response, options) =>\r\n          me.fetch cache: false\r\n          @publicClans.fetch cache: false\r\n          @myClans.fetch cache: false\r\n      @supermodel.addRequestResource( 'leave_clan', options).load()\r\n    else\r\n      console.error \"No clan ID attached to leave button.\"\r\n\r\n  onClickPrivateCheckbox: (e) ->\r\n    return @openModalView new CreateAccountModal() if me.isAnonymous()\r\n    if $('.private-clan-checkbox').prop('checked') and not me.isPremium()\r\n      $('.private-clan-checkbox').attr('checked', false)\r\n      @openModalView new SubscribeModal()\r\n      window.tracker?.trackEvent 'Show subscription modal', category: 'Subscription', label: 'check private clan'\r\n"]}