{"version":3,"sources":["app/templates/editor/modal/save-version-modal.jade","app/views/editor/modal/SaveVersionModal.coffee"],"names":[],"mappings":"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","file":"public/javascripts/app/views/editor/modal/SaveVersionModal.js","sourcesContent":["var __templateData = function anonymous(locals\n/**/) {\nvar buf = [];\nvar locals_ = (locals || {}),view = locals_.view;buf.push(\"<div class=\\\"modal-dialog game\\\"><div class=\\\"background-wrapper\\\"><div class=\\\"modal-content\\\"><div class=\\\"modal-header\\\">\");\nif ( view.closeButton)\n{\nbuf.push(\"<div type=\\\"button\\\" data-dismiss=\\\"modal\\\" aria-hidden=\\\"true\\\" class=\\\"button close\\\">&times;</div>\");\n}\nif ( view.isPatch)\n{\nbuf.push(\"<h3 data-i18n=\\\"common.submit_patch\\\">Submit Patch</h3>\");\n}\nelse\n{\nbuf.push(\"<h3 data-i18n=\\\"versions.save_version_title\\\">Save New Version</h3>\");\n}\nbuf.push(\"</div><div class=\\\"modal-body\\\">\");\nif ( view.hasChanges)\n{\nbuf.push(\"<div class=\\\"changes-stub\\\"></div><form class=\\\"form-inline\\\"><div class=\\\"form-group commit-message\\\"><input id=\\\"commit-message\\\" name=\\\"commitMessage\\\" type=\\\"text\\\" class=\\\"form-control\\\"/></div>\");\nif ( !view.isPatch && !view.options.noNewMajorVersions)\n{\nbuf.push(\"<div class=\\\"checkbox\\\"><label><input id=\\\"major-version\\\" name=\\\"version-is-major\\\" type=\\\"checkbox\\\"/><span data-i18n=\\\"versions.new_major_version\\\">New Major Version</span></label></div>\");\n}\nbuf.push(\"</form>\");\n}\nelse\n{\nbuf.push(\"<div data-i18n=\\\"delta.no_changes\\\" class=\\\"alert alert-danger\\\">No changes</div>\");\n}\nbuf.push(\"</div><div class=\\\"modal-body wait secret\\\">\");\nif ( view.hasChanges)\n{\nif ( view.isPatch)\n{\nbuf.push(\"<h3 data-i18n=\\\"versions.submitting_patch\\\">Submitting Patch...</h3>\");\n}\nelse\n{\nbuf.push(\"<h3 data-i18n=\\\"common.saving\\\">Saving...</h3>\");\n}\n}\nbuf.push(\"<div class=\\\"progress progress-striped active\\\"><div class=\\\"progress-bar\\\"></div></div></div><div class=\\\"modal-footer\\\">\");\nif ( view.hasChanges)\n{\nbuf.push(\"<div id=\\\"accept-cla-wrapper\\\" class=\\\"alert alert-info\\\"><span data-i18n=\\\"versions.cla_prefix\\\" class=\\\"spr\\\">To save changes, first you must agree to our</span><strong id=\\\"cla-link\\\" data-i18n=\\\"versions.cla_url\\\">CLA</strong><span data-i18n=\\\"versions.cla_suffix\\\"></span><button id=\\\"agreement-button\\\" data-i18n=\\\"versions.cla_agree\\\" class=\\\"btn btn-sm\\\">I AGREE</button></div>\");\nif ( view.isPatch)\n{\nbuf.push(\"<div data-i18n=\\\"versions.owner_approve\\\" class=\\\"alert alert-info\\\">An owner will need to approve it before your changes will become visible.</div>\");\n}\nbuf.push(\"<div class=\\\"save-error-area\\\">\");\nif ( view.savingPatchError)\n{\nbuf.push(\"<div class=\\\"alert alert-danger\\\">Unable to save patch: \" + (jade.escape((jade.interp = view.savingPatchError) == null ? '' : jade.interp)) + \"</div>\");\n}\nbuf.push(\"</div>\");\n}\nbuf.push(\"<div class=\\\"buttons\\\"><button data-dismiss=\\\"modal\\\" data-i18n=\\\"common.cancel\\\" class=\\\"btn\\\">Cancel</button>\");\nif ( view.hasChanges && !view.isPatch)\n{\nbuf.push(\"<button id=\\\"save-version-button\\\" data-i18n=\\\"common.save\\\" class=\\\"btn btn-primary\\\">Save</button>\");\n}\nif ( view.hasChanges && view.isPatch)\n{\nbuf.push(\"<button id=\\\"submit-patch-button\\\" data-i18n=\\\"common.submit_patch\\\" class=\\\"btn btn-primary\\\">Submit Patch</button>\");\n}\nbuf.push(\"</div></div></div></div></div>\");;return buf.join(\"\");\n};\nif (typeof define === 'function' && define.amd) {\n  define([], function() {\n    return __templateData;\n  });\n} else if (typeof module === 'object' && module && module.exports) {\n  module.exports = __templateData;\n} else {\n  __templateData;\n}","ModalView = require 'views/core/ModalView'\r\ntemplate = require 'templates/editor/modal/save-version-modal'\r\nDeltaView = require 'views/editor/DeltaView'\r\nPatch = require 'models/Patch'\r\nforms = require 'core/forms'\r\n\r\nmodule.exports = class SaveVersionModal extends ModalView\r\n  id: 'save-version-modal'\r\n  template: template\r\n  plain: true\r\n  modalWidthPercent: 60\r\n\r\n  events:\r\n    'click #save-version-button': 'saveChanges'\r\n    'click #cla-link': 'onClickCLALink'\r\n    'click #agreement-button': 'onAgreedToCLA'\r\n    'click #submit-patch-button': 'submitPatch'\r\n    'submit form': 'onSubmitForm'\r\n\r\n  constructor: (options) ->\r\n    super options\r\n    @model = options.model or options.level\r\n    @isPatch = not @model.hasWriteAccess()\r\n    @hasChanges = @model.hasLocalChanges()\r\n\r\n  afterRender: (insertDeltaView=true) ->\r\n    super()\r\n    @$el.find(if me.get('signedCLA') then '#accept-cla-wrapper' else '#save-version-button').hide()\r\n    changeEl = @$el.find('.changes-stub')\r\n    if insertDeltaView\r\n      try\r\n        deltaView = new DeltaView({model: @model})\r\n        @insertSubView(deltaView, changeEl)\r\n      catch e\r\n        console.error 'Couldn\\'t create delta view:', e, e.stack\r\n    @$el.find('.commit-message input').attr('placeholder', $.i18n.t('general.commit_msg'))\r\n\r\n  onSubmitForm: (e) ->\r\n    e.preventDefault()\r\n    if @isPatch then @submitPatch() else @saveChanges()\r\n\r\n  saveChanges: ->\r\n    @trigger 'save-new-version', {\r\n      major: @$el.find('#major-version').prop('checked')\r\n      commitMessage: @$el.find('#commit-message').val()\r\n    }\r\n\r\n  submitPatch: ->\r\n    @savingPatchError = false\r\n    forms.clearFormAlerts @$el\r\n    patch = new Patch()\r\n    patch.set 'delta', @model.getDelta()\r\n    patch.set 'commitMessage', @$el.find('#commit-message').val()\r\n    patch.set 'target', {\r\n      'collection': _.string.underscored @model.constructor.className\r\n      'id': @model.id\r\n    }\r\n    errors = patch.validate()\r\n    forms.applyErrorsToForm(@$el, errors) if errors\r\n    res = patch.save()\r\n    return unless res\r\n    @enableModalInProgress(@$el)\r\n\r\n    res.error (jqxhr) =>\r\n      @disableModalInProgress(@$el)\r\n      @savingPatchError = jqxhr.responseJSON?.message or 'Unknown error.'\r\n      @renderSelectors '.save-error-area'\r\n\r\n    res.success =>\r\n      @hide()\r\n\r\n  onClickCLALink: ->\r\n    window.open('/cla', 'cla', 'height=800,width=900')\r\n\r\n  onAgreedToCLA: ->\r\n    @$el.find('#agreement-button').text('Saving').prop('disabled', true)\r\n    $.ajax({\r\n      url: '/db/user/me/agreeToCLA'\r\n      method: 'POST'\r\n      success: @onAgreeSucceeded\r\n      error: @onAgreeFailed\r\n    })\r\n\r\n  onAgreeSucceeded: =>\r\n    @$el.find('#agreement-button').text('Thanks!')\r\n    @$el.find('#save-version-button').show()\r\n\r\n  onAgreeFailed: =>\r\n    @$el.find('#agreement-button').text('Failed').prop('disabled', false)\r\n"]}