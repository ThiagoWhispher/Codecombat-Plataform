{"version":3,"sources":["app/templates/editor/campaign/campaign-editor-view.jade","app/views/editor/campaign/CampaignEditorView.coffee"],"names":[],"mappings":"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","file":"public/javascripts/app/views/editor/campaign/CampaignEditorView.js","sourcesContent":["var __templateData = function anonymous(locals\n/**/) {\nvar buf = [];\nvar locals_ = (locals || {}),view = locals_.view,me = locals_.me,anonymous = locals_.anonymous;if ( view.campaign.loading)\n{\nbuf.push(\"<nav role=\\\"navigation\\\" id=\\\"campaign-editor-top-nav\\\" class=\\\"navbar navbar-default\\\"><div class=\\\"container-fluid\\\"><ul class=\\\"nav navbar-nav\\\"><li><a href=\\\"/\\\"><span class=\\\"glyphicon-home glyphicon\\\"></span></a></li></ul></div></nav>\");\n}\nelse\n{\nbuf.push(\"<nav role=\\\"navigation\\\" id=\\\"campaign-editor-top-nav\\\" class=\\\"navbar navbar-default\\\"><ul class=\\\"nav navbar-nav\\\"><li><a href=\\\"/\\\"><span class=\\\"glyphicon-home glyphicon\\\"></span></a></li></ul><ul class=\\\"nav navbar-nav navbar-right\\\">\");\nif ( me.isAdmin())\n{\nbuf.push(\"<li id=\\\"analytics-button\\\"><a><span class=\\\"glyphicon-stats glyphicon\\\"></span></a></li>\");\n}\nif ( me.isAdmin())\n{\nbuf.push(\"<li id=\\\"save-button\\\"><a><span class=\\\"glyphicon-floppy-disk glyphicon\\\"></span></a></li>\");\n}\nbuf.push(\"<li class=\\\"dropdown\\\"><a data-toggle=\\\"dropdown\\\"><span class=\\\"glyphicon-chevron-down glyphicon\\\"></span></a><ul class=\\\"dropdown-menu\\\"><li data-i18n=\\\"common.actions\\\" class=\\\"dropdown-header\\\">Actions</li><li\" + (jade.attrs({ \"class\": [(anonymous ? \"disabled\": \"\")] }, {\"class\":true})) + \"><a data-toggle=\\\"coco-modal\\\" data-target=\\\"modal/RevertModal\\\" data-i18n=\\\"editor.revert\\\" id=\\\"revert-button\\\">Revert</a></li><li\" + (jade.attrs({ \"class\": [(anonymous ? \"disabled\": \"\")] }, {\"class\":true})) + \"><a data-i18n=\\\"editor.pop_i18n\\\" id=\\\"pop-level-i18n-button\\\">Populate i18n</a></li>\");\nif ( me.isAdmin())\n{\nbuf.push(\"<li id=\\\"patches-button\\\"><a><span class=\\\"spr glyphicon-wrench glyphicon\\\"></span><span data-i18n=\\\"resources.patches\\\">Patches</span></a></li>\");\n}\nbuf.push(\"<li class=\\\"divider\\\"></li><li data-i18n=\\\"common.info\\\" class=\\\"dropdown-header\\\">Info</li></ul></li></ul></nav>\");\n}\nbuf.push(\"<div class=\\\"outer-content\\\"><div id=\\\"left-column\\\"><div id=\\\"campaign-treema\\\"></div></div><div id=\\\"right-column\\\"><div id=\\\"campaign-view\\\"></div><div id=\\\"campaign-level-view\\\" class=\\\"hidden\\\"></div><div class=\\\"patches-view hidden\\\"></div></div></div>\");;return buf.join(\"\");\n};\nif (typeof define === 'function' && define.amd) {\n  define([], function() {\n    return __templateData;\n  });\n} else if (typeof module === 'object' && module && module.exports) {\n  module.exports = __templateData;\n} else {\n  __templateData;\n}","RootView = require 'views/core/RootView'\r\nCampaign = require 'models/Campaign'\r\nLevel = require 'models/Level'\r\nAchievement = require 'models/Achievement'\r\nThangType = require 'models/ThangType'\r\nCampaignView = require 'views/play/CampaignView'\r\nCocoCollection = require 'collections/CocoCollection'\r\ntreemaExt = require 'core/treema-ext'\r\nutils = require 'core/utils'\r\nRelatedAchievementsCollection = require 'collections/RelatedAchievementsCollection'\r\nCampaignAnalyticsModal = require './CampaignAnalyticsModal'\r\nCampaignLevelView = require './CampaignLevelView'\r\nSaveCampaignModal = require './SaveCampaignModal'\r\nPatchesView = require 'views/editor/PatchesView'\r\n\r\nrequire 'game-libraries'\r\n\r\nachievementProject = ['related', 'rewards', 'name', 'slug']\r\nthangTypeProject = ['name', 'original']\r\n\r\nmodule.exports = class CampaignEditorView extends RootView\r\n  id: \"campaign-editor-view\"\r\n  template: require 'templates/editor/campaign/campaign-editor-view'\r\n  className: 'editor'\r\n\r\n  events:\r\n    'click #analytics-button': 'onClickAnalyticsButton'\r\n    'click #save-button': 'onClickSaveButton'\r\n    'click #patches-button': 'onClickPatches'\r\n\r\n  subscriptions:\r\n    'editor:campaign-analytics-modal-closed' : 'onAnalyticsModalClosed'\r\n\r\n  constructor: (options, @campaignHandle) ->\r\n    super(options)\r\n    @campaign = new Campaign({_id:@campaignHandle})\r\n    @supermodel.loadModel(@campaign)\r\n    @listenToOnce @campaign, 'sync', (model, response, jqXHR) ->\r\n      @campaign.set '_id', response._id\r\n      @campaign.url = -> '/db/campaign/' + @id\r\n\r\n    # Save reference to data used by anlytics modal so it persists across modal open/closes.\r\n    @campaignAnalytics = {}\r\n\r\n    @levels = new CocoCollection([], {\r\n      model: Level\r\n      url: \"/db/campaign/#{@campaignHandle}/levels\"\r\n      project: Campaign.denormalizedLevelProperties\r\n    })\r\n    @supermodel.loadCollection(@levels, 'levels')\r\n\r\n    @achievements = new CocoCollection([], {\r\n      model: Achievement\r\n      url: \"/db/campaign/#{@campaignHandle}/achievements\"\r\n      project: achievementProject\r\n    })\r\n    @supermodel.loadCollection(@achievements, 'achievements')\r\n\r\n    @toSave = new Backbone.Collection()\r\n    @listenToOnce @campaign ,'sync', @loadThangTypeNames\r\n    @listenToOnce @campaign, 'sync', @onFundamentalLoaded\r\n    @listenToOnce @levels, 'sync', @onFundamentalLoaded\r\n    @listenToOnce @achievements, 'sync', @onFundamentalLoaded\r\n\r\n  onLeaveMessage: ->\r\n    for model in @toSave.models\r\n      diff = model.getDelta()\r\n      if _.size(diff)\r\n        console.log 'model, diff', model, diff\r\n        return 'You have changes!'\r\n\r\n  loadThangTypeNames: ->\r\n    # Load the names of the ThangTypes that this level's Treema nodes might want to display.\r\n    originals = []\r\n    for level in _.values(@campaign.get('levels'))\r\n      originals = originals.concat(_.values(level.requiredGear)) if level.requiredGear\r\n      originals = originals.concat(_.values(level.restrictedGear)) if level.restrictedGear\r\n    originals = _.uniq _.flatten originals\r\n    for original in originals\r\n      thangType = new ThangType()\r\n      thangType.setProjection(thangTypeProject)\r\n      thangType.setURL(\"/db/thang.type/#{original}/version\")\r\n      @supermodel.loadModel(thangType)\r\n\r\n  onFundamentalLoaded: ->\r\n    # Load any levels which haven't been denormalized into our campaign.\r\n    return unless @campaign.loaded and @levels.loaded and @achievements.loaded\r\n    @loadMissingLevelsAndRelatedModels()\r\n    \r\n  loadMissingLevelsAndRelatedModels: ->\r\n    promises = []\r\n    for level in _.values(@campaign.get('levels'))\r\n      continue if model = @levels.findWhere(original: level.original)\r\n      model = new Level({})\r\n      model.setProjection Campaign.denormalizedLevelProperties\r\n      model.setURL(\"/db/level/#{level.original}/version\")\r\n      levelResource = @supermodel.loadModel(model)\r\n      @levels.add levelResource.model\r\n      # Handle SuperModel's caching, and make sure loaded levels save and notice changes properly\r\n      if levelResource.jqxhr\r\n        levelResource.model.once('sync', ->\r\n          @setURL(\"/db/level/#{@id}\")\r\n          @markToRevert()\r\n        )\r\n        promises.push(levelResource.jqxhr)\r\n      achievements = new RelatedAchievementsCollection level.original\r\n      achievements.setProjection achievementProject\r\n      achievementsResource = @supermodel.loadCollection(achievements)\r\n      promises.push(achievementsResource.jqxhr)\r\n      @listenToOnce achievements, 'sync', (achievementsLoaded) ->\r\n        @achievements.add(achievementsLoaded.models)\r\n    return Promise.resolve($.when(promises...))\r\n\r\n  onLoaded: ->\r\n    @updateCampaignLevels()\r\n    @campaignView.render()\r\n    super()\r\n\r\n  updateCampaignLevels: ->\r\n    @toSave.add @campaign if @campaign.hasLocalChanges()\r\n    campaignLevels = $.extend({}, @campaign.get('levels'))\r\n    for level, levelIndex in @levels.models\r\n      levelOriginal = level.get('original')\r\n      campaignLevel = campaignLevels[levelOriginal]\r\n      continue if not campaignLevel\r\n      $.extend campaignLevel, _.pick(level.attributes, Campaign.denormalizedLevelProperties)\r\n      # TODO: better way for it to remember when we intend to not specifically require/restrict gear any more\r\n      delete campaignLevel.requiredGear if not level.attributes.requiredGear\r\n      delete campaignLevel.restrictedGear if not level.attributes.restrictedGear\r\n      campaignLevel.rewards = @formatRewards level\r\n      # Save campaign to level if it's a main 'hero' campaign so HeroVictoryModal knows where to return.\r\n      # (Not if it's a defaulted, typeless campaign like game-dev-hoc or auditions.)\r\n      campaignLevel.campaign = @campaign.get 'slug' if @campaign.get('type') is 'hero'\r\n      # Save campaign index to level if it's a course campaign, since we show linear level order numbers for course levels.\r\n      campaignLevel.campaignIndex = (@levels.models.length - levelIndex - 1) if @campaign.get('type', true) is 'course'\r\n      campaignLevels[levelOriginal] = campaignLevel\r\n\r\n    @campaign.set('levels', campaignLevels)\r\n\r\n    for level in _.values campaignLevels\r\n      continue if /test/.test @campaign.get('slug')  # Don't overwrite level stuff for testing Campaigns\r\n      model = @levels.findWhere {original: level.original}\r\n      # do not propagate campaignIndex for non-course campaigns\r\n      propsToPropagate = Campaign.denormalizedLevelProperties\r\n      if @campaign.get('type') isnt 'course'\r\n        propsToPropagate = _.without(propsToPropagate, 'campaignIndex')\r\n      for key in propsToPropagate\r\n        model.set key, level[key] if model.get(key) isnt level[key]\r\n      @toSave.add model if model.hasLocalChanges()\r\n\r\n  formatRewards: (level) ->\r\n    achievements = @achievements.where related: level.get('original')\r\n    rewards = []\r\n    for achievement in achievements\r\n      for rewardType, rewardArray of achievement.get('rewards')\r\n        for reward in rewardArray\r\n          rewardObject = { achievement: achievement.id }\r\n\r\n          if rewardType is 'heroes'\r\n            rewardObject.hero = reward\r\n            thangType = new ThangType({}, {project: thangTypeProject})\r\n            thangType.setURL(\"/db/thang.type/#{reward}/version\")\r\n            @supermodel.loadModel(thangType)\r\n\r\n          if rewardType is 'levels'\r\n            rewardObject.level = reward\r\n            if not @levels.findWhere({original: reward})\r\n              level = new Level({}, {project: Campaign.denormalizedLevelProperties})\r\n              level.setURL(\"/db/level/#{reward}/version\")\r\n              @supermodel.loadModel(level)\r\n\r\n          if rewardType is 'items'\r\n            rewardObject.item = reward\r\n            thangType = new ThangType({}, {project: thangTypeProject})\r\n            thangType.setURL(\"/db/thang.type/#{reward}/version\")\r\n            @supermodel.loadModel(thangType)\r\n\r\n          rewards.push rewardObject\r\n    rewards\r\n\r\n  propagateCampaignIndexes: ->\r\n    campaignLevels = $.extend({}, @campaign.get('levels'))\r\n    index = 0\r\n    for levelOriginal, campaignLevel of campaignLevels\r\n      if @campaign.get('type') is 'course'\r\n        level = @levels.findWhere({original: levelOriginal})\r\n        if level and level.get('campaignIndex') isnt index\r\n          level.set('campaignIndex', index)\r\n      campaignLevel.campaignIndex = index\r\n      index += 1\r\n      @campaign.set('levels', campaignLevels)\r\n\r\n  onClickPatches: (e) ->\r\n    @patchesView = @insertSubView(new PatchesView(@campaign), @$el.find('.patches-view'))\r\n    @patchesView.load()\r\n    @patchesView.$el.removeClass 'hidden'\r\n\r\n  onClickAnalyticsButton: ->\r\n    @openModalView new CampaignAnalyticsModal {}, @campaignHandle, @campaignAnalytics\r\n\r\n  onAnalyticsModalClosed: (options) ->\r\n    if options.targetLevelSlug? and @treema.childrenTreemas?.levels?.childrenTreemas?\r\n      for original, level of @treema.childrenTreemas.levels.childrenTreemas\r\n        if level.data?.slug is options.targetLevelSlug\r\n          @openCampaignLevelView @supermodel.getModelByOriginal Level, original\r\n          break\r\n\r\n  onClickSaveButton: (e) ->\r\n    return if @openingModal\r\n    @openingModal = true\r\n    @loadMissingLevelsAndRelatedModels().then(=>\r\n      @openingModal = false\r\n      @propagateCampaignIndexes()\r\n      @updateCampaignLevels()\r\n      @toSave.set @toSave.filter (m) -> m.hasLocalChanges()\r\n      @openModalView new SaveCampaignModal({}, @toSave)\r\n    )\r\n\r\n  afterRender: ->\r\n    super()\r\n    treemaOptions =\r\n      schema: Campaign.schema\r\n      data: $.extend({}, @campaign.attributes)\r\n      filePath: \"db/campaign/#{@campaign.get('_id')}\"\r\n      callbacks:\r\n        change: @onTreemaChanged\r\n        select: @onTreemaSelectionChanged\r\n        dblclick: @onTreemaDoubleClicked\r\n        achievementUpdated: @onAchievementUpdated\r\n      nodeClasses:\r\n        levels: LevelsNode\r\n        level: LevelNode\r\n        campaigns: CampaignsNode\r\n        campaign: CampaignNode\r\n        achievement: AchievementNode\r\n        rewards: RewardsNode\r\n      supermodel: @supermodel\r\n\r\n    @treema = @$el.find('#campaign-treema').treema treemaOptions\r\n    @treema.build()\r\n    @treema.open()\r\n    @treema.childrenTreemas.levels?.open()\r\n\r\n    @campaignView = new CampaignView({editorMode: true, supermodel: @supermodel}, @campaignHandle)\r\n    @campaignView.highlightElement = _.noop # make it stop\r\n    @listenTo @campaignView, 'level-moved', @onCampaignLevelMoved\r\n    @listenTo @campaignView, 'adjacent-campaign-moved', @onAdjacentCampaignMoved\r\n    @listenTo @campaignView, 'level-clicked', @onCampaignLevelClicked\r\n    @listenTo @campaignView, 'level-double-clicked', @onCampaignLevelDoubleClicked\r\n    @listenTo @campaign, 'change:i18n', =>\r\n      @campaign.updateI18NCoverage()\r\n      @treema.set('/i18n', @campaign.get('i18n'))\r\n      @treema.set('/i18nCoverage', @campaign.get('i18nCoverage'))\r\n\r\n    @insertSubView @campaignView\r\n\r\n  onTreemaChanged: (e, nodes) =>\r\n    unless /test/.test @campaign.get('slug')  # Don't overwrite level stuff for testing Campaigns\r\n      for node in nodes\r\n        path = node.getPath()\r\n        if _.string.startsWith path, '/levels/'\r\n          parts = path.split('/')\r\n          original = parts[2]\r\n          level = @supermodel.getModelByOriginal Level, original\r\n          campaignLevel = @treema.get \"/levels/#{original}\"\r\n          level.set key, campaignLevel[key] for key in Campaign.denormalizedLevelProperties\r\n          @toSave.add level if level.hasLocalChanges()\r\n\r\n    @toSave.add @campaign\r\n    @campaign.set key, value for key, value of @treema.data\r\n    @campaignView.setCampaign(@campaign)\r\n\r\n  onTreemaSelectionChanged: (e, node) =>\r\n    return unless node[0]?.data?.original?\r\n    elem = @$(\"div[data-level-original='#{node[0].data.original}']\")\r\n    elem.toggle('pulsate')\r\n    setTimeout ()->\r\n      elem.toggle('pulsate')\r\n    , 1000\r\n\r\n  onTreemaDoubleClicked: (e, node) =>\r\n    path = node.getPath()\r\n    return unless _.string.startsWith path, '/levels/'\r\n    original = path.split('/')[2]\r\n    @openCampaignLevelView @supermodel.getModelByOriginal Level, original\r\n\r\n  onAchievementUpdated: (e, node) =>\r\n    @supermodel.registerModel e.achievement\r\n    @achievements.findWhere({_id: e.achievement.id}).set('rewards', e.achievement.get('rewards'))\r\n    @updateCampaignLevels()  # TODO: only change the rewards for the one we had, don't wipe anything else\r\n    levelOriginal = node.getPath().split('/')[2]\r\n    level = @levels.findWhere original: levelOriginal\r\n    rewardsPath = \"/levels/#{levelOriginal}/rewards\"\r\n    @treema.set rewardsPath, @formatRewards level\r\n    @campaignView.setCampaign @campaign\r\n\r\n  onCampaignLevelMoved: (e) ->\r\n    path = \"levels/#{e.levelOriginal}/position\"\r\n    @treema.set path, e.position\r\n\r\n  onAdjacentCampaignMoved: (e) ->\r\n    path = \"adjacentCampaigns/#{e.campaignID}/position\"\r\n    @treema.set path, e.position\r\n\r\n  onCampaignLevelClicked: (levelOriginal) ->\r\n    return unless levelTreema = @treema.childrenTreemas?.levels?.childrenTreemas?[levelOriginal]\r\n    if key.ctrl or key.command\r\n      url = \"/editor/level/#{levelTreema.data.slug}\"\r\n      window.open url, '_blank'\r\n    levelTreema.select()\r\n    #levelTreema.open()\r\n\r\n  onCampaignLevelDoubleClicked: (levelOriginal) ->\r\n    @openCampaignLevelView @supermodel.getModelByOriginal Level, levelOriginal\r\n\r\n  openCampaignLevelView: (level) ->\r\n    @insertSubView campaignLevelView = new CampaignLevelView({}, level)\r\n    @listenToOnce campaignLevelView, 'hidden', => @$el.find('#campaign-view').show()\r\n    @$el.find('#campaign-view').hide()\r\n\r\n  onClickLoginButton: ->\r\n    # Do Nothing\r\n    # This is a override method to RootView, so that only CampaignView is listenting to login button click\r\n\r\n  onClickSignupButton: ->\r\n    # Do Nothing\r\n    # This is a override method to RootView, so that only CampaignView is listenting to signup button click\r\n\r\nclass LevelsNode extends TreemaObjectNode\r\n  valueClass: 'treema-levels'\r\n  @levels: {}\r\n  ordered: true\r\n\r\n  buildValueForDisplay: (valEl, data) ->\r\n    @buildValueForDisplaySimply valEl, ''+_.size(data)\r\n\r\n  childPropertiesAvailable: -> @childSource\r\n\r\n  childSource: (req, res) =>\r\n    s = new Backbone.Collection([], {model:Level})\r\n    s.url = '/db/level'\r\n    s.fetch({data: {term:req.term, project: Campaign.denormalizedLevelProperties.join(',')}})\r\n    s.once 'sync', (collection) =>\r\n      for level in collection.models\r\n        LevelsNode.levels[level.get('original')] = level\r\n        @settings.supermodel.registerModel level\r\n      mapped = ({label: r.get('name'), value: r.get('original')} for r in collection.models)\r\n\r\n      # Sort the results. Prioritize names that start with the search term, then contain the search term.\r\n      lowerPriority = _.clone(mapped)\r\n      lowerTerm = req.term.toLowerCase()\r\n      startsWithTerm = _.filter(lowerPriority, (item) -> _.string.startsWith(item.label.toLowerCase(), lowerTerm))\r\n      _.pull(lowerPriority, startsWithTerm...)\r\n      hasTerm = _.filter(lowerPriority, (item) -> _.string.contains(item.label.toLowerCase(), lowerTerm))\r\n      _.pull(lowerPriority, hasTerm...)\r\n      sorted = _.flatten([startsWithTerm, hasTerm, lowerPriority])\r\n      res(sorted)\r\n\r\nclass LevelNode extends TreemaObjectNode\r\n  valueClass: 'treema-level'\r\n  buildValueForDisplay: (valEl, data) ->\r\n    name = data.name\r\n    if data.requiresSubscription\r\n      name = \"[P] \" + name\r\n\r\n    status = ''\r\n    el = 'strong'\r\n    if data.adminOnly\r\n      status += \" (disabled)\"\r\n      el = 'span'\r\n    else if data.adventurer\r\n      status += \" (adventurer)\"\r\n\r\n    completion = ''\r\n\r\n    valEl.append $(\"<a href='/editor/level/#{_.string.slugify(data.name)}' class='spr'>(e)</a>\")\r\n    valEl.append $(\"<#{el}></#{el}>\").addClass('treema-shortened').text name\r\n    if status\r\n      valEl.append $('<em class=\"spl\"></em>').text status\r\n    if completion\r\n      valEl.append $('<span class=\"completion\"></span>').text completion\r\n\r\n  populateData: ->\r\n    return if @data.name?\r\n    data = _.pick LevelsNode.levels[@keyForParent].attributes, Campaign.denormalizedLevelProperties\r\n    _.extend @data, data\r\n\r\nclass CampaignsNode extends TreemaObjectNode\r\n  valueClass: 'treema-campaigns'\r\n  @campaigns: {}\r\n\r\n  buildValueForDisplay: (valEl, data) ->\r\n    @buildValueForDisplaySimply valEl, ''+_.size(data)\r\n\r\n  childPropertiesAvailable: -> @childSource\r\n\r\n  childSource: (req, res) =>\r\n    s = new Backbone.Collection([], {model:Campaign})\r\n    s.url = '/db/campaign'\r\n    s.fetch({data: {term:req.term, project: Campaign.denormalizedCampaignProperties}})\r\n    s.once 'sync', (collection) ->\r\n      CampaignsNode.campaigns[campaign.id] = campaign for campaign in collection.models\r\n      mapped = ({label: r.get('name'), value: r.id} for r in collection.models)\r\n      res(mapped)\r\n\r\n\r\nclass CampaignNode extends TreemaObjectNode\r\n  valueClass: 'treema-campaign'\r\n  buildValueForDisplay: (valEl, data) ->\r\n    @buildValueForDisplaySimply valEl, data.name\r\n\r\n  populateData: ->\r\n    return if @data.name?\r\n    # TODO: Need to be able to update i18n links to other campaigns\r\n    data = _.pick CampaignsNode.campaigns[@keyForParent].attributes, Campaign.denormalizedCampaignProperties\r\n    _.extend @data, data\r\n\r\nclass AchievementNode extends treemaExt.IDReferenceNode\r\n  buildSearchURL: (term) -> \"#{@url}?term=#{term}&project=#{achievementProject.join(',')}\"\r\n\r\n  buildValueForDisplay: (valEl, data) ->\r\n    super valEl, data\r\n    addAchievementEditorLink @, valEl, data\r\n\r\nclass RewardsNode extends TreemaArrayNode\r\n  buildValueForDisplay: (valEl, data) ->\r\n    super valEl, data\r\n    achievements = window.currentView.achievements.where related: @parent.data.original\r\n    achievements = _.sortBy achievements, (a) -> a.get('rewards')?.levels?.length ? 0\r\n    mainAchievement = achievements[0]\r\n    return unless mainAchievement\r\n    addAchievementEditorLink @, valEl, mainAchievement.id\r\n\r\naddAchievementEditorLink = (node, valEl, achievementId) ->\r\n  anchor = $('<a class=\"spl\">(e)</a>')\r\n  anchor.on 'click', (event) ->\r\n    childWindow = window.open(\"/editor/achievement/#{achievementId}\", achievementId, 'width=1040,height=900,left=1600,top=0,location=1,menubar=1,scrollbars=1,status=0,titlebar=1,toolbar=1', true)\r\n    childWindow.achievementSavedCallback = (event) ->\r\n      node.callbacks.achievementUpdated {achievement: event.achievement}, node\r\n    childWindow.focus()\r\n    event.stopPropagation()\r\n  valEl.find('.treema-shortened').append anchor\r\n"]}