{"version":3,"sources":["app/views/editor/verifier/VerifierTest.coffee"],"names":[],"mappings":"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","file":"public/javascripts/app/views/editor/verifier/VerifierTest.js","sourcesContent":["CocoClass = require 'core/CocoClass'\r\nSuperModel = require 'models/SuperModel'\r\n{createAetherOptions} = require 'lib/aether_utils'\r\nGod = require 'lib/God'\r\nGoalManager = require 'lib/world/GoalManager'\r\nLevelLoader = require 'lib/LevelLoader'\r\nutils = require 'core/utils'\r\n\r\nmodule.exports = class VerifierTest extends CocoClass\r\n  constructor: (@levelID, @updateCallback, @supermodel, @language, @options) ->\r\n    super()\r\n    # TODO: turn this into a Subview\r\n    # TODO: listen to the progress report from Angel to show a simulation progress bar (maybe even out of the number of frames we actually know it'll take)\r\n    @supermodel ?= new SuperModel()\r\n\r\n    if utils.getQueryVariable('dev') or @options.devMode\r\n      @supermodel.shouldSaveBackups = (model) ->  # Make sure to load possibly changed things from localStorage.\r\n        model.constructor.className in ['Level', 'LevelComponent', 'LevelSystem', 'ThangType']\r\n\r\n    @language ?= 'python'\r\n    @userCodeProblems = []\r\n    @load()\r\n\r\n  load: ->\r\n    @loadStartTime = new Date()\r\n    @god = new God maxAngels: 1, headless: true\r\n    @levelLoader = new LevelLoader supermodel: @supermodel, levelID: @levelID, headless: true, fakeSessionConfig: {codeLanguage: @language, callback: @configureSession}\r\n    @listenToOnce @levelLoader, 'world-necessities-loaded', -> _.defer @onWorldNecessitiesLoaded\r\n\r\n  onWorldNecessitiesLoaded: =>\r\n    # Called when we have enough to build the world, but not everything is loaded\r\n    @grabLevelLoaderData()\r\n\r\n    unless @solution\r\n      @error = 'No solution present...'\r\n      @state = 'no-solution'\r\n      @updateCallback? test: @, state: 'no-solution'\r\n      return\r\n    me.team = @team = 'humans'\r\n    @setupGod()\r\n    @initGoalManager()\r\n    @register()\r\n\r\n  configureSession: (session, level) =>\r\n    try\r\n      session.solution = _.find level.getSolutions(), language: session.get('codeLanguage')\r\n      session.set 'heroConfig', session.solution.heroConfig\r\n      session.set 'code', {'hero-placeholder': plan: session.solution.source}\r\n      state = session.get 'state'\r\n      state.flagHistory = session.solution.flagHistory\r\n      state.realTimeInputEvents = session.solution.realTimeInputEvents\r\n      state.difficulty = session.solution.difficulty or 0\r\n      session.solution.seed = undefined unless _.isNumber session.solution.seed  # TODO: migrate away from submissionCount/sessionID seed objects\r\n    catch e\r\n      @state = 'error'\r\n      @error = \"Could not load the session solution for #{level.get('name')}: \" + e.toString() + \"\\n\" + e.stack\r\n\r\n  grabLevelLoaderData: ->\r\n    @world = @levelLoader.world\r\n    @level = @levelLoader.level\r\n    @session = @levelLoader.session\r\n    @solution = @levelLoader.session.solution\r\n\r\n  setupGod: ->\r\n    @god.setLevel @level.serialize {@supermodel, @session, otherSession: null, headless: true, sessionless: false}\r\n    @god.setLevelSessionIDs [@session.id]\r\n    @god.setWorldClassMap @world.classMap\r\n    @god.lastFlagHistory = @session.get('state').flagHistory\r\n    @god.lastDifficulty = @session.get('state').difficulty\r\n    @god.lastFixedSeed = @session.solution.seed\r\n    @god.lastSubmissionCount = 0\r\n\r\n  initGoalManager: ->\r\n    @goalManager = new GoalManager(@world, @level.get('goals'), @team)\r\n    @god.setGoalManager @goalManager\r\n\r\n  register: ->\r\n    @listenToOnce @god, 'infinite-loop', @fail\r\n    @listenToOnce @god, 'user-code-problem', @onUserCodeProblem\r\n    @listenToOnce @god, 'goals-calculated', @processSingleGameResults\r\n    @god.createWorld @session.generateSpellsObject()\r\n    @state = 'running'\r\n    @reportResults()\r\n\r\n  extractTestLogs: ->\r\n    @testLogs = []\r\n    for log in @god?.angelsShare?.busyAngels?[0]?.allLogs ? []\r\n      continue if log.indexOf('[TEST]') is -1\r\n      @testLogs.push log.replace /\\|.*?\\| \\[TEST\\] /, ''\r\n    @testLogs\r\n\r\n  reportResults: ->\r\n    @updateCallback? test: @, state: @state, testLogs: @extractTestLogs()\r\n\r\n  processSingleGameResults: (e) ->\r\n    @goals = e.goalStates\r\n    @frames = e.totalFrames\r\n    @lastFrameHash = e.lastFrameHash\r\n    @simulationFrameRate = e.simulationFrameRate\r\n    @state = 'complete'\r\n    @reportResults()\r\n    @scheduleCleanup()\r\n\r\n  isSuccessful: (careAboutFrames=true) ->\r\n    return false unless @solution?\r\n    return false unless @frames == @solution.frameCount or not careAboutFrames\r\n    return false if @simulationFrameRate < 30\r\n    if @goals and @solution.goals\r\n      for k of @goals\r\n        continue if not @solution.goals[k]\r\n        return false if @solution.goals[k] != @goals[k].status\r\n    return true\r\n\r\n  onUserCodeProblem: (e) ->\r\n    console.warn \"Found user code problem:\", e\r\n    @userCodeProblems.push e.problem\r\n    @reportResults()\r\n\r\n  onNonUserCodeProblem: (e) ->\r\n    console.error \"Found non-user-code problem:\", e\r\n    @error = \"Failed due to non-user-code problem: #{JSON.stringify(e)}\"\r\n    @state = 'error'\r\n    @reportResults()\r\n    @scheduleCleanup()\r\n\r\n  fail: (e) ->\r\n    @error = 'Failed due to infinite loop.'\r\n    @state = 'error'\r\n    @reportResults()\r\n    @scheduleCleanup()\r\n\r\n  scheduleCleanup: ->\r\n    setTimeout @cleanup, 100\r\n\r\n  cleanup: =>\r\n    if @levelLoader\r\n      @stopListening @levelLoader\r\n      @levelLoader.destroy()\r\n    if @god\r\n      @stopListening @god\r\n      @god.destroy()\r\n    @world = null\r\n"]}