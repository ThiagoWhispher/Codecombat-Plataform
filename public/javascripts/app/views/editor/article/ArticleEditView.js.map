{"version":3,"sources":["app/views/editor/article/ArticleEditView.coffee"],"names":[],"mappings":";AAAA;EAAA;;;;AAAA,WAAW,QAAQ,qBAAR;;AACX,qBAAqB,QAAQ,wBAAR;;AACrB,WAAW,QAAQ,+BAAR;;AACX,UAAU,QAAQ,gBAAR;;AACV,mBAAmB,QAAQ,qCAAR;;AACnB,cAAc,QAAQ,0BAAR;;AACd,QAAQ,yBAAR;;AACA,QAAQ,eAAR;;AAEA,QAAQ,gBAAR;;AAEA,MAAM,CAAC,OAAP,GAAuB;;;4BACrB,KAAI;;4BACJ,WAAU;;4BAEV,SACE;IAAA,yBAAyB,aAAzB;IACA,yBAAyB,oBADzB;IAEA,sBAAsB,eAFtB;;;EAIW,yBAAC,OAAD,EAAU,SAAV;IAAU,IAAC,aAAD;;IACrB,iDAAM,OAAN;IACA,IAAC,QAAD,GAAe,YAAQ;MAAC,KAAK,IAAC,UAAP;KAAR;IACf,IAAC,QAAO,CAAC,WAAT,GAAuB;IACvB,IAAC,WAAU,CAAC,SAAZ,CAAsB,IAAC,QAAvB;IACA,IAAC,qBAAD,GAAwB,CAAC,CAAC,QAAF,CAAW,IAAC,qBAAZ,EAAkC,GAAlC;EALb;;4BAOb,WAAU;IACR;IACA,IAAC,YAAD;WACA,IAAC,SAAD,CAAU,IAAC,QAAX,EAAoB,QAApB,EAA8B;aAAA;QAC5B,KAAC,QAAO,CAAC,kBAAT;eACA,KAAC,OAAM,CAAC,GAAR,CAAY,GAAZ,EAAiB,KAAC,QAAO,CAAC,UAA1B;MAF4B;IAAA,QAA9B;EAHQ;;4BAOV,cAAa;AACX;IAAA,IAAU,yBAAY,CAAC,CAAI,IAAC,QAAO,CAAC,MAAd,CAAtB;AAAA;;IACA,KAAO,IAAC,QAAO,CAAC,UAAU,CAAC,IAA3B;MACE,IAAC,QAAO,CAAC,GAAT,CAAa,MAAb,EAAqB,EAArB,EADF;;IAEA,OAAO,CAAC,CAAC,MAAF,CAAS,IAAT,EAAe,EAAf,EAAmB,IAAC,QAAO,CAAC,UAA5B;IACP,UACE;MAAA,MAAM,IAAN;MACA,UAAU,mBAAgB,CAAC,IAAC,QAAO,CAAC,GAAT,CAAa,UAAb,CAAD,CAD1B;MAEA,QAAQ,OAAO,CAAC,MAFhB;MAGA,UAAU,EAAE,CAAC,GAAH,CAAO,WAAP,CAHV;MAIA,WACE;QAAA,QAAQ,IAAC,qBAAT;OALF;;IAMF,IAAC,OAAD,GAAU,IAAC,IAAG,CAAC,IAAL,CAAU,iBAAV,CAA4B,CAAC,MAA7B,CAAoC,OAApC;WACV,IAAC,OAAM,CAAC,KAAR;EAbW;;4BAeb,uBAAsB;AACpB;AAAA;AAAA;;MACE,IAAC,QAAO,CAAC,GAAT,CAAa,GAAb,EAAkB,KAAlB;AADF;IAEA,MAAc,IAAC,OAAD,IAAY,IAAC,QAA3B;AAAA;;IACA,IAAI,OAAO,IAAC,OAAM,CAAC,IAAI,CAAC,IAApB;IACJ,IAAI,EAAE,IAAC,QAAO,CAAC,QAAQ,CAAC,IAApB;IACJ,gBAAgB;aAAA;QACd,IAAG,CAAC,CAAC,IAAF,CAAO,SAAP,CAAiB,CAAC,MAAlB,KAA4B,CAA/B;UACE,CAAC,CAAC,IAAF,CAAO,SAAP,CAAiB,CAAC,IAAlB,CAAuB,CAAvB;UACA,CAAC,CAAC,IAAF,CAAO,QAAP,CAAgB,CAAC,IAAjB,CAAsB,KAAC,OAAM,CAAC,IAAI,CAAC,IAAnC;iBACA,cAAc,EAAd,EAHF;;MADc;IAAA;WAKhB,KAAK,YAAY,aAAZ,EAA2B,GAA3B;EAXe;;4BAatB,cAAa;IACX;IACA,KAAc,IAAC,WAAU,CAAC,QAAZ,EAAd;AAAA;;IACA,IAAmB,EAAE,CAAC,GAAH,CAAO,WAAP,CAAnB;MAAA,IAAC,aAAD;;IACA,IAAC,YAAD,GAAe,IAAC,cAAD,CAAmB,gBAAY,IAAC,QAAb,CAAnB,EAA0C,IAAC,IAAG,CAAC,IAAL,CAAU,eAAV,CAA1C;WACf,IAAC,YAAW,CAAC,IAAb;EALW;;4BAOb,cAAa;IACX,IAAG,CAAI,IAAC,QAAL,IAAgB,IAAC,QAAO,CAAC,MAA5B;MACE,IAAC,QAAD,GAAW,MAAM,CAAC,IAAP,CAAY,yBAAZ,EAAuC,SAAvC,EAAkD,sBAAlD,EADb;;IAEA,IAAoB,MAAM,CAAC,KAA3B;MAAA,IAAC,QAAO,CAAC,KAAT;;IACA,IAAC,QAAO,CAAC,MAAT,GAAkB;aAAA;eAAG,KAAC,qBAAD;MAAH;IAAA;AAClB,WAAO;EALI;;4BAOb,gBAAe;AACb;IAAA,QAAY,qBAAiB;MAAC,OAAO,IAAC,QAAT;MAAkB,oBAAoB,IAAtC;KAAjB;IACZ,IAAC,cAAD,CAAe,KAAf;IACA,IAAC,aAAD,CAAc,KAAd,EAAqB,kBAArB,EAAyC,IAAC,eAA1C;WACA,IAAC,aAAD,CAAc,KAAd,EAAqB,QAArB,EAA+B;aAAG,IAAC,cAAD,CAAe,KAAf;IAAH,CAA/B;EAJa;;4BAMf,iBAAgB,SAAC,CAAD;AACd;IAAA,IAAC,OAAM,CAAC,gBAAR;AACA;AAAA;;MACE,IAAC,QAAO,CAAC,GAAT,CAAa,GAAb,EAAkB,KAAlB;AADF;IAGA,IAAC,QAAO,CAAC,GAAT,CAAa,eAAb,EAA8B,CAAC,CAAC,aAAhC;IACA,MAAM,IAAC,QAAO,CAAC,mBAAT;IACN,KAAc,GAAd;AAAA;;IACA,QAAQ,IAAC,IAAG,CAAC,IAAL,CAAU,qBAAV;IACR,IAAC,sBAAD,CAAuB,KAAvB;IAEA,GAAG,CAAC,KAAJ,CAAU;aAAA;eACR,KAAC,uBAAD,CAAwB,KAAxB;MADQ;IAAA,QAAV;WAGA,GAAG,CAAC,OAAJ,CAAY;aAAA;AACV;QAAA,KAAC,QAAO,CAAC,WAAT;QACA,KAAK,CAAC,KAAN,CAAY,MAAZ;QACA,MAAM,qBAAkB,CAAC,KAAC,QAAO,CAAC,GAAT,CAAa,MAAb,KAAwB,KAAC,QAAO,CAAC,EAAlC;eACxB,QAAQ,CAAC,QAAQ,CAAC,IAAlB,GAAyB;MAJf;IAAA,QAAZ;EAdc;;4BAoBhB,qBAAoB,SAAC,CAAD;AAClB;IAAA,qBAAyB,uBAAmB;MAAA,SAAS,IAAC,QAAV;KAAnB,EAAsC,IAAC,UAAvC;IACzB,IAAC,cAAD,CAAe,kBAAf;WACA,QAAQ,CAAC,QAAQ,CAAC,OAAlB,CAA0B,sBAA1B,EAAkD,EAAlD;EAHkB;;;;GA3FyB","file":"public/javascripts/app/views/editor/article/ArticleEditView.js","sourcesContent":["RootView = require 'views/core/RootView'\r\nVersionHistoryView = require './ArticleVersionsModal'\r\ntemplate = require 'templates/editor/article/edit'\r\nArticle = require 'models/Article'\r\nSaveVersionModal = require 'views/editor/modal/SaveVersionModal'\r\nPatchesView = require 'views/editor/PatchesView'\r\nrequire 'views/modal/RevertModal'\r\nrequire 'vendor/treema'\r\n\r\nrequire 'game-libraries'\r\n\r\nmodule.exports = class ArticleEditView extends RootView\r\n  id: 'editor-article-edit-view'\r\n  template: template\r\n\r\n  events:\r\n    'click #preview-button': 'openPreview'\r\n    'click #history-button': 'showVersionHistory'\r\n    'click #save-button': 'openSaveModal'\r\n\r\n  constructor: (options, @articleID) ->\r\n    super options\r\n    @article = new Article({_id: @articleID})\r\n    @article.saveBackups = true\r\n    @supermodel.loadModel @article\r\n    @pushChangesToPreview = _.throttle(@pushChangesToPreview, 500)\r\n\r\n  onLoaded: ->\r\n    super()\r\n    @buildTreema()\r\n    @listenTo @article, 'change', =>\r\n      @article.updateI18NCoverage()\r\n      @treema.set('/', @article.attributes)\r\n\r\n  buildTreema: ->\r\n    return if @treema? or (not @article.loaded)\r\n    unless @article.attributes.body\r\n      @article.set('body', '')\r\n    data = $.extend(true, {}, @article.attributes)\r\n    options =\r\n      data: data\r\n      filePath: \"db/thang.type/#{@article.get('original')}\"\r\n      schema: Article.schema\r\n      readOnly: me.get('anonymous')\r\n      callbacks:\r\n        change: @pushChangesToPreview\r\n    @treema = @$el.find('#article-treema').treema(options)\r\n    @treema.build()\r\n\r\n  pushChangesToPreview: =>\r\n    for key, value of @treema.data\r\n      @article.set(key, value)\r\n    return unless @treema and @preview\r\n    m = marked(@treema.data.body)\r\n    b = $(@preview.document.body)\r\n    onLoadHandler = =>\r\n      if b.find('#insert').length == 1\r\n        b.find('#insert').html(m)\r\n        b.find('#title').text(@treema.data.name)\r\n        clearInterval(id)\r\n    id = setInterval(onLoadHandler, 100)\r\n\r\n  afterRender: ->\r\n    super()\r\n    return unless @supermodel.finished()\r\n    @showReadOnly() if me.get('anonymous')\r\n    @patchesView = @insertSubView(new PatchesView(@article), @$el.find('.patches-view'))\r\n    @patchesView.load()\r\n\r\n  openPreview: ->\r\n    if not @preview or @preview.closed\r\n      @preview = window.open('/editor/article/preview', 'preview', 'height=800,width=600')\r\n    @preview.focus() if window.focus\r\n    @preview.onload = => @pushChangesToPreview()\r\n    return false\r\n\r\n  openSaveModal: ->\r\n    modal = new SaveVersionModal({model: @article, noNewMajorVersions: true})\r\n    @openModalView(modal)\r\n    @listenToOnce modal, 'save-new-version', @saveNewArticle\r\n    @listenToOnce modal, 'hidden', -> @stopListening(modal)\r\n\r\n  saveNewArticle: (e) ->\r\n    @treema.endExistingEdits()\r\n    for key, value of @treema.data\r\n      @article.set(key, value)\r\n\r\n    @article.set('commitMessage', e.commitMessage)\r\n    res = @article.saveNewMinorVersion()\r\n    return unless res\r\n    modal = @$el.find('#save-version-modal')\r\n    @enableModalInProgress(modal)\r\n\r\n    res.error =>\r\n      @disableModalInProgress(modal)\r\n\r\n    res.success =>\r\n      @article.clearBackup()\r\n      modal.modal('hide')\r\n      url = \"/editor/article/#{@article.get('slug') or @article.id}\"\r\n      document.location.href = url\r\n\r\n  showVersionHistory: (e) ->\r\n    versionHistoryView = new VersionHistoryView article: @article, @articleID\r\n    @openModalView versionHistoryView\r\n    Backbone.Mediator.publish 'editor:view-switched', {}\r\n"]}