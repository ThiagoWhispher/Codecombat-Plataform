{"version":3,"sources":["app/templates/editor/patch_modal.jade","app/views/editor/PatchModal.coffee"],"names":[],"mappings":"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","file":"public/javascripts/app/views/editor/PatchModal.js","sourcesContent":["var __templateData = function anonymous(locals\n/**/) {\nvar buf = [];\nvar locals_ = (locals || {}),view = locals_.view,patch = locals_.patch,deltaWorked = locals_.deltaWorked,isPatchCreator = locals_.isPatchCreator,status = locals_.status,isPatchRecipient = locals_.isPatchRecipient;buf.push(\"<div class=\\\"modal-dialog game\\\"><div class=\\\"background-wrapper\\\"><div class=\\\"modal-content\\\"><div class=\\\"modal-header\\\">\");\nif ( view.closeButton)\n{\nbuf.push(\"<div type=\\\"button\\\" data-dismiss=\\\"modal\\\" aria-hidden=\\\"true\\\" class=\\\"button close\\\">&times;</div>\");\n}\nbuf.push(\"<div class=\\\"modal-header-content\\\"><h3 data-i18n=\\\"resources.patch\\\"></h3></div></div><div class=\\\"modal-body\\\"><div class=\\\"modal-body\\\"><p>\" + (jade.escape(null == (jade.interp = patch.get('commitMessage')) ? \"\" : jade.interp)) + \"</p>\");\nif ( deltaWorked)\n{\nbuf.push(\"<div class=\\\"changes-stub\\\"></div>\");\n}\nelse\n{\nbuf.push(\"<div class=\\\"alert alert-danger\\\">Could not apply this delta to the current version.</div>\");\n}\nbuf.push(\"</div></div><div class=\\\"modal-body wait secret\\\"><h3>Reticulating Splines...</h3><div class=\\\"progress progress-striped active\\\"><div class=\\\"progress-bar\\\"></div></div></div><div class=\\\"modal-footer\\\"><button data-dismiss=\\\"modal\\\" data-i18n=\\\"common.cancel\\\" class=\\\"btn\\\"></button>\");\nif ( isPatchCreator)\n{\nif ( status != 'withdrawn')\n{\nbuf.push(\"<button id=\\\"withdraw-button\\\" data-i18n=\\\"general.withdraw\\\" class=\\\"btn btn-danger\\\"></button>\");\n}\n}\nif ( isPatchRecipient)\n{\nif ( status != 'accepted')\n{\nbuf.push(\"<button id=\\\"accept-button\\\" data-i18n=\\\"general.accept\\\" class=\\\"btn btn-primary\\\"></button>\");\n}\nif ( status != 'rejected')\n{\nbuf.push(\"<button id=\\\"reject-button\\\" data-i18n=\\\"general.reject\\\" class=\\\"btn btn-danger\\\"></button>\");\n}\n}\nbuf.push(\"</div></div></div></div>\");;return buf.join(\"\");\n};\nif (typeof define === 'function' && define.amd) {\n  define([], function() {\n    return __templateData;\n  });\n} else if (typeof module === 'object' && module && module.exports) {\n  module.exports = __templateData;\n} else {\n  __templateData;\n}","ModalView = require 'views/core/ModalView'\r\ntemplate = require 'templates/editor/patch_modal'\r\nDeltaView = require 'views/editor/DeltaView'\r\nauth = require 'core/auth'\r\ndeltasLib = require 'core/deltas'\r\n\r\nmodule.exports = class PatchModal extends ModalView\r\n  id: 'patch-modal'\r\n  template: template\r\n  plain: true\r\n  modalWidthPercent: 60\r\n  instant: true\r\n\r\n  events:\r\n    'click #withdraw-button': 'withdrawPatch'\r\n    'click #reject-button': 'rejectPatch'\r\n    'click #accept-button': 'acceptPatch'\r\n\r\n  shortcuts:\r\n    'a, shift+a': 'acceptPatch'\r\n    'r': 'rejectPatch'\r\n\r\n  constructor: (@patch, @targetModel, options) ->\r\n    super(options)\r\n    targetID = @patch.get('target').id\r\n    if targetID is @targetModel.id\r\n      @originalSource = @targetModel.clone(false)\r\n    else\r\n      @originalSource = new @targetModel.constructor({_id:targetID})\r\n      @supermodel.loadModel @originalSource\r\n\r\n  applyDelta: ->\r\n    @headModel = null\r\n    if @targetModel.hasWriteAccess()\r\n      @headModel = @originalSource.clone(false)\r\n      @headModel.markToRevert true\r\n      @headModel.set(@targetModel.attributes)\r\n      @headModel.loaded = true\r\n\r\n    @pendingModel = @originalSource.clone(false)\r\n    @pendingModel.markToRevert true\r\n    @deltaWorked = @pendingModel.applyDelta(@patch.get('delta'))\r\n    @pendingModel.loaded = true\r\n\r\n  render: ->\r\n    @applyDelta() if @supermodel.finished()\r\n    super()\r\n\r\n  getRenderData: ->\r\n    c = super()\r\n    c.isPatchCreator = @patch.get('creator') is auth.me.id\r\n    c.isPatchRecipient = @targetModel.hasWriteAccess()\r\n    c.status = @patch.get 'status'\r\n    c.patch = @patch\r\n    c.deltaWorked = @deltaWorked\r\n    c\r\n\r\n  afterRender: ->\r\n    return super() unless @supermodel.finished() and @deltaWorked\r\n    @deltaView = new DeltaView({model:@pendingModel, headModel:@headModel, skipPaths: deltasLib.DOC_SKIP_PATHS})\r\n    changeEl = @$el.find('.changes-stub')\r\n    @insertSubView(@deltaView, changeEl)\r\n    super()\r\n\r\n  acceptPatch: ->\r\n    delta = @deltaView.getApplicableDelta()\r\n    @targetModel.applyDelta(delta)\r\n    @targetModel.saveBackupNow()\r\n    @patch.setStatus('accepted')\r\n    @trigger 'accepted-patch'\r\n    @hide()\r\n\r\n  rejectPatch: ->\r\n    @patch.setStatus('rejected')\r\n    @hide()\r\n\r\n  withdrawPatch: ->\r\n    @patch.setStatus('withdrawn')\r\n    @hide()\r\n"]}