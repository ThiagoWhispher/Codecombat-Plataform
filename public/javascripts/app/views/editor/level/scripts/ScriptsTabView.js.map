{"version":3,"sources":["app/views/editor/level/scripts/ScriptsTabView.coffee"],"names":[],"mappings":"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","file":"public/javascripts/app/views/editor/level/scripts/ScriptsTabView.js","sourcesContent":["CocoView = require 'views/core/CocoView'\r\ntemplate = require 'templates/editor/level/scripts_tab'\r\nLevel = require 'models/Level'\r\nSurface = require 'lib/surface/Surface'\r\nnodes = require './../treema_nodes'\r\ndefaultScripts = require 'lib/DefaultScripts'\r\nrequire 'vendor/treema'\r\n\r\nmodule.exports = class ScriptsTabView extends CocoView\r\n  id: 'editor-level-scripts-tab-view'\r\n  template: template\r\n  className: 'tab-pane'\r\n\r\n  subscriptions:\r\n    'editor:level-loaded': 'onLevelLoaded'\r\n    'editor:thangs-edited': 'onThangsEdited'\r\n\r\n  constructor: (options) ->\r\n    super options\r\n    @world = options.world\r\n    @files = options.files\r\n    $(window).on 'resize', @onWindowResize\r\n\r\n  destroy: ->\r\n    @scriptTreema?.destroy()\r\n    @scriptTreemas?.destroy()\r\n    $(window).off 'resize', @onWindowResize\r\n    super()\r\n\r\n  onLoaded: ->\r\n  onLevelLoaded: (e) ->\r\n    @level = e.level\r\n    @dimensions = @level.dimensions()\r\n    scripts = $.extend(true, [], @level.get('scripts') ? [])\r\n    if scripts.length is 0\r\n      scripts = $.extend(true, [], defaultScripts)\r\n    treemaOptions =\r\n      schema: Level.schema.properties.scripts\r\n      data: scripts\r\n      callbacks:\r\n        change: @onScriptsChanged\r\n        select: @onScriptSelected\r\n        addChild: @onNewScriptAdded\r\n        removeChild: @onScriptDeleted\r\n      nodeClasses:\r\n        array: ScriptsNode\r\n        object: ScriptNode\r\n      view: @\r\n    @scriptsTreema = @$el.find('#scripts-treema').treema treemaOptions\r\n    @scriptsTreema.build()\r\n    if @scriptsTreema.childrenTreemas[0]?\r\n      @scriptsTreema.childrenTreemas[0].select()\r\n      @scriptsTreema.childrenTreemas[0].broadcastChanges() # can get rid of this after refactoring treema\r\n\r\n  onScriptsChanged: (e) =>\r\n    @level.set 'scripts', @scriptsTreema.data\r\n\r\n  onScriptSelected: (e, selected) =>\r\n    selected = if selected.length > 1 then selected[0].getLastSelectedTreema() else selected[0]\r\n    unless selected\r\n      @$el.find('#script-treema').replaceWith($('<div id=\"script-treema\"></div>'))\r\n      @selectedScriptPath = null\r\n      return\r\n\r\n    @thangIDs = @getThangIDs()\r\n    treemaOptions =\r\n      world: @world\r\n      filePath: \"db/level/#{@level.get('original')}\"\r\n      files: @files\r\n      view: @\r\n      schema: Level.schema.properties.scripts.items\r\n      data: selected.data\r\n      thangIDs: @thangIDs\r\n      dimensions: @dimensions\r\n      supermodel: @supermodel\r\n      readOnly: me.get('anonymous')\r\n      callbacks:\r\n        change: @onScriptChanged\r\n      nodeClasses:\r\n        object: PropertiesNode\r\n        'event-value-chain': EventPropsNode\r\n        'event-prereqs': EventPrereqsNode\r\n        'event-prereq': EventPrereqNode\r\n        'event-channel': ChannelNode\r\n        'thang': nodes.ThangNode\r\n        'milliseconds': nodes.MillisecondsNode\r\n        'seconds': nodes.SecondsNode\r\n        'point2d': nodes.WorldPointNode\r\n        'viewport': nodes.WorldViewportNode\r\n        'bounds': nodes.WorldBoundsNode\r\n\r\n    newPath = selected.getPath()\r\n    return if newPath is @selectedScriptPath\r\n    #@scriptTreema?.destroy() # TODO: get this to work\r\n    @scriptTreema = @$el.find('#script-treema').treema treemaOptions\r\n    @scriptTreema.build()\r\n    @scriptTreema.childrenTreemas?.noteChain?.open(5)\r\n    @selectedScriptPath = newPath\r\n\r\n  getThangIDs: ->\r\n    (t.id for t in @level.get('thangs') ? [])\r\n\r\n  onNewScriptAdded: (scriptNode) =>\r\n    return unless scriptNode\r\n    if scriptNode.data.id is undefined\r\n      scriptNode.disableTracking()\r\n      scriptNode.set '/id', 'Script-' + @scriptsTreema.data.length\r\n      scriptNode.enableTracking()\r\n\r\n  onScriptDeleted: =>\r\n    for key, treema of @scriptsTreema.childrenTreemas\r\n      key = parseInt(key)\r\n      treema.disableTracking()\r\n      if /Script-[0-9]*/.test treema.data.id\r\n        existingKey = parseInt(treema.data.id.substr(7))\r\n        if existingKey isnt key+1\r\n          treema.set 'id', 'Script-' + (key+1)\r\n      treema.enableTracking()\r\n\r\n  onScriptChanged: =>\r\n    return unless @selectedScriptPath\r\n    @scriptsTreema.set(@selectedScriptPath, @scriptTreema.data)\r\n\r\n  onThangsEdited: (e) ->\r\n    # Update in-place so existing Treema nodes refer to the same array.\r\n    @thangIDs?.splice(0, @thangIDs.length, @getThangIDs()...)\r\n\r\n  onWindowResize: (e) =>\r\n    @$el.find('#scripts-treema').collapse('show') if $('body').width() > 800\r\n\r\nclass ScriptsNode extends TreemaArrayNode\r\n  nodeDescription: 'Script'\r\n  addNewChild: ->\r\n    newTreema = super()\r\n    if @callbacks.addChild\r\n      @callbacks.addChild newTreema\r\n    newTreema\r\n\r\nclass ScriptNode extends TreemaObjectNode\r\n  valueClass: 'treema-script'\r\n  collection: false\r\n  buildValueForDisplay: (valEl, data) ->\r\n    val = data.id or data.channel\r\n    s = \"#{val}\"\r\n    @buildValueForDisplaySimply valEl, s\r\n\r\n  onTabPressed: (e) ->\r\n    @tabToCurrentScript()\r\n    e.preventDefault()\r\n\r\n  onDeletePressed: (e) ->\r\n    returnVal = super(e)\r\n    if @callbacks.removeChild\r\n      @callbacks.removeChild()\r\n    returnVal\r\n\r\n  onRightArrowPressed: ->\r\n    @tabToCurrentScript()\r\n\r\n  tabToCurrentScript: ->\r\n    @settings.view.scriptTreema?.keepFocus()\r\n    firstRow = @settings.view.scriptTreema?.$el.find('.treema-node:visible').data('instance')\r\n    return unless firstRow?\r\n    firstRow.select()\r\n\r\nclass PropertiesNode extends TreemaObjectNode\r\n  nodeDescription: 'Script Property'\r\n\r\nclass EventPropsNode extends TreemaNode.nodeMap.string\r\n  valueClass: 'treema-event-props'\r\n\r\n  arrayToString: -> (@getData() or []).join('.')\r\n\r\n  buildValueForDisplay: (valEl, data) ->\r\n    joined = @arrayToString()\r\n    joined = '(unset)' if not joined.length\r\n    @buildValueForDisplaySimply valEl, joined\r\n\r\n  buildValueForEditing: (valEl, data) ->\r\n    super(valEl, data)\r\n    channel = @getRoot().data.channel\r\n    channelSchema = Backbone.Mediator.channelSchemas[channel]\r\n    autocompleteValues = []\r\n    autocompleteValues.push key for key, val of channelSchema?.properties\r\n    valEl.find('input').autocomplete(source: autocompleteValues, minLength: 0, delay: 0, autoFocus: true).autocomplete('search')\r\n    valEl\r\n\r\n  saveChanges: (valEl) ->\r\n    @data = (s for s in $('input', valEl).val().split('.') when s.length)\r\n\r\nclass EventPrereqsNode extends TreemaNode.nodeMap.array\r\n  open: (depth=2) ->\r\n    super(depth)\r\n\r\n  addNewChild: ->\r\n    newTreema = super(arguments)\r\n    return unless newTreema?\r\n    newTreema.open()\r\n    newTreema.childrenTreemas.eventProps?.edit()\r\n\r\nclass EventPrereqNode extends TreemaNode.nodeMap.object\r\n  buildValueForDisplay: (valEl, data) ->\r\n    eventProp = (data.eventProps or []).join('.')\r\n    eventProp = '(unset)' unless eventProp.length\r\n    statements = []\r\n    for key, value of data\r\n      continue if key is 'eventProps'\r\n      comparison = @workingSchema.properties[key].title\r\n      value = value.toString()\r\n      statements.push(\"#{comparison} #{value}\")\r\n    statements = statements.join(', ')\r\n    s = \"#{eventProp} #{statements}\"\r\n    @buildValueForDisplaySimply valEl, s\r\n\r\nclass ChannelNode extends TreemaNode.nodeMap.string\r\n  buildValueForEditing: (valEl, data) ->\r\n    super(valEl, data)\r\n    autocompleteValues = ({label: val?.title or key, value: key} for key, val of Backbone.Mediator.channelSchemas)\r\n    valEl.find('input').autocomplete(source: autocompleteValues, minLength: 0, delay: 0, autoFocus: true)\r\n    valEl\r\n"]}