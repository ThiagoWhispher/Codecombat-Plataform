{"version":3,"sources":["app/views/editor/level/settings/SettingsTabView.coffee"],"names":[],"mappings":"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","file":"public/javascripts/app/views/editor/level/settings/SettingsTabView.js","sourcesContent":["CocoView = require 'views/core/CocoView'\r\ntemplate = require 'templates/editor/level/settings_tab'\r\nLevel = require 'models/Level'\r\nThangType = require 'models/ThangType'\r\nSurface = require 'lib/surface/Surface'\r\nnodes = require './../treema_nodes'\r\n{me} = require 'core/auth'\r\nrequire 'vendor/treema'\r\nconcepts = require 'schemas/concepts'\r\n\r\nmodule.exports = class SettingsTabView extends CocoView\r\n  id: 'editor-level-settings-tab-view'\r\n  className: 'tab-pane'\r\n  template: template\r\n\r\n  # not thangs or scripts or the backend stuff\r\n  editableSettings: [\r\n    'name', 'description', 'documentation', 'nextLevel', 'victory', 'i18n', 'goals',\r\n    'type', 'kind', 'terrain', 'banner', 'loadingTip', 'requiresSubscription', 'adventurer', 'adminOnly',\r\n    'helpVideos', 'replayable', 'scoreTypes', 'concepts', 'primaryConcepts', 'picoCTFProblem', 'practice', 'practiceThresholdMinutes'\r\n    'primerLanguage', 'shareable', 'studentPlayInstructions', 'requiredCode', 'suspectCode',\r\n    'requiredGear', 'restrictedGear', 'requiredProperties', 'restrictedProperties', 'recommendedHealth', 'allowedHeroes'\r\n  ]\r\n\r\n  subscriptions:\r\n    'editor:level-loaded': 'onLevelLoaded'\r\n    'editor:thangs-edited': 'onThangsEdited'\r\n    'editor:random-terrain-generated': 'onRandomTerrainGenerated'\r\n\r\n  constructor: (options) ->\r\n    super options\r\n\r\n  onLoaded: ->\r\n  onLevelLoaded: (e) ->\r\n    @level = e.level\r\n    data = _.pick @level.attributes, (value, key) => key in @editableSettings\r\n    schema = _.cloneDeep Level.schema\r\n    schema.properties = _.pick schema.properties, (value, key) => key in @editableSettings\r\n    schema.required = _.intersection schema.required, @editableSettings\r\n    schema.default = _.pick schema.default, (value, key) => key in @editableSettings\r\n    @thangIDs = @getThangIDs()\r\n    treemaOptions =\r\n      filePath: \"db/level/#{@level.get('original')}\"\r\n      supermodel: @supermodel\r\n      schema: schema\r\n      data: data\r\n      readOnly: me.get('anonymous')\r\n      callbacks: {change: @onSettingsChanged}\r\n      thangIDs: @thangIDs\r\n      nodeClasses:\r\n        object: SettingsNode\r\n        thang: nodes.ThangNode\r\n        'solution-gear': SolutionGearNode\r\n        'solution-stats': SolutionStatsNode\r\n        concept: ConceptNode\r\n        'concepts-list': ConceptsListNode\r\n      solutions: @level.getSolutions()\r\n\r\n    @settingsTreema = @$el.find('#settings-treema').treema treemaOptions\r\n    @settingsTreema.build()\r\n    @settingsTreema.open()\r\n    @lastTerrain = data.terrain\r\n\r\n  getThangIDs: ->\r\n    (t.id for t in @level.get('thangs') ? [])\r\n\r\n  onSettingsChanged: (e) =>\r\n    $('.level-title').text @settingsTreema.data.name\r\n    for key in @editableSettings\r\n      @level.set key, @settingsTreema.data[key]\r\n    if (terrain = @settingsTreema.data.terrain) isnt @lastTerrain\r\n      @lastTerrain = terrain\r\n      Backbone.Mediator.publish 'editor:terrain-changed', terrain: terrain\r\n    for goal, index in @settingsTreema.data.goals ? []\r\n      continue if goal.id\r\n      goalIndex = index\r\n      goalID = \"goal-#{goalIndex}\"\r\n      goalID = \"goal-#{++goalIndex}\" while _.find @settingsTreema.get(\"goals\"), id: goalID\r\n      @settingsTreema.disableTracking()\r\n      @settingsTreema.set \"/goals/#{index}/id\", goalID\r\n      @settingsTreema.set \"/goals/#{index}/name\", _.string.humanize goalID\r\n      @settingsTreema.enableTracking()\r\n\r\n  onThangsEdited: (e) ->\r\n    # Update in-place so existing Treema nodes refer to the same array.\r\n    @thangIDs?.splice(0, @thangIDs.length, @getThangIDs()...)\r\n    @settingsTreema.solutions = @level.getSolutions()  # Remove if slow\r\n\r\n  onRandomTerrainGenerated: (e) ->\r\n    @settingsTreema.set '/terrain', e.terrain\r\n\r\n  destroy: ->\r\n    @settingsTreema?.destroy()\r\n    super()\r\n\r\n\r\nclass SettingsNode extends TreemaObjectNode\r\n  nodeDescription: 'Settings'\r\n\r\nclass SolutionGearNode extends TreemaArrayNode\r\n  select: ->\r\n    super()\r\n    return unless solution = _.find @getRoot().solutions, succeeds: true, language: 'javascript'\r\n    propertiesUsed = []\r\n    for match in (solution.source ? '').match /hero\\.([a-z][A-Za-z0-9]*)/g\r\n      prop = match.split('.')[1]\r\n      propertiesUsed.push prop unless prop in propertiesUsed\r\n    return unless propertiesUsed.length\r\n    if _.isEqual @data, propertiesUsed\r\n      @$el.find('.treema-description').html('Solution uses exactly these required properties.')\r\n      return\r\n    description = 'Solution used properties: ' + [\"<code>#{prop}</code>\" for prop in propertiesUsed].join(' ')\r\n    button = $('<button class=\"btn btn-sm\">Use</button>')\r\n    $(button).on 'click', =>\r\n      @set '', propertiesUsed\r\n      _.defer =>\r\n        @open()\r\n        @select()\r\n    @$el.find('.treema-description').html(description).append(button)\r\n\r\nclass SolutionStatsNode extends TreemaNode.nodeMap.number\r\n  select: ->\r\n    super()\r\n    return unless solution = _.find @getRoot().solutions, succeeds: true, language: 'javascript'\r\n    ThangType.calculateStatsForHeroConfig solution.heroConfig, (stats) =>\r\n      stats[key] = val.toFixed(2) for key, val of stats when parseInt(val) isnt val\r\n      description = \"Solution had stats: <code>#{JSON.stringify(stats)}</code>\"\r\n      button = $('<button class=\"btn btn-sm\">Use health</button>')\r\n      $(button).on 'click', =>\r\n        @set '', stats.health\r\n        _.defer =>\r\n          @open()\r\n          @select()\r\n      @$el.find('.treema-description').html(description).append(button)\r\n\r\nclass ConceptNode extends TreemaNode.nodeMap.string\r\n  buildValueForDisplay: (valEl, data) ->\r\n    super valEl, data\r\n    return unless data\r\n    return console.error \"Couldn't find concept #{@data}\" unless concept = _.find concepts, concept: @data\r\n    description = \"#{concept.name} -- #{concept.description}\"\r\n    description = description + \" (Deprecated)\" if concept.deprecated\r\n    description = \"AUTO | \" + description if concept.automatic\r\n    @$el.find('.treema-row').css('float', 'left')\r\n    @$el.addClass('concept-automatic') if concept.automatic\r\n    @$el.addClass('concept-deprecated') if concept.deprecated\r\n    @$el.find('.treema-description').remove()\r\n    @$el.append($(\"<span class='treema-description'>#{description}</span>\").show())\r\n\r\n  limitChoices: (options) ->\r\n    if @parent.keyForParent is 'concepts'\r\n      options = (o for o in options when _.find(concepts, (c) -> c.concept is o and not c.automatic and not c.deprecated))  # Allow manual, not automatic\r\n    else\r\n      options = (o for o in options when _.find(concepts, (c) -> c.concept is o and not c.deprecated))  # Allow both\r\n    super options\r\n\r\n  onClick: (e) ->\r\n    return if @$el.hasClass('concept-automatic')  # Don't allow editing of automatic concepts\r\n    super e\r\n\r\nclass ConceptsListNode extends TreemaNode.nodeMap.array\r\n  sort: true\r\n\r\n  sortFunction: (a, b) ->\r\n    aAutomatic = _.find concepts, (c) -> c.concept is a and c.automatic\r\n    bAutomatic = _.find concepts, (c) -> c.concept is b and c.automatic\r\n    return 1 if bAutomatic and not aAutomatic  # Auto before manual\r\n    return -1 if aAutomatic and not bAutomatic  # Auto before manual\r\n    return 0 if not aAutomatic and not bAutomatic  # No ordering within manual\r\n    super a, b  # Alpha within auto\r\n"]}