{"version":3,"sources":["app/views/editor/level/modals/WorldSelectModal.coffee"],"names":[],"mappings":";AAAA;EAAA;;;;AAAA,YAAY,QAAQ,sBAAR;;AACZ,WAAW,QAAQ,iDAAR;;AACX,UAAU,QAAQ,qBAAR;;AACV,YAAY,QAAQ,kBAAR;;AAEZ,MAAM,CAAC,OAAP,GAAuB;;;6BACrB,KAAI;;6BACJ,WAAU;;6BACV,oBAAmB;;6BACnB,QAAO;;6BAEP,gBACE;IAAA,yBAAyB,eAAzB;IACA,wBAAwB,eADxB;;;6BAGF,SACE;IAAA,sBAAsB,MAAtB;;;6BAEF,YACE;IAAA,SAAS,MAAT;;;EAEW,0BAAC,OAAD;;;;IACX,IAAC,MAAD,GAAS,OAAO,CAAC;IACjB,IAAC,SAAD,GAAY,OAAO,CAAC,QAAR,IAAoB;IAChC,IAAC,WAAD,GAAW,OAAO,CAAC,SAAD;IAClB,IAAC,gBAAD,GAAmB,OAAO,CAAC;IAC3B,IAAC,cAAD,GAAiB,CAAC,CAAC,QAAF,CAAW,IAAC,cAAZ,EAA2B,GAA3B;IACjB,IAAC,WAAD,GAAc,OAAO,CAAC;IACtB;EAPW;;6BASb,gBAAe,SAAC,CAAD;;MAAC,IAAE;;IAChB,IAAI,oDAAM,CAAN;IACJ,CAAC,CAAC,cAAF,GAAmB,IAAC,SAAD,KAAa;IAChC,CAAC,CAAC,cAAF,GAAmB,IAAC,SAAD,KAAa;WAChC;EAJa;;6BAMf,cAAa;IACX;WACA,IAAC,YAAD;EAFW;;6BAMb,cAAa;AACX;IAAA,cAAc,IAAC,IAAG,CAAC,IAAL,CAAU,eAAV;IACd,eAAe,IAAC,IAAG,CAAC,IAAL,CAAU,gBAAV;IACf,WAAW,WAAW,CAAC,GAAZ,CAAgB,YAAhB;IACX,QAAQ,CAAC,IAAT,CAAc,OAAd,EAAuB,WAAW,CAAC,GAAG,CAAC,KAAhB,KAAwB,EAAxB,GAA2B,EAAlD;IACA,QAAQ,CAAC,IAAT,CAAc,QAAd,EAAwB,WAAW,CAAC,GAAG,CAAC,MAAhB,KAAyB,EAAjD;IACA,IAAC,QAAD,GAAe,YAAQ,IAAC,MAAT,EAAgB,YAAhB,EAA8B,WAA9B,EAA2C;MACxD,OAAO,KADiD;MAExD,MAAM,IAFkD;MAGxD,qBAAqB,KAHmC;MAIxD,UAAU,IAAC,SAJ6C;MAKxD,QAAQ,IALgD;MAMxD,YAAY,IAAC,WAAU,CAAC,SAAZ,CAAsB,SAAtB,CAN4C;MAOxD,eAAe,IAPyC;KAA3C;IASf,IAAC,QAAO,CAAC,OAAT,GAAmB;IACnB,IAAC,QAAO,CAAC,QAAT,CAAkB,IAAC,MAAnB;IACA,IAAC,QAAO,CAAC,MAAM,CAAC,MAAhB,CAAuB;MAAC,GAAG,GAAJ;MAAS,GAAG,CAAC,GAAb;KAAvB,EAA0C,IAA1C,EAAgD,CAAhD;WACA,IAAC,aAAD;EAlBW;;6BAoBb,eAAc;AAEZ;IAAA,IAAG,IAAC,SAAD,KAAa,OAAhB;MACE,IAAG,6BAAc,CAAC,CAAC,QAAF,CAAW,IAAC,WAAO,CAAC,CAApB,CAAd,IAAyC,CAAC,CAAC,QAAF,CAAW,IAAC,WAAO,CAAC,CAApB,CAA5C;QACE,IAAC,QAAO,CAAC,OAAO,CAAC,QAAjB,CAA0B,IAAC,WAA3B;eACA,IAAC,QAAO,CAAC,MAAM,CAAC,MAAhB,CAAuB,IAAC,QAAO,CAAC,MAAM,CAAC,cAAhB,CAA+B,IAAC,WAAhC,CAAvB,EAAiE,CAAjE,EAFF;OADF;KAAA,MAKK,IAAG,4BAAH;MACH,IAAC,eAAD;MACA,gBAAgB,IAAC,QAAO,CAAC,MAAM,CAAC,cAAhB,CAA+B,IAAC,gBAAe,CAAC,MAAhD;aAChB,IAAC,QAAO,CAAC,MAAM,CAAC,MAAhB,CAAuB,aAAvB,EAAsC,IAAC,gBAAe,CAAC,IAAjB,GAAsB,GAA5D,EAHG;KAAA,MAKA,IAAG,6BAAc,CAAC,CAAC,QAAF,CAAW,IAAC,WAAQ,GAAE,CAAC,CAAvB,CAAd,IAA4C,CAAC,CAAC,QAAF,CAAW,IAAC,WAAQ,GAAE,CAAC,CAAvB,CAA5C,IAA0E,CAAC,CAAC,QAAF,CAAW,IAAC,WAAQ,GAAE,CAAC,CAAvB,CAA1E,IAAwG,CAAC,CAAC,QAAF,CAAW,IAAC,WAAQ,GAAE,CAAC,CAAvB,CAA3G;MACH,IAAC,QAAO,CAAC,OAAO,CAAC,SAAjB,CAA2B,IAAC,WAA5B;aACA,IAAC,mBAAD,GAFG;;EAZO;;6BAgBd,iBAAgB;AACd;IAAA,IAAI,IAAC;IACL,cAAc;IACd,eAAe;IACf,aAAa;MAAC,GAAG,cAAY,CAAC,CAAC,IAAlB;MAAwB,GAAG,eAAa,CAAC,CAAC,IAA1C;;IACb,aAAa,IAAC,QAAO,CAAC,MAAM,CAAC,cAAhB,CAA+B,UAA/B;IACb,QAAQ,UAAU,CAAC;IACnB,SAAS,UAAU,CAAC;IACpB,SAAS,CAAC,CAAC;IACX,SAAS;MACP;QAAC,GAAG,MAAM,CAAC,CAAP,GAAW,QAAM,CAArB;QAAwB,GAAG,MAAM,CAAC,CAAP,GAAW,SAAO,CAA7C;OADO,EAEP;QAAC,GAAG,MAAM,CAAC,CAAP,GAAW,QAAM,CAArB;QAAwB,GAAG,MAAM,CAAC,CAAP,GAAW,SAAO,CAA7C;OAFO;;WAIT,IAAC,QAAO,CAAC,OAAO,CAAC,SAAjB,CAA2B,MAA3B;EAbc;;6BAehB,qBAAoB;AAClB;IAAA,SAAS,IAAC,QAAO,CAAC,MAAM,CAAC,eAAhB,CAAgC,IAAC,WAAjC;IACT,QAAQ;MACN,GAAG,MAAM,CAAC,CAAP,GAAW,MAAM,CAAC,KAAP,GAAe,CADvB;MAEN,GAAG,MAAM,CAAC,CAAP,GAAW,MAAM,CAAC,MAAP,GAAgB,CAFxB;;IAIR,OAAO,MAAM,CAAC,IAAC,QAAO,CAAC,MAAM,CAAC,WAAhB,GAA8B,MAAM,CAAC,KAAtC;WACb,IAAC,QAAO,CAAC,MAAM,CAAC,MAAhB,CAAuB,KAAvB,EAA8B,IAA9B;EAPkB;;6BAWpB,gBAAe,SAAC,CAAD;IACb,CAAC,CAAC,MAAF,GAAW,IAAC,QAAO,CAAC;WACpB,IAAC,cAAD,GAAiB;EAFJ;;6BAIf,OAAM;;MACJ,IAAC,UAAU,IAAC;;WACZ,IAAC,KAAD;EAFI;;6BAIN,WAAU;AACR;6CAAQ,CAAE,OAAV;EADQ;;;;GA3GoC","file":"public/javascripts/app/views/editor/level/modals/WorldSelectModal.js","sourcesContent":["ModalView = require 'views/core/ModalView'\r\ntemplate = require 'templates/editor/level/modal/world-select-modal'\r\nSurface = require 'lib/surface/Surface'\r\nThangType = require 'models/ThangType'\r\n\r\nmodule.exports = class WorldSelectModal extends ModalView\r\n  id: 'world-select-modal'\r\n  template: template\r\n  modalWidthPercent: 80\r\n  cache: false\r\n\r\n  subscriptions:\r\n    'surface:choose-region': 'selectionMade'\r\n    'surface:choose-point': 'selectionMade'\r\n\r\n  events:\r\n    'click #done-button': 'done'\r\n\r\n  shortcuts:\r\n    'enter': 'done'\r\n\r\n  constructor: (options) ->\r\n    @world = options.world\r\n    @dataType = options.dataType or 'point'\r\n    @default = options.default\r\n    @defaultFromZoom = options.defaultFromZoom\r\n    @selectionMade = _.debounce(@selectionMade, 300)\r\n    @supermodel = options.supermodel\r\n    super()\r\n\r\n  getRenderData: (c={}) =>\r\n    c = super(c)\r\n    c.selectingPoint = @dataType is 'point'\r\n    c.flexibleRegion = @dataType is 'region'\r\n    c\r\n\r\n  afterInsert: ->\r\n    super()\r\n    @initSurface()\r\n\r\n  # surface setup\r\n\r\n  initSurface: ->\r\n    webGLCanvas = @$el.find('.webgl-canvas')\r\n    normalCanvas = @$el.find('.normal-canvas')\r\n    canvases = webGLCanvas.add(normalCanvas)\r\n    canvases.attr('width', currentView.$el.width()*.8-70)\r\n    canvases.attr('height', currentView.$el.height()*.6)\r\n    @surface = new Surface @world, normalCanvas, webGLCanvas, {\r\n      paths: false\r\n      grid: true\r\n      navigateToSelection: false\r\n      choosing: @dataType\r\n      coords: true\r\n      thangTypes: @supermodel.getModels(ThangType)\r\n      showInvisible: true\r\n    }\r\n    @surface.playing = false\r\n    @surface.setWorld @world\r\n    @surface.camera.zoomTo({x: 262, y: -164}, 1.66, 0)\r\n    @showDefaults()\r\n\r\n  showDefaults: ->\r\n    # show current point, and zoom to it\r\n    if @dataType is 'point'\r\n      if @default? and _.isFinite(@default.x) and _.isFinite(@default.y)\r\n        @surface.chooser.setPoint(@default)\r\n        @surface.camera.zoomTo(@surface.camera.worldToSurface(@default), 2)\r\n\r\n    else if @defaultFromZoom?\r\n      @showZoomRegion()\r\n      surfaceTarget = @surface.camera.worldToSurface(@defaultFromZoom.target)\r\n      @surface.camera.zoomTo(surfaceTarget, @defaultFromZoom.zoom*0.6)\r\n\r\n    else if @default? and _.isFinite(@default[0].x) and _.isFinite(@default[0].y) and _.isFinite(@default[1].x) and _.isFinite(@default[1].y)\r\n      @surface.chooser.setRegion(@default)\r\n      @showBoundaryRegion()\r\n\r\n  showZoomRegion: ->\r\n    d = @defaultFromZoom\r\n    canvasWidth = 924  # Dimensions for canvas player. Need these somewhere.\r\n    canvasHeight = 589\r\n    dimensions = {x: canvasWidth/d.zoom, y: canvasHeight/d.zoom}\r\n    dimensions = @surface.camera.surfaceToWorld(dimensions)\r\n    width = dimensions.x\r\n    height = dimensions.y\r\n    target = d.target\r\n    region = [\r\n      {x: target.x - width/2, y: target.y - height/2}\r\n      {x: target.x + width/2, y: target.y + height/2}\r\n    ]\r\n    @surface.chooser.setRegion(region)\r\n\r\n  showBoundaryRegion: ->\r\n    bounds = @surface.camera.normalizeBounds(@default)\r\n    point = {\r\n      x: bounds.x + bounds.width / 2\r\n      y: bounds.y + bounds.height / 2\r\n    }\r\n    zoom = 0.8 * (@surface.camera.canvasWidth / bounds.width)\r\n    @surface.camera.zoomTo(point, zoom)\r\n\r\n  # event handlers\r\n\r\n  selectionMade: (e) =>\r\n    e.camera = @surface.camera\r\n    @lastSelection = e\r\n\r\n  done: =>\r\n    @callback?(@lastSelection)\r\n    @hide()\r\n\r\n  onHidden: ->\r\n    @surface?.destroy()\r\n"]}