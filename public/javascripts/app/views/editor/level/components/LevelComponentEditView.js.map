{"version":3,"sources":["app/views/editor/level/components/LevelComponentEditView.coffee"],"names":[],"mappings":";AAAA;EAAA;;;;;AAAA,WAAW,QAAQ,qBAAR;;AACX,WAAW,QAAQ,4DAAR;;AACX,iBAAiB,QAAQ,uBAAR;;AACjB,yBAAyB,QAAQ,+CAAR;;AACzB,cAAc,QAAQ,0BAAR;;AACd,mBAAmB,QAAQ,qCAAR;;AACnB,MAAM,QAAQ,KAAR;;AAEN,QAAQ,eAAR;;AAEA,MAAM,CAAC,OAAP,GAAuB;;;mCACrB,KAAI;;mCACJ,WAAU;;mCACV,mBAAkB,CAAC,MAAD,EAAS,aAAT,EAAwB,QAAxB,EAAkC,cAAlC,EAAkD,cAAlD,EAAkE,uBAAlE,EAA2F,MAA3F;;mCAElB,SACE;IAAA,wCAAwC,YAAxC;IACA,gBAAgB,SAAC,CAAD;aAAO,EAAE,CAAC,CAAC,MAAJ,CAAW,CAAC,GAAZ,CAAgB,MAAhB;IAAP,CADhB;IAEA,gCAAgC;aAAG,IAAC,YAAW,CAAC,IAAb;IAAH,CAFhC;IAGA,6BAA6B,iBAH7B;IAIA,sCAAsC,yBAJtC;IAKA,iCAAiC,qBALjC;IAMA,mCAAmC,oBANnC;IAOA,iCAAiC,wBAPjC;IAQA,iCAAiC,sBARjC;IASA,oCAAoC,gBATpC;;;EAWW,gCAAC,OAAD;;;;IACX,wDAAM,OAAN;IACA,IAAC,eAAD,GAAkB,IAAC,WAAU,CAAC,iCAAZ,CAA8C,cAA9C,EAA8D,OAAO,CAAC,QAAtE,EAAgF,OAAO,CAAC,YAAR,IAAwB,CAAxG;IAClB,KAA2F,IAAC,eAA5F;MAAA,OAAO,CAAC,GAAR,CAAY,kCAAZ,EAAgD,OAAhD,EAAyD,MAAzD,EAAiE,IAAC,WAAU,CAAC,MAA7E;;IACA,IAAC,eAAD,GAAkB,CAAC,CAAC,QAAF,CAAW,IAAC,eAAZ,EAA4B,IAA5B;EAJP;;mCAMb,gBAAe,SAAC,OAAD;;MAAC,UAAQ;;IACtB,UAAU,0DAAM,OAAN;IACV,OAAO,CAAC,SAAR,GAAsB,CAAC,IAAC,eAAc,CAAC,GAAhB,CAAoB,QAApB,CAAD,IAA+B,GAA/B,GAAiC,CAAC,IAAC,eAAc,CAAC,GAAhB,CAAoB,MAApB,CAAD;IACvD,OAAO,CAAC,SAAR,GAAoB,IAAC;WACrB;EAJa;;mCAMf,WAAU;WAAG,IAAC,OAAD;EAAH;;mCAEV,cAAa;IACX;IACA,IAAC,oBAAD;IACA,IAAC,wBAAD;IACA,IAAC,gBAAD;IACA,IAAC,YAAD,GAAe,IAAC,cAAD,CAAmB,gBAAY,IAAC,eAAb,CAAnB,EAAiD,IAAC,IAAG,CAAC,IAAL,CAAU,eAAV,CAAjD;IACf,IAA6E,IAAC,eAAc,CAAC,QAAhB,EAA7E;MAAA,IAAC,IAAG,CAAC,IAAL,CAAU,yBAAV,CAAoC,CAAC,IAArC,CAA0C,QAA1C,CAAmD,CAAC,WAApD,CAAgE,QAAhE;;WACA,IAAC,kBAAD;EAPW;;mCASb,sBAAqB;AACnB;IAAA,OAAO,CAAC,CAAC,IAAF,CAAO,IAAC,eAAc,CAAC,UAAvB,EAAmC;aAAA,SAAC,KAAD,EAAQ,GAAR;eAAgB,aAAO,KAAC,iBAAR;MAAhB;IAAA,QAAnC;IACP,OAAO,CAAC,CAAC,MAAF,CAAS,IAAT,EAAe,EAAf,EAAmB,IAAnB;IACP,SAAS,CAAC,CAAC,SAAF,CAAY,cAAc,CAAC,MAA3B;IACT,MAAM,CAAC,UAAP,GAAoB,CAAC,CAAC,IAAF,CAAO,MAAM,CAAC,UAAd,EAA0B;aAAA,SAAC,KAAD,EAAQ,GAAR;eAAgB,aAAO,KAAC,iBAAR;MAAhB;IAAA,QAA1B;IACpB,MAAM,CAAC,QAAP,GAAkB,CAAC,CAAC,YAAF,CAAe,MAAM,CAAC,QAAtB,EAAgC,IAAC,iBAAjC;IAClB,MAAM,CAAC,SAAD,CAAN,GAAiB,CAAC,CAAC,IAAF,CAAO,MAAM,CAAC,SAAD,CAAb,EAAuB;aAAA,SAAC,KAAD,EAAQ,GAAR;eAAgB,aAAO,KAAC,iBAAR;MAAhB;IAAA,QAAvB;IAEjB,gBACE;MAAA,YAAY,IAAC,WAAb;MACA,QAAQ,MADR;MAEA,MAAM,IAFN;MAGA,UAAU,EAAE,CAAC,GAAH,CAAO,WAAP,CAHV;MAIA,WAAW;QAAC,QAAQ,IAAC,0BAAV;OAJX;;IAKF,IAAC,wBAAD,GAA2B,IAAC,IAAG,CAAC,IAAL,CAAU,wBAAV,CAAmC,CAAC,MAApC,CAA2C,aAA3C;IAC3B,IAAC,wBAAuB,CAAC,KAAzB;WACA,IAAC,wBAAuB,CAAC,IAAzB;EAhBmB;;mCAkBrB,4BAA2B;AAEzB;AAAA;AAAA;;MACE,IAAsC,QAAO,IAA7C;QAAA,IAAC,eAAc,CAAC,GAAhB,CAAoB,GAApB,EAAyB,KAAzB;;AADF;WAEA,IAAC,kBAAD;EAJyB;;mCAM3B,0BAAyB;AACvB;IAAA,eAAe,CAAC,CAAC,MAAF,CAAS,IAAT,EAAe,EAAf,EAAmB,IAAC,eAAc,CAAC,GAAhB,CAAoB,cAApB,CAAnB;IACf,IAAG,YAAY,CAAC,UAAhB;MAEE,gBAAgB,CAAC,CAAC,IAAF,CAAO,YAAY,CAAC,UAApB;MAChB,aAAa,CAAC,IAAd;MACA,oBAAoB;AACpB;;QACE,iBAAkB,MAAlB,GAA0B,YAAY,CAAC,UAAW;AADpD;MAEA,YAAY,CAAC,UAAb,GAA0B,kBAP5B;;IAQA,gBACE;MAAA,YAAY,IAAC,WAAb;MACA,QAAQ,cAAc,CAAC,MAAM,CAAC,UAAU,CAAC,YADzC;MAEA,MAAM,YAFN;MAGA,UAAU,EAAE,CAAC,GAAH,CAAO,WAAP,CAHV;MAIA,WAAW;QAAC,QAAQ,IAAC,qBAAV;OAJX;;IAKF,IAAC,mBAAD,GAAsB,IAAC,IAAG,CAAC,IAAL,CAAU,uBAAV,CAAkC,CAAC,MAAnC,CAA0C,aAA1C;IACtB,IAAC,mBAAkB,CAAC,KAApB;IACA,IAAC,mBAAkB,CAAC,IAApB;WAEA,IAAC,mBAAkB,CAAC,GAAG,CAAC,SAAxB,CAAkC,YAAlC,EAAgD,cAAc,CAAC,MAAM,CAAC,UAAU,CAAC,YAAjF;EApBuB;;mCAsBzB,uBAAsB;IACpB,IAAC,eAAc,CAAC,GAAhB,CAAoB,cAApB,EAAoC,IAAC,mBAAkB,CAAC,IAAxD;WACA,IAAC,kBAAD;EAFoB;;mCAItB,kBAAiB;AACf;IAAA,IAAC,iBAAD,CAAkB,IAAC,OAAnB;IACA,WAAW,EAAE,aAAF,CAAgB,CAAC,IAAjB,CAAsB,IAAC,eAAc,CAAC,GAAhB,CAAoB,MAApB,CAAtB,CAAkD,CAAC,QAAnD,CAA4D,cAA5D;IACX,IAAC,IAAG,CAAC,IAAL,CAAU,wBAAV,CAAmC,CAAC,KAApC,EAA2C,CAAC,MAA5C,CAAmD,QAAnD;IACA,IAAC,OAAD,GAAU,GAAG,CAAC,IAAJ,CAAS,QAAS,GAAlB;IACV,IAAC,OAAM,CAAC,WAAR,CAAoB,EAAE,CAAC,GAAH,CAAO,WAAP,CAApB;IACA,UAAU,IAAC,OAAM,CAAC,UAAR;IACV,OAAO,CAAC,OAAR,CAAgB,iBAAhB;IACA,OAAO,CAAC,UAAR,CAAmB,CAAnB;IACA,OAAO,CAAC,cAAR,GAAyB;IACzB,OAAO,CAAC,cAAR,CAAuB,IAAvB;WACA,IAAC,OAAM,CAAC,EAAR,CAAW,QAAX,EAAqB,IAAC,eAAtB;EAXe;;mCAajB,iBAAgB;IACd,IAAU,IAAC,UAAX;AAAA;;IACA,IAAC,eAAc,CAAC,GAAhB,CAAoB,MAApB,EAA4B,IAAC,OAAM,CAAC,QAAR,EAA5B;WACA,IAAC,kBAAD;EAHc;;mCAKhB,oBAAmB;WACjB,IAAC,IAAG,CAAC,IAAL,CAAU,yBAAV,CAAoC,CAAC,MAArC,CAA4C,QAAQ,IAAC,eAAc,CAAC,eAAhB,EAAR,CAA5C;EADiB;;mCAGnB,aAAY,SAAC,CAAD;IACV,QAAQ,CAAC,QAAQ,CAAC,OAAlB,CAA0B,sCAA1B,EAAkE;MAAA,WAAW,IAAC,eAAZ;KAAlE;WACA;EAFU;;mCAIZ,qBAAoB,SAAC,CAAD;AAClB;IAAA,yBAA6B,2BAAuB,EAAvB,EAA2B,IAAC,eAAc,CAAC,EAA3C;IAC7B,IAAC,cAAD,CAAe,sBAAf;WACA,QAAQ,CAAC,QAAQ,CAAC,OAAlB,CAA0B,sBAA1B,EAAkD,EAAlD;EAHkB;;mCAKpB,yBAAwB,SAAC,CAAD;IACtB,IAAC,cAAD,CAAmB,qBAAiB;MAAC,OAAO,IAAC,eAAT;KAAjB,CAAnB;WACA,QAAQ,CAAC,QAAQ,CAAC,OAAlB,CAA0B,sBAA1B,EAAkD,EAAlD;EAFsB;;mCAIxB,uBAAsB;AACpB;IAAA,SAAS,IAAC,IAAG,CAAC,IAAL,CAAU,yBAAV;IACT,IAAC,eAAc,CAAC,KAAhB,CAAsB,MAAM,CAAC,IAAP,CAAY,QAAZ,CAAqB,CAAC,EAAtB,CAAyB,UAAzB,CAAtB;WACA,MAAM,CAAC,IAAP,CAAY,QAAZ,CAAqB,CAAC,WAAtB,CAAkC,QAAlC;EAHoB;;mCAKtB,iBAAgB;IACd,IAAC,eAAc,CAAC,YAAhB;WACA,IAAC,OAAD;EAFc;;mCAIhB,UAAS;AACP;IAAA,IAAC,iBAAD,CAAkB,IAAC,OAAnB;;SACwB,CAAE,OAA1B;;;UACmB,CAAE,OAArB;;WACA;EAJO;;;;GArI2C","file":"public/javascripts/app/views/editor/level/components/LevelComponentEditView.js","sourcesContent":["CocoView = require 'views/core/CocoView'\r\ntemplate = require 'templates/editor/level/component/level-component-edit-view'\r\nLevelComponent = require 'models/LevelComponent'\r\nComponentVersionsModal = require 'views/editor/component/ComponentVersionsModal'\r\nPatchesView = require 'views/editor/PatchesView'\r\nSaveVersionModal = require 'views/editor/modal/SaveVersionModal'\r\nace = require 'ace'\r\n\r\nrequire 'vendor/treema'\r\n\r\nmodule.exports = class LevelComponentEditView extends CocoView\r\n  id: 'level-component-edit-view'\r\n  template: template\r\n  editableSettings: ['name', 'description', 'system', 'codeLanguage', 'dependencies', 'propertyDocumentation', 'i18n']\r\n\r\n  events:\r\n    'click #done-editing-component-button': 'endEditing'\r\n    'click .nav a': (e) -> $(e.target).tab('show')\r\n    'click #component-patches-tab': -> @patchesView.load()\r\n    'click #component-code-tab': 'buildCodeEditor'\r\n    'click #component-config-schema-tab': 'buildConfigSchemaTreema'\r\n    'click #component-settings-tab': 'buildSettingsTreema'\r\n    'click #component-history-button': 'showVersionHistory'\r\n    'click #patch-component-button': 'startPatchingComponent'\r\n    'click #component-watch-button': 'toggleWatchComponent'\r\n    'click #pop-component-i18n-button': 'onPopulateI18N' \r\n\r\n  constructor: (options) ->\r\n    super options\r\n    @levelComponent = @supermodel.getModelByOriginalAndMajorVersion LevelComponent, options.original, options.majorVersion or 0\r\n    console.log 'Couldn\\'t get levelComponent for', options, 'from', @supermodel.models unless @levelComponent\r\n    @onEditorChange = _.debounce @onEditorChange, 1000\r\n\r\n  getRenderData: (context={}) ->\r\n    context = super(context)\r\n    context.editTitle = \"#{@levelComponent.get('system')}.#{@levelComponent.get('name')}\"\r\n    context.component = @levelComponent\r\n    context\r\n\r\n  onLoaded: -> @render()\r\n\r\n  afterRender: ->\r\n    super()\r\n    @buildSettingsTreema()\r\n    @buildConfigSchemaTreema()\r\n    @buildCodeEditor()\r\n    @patchesView = @insertSubView(new PatchesView(@levelComponent), @$el.find('.patches-view'))\r\n    @$el.find('#component-watch-button').find('> span').toggleClass('secret') if @levelComponent.watching()\r\n    @updatePatchButton()\r\n\r\n  buildSettingsTreema: ->\r\n    data = _.pick @levelComponent.attributes, (value, key) => key in @editableSettings\r\n    data = $.extend(true, {}, data)\r\n    schema = _.cloneDeep LevelComponent.schema\r\n    schema.properties = _.pick schema.properties, (value, key) => key in @editableSettings\r\n    schema.required = _.intersection schema.required, @editableSettings\r\n    schema.default = _.pick schema.default, (value, key) => key in @editableSettings\r\n\r\n    treemaOptions =\r\n      supermodel: @supermodel\r\n      schema: schema\r\n      data: data\r\n      readonly: me.get('anonymous')\r\n      callbacks: {change: @onComponentSettingsEdited}\r\n    @componentSettingsTreema = @$el.find('#edit-component-treema').treema treemaOptions\r\n    @componentSettingsTreema.build()\r\n    @componentSettingsTreema.open()\r\n\r\n  onComponentSettingsEdited: =>\r\n    # Make sure it validates first?\r\n    for key, value of @componentSettingsTreema.data\r\n      @levelComponent.set key, value unless key is 'js' # will compile code if needed\r\n    @updatePatchButton()\r\n\r\n  buildConfigSchemaTreema: ->\r\n    configSchema = $.extend true, {}, @levelComponent.get 'configSchema'\r\n    if configSchema.properties\r\n      # Alphabetize (#1297)\r\n      propertyNames = _.keys configSchema.properties\r\n      propertyNames.sort()\r\n      orderedProperties = {}\r\n      for prop in propertyNames\r\n        orderedProperties[prop] = configSchema.properties[prop]\r\n      configSchema.properties = orderedProperties\r\n    treemaOptions =\r\n      supermodel: @supermodel\r\n      schema: LevelComponent.schema.properties.configSchema\r\n      data: configSchema\r\n      readOnly: me.get('anonymous')\r\n      callbacks: {change: @onConfigSchemaEdited}\r\n    @configSchemaTreema = @$el.find('#config-schema-treema').treema treemaOptions\r\n    @configSchemaTreema.build()\r\n    @configSchemaTreema.open()\r\n    # TODO: schema is not loaded for the first one here?\r\n    @configSchemaTreema.tv4.addSchema('metaschema', LevelComponent.schema.properties.configSchema)\r\n\r\n  onConfigSchemaEdited: =>\r\n    @levelComponent.set 'configSchema', @configSchemaTreema.data\r\n    @updatePatchButton()\r\n\r\n  buildCodeEditor: ->\r\n    @destroyAceEditor(@editor)\r\n    editorEl = $('<div></div>').text(@levelComponent.get('code')).addClass('inner-editor')\r\n    @$el.find('#component-code-editor').empty().append(editorEl)\r\n    @editor = ace.edit(editorEl[0])\r\n    @editor.setReadOnly(me.get('anonymous'))\r\n    session = @editor.getSession()\r\n    session.setMode 'ace/mode/coffee'\r\n    session.setTabSize 2\r\n    session.setNewLineMode = 'unix'\r\n    session.setUseSoftTabs true\r\n    @editor.on('change', @onEditorChange)\r\n\r\n  onEditorChange: =>\r\n    return if @destroyed\r\n    @levelComponent.set 'code', @editor.getValue()\r\n    @updatePatchButton()\r\n\r\n  updatePatchButton: ->\r\n    @$el.find('#patch-component-button').toggle Boolean @levelComponent.hasLocalChanges()\r\n\r\n  endEditing: (e) ->\r\n    Backbone.Mediator.publish 'editor:level-component-editing-ended', component: @levelComponent\r\n    null\r\n\r\n  showVersionHistory: (e) ->\r\n    componentVersionsModal = new ComponentVersionsModal {}, @levelComponent.id\r\n    @openModalView componentVersionsModal\r\n    Backbone.Mediator.publish 'editor:view-switched', {}\r\n\r\n  startPatchingComponent: (e) ->\r\n    @openModalView new SaveVersionModal({model: @levelComponent})\r\n    Backbone.Mediator.publish 'editor:view-switched', {}\r\n\r\n  toggleWatchComponent: ->\r\n    button = @$el.find('#component-watch-button')\r\n    @levelComponent.watch(button.find('.watch').is(':visible'))\r\n    button.find('> span').toggleClass('secret')\r\n\r\n  onPopulateI18N: ->\r\n    @levelComponent.populateI18N()\r\n    @render()\r\n\r\n  destroy: ->\r\n    @destroyAceEditor(@editor)\r\n    @componentSettingsTreema?.destroy()\r\n    @configSchemaTreema?.destroy()\r\n    super()\r\n"]}