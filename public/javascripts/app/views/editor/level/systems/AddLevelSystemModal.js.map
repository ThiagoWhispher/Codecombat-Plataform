{"version":3,"sources":["app/views/editor/level/systems/AddLevelSystemModal.coffee"],"names":[],"mappings":";AAAA;EAAA;;;AAAA,YAAY,QAAQ,sBAAR;;AACZ,WAAW,QAAQ,mCAAR;;AACX,0BAA0B,QAAQ,gDAAR;;AAC1B,cAAc,QAAQ,oBAAR;;AACd,iBAAiB,QAAQ,4BAAR;;AAEX;;;;;;;wCACJ,MAAK;;wCACL,QAAO;;;;GAFiC;;AAI1C,MAAM,CAAC,OAAP,GAAuB;;;gCACrB,KAAI;;gCACJ,WAAU;;gCACV,UAAS;;gCAET,SACE;IAAA,oCAAoC,aAApC;;;EAEW,6BAAC,OAAD;AACX;IAAA,qDAAM,OAAN;IACA,IAAC,cAAD,iDAAyC;IACzC,IAAC,QAAD,GAAW,IAAC,WAAU,CAAC,cAAZ,CAA+B,iCAA/B,EAA8D,SAA9D,CAAwE,CAAC;EAHzE;;gCAKb,cAAa;IACX;IACA,KAAc,IAAC,WAAU,CAAC,QAAZ,EAAd;AAAA;;WACA,IAAC,uBAAD;EAHW;;gCAKb,yBAAwB;AACtB;IAAA,KAAK,IAAC,IAAG,CAAC,IAAL,CAAU,2BAAV,CAAsC,CAAC,KAAvC;IACL;;AAAW;AAAA;WAAA;;qBAAA,CAAC,CAAC;AAAF;;;IACX,CAAC,CAAC,MAAF,CAAS,OAAT,EAAkB;aAAA,SAAC,MAAD;eAChB,CAAC,CAAC,IAAF,CAAO,KAAC,cAAR,EAAuB;UAAC,UAAU,MAAM,CAAC,QAAlB;SAAvB;MADgB;IAAA,QAAlB;IAEA,UAAU,CAAC,CAAC,MAAF,CAAS,OAAT,EAAkB,MAAlB;AACV;SAAA;;mBACE,EAAE,CAAC,MAAH,CAAU,EAAE,wBAAwB;QAAA,QAAQ,MAAR;OAAxB,CAAF,CAAV;AADF;;EANsB;;gCASxB,cAAa,SAAC,CAAD;AACX;IAAA,KAAK,EAAE,CAAC,CAAC,aAAJ,CAAkB,CAAC,IAAnB,CAAwB,WAAxB;IACL,SAAS,CAAC,CAAC,IAAF,CAAO,IAAC,QAAO,CAAC,MAAhB,EAAwB;MAAA,IAAI,EAAJ;KAAxB;IACT,KAAO,MAAP;AACE,aAAO,OAAO,CAAC,KAAR,CAAc,8BAAd,EAA8C,EAA9C,EAAkD,QAAlD,EAA4D,IAAC,QAAO,CAAC,MAArE,EADT;;IAGA,QAAQ,MAAM,CAAC,eAAP,CAAuB,IAAC,QAAO,CAAC,MAAhC;IACR,CAAC,CAAC,MAAF,CAAS,KAAT,EAAgB;aAAA,SAAC,EAAD;eACd,CAAC,CAAC,IAAF,CAAO,KAAC,cAAR,EAAuB;UAAA,UAAU,EAAE,CAAC,GAAH,CAAO,UAAP,CAAV;SAAvB;MADc;IAAA,QAAhB;AAEA;AAAA;;MACE,cACE;QAAA,sDAA8B,EAA9B;QACA,+DAAuC,CADvC;;MAEF,IAAC,cAAa,CAAC,IAAf,CAAoB,WAApB;MACA,QAAQ,CAAC,QAAQ,CAAC,OAAlB,CAA0B,2BAA1B,EAAuD;QAAA,QAAQ,WAAR;OAAvD;AALF;WAMA,IAAC,uBAAD;EAfW;;;;GA3BoC","file":"public/javascripts/app/views/editor/level/systems/AddLevelSystemModal.js","sourcesContent":["ModalView = require 'views/core/ModalView'\r\ntemplate = require 'templates/editor/level/system/add'\r\navailableSystemTemplate = require 'templates/editor/level/system/available_system'\r\nLevelSystem = require 'models/LevelSystem'\r\nCocoCollection = require 'collections/CocoCollection'\r\n\r\nclass LevelSystemSearchCollection extends CocoCollection\r\n  url: '/db/level.system'\r\n  model: LevelSystem\r\n\r\nmodule.exports = class AddLevelSystemModal extends ModalView\r\n  id: 'editor-level-system-add-modal'\r\n  template: template\r\n  instant: true\r\n\r\n  events:\r\n    'click .available-systems-list li': 'onAddSystem'\r\n\r\n  constructor: (options) ->\r\n    super options\r\n    @extantSystems = options.extantSystems ? []\r\n    @systems = @supermodel.loadCollection(new LevelSystemSearchCollection(), 'systems').model\r\n\r\n  afterRender: ->\r\n    super()\r\n    return unless @supermodel.finished()\r\n    @renderAvailableSystems()\r\n\r\n  renderAvailableSystems: ->\r\n    ul = @$el.find('ul.available-systems-list').empty()\r\n    systems = (m.attributes for m in @systems.models)\r\n    _.remove systems, (system) =>\r\n      _.find @extantSystems, {original: system.original}  # already have this one added\r\n    systems = _.sortBy systems, 'name'\r\n    for system in systems\r\n      ul.append $(availableSystemTemplate(system: system))\r\n\r\n  onAddSystem: (e) ->\r\n    id = $(e.currentTarget).data('system-id')\r\n    system = _.find @systems.models, id: id\r\n    unless system\r\n      return console.error 'Couldn\\'t find system for id', id, 'out of', @systems.models\r\n    # Add all dependencies, recursively, unless we already have them\r\n    toAdd = system.getDependencies(@systems.models)\r\n    _.remove toAdd, (s1) =>\r\n      _.find @extantSystems, original: s1.get('original')\r\n    for s in toAdd.concat [system]\r\n      levelSystem =\r\n        original: s.get('original') ? id\r\n        majorVersion: s.get('version').major ? 0\r\n      @extantSystems.push levelSystem\r\n      Backbone.Mediator.publish 'editor:level-system-added', system: levelSystem\r\n    @renderAvailableSystems()\r\n"]}