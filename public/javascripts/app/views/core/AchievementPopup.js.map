{"version":3,"sources":["app/templates/core/achievement-popup.jade","app/views/core/AchievementPopup.coffee"],"names":[],"mappings":"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","file":"public/javascripts/app/views/core/AchievementPopup.js","sourcesContent":["var __templateData = function anonymous(locals\n/**/) {\nvar buf = [];\nvar locals_ = (locals || {}),style = locals_.style,locked = locals_.locked,imgURL = locals_.imgURL,title = locals_.title,description = locals_.description,popup = locals_.popup,level = locals_.level,$ = locals_.$,currentXP = locals_.currentXP,newXP = locals_.newXP,leftXP = locals_.leftXP,oldXPWidth = locals_.oldXPWidth,newXPWidth = locals_.newXPWidth,leftXPWidth = locals_.leftXPWidth;var addedClass = style + (locked === true ? ' locked' : '')\nbuf.push(\"<div\" + (jade.attrs({ \"class\": [('clearfix'),('achievement-body'),(addedClass)] }, {\"class\":true})) + \"><div class=\\\"achievement-icon\\\"><div class=\\\"achievement-image\\\"><img\" + (jade.attrs({ 'src':(imgURL) }, {\"src\":true})) + \"/></div></div><div class=\\\"achievement-content\\\"><div class=\\\"achievement-title\\\">\" + (jade.escape(null == (jade.interp = title) ? \"\" : jade.interp)) + \"</div><p class=\\\"achievement-description\\\">\" + (jade.escape(null == (jade.interp = description) ? \"\" : jade.interp)) + \"</p>\");\nif ( popup)\n{\nbuf.push(\"<div class=\\\"progress-wrapper\\\"><span class=\\\"user-level\\\">\" + (jade.escape(null == (jade.interp = level) ? \"\" : jade.interp)) + \"</span><div class=\\\"progress-bar-wrapper\\\"><div class=\\\"progress\\\">\");\nvar currentTitle = $.i18n.t('achievements.current_xp_prefix') + currentXP + ' XP' + $.i18n.t('achievements.current_xp_postfix');\nvar newTitle = $.i18n.t('achievements.new_xp_prefix') + newXP + ' XP' + $.i18n.t('achievements.new_xp_postfix');\nvar leftTitle = $.i18n.t('achievements.left_xp_prefix') + leftXP + ' XP' + $.i18n.t('achievements.left_xp_infix') + (level+1) + $.i18n.t('achievements.left_xp_postfix');\nbuf.push(\"<div\" + (jade.attrs({ 'style':(\"width:\" + (oldXPWidth) + \"%\"), 'data-toggle':(\"tooltip\"), 'data-placement':(\"top\"), 'title':(\"\" + (currentTitle) + \"\"), \"class\": [('progress-bar'),('xp-bar-old')] }, {\"style\":true,\"data-toggle\":true,\"data-placement\":true,\"title\":true})) + \"></div><div\" + (jade.attrs({ 'style':(\"width:\" + (newXPWidth) + \"%\"), 'data-toggle':(\"tooltip\"), 'title':(\"\" + (newTitle) + \"\"), \"class\": [('progress-bar'),('xp-bar-new')] }, {\"style\":true,\"data-toggle\":true,\"title\":true})) + \"></div><div\" + (jade.attrs({ 'style':(\"width:\" + (leftXPWidth) + \"%\"), 'data-toggle':(\"tooltip\"), 'title':(\"\" + (leftTitle) + \"\"), \"class\": [('progress-bar'),('xp-bar-left')] }, {\"style\":true,\"data-toggle\":true,\"title\":true})) + \"></div></div></div><div class=\\\"progress-bar-border\\\"></div></div>\");\n}\nbuf.push(\"</div></div>\");;return buf.join(\"\");\n};\nif (typeof define === 'function' && define.amd) {\n  define([], function() {\n    return __templateData;\n  });\n} else if (typeof module === 'object' && module && module.exports) {\n  module.exports = __templateData;\n} else {\n  __templateData;\n}","CocoView = require 'views/core/CocoView'\r\ntemplate = require 'templates/core/achievement-popup'\r\nUser = require '../../models/User'\r\nAchievement = require '../../models/Achievement'\r\n\r\nmodule.exports = class AchievementPopup extends CocoView\r\n  className: 'achievement-popup'\r\n  template: template\r\n\r\n  constructor: (options) ->\r\n    @achievement = options.achievement\r\n    @earnedAchievement = options.earnedAchievement\r\n    @container = options.container or @getContainer()\r\n    @popup = options.container\r\n    @popup ?= true\r\n    @className += ' popup' if @popup\r\n    super options\r\n    @render()\r\n\r\n  calculateData: ->\r\n    currentLevel = me.level()\r\n    nextLevel = currentLevel + 1\r\n    currentLevelXP = User.expForLevel(currentLevel)\r\n    nextLevelXP = User.expForLevel(nextLevel)\r\n    totalXPNeeded = nextLevelXP - currentLevelXP\r\n    expFunction = @achievement.getExpFunction()\r\n    currentXP = me.get 'points', true\r\n    if @achievement.isRepeatable()\r\n      achievedXP = expFunction(@earnedAchievement.get('previouslyAchievedAmount')) * @achievement.get('worth') if @achievement.isRepeatable()\r\n    else\r\n      achievedXP = @achievement.get 'worth', true\r\n    previousXP = currentXP - achievedXP\r\n    leveledUp = currentXP - achievedXP < currentLevelXP\r\n    #console.debug 'Leveled up' if leveledUp\r\n    alreadyAchievedPercentage = 100 * (previousXP - currentLevelXP) / totalXPNeeded\r\n    alreadyAchievedPercentage = 0 if alreadyAchievedPercentage < 0 # In case of level up\r\n    newlyAchievedPercentage = if leveledUp then 100 * (currentXP - currentLevelXP) / totalXPNeeded else  100 * achievedXP / totalXPNeeded\r\n\r\n    #console.debug \"Current level is #{currentLevel} (#{currentLevelXP} xp), next level is #{nextLevel} (#{nextLevelXP} xp).\"\r\n    #console.debug \"Need a total of #{nextLevelXP - currentLevelXP}, already had #{previousXP} and just now earned #{achievedXP} totalling on #{currentXP}\"\r\n\r\n    data =\r\n      title: @achievement.i18nName()\r\n      imgURL: @achievement.getImageURL()\r\n      description: @achievement.i18nDescription()\r\n      level: currentLevel\r\n      currentXP: currentXP\r\n      newXP: achievedXP\r\n      leftXP: nextLevelXP - currentXP\r\n      oldXPWidth: alreadyAchievedPercentage\r\n      newXPWidth: newlyAchievedPercentage\r\n      leftXPWidth: 100 - newlyAchievedPercentage - alreadyAchievedPercentage\r\n\r\n  getRenderData: ->\r\n    c = super()\r\n    _.extend c, @calculateData()\r\n    c.style = @achievement.getStyle()\r\n    c.popup = true\r\n    c.$ = $ # Allows the jade template to do i18n\r\n    c\r\n\r\n  render: ->\r\n    super()\r\n    @container.prepend @$el\r\n    if @popup\r\n      hide = =>\r\n        return if @destroyed\r\n        @$el.animate {left: -600}, =>\r\n          @$el.remove()\r\n          @destroy()\r\n      @$el.animate left: 0\r\n      @$el.on 'click', hide\r\n      _.delay hide, 10000 unless $('#editor-achievement-edit-view').length\r\n\r\n  getContainer: ->\r\n    unless @container\r\n      @container = $('.achievement-popup-container')\r\n      unless @container.length\r\n        $('body').append('<div class=\"achievement-popup-container\"></div>')\r\n        @container = $('.achievement-popup-container')\r\n    @container\r\n\r\n  afterRender: ->\r\n    super()\r\n    _.delay @initializeTooltips, 1000 # TODO this could be smoother\r\n\r\n  initializeTooltips: ->\r\n    $('.progress-bar').addClass('has-tooltip').tooltip()\r\n"]}