{"version":3,"sources":["app/views/core/CreateAccountModal/SegmentCheckView.coffee"],"names":[],"mappings":"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","file":"public/javascripts/app/views/core/CreateAccountModal/SegmentCheckView.js","sourcesContent":["CocoView = require 'views/core/CocoView'\r\ntemplate = require 'templates/core/create-account-modal/segment-check-view'\r\nforms = require 'core/forms'\r\nClassroom = require 'models/Classroom'\r\nState = require 'models/State'\r\n\r\nmodule.exports = class SegmentCheckView extends CocoView\r\n  id: 'segment-check-view'\r\n  template: template\r\n\r\n  events:\r\n    'click .back-to-account-type': -> @trigger 'nav-back'\r\n    'input .class-code-input': 'onInputClassCode'\r\n    'change .birthday-form-group': 'onInputBirthday'\r\n    'submit form.segment-check': 'onSubmitSegmentCheck'\r\n    'click .individual-path-button': -> @trigger 'choose-path', 'individual'\r\n\r\n  initialize: ({ @signupState } = {}) ->\r\n    @checkClassCodeDebounced = _.debounce @checkClassCode, 1000\r\n    @fetchClassByCode = _.memoize(@fetchClassByCode)\r\n    @classroom = new Classroom()\r\n    @state = new State()\r\n    if @signupState.get('classCode')\r\n      @checkClassCode(@signupState.get('classCode'))\r\n    @listenTo @state, 'all', _.debounce(->\r\n      @renderSelectors('.render')\r\n      @trigger 'special-render'\r\n    )\r\n    \r\n  getClassCode: -> @$('.class-code-input').val() or @signupState.get('classCode') \r\n\r\n  onInputClassCode: ->\r\n    @classroom = new Classroom()\r\n    forms.clearFormAlerts(@$el)\r\n    classCode = @getClassCode()\r\n    @signupState.set { classCode }, { silent: true }\r\n    @checkClassCodeDebounced()\r\n    \r\n  checkClassCode: ->\r\n    return if @destroyed\r\n    classCode = @getClassCode()\r\n    \r\n    @fetchClassByCode(classCode)\r\n    .then (classroom) =>\r\n      return if @destroyed or @getClassCode() isnt classCode\r\n      if classroom\r\n        @classroom = classroom\r\n        @state.set { classCodeValid: true, segmentCheckValid: true }\r\n      else\r\n        @classroom = new Classroom()\r\n        @state.set { classCodeValid: false, segmentCheckValid: false }\r\n    .catch (error) ->\r\n      throw error\r\n      \r\n  onInputBirthday: ->\r\n    { birthdayYear, birthdayMonth, birthdayDay } = forms.formToObject(@$('form'))\r\n    birthday = new Date Date.UTC(birthdayYear, birthdayMonth - 1, birthdayDay)\r\n    @signupState.set { birthdayYear, birthdayMonth, birthdayDay, birthday }, { silent: true }\r\n    unless _.isNaN(birthday.getTime())\r\n      forms.clearFormAlerts(@$el)\r\n    \r\n  onSubmitSegmentCheck: (e) ->\r\n    e.preventDefault()\r\n    \r\n    if @signupState.get('path') is 'student'\r\n      @$('.class-code-input').attr('disabled', true)\r\n    \r\n      @fetchClassByCode(@getClassCode())\r\n      .then (classroom) =>\r\n        return if @destroyed\r\n        if classroom\r\n          @signupState.set { classroom }\r\n          @trigger 'nav-forward'\r\n        else\r\n          @$('.class-code-input').attr('disabled', false)\r\n          @classroom = new Classroom()\r\n          @state.set { classCodeValid: false, segmentCheckValid: false }\r\n      .catch (error) ->\r\n        throw error\r\n        \r\n    else if @signupState.get('path') is 'individual'\r\n      if _.isNaN(@signupState.get('birthday').getTime())\r\n        forms.clearFormAlerts(@$el)\r\n        forms.setErrorToProperty @$el, 'birthdayDay', 'Required'\r\n      else\r\n        age = (new Date().getTime() - @signupState.get('birthday').getTime()) / 365.4 / 24 / 60 / 60 / 1000\r\n        if age > 13\r\n          @trigger 'nav-forward'\r\n        else\r\n          @trigger 'nav-forward', 'coppa-deny'\r\n\r\n  fetchClassByCode: (classCode) ->\r\n    if not classCode\r\n      return Promise.resolve()\r\n      \r\n    new Promise((resolve, reject) ->\r\n      new Classroom().fetchByCode(classCode, {\r\n        success: resolve\r\n        error: (classroom, jqxhr) ->\r\n          if jqxhr.status is 404\r\n            resolve()\r\n          else\r\n            reject(jqxhr.responseJSON)\r\n      })\r\n    )\r\n  \r\n"]}