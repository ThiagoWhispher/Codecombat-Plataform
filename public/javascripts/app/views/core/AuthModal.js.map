{"version":3,"sources":["app/templates/core/auth-modal.jade","app/views/core/AuthModal.coffee"],"names":[],"mappings":"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","file":"public/javascripts/app/views/core/AuthModal.js","sourcesContent":["var __templateData = function anonymous(locals\n/**/) {\nvar buf = [];\nvar locals_ = (locals || {}),showRequiredError = locals_.showRequiredError,view = locals_.view,translate = locals_.translate;buf.push(\"<div class=\\\"modal-dialog\\\"><div class=\\\"modal-content\\\"><img src=\\\"/images/pages/modal/auth/login-background.png\\\" draggable=\\\"false\\\" class=\\\"auth-modal-background\\\"/><h1 data-i18n=\\\"login.log_in\\\"></h1><div id=\\\"close-modal\\\"><span class=\\\"glyphicon glyphicon-remove\\\"></span></div></div><div class=\\\"auth-form-content\\\">\");\nif ( showRequiredError)\n{\nbuf.push(\"<div class=\\\"alert alert-success\\\"><span data-i18n=\\\"signup.required\\\"></span></div>\");\n}\nbuf.push(\"<div id=\\\"unknown-error-alert\\\" data-i18n=\\\"loading_error.unknown\\\" class=\\\"alert alert-danger hide\\\"></div><form class=\\\"form\\\"><div class=\\\"form-group\\\"><label for=\\\"username-or-email-input\\\" class=\\\"control-label\\\"><span data-i18n=\\\"login.email_or_username\\\"></span>:</label><div class=\\\"input-border\\\"><input\" + (jade.attrs({ 'id':('username-or-email-input'), 'name':(\"emailOrUsername\"), 'value':(view.previousFormInputs.email), \"class\": [('input-large'),('form-control')] }, {\"name\":true,\"value\":true})) + \"/></div></div><div class=\\\"form-group\\\"><div id=\\\"recover-account-wrapper\\\"><a id=\\\"link-to-recover\\\" data-toggle=\\\"coco-modal\\\" data-target=\\\"core/RecoverModal\\\" data-i18n=\\\"login.forgot_password\\\"></a></div><label for=\\\"password\\\" class=\\\"control-label\\\"><span data-i18n=\\\"general.password\\\"></span>:</label><div class=\\\"input-border\\\"><input\" + (jade.attrs({ 'id':('password-input'), 'name':(\"password\"), 'type':(\"password\"), 'value':(view.previousFormInputs.password), \"class\": [('input-large'),('form-control')] }, {\"name\":true,\"type\":true,\"value\":true})) + \"/></div></div><input\" + (jade.attrs({ 'id':('login-btn'), 'value':(translate(\"login.log_in\")), 'type':(\"submit\"), \"class\": [('btn'),('btn-lg'),('btn-illustrated'),('btn-block'),('btn-success')] }, {\"value\":true,\"type\":true})) + \"/></form><div class=\\\"wait secret\\\"><h3 data-i18n=\\\"login.logging_in\\\"></h3></div></div><div class=\\\"auth-network-logins\\\"><!-- GitHub login complete, but the button does not fit in with the design yet. Hidden for now--><!--div.network-login--><!--  btn.btn.btn-sm.github-login-button#github-login-button--><!--    img(src=\\\"/images/pages/modal/auth/github_icon.png\\\")--><!--    | GitHub--><button id=\\\"facebook-login-btn\\\" disabled=\\\"disabled\\\" class=\\\"btn btn-primary btn-lg btn-illustrated network-login\\\"><img src=\\\"/images/pages/community/logo_facebook.png\\\" draggable=\\\"false\\\" class=\\\"network-logo\\\"/><span data-i18n=\\\"login.sign_in_with_facebook\\\" class=\\\"sign-in-blurb\\\"></span></button><button id=\\\"gplus-login-btn\\\" disabled=\\\"disabled\\\" class=\\\"btn btn-danger btn-lg btn-illustrated network-login\\\"><img src=\\\"/images/pages/community/logo_g+.png\\\" draggable=\\\"false\\\" class=\\\"network-logo\\\"/><span data-i18n=\\\"login.sign_in_with_gplus\\\" class=\\\"sign-in-blurb\\\"></span><div class=\\\"gplus-login-wrapper\\\"><div class=\\\"gplus-login-button\\\"></div></div></button></div><div class=\\\"extra-pane\\\"><div data-i18n=\\\"login.signup_switch\\\" class=\\\"switch-explanation\\\"></div><div id=\\\"switch-to-signup-btn\\\" data-i18n=\\\"login.sign_up\\\" class=\\\"btn btn-lg btn-illustrated btn-warning\\\"></div></div></div>\");;return buf.join(\"\");\n};\nif (typeof define === 'function' && define.amd) {\n  define([], function() {\n    return __templateData;\n  });\n} else if (typeof module === 'object' && module && module.exports) {\n  module.exports = __templateData;\n} else {\n  __templateData;\n}","ModalView = require 'views/core/ModalView'\r\ntemplate = require 'templates/core/auth-modal'\r\nforms = require 'core/forms'\r\nUser = require 'models/User'\r\napplication  = require 'core/application'\r\nerrors = require 'core/errors'\r\n\r\nmodule.exports = class AuthModal extends ModalView\r\n  id: 'auth-modal'\r\n  template: template\r\n\r\n  events:\r\n    'click #switch-to-signup-btn': 'onSignupInstead'\r\n    'submit form': 'onSubmitForm'\r\n    'keyup #name': 'onNameChange'\r\n    'click #gplus-login-btn': 'onClickGPlusLoginButton'\r\n    'click #facebook-login-btn': 'onClickFacebookLoginButton'\r\n    'click #close-modal': 'hide'\r\n\r\n\r\n  # Initialization\r\n    \r\n  initialize: (options={}) ->\r\n    @previousFormInputs = options.initialValues or {}\r\n    @previousFormInputs.emailOrUsername ?= @previousFormInputs.email or @previousFormInputs.username\r\n\r\n    # TODO: Switch to promises and state, rather than using defer to hackily enable buttons after render\r\n    application.gplusHandler.loadAPI({ success: => _.defer => @$('#gplus-login-btn').attr('disabled', false) })\r\n    application.facebookHandler.loadAPI({ success: => _.defer => @$('#facebook-login-btn').attr('disabled', false) })\r\n\r\n  afterRender: ->\r\n    super()\r\n    @playSound 'game-menu-open'\r\n\r\n  afterInsert: ->\r\n    super()\r\n    _.delay (=> $('input:visible:first', @$el).focus()), 500\r\n\r\n  onSignupInstead: (e) ->\r\n    CreateAccountModal = require('./CreateAccountModal')\r\n    modal = new CreateAccountModal({initialValues: forms.formToObject @$el})\r\n    currentView.openModalView(modal)\r\n\r\n  onSubmitForm: (e) ->\r\n    @playSound 'menu-button-click'\r\n    e.preventDefault()\r\n    forms.clearFormAlerts(@$el)\r\n    @$('#unknown-error-alert').addClass('hide')\r\n    userObject = forms.formToObject @$el\r\n    res = tv4.validateMultiple userObject, formSchema\r\n    return forms.applyErrorsToForm(@$el, res.errors) unless res.valid\r\n    new Promise(me.loginPasswordUser(userObject.emailOrUsername, userObject.password).then)\r\n    .then(->\r\n      if window.nextURL then window.location.href = window.nextURL else loginNavigate()\r\n    )\r\n    .catch((jqxhr) =>\r\n      showingError = false\r\n      if jqxhr.status is 401\r\n        errorID = jqxhr.responseJSON.errorID\r\n        if errorID is 'not-found'\r\n          forms.setErrorToProperty(@$el, 'emailOrUsername', $.i18n.t('loading_error.not_found'))\r\n          showingError = true\r\n        if errorID is 'wrong-password'\r\n          forms.setErrorToProperty(@$el, 'password', $.i18n.t('account_settings.wrong_password'))\r\n          showingError = true\r\n      \r\n      if not showingError\r\n        @$('#unknown-error-alert').removeClass('hide')\r\n    )\r\n      \r\n  \r\n  # Google Plus\r\n\r\n  onClickGPlusLoginButton: ->\r\n    btn = @$('#gplus-login-btn')\r\n    application.gplusHandler.connect({\r\n      context: @\r\n      success: ->\r\n        btn.find('.sign-in-blurb').text($.i18n.t('login.logging_in'))\r\n        btn.attr('disabled', true)\r\n        application.gplusHandler.loadPerson({\r\n          context: @\r\n          success: (gplusAttrs) ->\r\n            existingUser = new User()\r\n            existingUser.fetchGPlusUser(gplusAttrs.gplusID, {\r\n              success: =>\r\n                me.loginGPlusUser(gplusAttrs.gplusID, {\r\n                  success: -> loginNavigate()\r\n                  error: @onGPlusLoginError\r\n                })\r\n              error: @onGPlusLoginError\r\n            })\r\n        })\r\n    })\r\n\r\n  onGPlusLoginError: =>\r\n    btn = @$('#gplus-login-btn')\r\n    btn.find('.sign-in-blurb').text($.i18n.t('login.sign_in_with_gplus'))\r\n    btn.attr('disabled', false)\r\n    errors.showNotyNetworkError(arguments...)\r\n    \r\n    \r\n  # Facebook\r\n\r\n  onClickFacebookLoginButton: ->\r\n    btn = @$('#facebook-login-btn')\r\n    application.facebookHandler.connect({\r\n      context: @\r\n      success: ->\r\n        btn.find('.sign-in-blurb').text($.i18n.t('login.logging_in'))\r\n        btn.attr('disabled', true)\r\n        application.facebookHandler.loadPerson({\r\n          context: @\r\n          success: (facebookAttrs) ->\r\n            existingUser = new User()\r\n            existingUser.fetchFacebookUser(facebookAttrs.facebookID, {\r\n              success: =>\r\n                me.loginFacebookUser(facebookAttrs.facebookID, {\r\n                  success: -> loginNavigate()\r\n                  error: @onFacebookLoginError\r\n                })\r\n              error: @onFacebookLoginError\r\n            })\r\n        })\r\n    })\r\n    \r\n  onFacebookLoginError: =>\r\n    btn = @$('#facebook-login-btn')\r\n    btn.find('.sign-in-blurb').text($.i18n.t('login.sign_in_with_facebook'))\r\n    btn.attr('disabled', false)\r\n    errors.showNotyNetworkError(arguments...)\r\n\r\n\r\n  onHidden: ->\r\n    super()\r\n    @playSound 'game-menu-close'\r\n\r\nformSchema = {\r\n  type: 'object'\r\n  properties: {\r\n    emailOrUsername: {\r\n      $or: [\r\n        User.schema.properties.name\r\n        User.schema.properties.email\r\n      ]\r\n    }\r\n    password: User.schema.properties.password\r\n  }\r\n  required: ['emailOrUsername', 'password']\r\n}\r\n\r\nloginNavigate = ->\r\n  if me.isStudent() and not me.isAdmin()\r\n    application.router.navigate('/students', {trigger: true})\r\n  else if me.isTeacher() and not me.isAdmin()\r\n    application.router.navigate('/teachers/classes', {trigger: true})\r\n  window.location.reload()\r\n"]}