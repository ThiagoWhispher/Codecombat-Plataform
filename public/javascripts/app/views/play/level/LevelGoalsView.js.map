{"version":3,"sources":["app/views/play/level/LevelGoalsView.coffee"],"names":[],"mappings":"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","file":"public/javascripts/app/views/play/level/LevelGoalsView.js","sourcesContent":["CocoView = require 'views/core/CocoView'\r\ntemplate = require 'templates/play/level/goals'\r\n{me} = require 'core/auth'\r\nutils = require 'core/utils'\r\n\r\nstateIconMap =\r\n  success: 'glyphicon-ok'\r\n  failure: 'glyphicon-remove'\r\n\r\nmodule.exports = class LevelGoalsView extends CocoView\r\n  id: 'goals-view'\r\n  template: template\r\n  className: 'secret expanded'\r\n  playbackEnded: false\r\n\r\n  subscriptions:\r\n    'goal-manager:new-goal-states': 'onNewGoalStates'\r\n    'tome:cast-spells': 'onTomeCast'\r\n    'level:set-letterbox': 'onSetLetterbox'\r\n    'level:set-playing': 'onSetPlaying'\r\n    'surface:playback-restarted': 'onSurfacePlaybackRestarted'\r\n    'surface:playback-ended': 'onSurfacePlaybackEnded'\r\n\r\n  events:\r\n    'mouseenter': ->\r\n      @mouseEntered = true\r\n      @updatePlacement()\r\n\r\n    'mouseleave': ->\r\n      @mouseEntered = false\r\n      @updatePlacement()\r\n\r\n  constructor: (options) ->\r\n    super options\r\n    @level = options.level\r\n\r\n  onNewGoalStates: (e) ->\r\n    firstRun = not @previousGoalStatus?\r\n    @previousGoalStatus ?= {}\r\n    @$el.find('.goal-status').addClass 'secret'\r\n    classToShow = null\r\n    classToShow = 'success' if e.overallStatus is 'success'\r\n    classToShow = 'failure' if e.overallStatus is 'failure'\r\n    classToShow ?= 'timed-out' if e.timedOut\r\n    classToShow ?= 'incomplete'\r\n    @$el.find('.goal-status.'+classToShow).removeClass 'secret'\r\n    list = $('#primary-goals-list', @$el)\r\n    list.empty()\r\n    goals = []\r\n    for goal in e.goals\r\n      state = e.goalStates[goal.id]\r\n      continue if goal.optional and @level.isType('course') and state.status isnt 'success'\r\n      if goal.hiddenGoal\r\n        continue if goal.optional and state.status isnt 'success'\r\n        continue if not goal.optional and state.status isnt 'failure'\r\n      continue if goal.team and me.team isnt goal.team\r\n      text = utils.i18n goal, 'name'\r\n      if state.killed\r\n        dead = _.filter(_.values(state.killed)).length\r\n        targeted = _.values(state.killed).length\r\n        if targeted > 1\r\n          # Does this make sense?\r\n          if goal.isPositive\r\n            completed = dead\r\n          else\r\n            completed = targeted - dead\r\n          text = text + \" (#{completed}/#{targeted})\"\r\n      # This should really get refactored, along with GoalManager, so that goals have a standard\r\n      # representation of how many are done, how many are needed, what that means, etc.\r\n      li = $('<li></li>').addClass(\"status-#{state.status}\").text(text)\r\n      iconClass = stateIconMap[state.status]\r\n      li.prepend($('<i></i>').addClass(\"glyphicon #{iconClass or ''}\"))  # If empty, insert a .glyphicon to take up space\r\n      list.append(li)\r\n      goals.push goal\r\n      if not firstRun and state.status is 'success' and @previousGoalStatus[goal.id] isnt 'success'\r\n        @soundToPlayWhenPlaybackEnded = 'goal-success'\r\n      else if not firstRun and state.status isnt 'success' and @previousGoalStatus[goal.id] is 'success'\r\n        @soundToPlayWhenPlaybackEnded = 'goal-incomplete-again'\r\n      else\r\n        @soundToPlayWhenPlaybackEnded = null\r\n      @previousGoalStatus[goal.id] = state.status\r\n    if goals.length > 0 and @$el.hasClass 'secret'\r\n      @$el.removeClass('secret')\r\n      @lastSizeTweenTime = new Date()\r\n    @updatePlacement()\r\n\r\n  onTomeCast: (e) ->\r\n    return if e.preload\r\n    @$el.find('.goal-status').addClass('secret')\r\n    @$el.find('.goal-status.running').removeClass('secret')\r\n\r\n  onSetPlaying: (e) ->\r\n    return unless e.playing\r\n    # Automatically hide it while we replay\r\n    @mouseEntered = false\r\n    @expanded = true\r\n    @updatePlacement()\r\n\r\n  onSurfacePlaybackRestarted: ->\r\n    @playbackEnded = false\r\n    @$el.removeClass 'brighter'\r\n    @lastSizeTweenTime = new Date()\r\n    @updatePlacement()\r\n\r\n  onSurfacePlaybackEnded: ->\r\n    return if @level.isType('game-dev')\r\n    @playbackEnded = true\r\n    @updateHeight()\r\n    @$el.addClass 'brighter'\r\n    @lastSizeTweenTime = new Date()\r\n    @updatePlacement()\r\n    if @soundToPlayWhenPlaybackEnded\r\n      @playSound @soundToPlayWhenPlaybackEnded\r\n\r\n  updateHeight: ->\r\n    return if @$el.hasClass('brighter') or @$el.hasClass('secret')\r\n    return if (new Date() - @lastSizeTweenTime) < 500  # Don't measure this while still animating, might get the wrong value. Should match sass transition time.\r\n    @normalHeight = @$el.outerHeight()\r\n\r\n  updatePlacement: ->\r\n    # Expand it if it's at the end. Mousing over reverses this.\r\n    expand = @playbackEnded isnt @mouseEntered\r\n    return if expand is @expanded\r\n    @updateHeight()\r\n    sound = if expand then 'goals-expand' else 'goals-collapse'\r\n    if expand\r\n      top = -5\r\n    else\r\n      height = @normalHeight\r\n      height = @$el.outerHeight() if not height or @playbackEnded\r\n      top = 41 - height\r\n    @$el.css 'top', top\r\n    if @soundTimeout\r\n      # Don't play the sound we were going to play after all; the transition has reversed.\r\n      clearTimeout @soundTimeout\r\n      @soundTimeout = null\r\n    else if @expanded?\r\n      # Play it when the transition ends, not when it begins.\r\n      @soundTimeout = _.delay @playToggleSound, 500, sound\r\n    @expanded = expand\r\n\r\n  playToggleSound: (sound) =>\r\n    return if @destroyed\r\n    @playSound sound unless @options.level.isType('game-dev')\r\n    @soundTimeout = null\r\n\r\n  onSetLetterbox: (e) ->\r\n    @$el.toggle not e.on\r\n    @updatePlacement()\r\n"]}