{"version":3,"sources":["app/templates/play/level/level-dialogue-view.jade","app/views/play/level/LevelDialogueView.coffee"],"names":[],"mappings":"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","file":"public/javascripts/app/views/play/level/LevelDialogueView.js","sourcesContent":["var __templateData = function anonymous(locals\n/**/) {\nvar buf = [];\nbuf.push(\"<div class=\\\"dialogue-area\\\"><p class=\\\"bubble dialogue-bubble\\\"></p></div>\");;return buf.join(\"\");\n};\nif (typeof define === 'function' && define.amd) {\n  define([], function() {\n    return __templateData;\n  });\n} else if (typeof module === 'object' && module && module.exports) {\n  module.exports = __templateData;\n} else {\n  __templateData;\n}","CocoView = require 'views/core/CocoView'\r\ntemplate = require 'templates/play/level/level-dialogue-view'\r\nDialogueAnimator = require './DialogueAnimator'\r\n\r\nmodule.exports = class LevelDialogueView extends CocoView\r\n  id: 'level-dialogue-view'\r\n  template: template\r\n\r\n  subscriptions:\r\n    'sprite:speech-updated': 'onSpriteDialogue'\r\n    'level:sprite-clear-dialogue': 'onSpriteClearDialogue'\r\n    'level:shift-space-pressed': 'onShiftSpacePressed'\r\n    'level:escape-pressed': 'onEscapePressed'\r\n    'sprite:dialogue-sound-completed': 'onDialogueSoundCompleted'\r\n\r\n  events:\r\n    'click': 'onClick'\r\n    'click a': 'onClickLink'\r\n\r\n  constructor: (options) ->\r\n    super options\r\n    @level = options.level\r\n    @sessionID = options.sessionID\r\n\r\n  onClick: (e) ->\r\n    Backbone.Mediator.publish 'tome:focus-editor', {}\r\n\r\n  onClickLink: (e) ->\r\n    route = $(e.target).attr('href')\r\n    if route and /item-store/.test route\r\n      PlayItemsModal = require 'views/play/modal/PlayItemsModal'\r\n      @openModalView new PlayItemsModal supermodel: @supermodal\r\n      e.stopPropagation()\r\n\r\n  onSpriteDialogue: (e) ->\r\n    return unless e.message\r\n    @$el.addClass 'active speaking'\r\n    $('body').addClass('dialogue-view-active')\r\n    @setMessage e.message, e.mood, e.responses\r\n\r\n    window.tracker?.trackEvent 'Heard Sprite', {message: e.message, label: e.message, ls: @sessionID}\r\n\r\n  onDialogueSoundCompleted: ->\r\n    @$el.removeClass 'speaking'\r\n\r\n  onSpriteClearDialogue: ->\r\n    @$el.removeClass 'active speaking'\r\n    $('body').removeClass('dialogue-view-active')\r\n\r\n  setMessage: (message, mood, responses) ->\r\n    message = marked message\r\n    # Fix old HTML icons like <i class='icon-play'></i> in the Markdown\r\n    message = message.replace /&lt;i class=&#39;(.+?)&#39;&gt;&lt;\\/i&gt;/, \"<i class='$1'></i>\"\r\n    clearInterval(@messageInterval) if @messageInterval\r\n    @bubble = $('.dialogue-bubble', @$el)\r\n    @bubble.removeClass(@lastMood) if @lastMood\r\n    @lastMood = mood\r\n    @bubble.text('')\r\n    group = $('<div class=\"enter secret\"></div>')\r\n    @bubble.append(group)\r\n    if responses\r\n      @lastResponses = responses\r\n      for response in responses\r\n        button = $('<button class=\"btn btn-small banner\"></button>').text(response.text)\r\n        button.addClass response.buttonClass if response.buttonClass\r\n        group.append(button)\r\n        response.button = $('button:last', group)\r\n    else\r\n      s = $.i18n.t('common.continue', defaultValue: 'Continue')\r\n      sk = $.i18n.t('play_level.skip_tutorial', defaultValue: 'skip: esc')\r\n      if not @escapePressed and not @isFullScreen()\r\n        group.append('<span class=\"hud-hint\">' + sk + '</span>')\r\n      group.append($('<button class=\"btn btn-small banner with-dot\">' + s + ' <div class=\"dot\"></div></button>'))\r\n      @lastResponses = null\r\n    @animator = new DialogueAnimator(message, @bubble)\r\n    @messageInterval = setInterval(@addMoreMessage, 1000 / 30)  # 30 FPS\r\n\r\n  isFullScreen: ->\r\n    document.fullScreen || document.mozFullScreen || document.webkitIsFullScreen\r\n\r\n  addMoreMessage: =>\r\n    if @animator.done()\r\n      clearInterval(@messageInterval)\r\n      @messageInterval = null\r\n      $('.enter', @bubble).removeClass('secret').css('opacity', 0.0).delay(500).animate({opacity: 1.0}, 500, @animateEnterButton)\r\n      if @lastResponses\r\n        buttons = $('.enter button')\r\n        for response, i in @lastResponses\r\n          channel = response.channel.replace 'level-set-playing', 'level:set-playing'  # Easier than migrating all those victory buttons.\r\n          f = (r) => => setTimeout((-> Backbone.Mediator.publish(channel, r.event or {})), 10)\r\n          $(buttons[i]).click(f(response))\r\n      else\r\n        $('.enter', @bubble).click(-> Backbone.Mediator.publish('script:end-current-script', {}))\r\n      return\r\n    @animator.tick()\r\n\r\n  onShiftSpacePressed: (e) ->\r\n    @shiftSpacePressed = (@shiftSpacePressed || 0) + 1\r\n    # We don't need to handle script:end-current-script--that's done--but if we do have\r\n    # custom buttons, then we need to trigger the one that should fire (the last one).\r\n    # If we decide that always having the last one fire is bad, we should make it smarter.\r\n    return unless @lastResponses?.length\r\n    r = @lastResponses[@lastResponses.length - 1]\r\n    channel = r.channel.replace 'level-set-playing', 'level:set-playing'\r\n    _.delay (-> Backbone.Mediator.publish(channel, r.event or {})), 10\r\n\r\n  onEscapePressed: (e) ->\r\n    @escapePressed = true\r\n\r\n  animateEnterButton: =>\r\n    return unless @bubble\r\n    button = $('.enter', @bubble)\r\n    dot = $('.dot', button)\r\n    dot.animate({opacity: 0.2}, 300).animate({opacity: 1.9}, 600, @animateEnterButton)\r\n\r\n  destroy: ->\r\n    clearInterval(@messageInterval) if @messageInterval\r\n    super()\r\n"]}