{"version":3,"sources":["app/views/play/level/tome/SpellTranslationView.coffee"],"names":[],"mappings":"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","file":"public/javascripts/app/views/play/level/tome/SpellTranslationView.js","sourcesContent":["CocoView = require 'views/core/CocoView'\r\nLevelComponent = require 'models/LevelComponent'\r\ntemplate = require 'templates/play/level/tome/spell_translation'\r\nace = require 'ace'\r\nRange = ace.require('ace/range').Range\r\nTokenIterator = ace.require('ace/token_iterator').TokenIterator\r\nutils = require 'core/utils'\r\n\r\nmodule.exports = class SpellTranslationView extends CocoView\r\n  className: 'spell-translation-view'\r\n  template: template\r\n  \r\n  events:\r\n    'mousemove': ->\r\n      @$el.hide()\r\n\r\n  constructor: (options) ->\r\n    super options\r\n    @ace = options.ace\r\n    \r\n    levelComponents = @supermodel.getModels LevelComponent\r\n    @componentTranslations = levelComponents.reduce((acc, lc) ->\r\n      for doc in (lc.get('propertyDocumentation') ? [])\r\n        translated = utils.i18n(doc, 'name', null, false)\r\n        acc[doc.name] = translated if translated isnt doc.name\r\n      acc\r\n    , {})\r\n    \r\n    @onMouseMove = _.throttle @onMouseMove, 25\r\n    \r\n  afterRender: ->\r\n    super()\r\n    @ace.on 'mousemove', @onMouseMove\r\n\r\n  setTooltipText: (text) =>\r\n    @$el.find('code').text text\r\n    @$el.show().css(@pos)\r\n    \r\n  isIdentifier: (t) ->\r\n    t and (_.any([/identifier/, /keyword/], (regex) -> regex.test(t.type)) or t.value is 'this')\r\n    \r\n  onMouseMove: (e) =>\r\n    return if @destroyed\r\n    pos = e.getDocumentPosition()\r\n    it = new TokenIterator e.editor.session, pos.row, pos.column\r\n    endOfLine = it.getCurrentToken()?.index is it.$rowTokens.length - 1\r\n    while it.getCurrentTokenRow() is pos.row and not @isIdentifier(token = it.getCurrentToken())\r\n      break if endOfLine or not token  # Don't iterate beyond end or beginning of line\r\n      it.stepBackward()\r\n    unless @isIdentifier(token)\r\n      @word = null\r\n      @update()\r\n      return\r\n    try\r\n      # Ace was breaking under some (?) conditions, dependent on mouse location.\r\n      #   with $rowTokens = [] (but should have things)\r\n      start = it.getCurrentTokenColumn()\r\n    catch error\r\n      start = 0\r\n    end = start + token.value.length\r\n    if @isIdentifier(token)\r\n      @word = token.value\r\n      @markerRange = new Range pos.row, start, pos.row, end\r\n      @reposition(e.domEvent)\r\n    @update()\r\n    \r\n  reposition: (e) ->\r\n    offsetX = e.offsetX ? e.clientX - $(e.target).offset().left\r\n    offsetY = e.offsetY ? e.clientY - $(e.target).offset().top\r\n    w = $(document).width() - 20\r\n    offsetX = w - $(e.target).offset().left - @$el.width() if e.clientX + @$el.width() > w\r\n    @pos = {left: offsetX + 80, top: offsetY - 20}\r\n    @$el.css(@pos)\r\n    \r\n  onMouseOut: ->\r\n    @word = null\r\n    @markerRange = null\r\n    @update()\r\n    \r\n  update: ->\r\n    i18nKey = 'code.'+@word\r\n    translation = @componentTranslations[@word] or $.t(i18nKey)\r\n    if @word and translation and translation not in [i18nKey, @word]\r\n      @setTooltipText translation\r\n    else\r\n      @$el.hide()\r\n\r\n  destroy: ->\r\n    @ace?.removeEventListener 'mousemove', @onMouseMove\r\n    super()\r\n"]}