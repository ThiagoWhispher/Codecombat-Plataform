{"version":3,"sources":["app/views/play/level/tome/SpellView.coffee"],"names":[],"mappings":"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","file":"public/javascripts/app/views/play/level/tome/SpellView.js","sourcesContent":["CocoView = require 'views/core/CocoView'\r\ntemplate = require 'templates/play/level/tome/spell'\r\n{me} = require 'core/auth'\r\nfilters = require 'lib/image_filter'\r\nace = require 'ace'\r\nRange = ace.require('ace/range').Range\r\nUndoManager = ace.require('ace/undomanager').UndoManager\r\nProblem = require './Problem'\r\nSpellDebugView = require './SpellDebugView'\r\nSpellTranslationView = require './SpellTranslationView'\r\nSpellToolbarView = require './SpellToolbarView'\r\nLevelComponent = require 'models/LevelComponent'\r\nUserCodeProblem = require 'models/UserCodeProblem'\r\nutils = require 'core/utils'\r\nCodeLog = require 'models/CodeLog'\r\nAutocomplete = require './editor/autocomplete'\r\nTokenIterator = ace.require('ace/token_iterator').TokenIterator\r\n\r\nmodule.exports = class SpellView extends CocoView\r\n  id: 'spell-view'\r\n  className: 'shown'\r\n  template: template\r\n  controlsEnabled: true\r\n  eventsSuppressed: true\r\n  writable: true\r\n  languagesThatUseWorkers: ['html']\r\n\r\n  keyBindings:\r\n    'default': null\r\n    'vim': 'ace/keyboard/vim'\r\n    'emacs': 'ace/keyboard/emacs'\r\n\r\n  subscriptions:\r\n    'level:disable-controls': 'onDisableControls'\r\n    'level:enable-controls': 'onEnableControls'\r\n    'surface:frame-changed': 'onFrameChanged'\r\n    'surface:coordinate-selected': 'onCoordinateSelected'\r\n    'god:new-world-created': 'onNewWorld'\r\n    'god:user-code-problem': 'onUserCodeProblem'\r\n    'god:non-user-code-problem': 'onNonUserCodeProblem'\r\n    'tome:manual-cast': 'onManualCast'\r\n    'tome:spell-changed': 'onSpellChanged'\r\n    'level:session-will-save': 'onSessionWillSave'\r\n    'modal:closed': 'focus'\r\n    'tome:focus-editor': 'focus'\r\n    'tome:spell-statement-index-updated': 'onStatementIndexUpdated'\r\n    'tome:change-language': 'onChangeLanguage'\r\n    'tome:change-config': 'onChangeEditorConfig'\r\n    'tome:update-snippets': 'addAutocompleteSnippets'\r\n    'tome:insert-snippet': 'onInsertSnippet'\r\n    'tome:spell-beautify': 'onSpellBeautify'\r\n    'tome:maximize-toggled': 'onMaximizeToggled'\r\n    'tome:problems-updated': 'onProblemsUpdated'\r\n    'script:state-changed': 'onScriptStateChange'\r\n    'playback:ended-changed': 'onPlaybackEndedChanged'\r\n    'level:contact-button-pressed': 'onContactButtonPressed'\r\n    'level:show-victory': 'onShowVictory'\r\n    'web-dev:error': 'onWebDevError'\r\n\r\n  events:\r\n    'mouseout': 'onMouseOut'\r\n\r\n  constructor: (options) ->\r\n    @supermodel = options.supermodel\r\n    super options\r\n    @worker = options.worker\r\n    @session = options.session\r\n    @spell = options.spell\r\n    @problems = []\r\n    @savedProblems = {} # Cache saved user code problems to prevent duplicates\r\n    @writable = false unless me.team in @spell.permissions.readwrite  # TODO: make this do anything\r\n    @highlightCurrentLine = _.throttle @highlightCurrentLine, 100\r\n    $(window).on 'resize', @onWindowResize\r\n    @observing = @session.get('creator') isnt me.id\r\n\r\n  afterRender: ->\r\n    super()\r\n    @createACE()\r\n    @createACEShortcuts()\r\n    @hookACECustomBehavior()\r\n    @fillACE()\r\n    @createOnCodeChangeHandlers()\r\n    @lockDefaultCode()\r\n    _.defer @onAllLoaded  # Needs to happen after the code generating this view is complete\r\n\r\n  # This ACE is used for the code editor, and is only instantiated once per level.\r\n  createACE: ->\r\n    # Test themes and settings here: http://ace.ajax.org/build/kitchen-sink.html\r\n    aceConfig = me.get('aceConfig') ? {}\r\n    @destroyAceEditor(@ace)\r\n    @ace = ace.edit @$el.find('.ace')[0]\r\n    @aceSession = @ace.getSession()\r\n    # Override setAnnotations so the Ace html worker doesn't clobber our annotations\r\n    @reallySetAnnotations = @aceSession.setAnnotations.bind(@aceSession)\r\n    @aceSession.setAnnotations = (annotations) =>\r\n      previousAnnotations = @aceSession.getAnnotations()\r\n      newAnnotations = _.filter previousAnnotations, (annotation) -> annotation.createdBy? # Keep the ones we generated\r\n        .concat _.reject annotations, (annotation) -> # Ignore this particular info-annotation the html worker generates\r\n          annotation.text is 'Start tag seen without seeing a doctype first. Expected e.g. <!DOCTYPE html>.'\r\n      @reallySetAnnotations newAnnotations\r\n    @aceDoc = @aceSession.getDocument()\r\n    @aceSession.setUseWorker @spell.language in @languagesThatUseWorkers\r\n    @aceSession.setMode utils.aceEditModes[@spell.language]\r\n    @aceSession.setWrapLimitRange null\r\n    @aceSession.setUseWrapMode true\r\n    @aceSession.setNewLineMode 'unix'\r\n    @aceSession.setUseSoftTabs true\r\n    @ace.setTheme 'ace/theme/textmate'\r\n    @ace.setDisplayIndentGuides false\r\n    @ace.setShowPrintMargin false\r\n    @ace.setShowInvisibles aceConfig.invisibles\r\n    @ace.setBehavioursEnabled aceConfig.behaviors\r\n    @ace.setAnimatedScroll true\r\n    @ace.setShowFoldWidgets false\r\n    @ace.setKeyboardHandler @keyBindings[aceConfig.keyBindings ? 'default']\r\n    @ace.$blockScrolling = Infinity\r\n    @ace.on 'mousemove', @onAceMouseMove\r\n    @ace.on 'mouseout', @onAceMouseOut\r\n    @toggleControls null, @writable\r\n    @aceSession.selection.on 'changeCursor', @onCursorActivity\r\n    $(@ace.container).find('.ace_gutter').on 'click mouseenter', '.ace_error, .ace_warning, .ace_info', @onAnnotationClick\r\n    $(@ace.container).find('.ace_gutter').on 'click', @onGutterClick\r\n    @initAutocomplete aceConfig.liveCompletion ? true\r\n\r\n    return if @session.get('creator') isnt me.id or @session.fake\r\n    # Create a Spade to 'dig' into Ace.\r\n    @spade = new Spade()\r\n    @spade.track(@ace)\r\n    # If a user is taking longer than 10 minutes, let's log it.\r\n    saveSpadeDelay = 10 * 60 * 1000\r\n    @saveSpadeTimeout = setTimeout @saveSpade, saveSpadeDelay\r\n\r\n  createACEShortcuts: ->\r\n    @aceCommands = aceCommands = []\r\n    addCommand = (c) =>\r\n      @ace.commands.addCommand c\r\n      aceCommands.push c.name\r\n    addCommand\r\n      name: 'run-code'\r\n      bindKey: {win: 'Shift-Enter|Ctrl-Enter', mac: 'Shift-Enter|Command-Enter|Ctrl-Enter'}\r\n      exec: => Backbone.Mediator.publish 'tome:manual-cast', {realTime: @options.level.isType('game-dev')}\r\n    unless @observing\r\n      addCommand\r\n        name: 'run-code-real-time'\r\n        bindKey: {win: 'Ctrl-Shift-Enter', mac: 'Command-Shift-Enter|Ctrl-Shift-Enter'}\r\n        exec: =>\r\n          doneButton = @$('.done-button:visible')\r\n          if doneButton.length\r\n            doneButton.trigger 'click'\r\n          else if @options.level.get('replayable') and (timeUntilResubmit = @session.timeUntilResubmit()) > 0\r\n            Backbone.Mediator.publish 'tome:manual-cast-denied', timeUntilResubmit: timeUntilResubmit\r\n          else\r\n            Backbone.Mediator.publish 'tome:manual-cast', {realTime: true}\r\n    addCommand\r\n      name: 'no-op'\r\n      bindKey: {win: 'Ctrl-S', mac: 'Command-S|Ctrl-S'}\r\n      exec: ->  # just prevent page save call\r\n    addCommand\r\n      name: 'toggle-playing'\r\n      bindKey: {win: 'Ctrl-P', mac: 'Command-P|Ctrl-P'}\r\n      readOnly: true\r\n      exec: -> Backbone.Mediator.publish 'level:toggle-playing', {}\r\n    addCommand\r\n      name: 'end-current-script'\r\n      bindKey: {win: 'Shift-Space', mac: 'Shift-Space'}\r\n      readOnly: true\r\n      exec: =>\r\n        if @scriptRunning\r\n          Backbone.Mediator.publish 'level:shift-space-pressed', {}\r\n        else\r\n          @ace.insert ' '\r\n    addCommand\r\n      name: 'end-all-scripts'\r\n      bindKey: {win: 'Escape', mac: 'Escape'}\r\n      readOnly: true\r\n      exec: ->\r\n        Backbone.Mediator.publish 'level:escape-pressed', {}\r\n    addCommand\r\n      name: 'toggle-grid'\r\n      bindKey: {win: 'Ctrl-G', mac: 'Command-G|Ctrl-G'}\r\n      readOnly: true\r\n      exec: -> Backbone.Mediator.publish 'level:toggle-grid', {}\r\n    addCommand\r\n      name: 'toggle-debug'\r\n      bindKey: {win: 'Ctrl-\\\\', mac: 'Command-\\\\|Ctrl-\\\\'}\r\n      readOnly: true\r\n      exec: -> Backbone.Mediator.publish 'level:toggle-debug', {}\r\n    addCommand\r\n      name: 'toggle-pathfinding'\r\n      bindKey: {win: 'Ctrl-O', mac: 'Command-O|Ctrl-O'}\r\n      readOnly: true\r\n      exec: -> Backbone.Mediator.publish 'level:toggle-pathfinding', {}\r\n    addCommand\r\n      name: 'level-scrub-forward'\r\n      bindKey: {win: 'Ctrl-]', mac: 'Command-]|Ctrl-]'}\r\n      readOnly: true\r\n      exec: -> Backbone.Mediator.publish 'level:scrub-forward', {}\r\n    addCommand\r\n      name: 'level-scrub-back'\r\n      bindKey: {win: 'Ctrl-[', mac: 'Command-[|Ctrl-]'}\r\n      readOnly: true\r\n      exec: -> Backbone.Mediator.publish 'level:scrub-back', {}\r\n    addCommand\r\n      name: 'spell-step-forward'\r\n      bindKey: {win: 'Ctrl-Alt-]', mac: 'Command-Alt-]|Ctrl-Alt-]'}\r\n      readOnly: true\r\n      exec: -> Backbone.Mediator.publish 'tome:spell-step-forward', {}\r\n    addCommand\r\n      name: 'spell-step-backward'\r\n      bindKey: {win: 'Ctrl-Alt-[', mac: 'Command-Alt-[|Ctrl-Alt-]'}\r\n      readOnly: true\r\n      exec: -> Backbone.Mediator.publish 'tome:spell-step-backward', {}\r\n    addCommand\r\n      name: 'spell-beautify'\r\n      bindKey: {win: 'Ctrl-Shift-B', mac: 'Command-Shift-B|Ctrl-Shift-B'}\r\n      exec: -> Backbone.Mediator.publish 'tome:spell-beautify', {}\r\n    addCommand\r\n      name: 'prevent-line-jump'\r\n      bindKey: {win: 'Ctrl-L', mac: 'Command-L'}\r\n      passEvent: true\r\n      exec: ->  # just prevent default ACE go-to-line alert\r\n    addCommand\r\n      name: 'open-fullscreen-editor'\r\n      bindKey: {win: 'Ctrl-Shift-M', mac: 'Command-Shift-M|Ctrl-Shift-M'}\r\n      exec: -> Backbone.Mediator.publish 'tome:toggle-maximize', {}\r\n    addCommand\r\n      # TODO: Restrict to beginner campaign levels like we do backspaceThrottle\r\n      name: 'enter-skip-delimiters'\r\n      bindKey: 'Enter|Return'\r\n      exec: =>\r\n        if @aceSession.selection.isEmpty()\r\n          cursor = @ace.getCursorPosition()\r\n          line = @aceDoc.getLine(cursor.row)\r\n          if delimMatch = line.substring(cursor.column).match /^([\"|']?\\)+;?)/  # Yay for editors misreading regexes: \"\r\n            newRange = @ace.getSelectionRange()\r\n            newRange.setStart newRange.start.row, newRange.start.column + delimMatch[1].length\r\n            newRange.setEnd newRange.end.row, newRange.end.column + delimMatch[1].length\r\n            @aceSession.selection.setSelectionRange newRange\r\n        @ace.execCommand 'insertstring', '\\n'\r\n    addCommand\r\n      name: 'disable-spaces'\r\n      bindKey: 'Space'\r\n      exec: =>\r\n        disableSpaces = @options.level.get('disableSpaces') or false\r\n        aceConfig = me.get('aceConfig') ? {}\r\n        disableSpaces = false if aceConfig.keyBindings and aceConfig.keyBindings isnt 'default'  # Not in vim/emacs mode\r\n        disableSpaces = false if @spell.language in ['lua', 'java', 'coffeescript', 'html']  # Don't disable for more advanced/experimental languages\r\n        if not disableSpaces or (_.isNumber(disableSpaces) and disableSpaces < me.level())\r\n          return @ace.execCommand 'insertstring', ' '\r\n        line = @aceDoc.getLine @ace.getCursorPosition().row\r\n        return @ace.execCommand 'insertstring', ' ' if @singleLineCommentRegex().test line\r\n\r\n    if @options.level.get 'backspaceThrottle'\r\n      addCommand\r\n        name: 'throttle-backspaces'\r\n        bindKey: 'Backspace'\r\n        exec: =>\r\n          # Throttle the backspace speed\r\n          # Slow to 500ms when whitespace at beginning of line is first encountered\r\n          # Slow to 100ms for remaining whitespace at beginning of line\r\n          # Rough testing showed backspaces happen at 150ms when tapping.\r\n          # Backspace speed varies by system when holding, 30ms on fastest Macbook setting.\r\n          nowDate = Date.now()\r\n          if @aceSession.selection.isEmpty()\r\n            cursor = @ace.getCursorPosition()\r\n            line = @aceDoc.getLine(cursor.row)\r\n            if /^\\s*$/.test line.substring(0, cursor.column)\r\n              @backspaceThrottleMs ?= 500\r\n              # console.log \"SpellView @backspaceThrottleMs=#{@backspaceThrottleMs}\"\r\n              # console.log 'SpellView lastBackspace diff', nowDate - @lastBackspace if @lastBackspace?\r\n              if not @lastBackspace? or nowDate - @lastBackspace > @backspaceThrottleMs\r\n                @backspaceThrottleMs = 100\r\n                @lastBackspace = nowDate\r\n                @ace.remove \"left\"\r\n              return\r\n          @backspaceThrottleMs = null\r\n          @lastBackspace = nowDate\r\n          @ace.remove \"left\"\r\n\r\n\r\n  hookACECustomBehavior: ->\r\n    aceConfig = me.get('aceConfig') ? {}\r\n    @ace.commands.on 'exec', (e) =>\r\n      # When pressing enter with an active selection, just make a new line under it.\r\n      if e.command.name is 'enter-skip-delimiters'\r\n        selection = @ace.selection.getRange()\r\n        unless selection.start.column is selection.end.column and selection.start.row is selection.end.row\r\n          e.editor.execCommand 'gotolineend'\r\n          return true\r\n\r\n    # Add visual indent guides\r\n    language = @spell.language\r\n    ensureLineStartsBlock = (line) ->\r\n      return false unless language is \"python\"\r\n      match = /^\\s*([^#]+)/.exec(line)\r\n      return false if not match?\r\n      return /:\\s*$/.test(match[1])\r\n\r\n    @aceSession.addDynamicMarker\r\n      update: (html, markerLayer, session, config) =>\r\n        Range = ace.require('ace/range').Range\r\n\r\n        foldWidgets = @aceSession.foldWidgets\r\n        return if not foldWidgets?\r\n\r\n        lines = @aceDoc.getAllLines()\r\n        startOfRow = (r) ->\r\n          str = lines[r]\r\n          ar = str.match(/^\\s*/)\r\n          ar.pop().length\r\n\r\n        colors = [{border: '74,144,226', fill: '108,162,226'}, {border: '132,180,235', fill: '230,237,245'}]\r\n\r\n        for row in [0..@aceSession.getLength()]\r\n          foldWidgets[row] = @aceSession.getFoldWidget(row) unless foldWidgets[row]?\r\n          continue unless foldWidgets? and foldWidgets[row] is \"start\"\r\n          try\r\n            docRange = @aceSession.getFoldWidgetRange(row)\r\n          catch error\r\n            console.warn \"Couldn't find fold widget docRange for row #{row}:\", error\r\n          if not docRange?\r\n            guess = startOfRow(row)\r\n            docRange = new Range(row,guess,row,guess+4)\r\n\r\n          continue unless ensureLineStartsBlock(lines[row])\r\n\r\n          if /^\\s+$/.test lines[docRange.end.row+1]\r\n            docRange.end.row += 1\r\n\r\n          xstart = startOfRow(row)\r\n          if language is 'python'\r\n            requiredIndent = new RegExp '^' + new Array(Math.floor(xstart / 4 + 1)).join('(    |\\t)') + '(    |\\t)+(\\\\S|\\\\s*$)'\r\n            for crow in [docRange.start.row+1..docRange.end.row]\r\n              unless requiredIndent.test lines[crow]\r\n                docRange.end.row = crow - 1\r\n                break\r\n\r\n          rstart = @aceSession.documentToScreenPosition docRange.start.row, docRange.start.column\r\n          rend = @aceSession.documentToScreenPosition docRange.end.row, docRange.end.column\r\n          range = new Range rstart.row, rstart.column, rend.row, rend.column\r\n          level = Math.floor(xstart / 4)\r\n          color = colors[level % colors.length]\r\n          bw = 3\r\n          to = markerLayer.$getTop(range.start.row, config)\r\n          t = markerLayer.$getTop(range.start.row + 1, config)\r\n          h = config.lineHeight * (range.end.row - range.start.row)\r\n          l = markerLayer.$padding + xstart * config.characterWidth\r\n          # w = (data.i - data.b) * config.characterWidth\r\n          w = 4 * config.characterWidth\r\n          fw = config.characterWidth * ( @aceSession.getScreenLastRowColumn(range.start.row) - xstart )\r\n\r\n          html.push \"\"\"\r\n            <div style=\r\n              \"position: absolute; top: #{to}px; left: #{l}px; width: #{fw+bw}px; height: #{config.lineHeight}px;\r\n               border: #{bw}px solid rgba(#{color.border},1); border-left: none;\"\r\n            ></div>\r\n            <div style=\r\n              \"position: absolute; top: #{t}px; left: #{l}px; width: #{w}px; height: #{h}px; background-color: rgba(#{color.fill},0.5);\r\n               border-right: #{bw}px solid rgba(#{color.border},1); border-bottom: #{bw}px solid rgba(#{color.border},1);\"\r\n            ></div>\r\n          \"\"\"\r\n\r\n  fillACE: ->\r\n    @ace.setValue @spell.source\r\n    @aceSession.setUndoManager(new UndoManager())\r\n    @ace.clearSelection()\r\n\r\n  lockDefaultCode: (force=false) ->\r\n    # TODO: Lock default indent for an empty line?\r\n    lockDefaultCode = @options.level.get('lockDefaultCode') or false\r\n    if not lockDefaultCode or (_.isNumber(lockDefaultCode) and lockDefaultCode < me.level())\r\n      return\r\n    return unless @spell.source is @spell.originalSource or force\r\n    return if @isIE()  # Temporary workaround for #2512\r\n    aceConfig = me.get('aceConfig') ? {}\r\n    return if aceConfig.keyBindings and aceConfig.keyBindings isnt 'default'  # Don't lock in vim/emacs mode\r\n\r\n    console.info 'Locking down default code.'\r\n\r\n    intersects = =>\r\n      return true for range in @readOnlyRanges when @ace.getSelectionRange().intersects(range)\r\n      false\r\n\r\n    intersectsLeft = =>\r\n      leftRange = @ace.getSelectionRange().clone()\r\n      if leftRange.start.column > 0\r\n        leftRange.setStart leftRange.start.row, leftRange.start.column - 1\r\n      else if leftRange.start.row > 0\r\n        leftRange.setStart leftRange.start.row - 1, 0\r\n      return true for range in @readOnlyRanges when leftRange.intersects(range)\r\n      false\r\n\r\n    intersectsRight = =>\r\n      rightRange = @ace.getSelectionRange().clone()\r\n      if rightRange.end.column < @aceDoc.getLine(rightRange.end.row).length\r\n        rightRange.setEnd rightRange.end.row, rightRange.end.column + 1\r\n      else if rightRange.start.row < @aceDoc.getLength() - 1\r\n        rightRange.setEnd rightRange.end.row + 1, 0\r\n      return true for range in @readOnlyRanges when rightRange.intersects(range)\r\n      false\r\n\r\n    pulseLockedCode = ->\r\n      $('.locked-code').finish().addClass('pulsating').effect('shake', times: 1, distance: 2, direction: 'down').removeClass('pulsating')\r\n\r\n    preventReadonly = (next) ->\r\n      if intersects()\r\n        pulseLockedCode()\r\n        return true\r\n      next?()\r\n\r\n    interceptCommand = (obj, method, wrapper) ->\r\n      orig = obj[method]\r\n      obj[method] = ->\r\n        args = Array.prototype.slice.call arguments\r\n        wrapper => orig.apply obj, args\r\n      obj[method]\r\n\r\n    finishRange = (row, startRow, startColumn) =>\r\n      range = new Range startRow, startColumn, row, @aceSession.getLine(row).length - 1\r\n      range.start = @aceDoc.createAnchor range.start\r\n      range.end = @aceDoc.createAnchor range.end\r\n      range.end.$insertRight = true\r\n      @readOnlyRanges.push range\r\n\r\n    # Remove previous locked code highlighting\r\n    if @lockedCodeMarkerIDs?\r\n      @aceSession.removeMarker marker for marker in @lockedCodeMarkerIDs\r\n    @lockedCodeMarkerIDs = []\r\n\r\n    # Create locked default code text ranges\r\n    @readOnlyRanges = []\r\n    if @spell.language in ['python', 'coffeescript']\r\n      # Lock contiguous section of default code\r\n      # Only works for languages without closing delimeters on blocks currently\r\n      lines = @aceDoc.getAllLines()\r\n      for line, row in lines when not /^\\s*$/.test(line)\r\n        lastRow = row\r\n      if lastRow?\r\n        @readOnlyRanges.push new Range 0, 0, lastRow, lines[lastRow].length - 1\r\n\r\n    # TODO: Highlighting does not work for multiple ranges\r\n    # TODO: Everything looks correct except the actual result.\r\n    # TODO: https://github.com/codecombat/codecombat/issues/1852\r\n    # else\r\n    #   # Create a read-only range for each chunk of text not separated by an empty line\r\n    #   startRow = startColumn = null\r\n    #   for row in [0...@aceSession.getLength()]\r\n    #     unless /^\\s*$/.test @aceSession.getLine(row)\r\n    #       unless startRow? and startColumn?\r\n    #         startRow = row\r\n    #         startColumn = 0\r\n    #     else\r\n    #       if startRow? and startColumn?\r\n    #         finishRange row - 1, startRow, startColumn\r\n    #         startRow = startColumn = null\r\n    #   if startRow? and startColumn?\r\n    #     finishRange @aceSession.getLength() - 1, startRow, startColumn\r\n\r\n    # Highlight locked ranges\r\n    for range in @readOnlyRanges\r\n      @lockedCodeMarkerIDs.push @aceSession.addMarker range, 'locked-code', 'fullLine'\r\n\r\n    # Override write operations that intersect with default code\r\n    interceptCommand @ace, 'onPaste', preventReadonly\r\n    interceptCommand @ace, 'onCut', preventReadonly\r\n    # TODO: can we use interceptCommand for this too?  'exec' and 'onExec' did not work.\r\n    @ace.commands.on 'exec', (e) =>\r\n      e.stopPropagation()\r\n      e.preventDefault()\r\n      if (e.command.name is 'insertstring' and intersects()) or\r\n         (e.command.name in ['Backspace', 'throttle-backspaces'] and intersectsLeft()) or\r\n         (e.command.name is 'del' and intersectsRight())\r\n        @autocomplete?.off?()\r\n        pulseLockedCode()\r\n        return false\r\n      else if e.command.name in ['enter-skip-delimiters', 'Enter', 'Return']\r\n        if intersects()\r\n          e.editor.navigateDown 1\r\n          e.editor.navigateLineStart()\r\n          return false\r\n        else if e.command.name in ['Enter', 'Return'] and not e.editor?.completer?.popup?.isOpen\r\n          @autocomplete?.on?()\r\n          return e.editor.execCommand 'enter-skip-delimiters'\r\n      @autocomplete?.on?()\r\n      e.command.exec e.editor, e.args or {}\r\n\r\n  initAutocomplete: (@autocompleteOn) ->\r\n    # TODO: Turn on more autocompletion based on level sophistication\r\n    # TODO: E.g. using the language default snippets yields a bunch of crazy non-beginner suggestions\r\n    # TODO: Options logic shouldn't exist both here and in updateAutocomplete()\r\n    return if @spell.language is 'html'\r\n    popupFontSizePx = @options.level.get('autocompleteFontSizePx') ? 16\r\n    @autocomplete = new Autocomplete @ace,\r\n      basic: false\r\n      liveCompletion: false\r\n      snippetsLangDefaults: false\r\n      completers:\r\n        keywords: false\r\n        snippets: @autocompleteOn\r\n      autoLineEndings:\r\n        javascript: ';'\r\n      popupFontSizePx: popupFontSizePx\r\n      popupLineHeightPx: 1.5 * popupFontSizePx\r\n      popupWidthPx: 380\r\n\r\n  updateAutocomplete: (@autocompleteOn) ->\r\n    @autocomplete?.set 'snippets', @autocompleteOn\r\n\r\n  addAutocompleteSnippets: (e) ->\r\n    # Snippet entry format:\r\n    # content: code inserted into document\r\n    # meta: displayed right-justfied in popup\r\n    # name: displayed left-justified in popup, and what's being matched\r\n    # tabTrigger: fallback for name field\r\n    return unless @autocomplete and @autocompleteOn\r\n    @autocomplete.addCodeCombatSnippets @options.level, @, e\r\n\r\n  translateFindNearest: ->\r\n    # If they have advanced glasses but are playing a level which assumes earlier glasses, we'll adjust the sample code to use the more advanced APIs instead.\r\n    oldSource = @getSource()\r\n    newSource = oldSource.replace /(self:|self.|this.|@)findNearestEnemy\\(\\)/g, \"$1findNearest($1findEnemies())\"\r\n    newSource = newSource.replace /(self:|self.|this.|@)findNearestItem\\(\\)/g, \"$1findNearest($1findItems())\"\r\n    return if oldSource is newSource\r\n    @spell.originalSource = newSource\r\n    @updateACEText newSource\r\n    _.delay (=> @recompile?()), 1000\r\n\r\n  createFirepad: ->\r\n    # Currently not called; could be brought back for future multiplayer modes.\r\n    # Load from firebase or the original source if there's nothing there.\r\n    return if @firepadLoading\r\n    @eventsSuppressed = true\r\n    @loaded = false\r\n    @previousSource = @ace.getValue()\r\n    @ace.setValue('')\r\n    @aceSession.setUndoManager(new UndoManager())\r\n    fireURL = 'https://codecombat.firebaseio.com/' + @spell.pathComponents.join('/')\r\n    @fireRef = new Firebase fireURL\r\n    firepadOptions = userId: me.id\r\n    @firepad = Firepad.fromACE @fireRef, @ace, firepadOptions\r\n    @firepadLoading = true\r\n    @firepad.on 'ready', =>\r\n      return if @destroyed\r\n      @firepadLoading = false\r\n      firepadSource = @ace.getValue()\r\n      if firepadSource\r\n        @spell.source = firepadSource\r\n      else\r\n        @ace.setValue @previousSource\r\n        @aceSession.setUndoManager(new UndoManager())\r\n        @ace.clearSelection()\r\n      @onAllLoaded()\r\n\r\n  onAllLoaded: =>\r\n    @spell.transpile @spell.source\r\n    @spell.loaded = true\r\n    Backbone.Mediator.publish 'tome:spell-loaded', spell: @spell\r\n    @eventsSuppressed = false  # Now that the initial change is in, we can start running any changed code\r\n    @createToolbarView()\r\n    @updateHTML create: true if @options.level.isType('web-dev')\r\n\r\n  createDebugView: ->\r\n    return if @options.level.isType('hero', 'hero-ladder', 'hero-coop', 'course', 'course-ladder', 'game-dev', 'web-dev')  # We'll turn this on later, maybe, but not yet.\r\n    @debugView = new SpellDebugView ace: @ace, thang: @thang, spell:@spell\r\n    @$el.append @debugView.render().$el.hide()\r\n\r\n  createTranslationView: ->\r\n    @translationView = new SpellTranslationView { @ace, @supermodel }\r\n    @$el.append @translationView.render().$el.hide()\r\n\r\n  createToolbarView: ->\r\n    @toolbarView = new SpellToolbarView ace: @ace\r\n    @$el.append @toolbarView.render().$el\r\n\r\n  onMouseOut: (e) ->\r\n    @debugView?.onMouseOut e\r\n\r\n  onContactButtonPressed: (e) ->\r\n    @saveSpade()\r\n\r\n  getSource: ->\r\n    @ace.getValue()\r\n\r\n  setThang: (thang) ->\r\n    @focus()\r\n    @lastScreenLineCount = null\r\n    @updateLines()\r\n    return if thang.id is @thang?.id\r\n    @thang = thang\r\n    @spellThang = @spell.thang\r\n    @createDebugView() unless @debugView\r\n    @debugView?.thang = @thang\r\n    @createTranslationView() unless @translationView\r\n    @toolbarView?.toggleFlow false\r\n    @updateAether false, false\r\n    # @addAutocompleteSnippets()\r\n    @highlightCurrentLine()\r\n\r\n  cast: (preload=false, realTime=false, justBegin=false) ->\r\n    Backbone.Mediator.publish 'tome:cast-spell', { @spell, @thang, preload, realTime, justBegin }\r\n\r\n  notifySpellChanged: =>\r\n    return if @destroyed\r\n    Backbone.Mediator.publish 'tome:spell-changed', spell: @spell\r\n\r\n  notifyEditingEnded: =>\r\n    return if @destroyed or @aceDoc.undergoingFirepadOperation  # from my Firepad ACE adapter\r\n    Backbone.Mediator.publish 'tome:editing-ended', {}\r\n\r\n  notifyEditingBegan: =>\r\n    return if @destroyed or @aceDoc.undergoingFirepadOperation  # from my Firepad ACE adapter\r\n    Backbone.Mediator.publish 'tome:editing-began', {}\r\n\r\n  updateLines: =>\r\n    # Make sure there are always blank lines for the player to type on, and that the editor resizes to the height of the lines.\r\n    return if @destroyed\r\n    lineCount = @aceDoc.getLength()\r\n    lastLine = @aceDoc.$lines[lineCount - 1]\r\n    if lastLine isnt ''\r\n      cursorPosition = @ace.getCursorPosition()\r\n      wasAtEnd = cursorPosition.row is lineCount - 1 and cursorPosition.column is lastLine.length\r\n      @aceDoc.insertNewLine row: lineCount, column: 0  #lastLine.length\r\n      @ace.navigateLeft(1) if wasAtEnd\r\n      ++lineCount\r\n      # Force the popup back\r\n      @ace?.completer?.showPopup(@ace)\r\n    screenLineCount = @aceSession.getScreenLength()\r\n    if screenLineCount isnt @lastScreenLineCount\r\n      @lastScreenLineCount = screenLineCount\r\n      lineHeight = @ace.renderer.lineHeight or 20\r\n      tomeHeight = $('#tome-view').innerHeight()\r\n      spellTopBarHeight = $('#spell-top-bar-view').outerHeight()\r\n      spellToolbarHeight = $('.spell-toolbar-view').outerHeight()\r\n      @spellPaletteHeight ?= 75\r\n      spellPaletteAllowedHeight = Math.min @spellPaletteHeight, tomeHeight / 3\r\n      maxHeight = tomeHeight - spellTopBarHeight - spellToolbarHeight - spellPaletteAllowedHeight\r\n      minHeight = Math.max 8, (Math.min($(\"#canvas-wrapper\").outerHeight(),$(\"#level-view\").innerHeight() - 175) / lineHeight) - 2\r\n      linesAtMaxHeight = Math.floor(maxHeight / lineHeight)\r\n      lines = Math.max minHeight, Math.min(screenLineCount + 2, linesAtMaxHeight)\r\n      # 2 lines buffer is nice\r\n      @ace.setOptions minLines: lines, maxLines: lines\r\n      # Move spell palette up, slightly overlapping us.\r\n      newTop = 185 + lineHeight * lines\r\n      #spellPaletteView.css('top', newTop)\r\n      # Expand it to bottom of tome if too short.\r\n      #newHeight = Math.max @spellPaletteHeight, tomeHeight - newTop + 10\r\n      #spellPaletteView.css('height', newHeight) if @spellPaletteHeight isnt newHeight\r\n\r\n  hideProblemAlert: ->\r\n    return if @destroyed\r\n    Backbone.Mediator.publish 'tome:hide-problem-alert', {}\r\n\r\n  saveSpade: =>\r\n    return if @destroyed or not @spade\r\n    spadeEvents = @spade.compile()\r\n    # Uncomment the below line for a debug panel to display inside the level\r\n    #@spade.debugPlay(spadeEvents)\r\n    condensedEvents = @spade.condense(spadeEvents)\r\n\r\n    return unless condensedEvents.length\r\n    compressedEvents = LZString.compressToUTF16(JSON.stringify(condensedEvents))\r\n\r\n    codeLog = new CodeLog({\r\n      sessionID: @options.session.id\r\n      level:\r\n        original: @options.level.get 'original'\r\n        majorVersion: (@options.level.get 'version').major\r\n      levelSlug: @options.level.get 'slug'\r\n      userID: @options.session.get 'creator'\r\n      log: compressedEvents\r\n    })\r\n\r\n    codeLog.save()\r\n\r\n  onShowVictory: (e) ->\r\n    if @saveSpadeTimeout?\r\n      window.clearTimeout @saveSpadeTimeout\r\n      @saveSpadeTimeout = null\r\n\r\n  onManualCast: (e) ->\r\n    cast = @$el.parent().length\r\n    @recompile cast, e.realTime\r\n    @focus() if cast\r\n    if @options.level.isType('web-dev')\r\n      @sourceAtLastCast = @getSource()\r\n      @ace.setStyle 'spell-cast'\r\n      @updateHTML create: true\r\n\r\n  reloadCode: (cast=true) ->\r\n    @spell.reloadCode() if cast\r\n    @thang = @spell.thang.thang\r\n    @updateACEText @spell.originalSource\r\n    @lockDefaultCode true\r\n    @recompile cast\r\n    Backbone.Mediator.publish 'tome:spell-loaded', spell: @spell\r\n    @updateLines()\r\n\r\n  recompile: (cast=true, realTime=false) ->\r\n    hasChanged = @spell.source isnt @getSource()\r\n    if hasChanged\r\n      @spell.transpile @getSource()\r\n      @updateAether true, false\r\n    if cast  #and (hasChanged or realTime)  # just always cast now\r\n      @cast(false, realTime)\r\n    if hasChanged\r\n      @notifySpellChanged()\r\n\r\n  updateACEText: (source) ->\r\n    @eventsSuppressed = true\r\n    if @firepad\r\n      @firepad.setText source\r\n    else\r\n      @ace.setValue source\r\n      @aceSession.setUndoManager(new UndoManager())\r\n    @eventsSuppressed = false\r\n    try\r\n      @ace.resize true  # hack: @ace may not have updated its text properly, so we force it to refresh\r\n    catch error\r\n      console.warn 'Error resizing ACE after an update:', error\r\n\r\n  createOnCodeChangeHandlers: ->\r\n    @aceDoc.removeListener 'change', @onCodeChangeMetaHandler if @onCodeChangeMetaHandler\r\n    onSignificantChange = []\r\n    onAnyChange = [\r\n      _.debounce @updateAether, if @options.level.isType('game-dev') then 10 else 500\r\n      _.debounce @notifyEditingEnded, 1000\r\n      _.throttle @notifyEditingBegan, 250\r\n      _.throttle @notifySpellChanged, 300\r\n      _.throttle @updateLines, 500\r\n      _.throttle @hideProblemAlert, 500\r\n    ]\r\n    onSignificantChange.push _.debounce @checkRequiredCode, 750 if @options.level.get 'requiredCode'\r\n    onSignificantChange.push _.debounce @checkSuspectCode, 750 if @options.level.get 'suspectCode'\r\n    onAnyChange.push _.throttle @updateHTML, 10 if @options.level.isType('web-dev')\r\n\r\n    @onCodeChangeMetaHandler = =>\r\n      return if @eventsSuppressed\r\n      #@playSound 'code-change', volume: 0.5  # Currently not using this sound.\r\n      if @spellThang\r\n        @spell.hasChangedSignificantly @getSource(), @spellThang.aether.raw, (hasChanged) =>\r\n          if not @spellThang or hasChanged\r\n            callback() for callback in onSignificantChange  # Do these first\r\n          callback() for callback in onAnyChange  # Then these\r\n    @aceDoc.on 'change', @onCodeChangeMetaHandler\r\n\r\n  onCursorActivity: =>  # Used to refresh autocast delay; doesn't do anything at the moment.\r\n\r\n  updateHTML: (options={}) =>\r\n    # TODO: Merge with onSpellChanged\r\n    # NOTE: Consider what goes in onManualCast only\r\n    if @spell.hasChanged(@spell.getSource(), @sourceAtLastCast)\r\n      @ace.unsetStyle 'spell-cast' # NOTE: Doesn't do anything for web-dev as of this writing, including for consistency\r\n    @clearWebDevErrors()\r\n    Backbone.Mediator.publish 'tome:html-updated', html: @spell.constructHTML(@getSource()), create: Boolean(options.create)\r\n\r\n  # Design for a simpler system?\r\n  # * Keep Aether linting, debounced, on any significant change\r\n  # - All problems just vanish when you make any change to the code\r\n  # * You wouldn't accept any Aether updates/runtime information/errors unless its code was current when you got it\r\n  # * Store the last run Aether in each spellThang and use it whenever its code actually is current.\r\n  #   Use dynamic markers for problem ranges and keep annotations/alerts in when insignificant\r\n  #   changes happen, but always treat any change in the (trimmed) number of lines as a significant change.\r\n  # - All problems have a master representation as a Problem, and we can easily generate all Problems from\r\n  #   any Aether instance. Then when we switch contexts in any way, we clear, recreate, and reapply the Problems.\r\n  # * Problem alerts have their own templated ProblemAlertViews.\r\n  # * We'll only show the first problem alert, and it will always be at the bottom.\r\n  #   Annotations and problem ranges can show all, I guess.\r\n  # * The editor will reserve space for one annotation as a codeless area.\r\n  # - Problem alerts and ranges will only show on fully cast worlds. Annotations will show continually.\r\n\r\n  updateAether: (force=false, fromCodeChange=true) =>\r\n    # Depending on whether we have any code changes, significant code changes, or have switched\r\n    # to a new spellThang, we may want to refresh our Aether display.\r\n    return unless aether = @spellThang?.aether\r\n    source = @getSource()\r\n    @spell.hasChangedSignificantly source, aether.raw, (hasChanged) =>\r\n      codeHasChangedSignificantly = force or hasChanged\r\n      needsUpdate = codeHasChangedSignificantly or @spellThang isnt @lastUpdatedAetherSpellThang\r\n      return if not needsUpdate and aether is @displayedAether\r\n      castAether = @spellThang.castAether\r\n      codeIsAsCast = castAether and source is castAether.raw\r\n      aether = castAether if codeIsAsCast\r\n      return if not needsUpdate and aether is @displayedAether\r\n\r\n      # Now that that's figured out, perform the update.\r\n      # The web worker Aether won't track state, so don't have to worry about updating it\r\n      finishUpdatingAether = (aether) =>\r\n        @clearAetherDisplay() # In case problems were added since last clearing\r\n        @displayAether aether, codeIsAsCast\r\n        @lastUpdatedAetherSpellThang = @spellThang\r\n        @guessWhetherFinished aether if fromCodeChange\r\n\r\n      @clearAetherDisplay()\r\n      if codeHasChangedSignificantly and not codeIsAsCast\r\n        if @worker\r\n          workerMessage =\r\n            function: 'transpile'\r\n            spellKey: @spell.spellKey\r\n            source: source\r\n\r\n          @worker.addEventListener 'message', (e) =>\r\n            workerData = JSON.parse e.data\r\n            if workerData.function is 'transpile' and workerData.spellKey is @spell.spellKey\r\n              @worker.removeEventListener 'message', arguments.callee, false\r\n              aether.problems = workerData.problems\r\n              aether.raw = source\r\n              finishUpdatingAether(aether)\r\n          @worker.postMessage JSON.stringify(workerMessage)\r\n        else\r\n          aether.transpile source\r\n          finishUpdatingAether(aether)\r\n      else\r\n        finishUpdatingAether(aether)\r\n\r\n  # Each problem-generating piece (aether, web-dev, ace html worker) clears its own problems/annotations\r\n  clearAetherDisplay: ->\r\n    @clearProblemsCreatedBy 'aether'\r\n    @highlightCurrentLine {}  # This'll remove all highlights\r\n\r\n  clearWebDevErrors: ->\r\n    @clearProblemsCreatedBy 'web-dev-iframe'\r\n\r\n  clearProblemsCreatedBy: (createdBy) ->\r\n    nonAetherAnnotations = _.reject @aceSession.getAnnotations(), (annotation) -> annotation.createdBy is createdBy\r\n    @reallySetAnnotations nonAetherAnnotations\r\n\r\n    problemsToClear = _.filter @problems, (p) -> p.createdBy is createdBy\r\n    problemsToClear.forEach (problem) -> problem.destroy()\r\n    @problems = _.difference @problems, problemsToClear\r\n    Backbone.Mediator.publish 'tome:problems-updated', spell: @spell, problems: @problems, isCast: false\r\n\r\n  convertAetherProblems: (aether, aetherProblems, isCast) ->\r\n    # TODO: Functional-ify\r\n    _.unique(aetherProblems, (p) -> p.userInfo?.key).map (aetherProblem) =>\r\n      new Problem { aether, aetherProblem, @ace, isCast, levelID: @options.levelID }\r\n\r\n  displayAether: (aether, isCast=false) ->\r\n    @displayedAether = aether\r\n    isCast = isCast or not _.isEmpty(aether.metrics) or _.some aether.getAllProblems(), {type: 'runtime'}\r\n    annotations = @aceSession.getAnnotations()\r\n\r\n    newProblems = @convertAetherProblems(aether, aether.getAllProblems(), isCast)\r\n    annotations.push problem.annotation for problem in newProblems when problem.annotation\r\n    if isCast\r\n      @displayProblemBanner(newProblems[0]) if newProblems[0]\r\n      @saveUserCodeProblem(aether, problem.aetherProblem) for problem in newProblems\r\n    @problems = @problems.concat(newProblems)\r\n\r\n    @aceSession.setAnnotations annotations\r\n    @highlightCurrentLine aether.flow unless _.isEmpty aether.flow\r\n    #console.log '  and we could do the metrics', aether.metrics unless _.isEmpty aether.metrics\r\n    #console.log '  and we could do the style', aether.style unless _.isEmpty aether.style\r\n    #console.log '  and we could do the visualization', aether.visualization unless _.isEmpty aether.visualization\r\n    Backbone.Mediator.publish 'tome:problems-updated', spell: @spell, problems: @problems, isCast: isCast\r\n    @ace.resize()\r\n\r\n  # Tell ProblemAlertView to display this problem (only)\r\n  displayProblemBanner: (problem) ->\r\n    lineOffsetPx = 0\r\n    if problem.row?\r\n      for i in [0...problem.row]\r\n        lineOffsetPx += @aceSession.getRowLength(i) * @ace.renderer.lineHeight\r\n      lineOffsetPx -= @ace.session.getScrollTop()\r\n    Backbone.Mediator.publish 'tome:show-problem-alert', problem: problem, lineOffsetPx: Math.max lineOffsetPx, 0\r\n\r\n  # Gets the number of lines before the start of <script> content in the usercode\r\n  # Because Errors report their line number relative to the <script> tag\r\n  linesBeforeScript: (html) ->\r\n    # TODO: refactor, make it work with multiple scripts. What to do when error is in level-creator's code?\r\n    _.size(html.split('<script>')[0].match(/\\n/g))\r\n\r\n  addAnnotation: (annotation) ->\r\n    annotations = @aceSession.getAnnotations()\r\n    annotations.push annotation\r\n    @reallySetAnnotations annotations\r\n\r\n  # Handle errors from the web-dev iframe asynchronously\r\n  onWebDevError: (error) ->\r\n    # TODO: Refactor this and the Aether problem flow to share as much as possible.\r\n    # TODO: Handle when the error is in our code, not theirs\r\n    # Compensate for line number being relative to <script> tag\r\n    offsetError = _.merge {}, error, { line: error.line + @linesBeforeScript(@getSource()) }\r\n    userCodeHasChangedSinceLastCast = @spell.hasChanged(@spell.getSource(), @sourceAtLastCast)\r\n    problem = new Problem({ error: offsetError, @ace, levelID: @options.levelID, userCodeHasChangedSinceLastCast })\r\n    # Ignore the Problem if we already know about it\r\n    if _.any(@problems, (preexistingProblem) -> problem.isEqual(preexistingProblem))\r\n      problem.destroy()\r\n    else # Ok, the problem is worth keeping\r\n      @problems.push problem\r\n      @displayProblemBanner(problem)\r\n\r\n      # @saveUserCodeProblem(aether, aetherProblem) # TODO: Enable saving of web-dev user code problems\r\n      @addAnnotation(problem.annotation) if problem.annotation\r\n      Backbone.Mediator.publish 'tome:problems-updated', spell: @spell, problems: @problems, isCast: false\r\n\r\n  onProblemsUpdated: ({ spell, problems, isCast }) ->\r\n    # This just handles some ace styles for now; other things handle @problems changes elsewhere\r\n    @ace[if problems.length then 'setStyle' else 'unsetStyle'] 'user-code-problem'\r\n    @ace[if isCast then 'setStyle' else 'unsetStyle'] 'spell-cast' # Does this still do anything?\r\n\r\n  saveUserCodeProblem: (aether, aetherProblem) ->\r\n    # Skip duplicate problems\r\n    hashValue = aether.raw + aetherProblem.message\r\n    return if hashValue of @savedProblems\r\n    @savedProblems[hashValue] = true\r\n    return unless Math.random() < 0.01  # Let's only save a tiny fraction of these during HoC to reduce writes.\r\n\r\n    # Save new problem\r\n    @userCodeProblem = new UserCodeProblem()\r\n    @userCodeProblem.set 'code', aether.raw\r\n    if aetherProblem.range\r\n      rawLines = aether.raw.split '\\n'\r\n      errorLines = rawLines.slice aetherProblem.range[0].row, aetherProblem.range[1].row + 1\r\n      @userCodeProblem.set 'codeSnippet', errorLines.join '\\n'\r\n    @userCodeProblem.set 'errHint', aetherProblem.hint if aetherProblem.hint\r\n    @userCodeProblem.set 'errId', aetherProblem.id if aetherProblem.id\r\n    @userCodeProblem.set 'errLevel', aetherProblem.level if aetherProblem.level\r\n    if aetherProblem.message\r\n      @userCodeProblem.set 'errMessage', aetherProblem.message\r\n      # Save error message without 'Line N: ' prefix\r\n      messageNoLineInfo = aetherProblem.message\r\n      if lineInfoMatch = messageNoLineInfo.match /^Line [0-9]+\\: /\r\n        messageNoLineInfo = messageNoLineInfo.slice(lineInfoMatch[0].length)\r\n      @userCodeProblem.set 'errMessageNoLineInfo', messageNoLineInfo\r\n    @userCodeProblem.set 'errRange', aetherProblem.range if aetherProblem.range\r\n    @userCodeProblem.set 'errType', aetherProblem.type if aetherProblem.type\r\n    @userCodeProblem.set 'language', aether.language.id if aether.language?.id\r\n    @userCodeProblem.set 'levelID', @options.levelID if @options.levelID\r\n    @userCodeProblem.save()\r\n    null\r\n\r\n  # Autocast (preload the world in the background):\r\n  # Goes immediately if the code is a) changed and b) complete/valid and c) the cursor is at beginning or end of a line\r\n  # We originally thought it would:\r\n  # - Go after specified delay if a) and b) but not c)\r\n  # - Go only when manually cast or deselecting a Thang when there are errors\r\n  # But the error message display was delayed, so now trying:\r\n  # - Go after specified delay if a) and not b) or c)\r\n  guessWhetherFinished: (aether) ->\r\n    valid = not aether.getAllProblems().length\r\n    return unless valid\r\n    cursorPosition = @ace.getCursorPosition()\r\n    currentLine = _.string.rtrim(@aceDoc.$lines[cursorPosition.row].replace(@singleLineCommentRegex(), ''))  # trim // unless inside \"\r\n    endOfLine = cursorPosition.column >= currentLine.length  # just typed a semicolon or brace, for example\r\n    beginningOfLine = not currentLine.substr(0, cursorPosition.column).trim().length  # uncommenting code, for example\r\n    incompleteThis = /^(s|se|sel|self|t|th|thi|this)$/.test currentLine.trim()\r\n    #console.log \"finished=#{valid and (endOfLine or beginningOfLine) and not incompleteThis}\", valid, endOfLine, beginningOfLine, incompleteThis, cursorPosition, currentLine.length, aether, new Date() - 0, currentLine\r\n    if not incompleteThis and @options.level.isType('game-dev')\r\n      # TODO: Improve gamedev autocast speed\r\n      @spell.transpile @getSource()\r\n      @cast(false, false, true)\r\n    else if (endOfLine or beginningOfLine) and not incompleteThis\r\n      @preload()\r\n\r\n  singleLineCommentRegex: ->\r\n    if @_singleLineCommentRegex\r\n      @_singleLineCommentRegex.lastIndex = 0\r\n      return @_singleLineCommentRegex\r\n    if @spell.language is 'html'\r\n      commentStart = \"#{commentStarts.html}|#{commentStarts.css}|#{commentStarts.javascript}\"\r\n    else\r\n      commentStart = commentStarts[@spell.language] or '//'\r\n    @_singleLineCommentRegex = new RegExp \"[ \\t]*(#{commentStart})[^\\\"'\\n]*\"\r\n    @_singleLineCommentRegex\r\n\r\n  singleLineCommentOnlyRegex: ->\r\n    if @_singleLineCommentOnlyRegex\r\n      @_singleLineCommentOnlyRegex.lastIndex = 0\r\n      return @_singleLineCommentOnlyRegex\r\n    @_singleLineCommentOnlyRegex = new RegExp( '^' + @singleLineCommentRegex().source)\r\n    @_singleLineCommentOnlyRegex\r\n\r\n  commentOutMyCode: ->\r\n    prefix = if @spell.language is 'javascript' then 'return;  ' else 'return  '\r\n    comment = prefix + commentStarts[@spell.language]\r\n\r\n  preload: ->\r\n    # Send this code over to the God for preloading, but don't change the cast state.\r\n    #console.log 'preload?', @spell.source.indexOf('while'), @spell.source.length, @spellThang?.castAether?.metrics?.statementsExecuted\r\n    return if @spell.source.indexOf('while') isnt -1  # If they're working with while-loops, it's more likely to be an incomplete infinite loop, so don't preload.\r\n    return if @spell.source.length > 500  # Only preload on really short methods\r\n    return if @spellThang?.castAether?.metrics?.statementsExecuted > 2000  # Don't preload if they are running significant amounts of user code\r\n    return if @options.level.isType('web-dev')\r\n    oldSource = @spell.source\r\n    oldSpellThangAether = @spell.thang?.aether.serialize()\r\n    @spell.transpile @getSource()\r\n    @cast true\r\n    @spell.source = oldSource\r\n    for key, value of oldSpellThangAether\r\n      @spell.thang.aether[key] = value\r\n\r\n  onSpellChanged: (e) ->\r\n    # TODO: Merge with updateHTML\r\n    @spellHasChanged = true\r\n\r\n  onAceMouseOut: (e) ->\r\n    Backbone.Mediator.publish(\"web-dev:stop-hovering-line\")\r\n\r\n  onAceMouseMove: (e) =>\r\n    return if @destroyed\r\n    row = e.getDocumentPosition().row\r\n    return if row is @lastRowHovered # Don't spam repeated messages for the same line\r\n    @lastRowHovered = row\r\n    line = @aceSession.getLine(row)\r\n    Backbone.Mediator.publish(\"web-dev:hover-line\", { row: row, line })\r\n    null\r\n\r\n  onSessionWillSave: (e) ->\r\n    return unless @spellHasChanged and me.isAdmin()\r\n    setTimeout(=>\r\n      unless @destroyed or @spellHasChanged\r\n        @$el.find('.save-status').finish().show().fadeOut(2000)\r\n    , 1000)\r\n    @spellHasChanged = false\r\n\r\n  onUserCodeProblem: (e) ->\r\n    return unless e.god is @options.god\r\n    return @onInfiniteLoop e if e.problem.id is 'runtime_InfiniteLoop'\r\n    return unless e.problem.userInfo.methodName is @spell.name\r\n    return unless @spell.thang?.thang.id is e.problem.userInfo.thangID\r\n    @spell.hasChangedSignificantly @getSource(), null, (hasChanged) =>\r\n      return if hasChanged\r\n      @spell.thang.aether.addProblem e.problem\r\n      @lastUpdatedAetherSpellThang = null  # force a refresh without a re-transpile\r\n      @updateAether false, false\r\n\r\n  onNonUserCodeProblem: (e) ->\r\n    return unless e.god is @options.god\r\n    return unless @spellThang\r\n    problem = @spellThang.aether.createUserCodeProblem type: 'runtime', kind: 'Unhandled', message: \"Unhandled error: #{e.problem.message}\"\r\n    @spellThang.aether.addProblem problem\r\n    @spellThang.castAether?.addProblem problem\r\n    @lastUpdatedAetherSpellThang = null  # force a refresh without a re-transpile\r\n    @updateAether false, false  # TODO: doesn't work, error doesn't display\r\n\r\n  onInfiniteLoop: (e) ->\r\n    return unless @spellThang\r\n    @spellThang.aether.addProblem e.problem\r\n    @spellThang.castAether?.addProblem e.problem\r\n    @lastUpdatedAetherSpellThang = null  # force a refresh without a re-transpile\r\n    @updateAether false, false\r\n\r\n  onNewWorld: (e) ->\r\n    if thang = e.world.getThangByID @spell.thang?.thang.id\r\n      aether = e.world.userCodeMap[thang.id]?[@spell.name]\r\n      @spell.thang.castAether = aether\r\n      @spell.thang.aether = @spell.createAether thang\r\n      #console.log thang.id, @spell.spellKey, 'ran', aether.metrics.callsExecuted, 'times over', aether.metrics.statementsExecuted, 'statements, with max recursion depth', aether.metrics.maxDepth, 'and full flow/metrics', aether.metrics, aether.flow\r\n    else\r\n      @spell.thang = null\r\n\r\n    @spell.transpile()  # TODO: is there any way we can avoid doing this if it hasn't changed? Causes a slight hang.\r\n    @updateAether false, false\r\n\r\n  # --------------------------------------------------------------------------------------------------\r\n\r\n  focus: ->\r\n    # TODO: it's a hack checking if a modal is visible; the events should be removed somehow\r\n    # but this view is not part of the normal subview destroying because of how it's swapped\r\n    return unless @controlsEnabled and @writable and $('.modal:visible').length is 0\r\n    return if @ace.isFocused()\r\n    @ace.focus()\r\n    @ace.clearSelection()\r\n\r\n  onFrameChanged: (e) ->\r\n    return unless @spellThang and e.selectedThang?.id is @spellThang?.thang.id\r\n    @thang = e.selectedThang  # update our thang to the current version\r\n    @highlightCurrentLine()\r\n\r\n  onCoordinateSelected: (e) ->\r\n    return unless @ace.isFocused() and e.x? and e.y?\r\n    if @spell.language is 'python'\r\n      @ace.insert \"{\\\"x\\\": #{e.x}, \\\"y\\\": #{e.y}}\"\r\n    else if @spell.language is 'lua'\r\n      @ace.insert \"{x=#{e.x}, y=#{e.y}}\"\r\n    else\r\n      @ace.insert \"{x: #{e.x}, y: #{e.y}}\"\r\n    @highlightCurrentLine()\r\n\r\n  onStatementIndexUpdated: (e) ->\r\n    return unless e.ace is @ace\r\n    @highlightCurrentLine()\r\n\r\n  highlightCurrentLine: (flow) =>\r\n    # TODO: move this whole thing into SpellDebugView or somewhere?\r\n    @highlightEntryPoints() unless @destroyed\r\n    flow ?= @spellThang?.castAether?.flow\r\n    return unless flow and @thang\r\n    executed = []\r\n    executedRows = {}\r\n    matched = false\r\n    states = flow.states ? []\r\n    currentCallIndex = null\r\n    for callState, callNumber in states\r\n      if not currentCallIndex? and callState.userInfo?.time > @thang.world.age\r\n        currentCallIndex = callNumber - 1\r\n      if matched\r\n        executed.pop()\r\n        break\r\n      executed.push []\r\n      for state, statementNumber in callState.statements\r\n        if state.userInfo?.time > @thang.world.age\r\n          matched = true\r\n          break\r\n        _.last(executed).push state\r\n        executedRows[state.range[0].row] = true\r\n    #state.executing = true if state.userInfo?.time is @thang.world.age  # no work\r\n    currentCallIndex ?= callNumber - 1\r\n    #console.log 'got call index', currentCallIndex, 'for time', @thang.world.age, 'out of', states.length\r\n\r\n    @decoratedGutter = @decoratedGutter || {}\r\n\r\n    # TODO: don't redo the markers if they haven't actually changed\r\n    for markerRange in (@markerRanges ?= [])\r\n      markerRange.start.detach()\r\n      markerRange.end.detach()\r\n      @aceSession.removeMarker markerRange.id\r\n    @markerRanges = []\r\n    for row in [0 ... @aceSession.getLength()]\r\n      unless executedRows[row]\r\n        @aceSession.removeGutterDecoration row, 'executing'\r\n        @aceSession.removeGutterDecoration row, 'executed'\r\n        @decoratedGutter[row] = ''\r\n    lastExecuted = _.last executed\r\n    showToolbarView = executed.length and @spellThang.castAether.metrics.statementsExecuted > 3 and not @options.level.get 'hidesCodeToolbar'  # Hide for a while\r\n    showToolbarView = false  # TODO: fix toolbar styling in new design to have some space for it\r\n\r\n    if showToolbarView\r\n      statementIndex = Math.max 0, lastExecuted.length - 1\r\n      @toolbarView?.toggleFlow true\r\n      @toolbarView?.setCallState states[currentCallIndex], statementIndex, currentCallIndex, @spellThang.castAether.metrics\r\n      lastExecuted = lastExecuted[0 .. @toolbarView.statementIndex] if @toolbarView?.statementIndex?\r\n    else\r\n      @toolbarView?.toggleFlow false\r\n      @debugView?.setVariableStates {}\r\n    marked = {}\r\n    gotVariableStates = false\r\n    for state, i in lastExecuted ? []\r\n      [start, end] = state.range\r\n      clazz = if i is lastExecuted.length - 1 then 'executing' else 'executed'\r\n      if clazz is 'executed'\r\n        continue if marked[start.row]\r\n        marked[start.row] = true\r\n        markerType = 'fullLine'\r\n      else\r\n        @debugView?.setVariableStates state.variables\r\n        gotVariableStates = true\r\n        markerType = 'text'\r\n      markerRange = new Range start.row, start.col, end.row, end.col\r\n      markerRange.start = @aceDoc.createAnchor markerRange.start\r\n      markerRange.end = @aceDoc.createAnchor markerRange.end\r\n      markerRange.id = @aceSession.addMarker markerRange, clazz, markerType\r\n      @markerRanges.push markerRange\r\n      if executedRows[start.row] and @decoratedGutter[start.row] isnt clazz\r\n        @aceSession.removeGutterDecoration start.row, @decoratedGutter[start.row] if @decoratedGutter[start.row] isnt ''\r\n        @aceSession.addGutterDecoration start.row, clazz\r\n        @decoratedGutter[start.row] = clazz\r\n        Backbone.Mediator.publish(\"tome:highlight-line\", line:start.row) if application.isIPadApp\r\n    @debugView?.setVariableStates {} unless gotVariableStates\r\n    null\r\n\r\n  highlightEntryPoints: ->\r\n    # Put a yellow arrow in the gutter pointing to each place we expect them to put in code.\r\n    # Usually, this is indicated by a blank line after a comment line, except for the first comment lines.\r\n    # If we need to indicate an entry point on a line that has code, we use ∆ in a comment on that line.\r\n    # If the entry point line has been changed (beyond the most basic shifted lines), we don't point it out.\r\n    lines = @aceDoc.$lines\r\n    originalLines = @spell.originalSource.split '\\n'\r\n    session = @aceSession\r\n    commentStart = commentStarts[@spell.language] or '//'\r\n    seenAnEntryPoint = false\r\n    previousLine = null\r\n    previousLineHadComment = false\r\n    previousLineHadCode = false\r\n    previousLineWasBlank = false\r\n    pastIntroComments = false\r\n    for line, index in lines\r\n      session.removeGutterDecoration index, 'entry-point'\r\n      session.removeGutterDecoration index, 'next-entry-point'\r\n      session.removeGutterDecoration index, \"entry-point-indent-#{i}\" for i in [0, 4, 8, 12, 16]\r\n\r\n      lineHasComment = @singleLineCommentRegex().test line\r\n      lineHasCode = line.trim()[0] and not @singleLineCommentOnlyRegex().test line\r\n      lineIsBlank = /^[ \\t]*$/.test line\r\n      lineHasExplicitMarker = line.indexOf('∆') isnt -1\r\n\r\n      originalLine = originalLines[index]\r\n      lineHasChanged = line isnt originalLine\r\n\r\n      isEntryPoint = lineIsBlank and previousLineHadComment and not previousLineHadCode and pastIntroComments\r\n      if isEntryPoint and lineHasChanged\r\n        # It might just be that the line was shifted around by the player inserting more code.\r\n        # We also look for the unchanged comment line in a new position to find what line we're really on.\r\n        movedIndex = originalLines.indexOf previousLine\r\n        if movedIndex isnt -1 and line is originalLines[movedIndex + 1]\r\n          lineHasChanged = false\r\n        else\r\n          isEntryPoint = false\r\n\r\n      if lineHasExplicitMarker\r\n        if lineHasChanged\r\n          if originalLines.indexOf(line) isnt -1\r\n            lineHasChanged = false\r\n            isEntryPoint = true\r\n        else\r\n          isEntryPoint = true\r\n\r\n      if isEntryPoint\r\n        session.addGutterDecoration index, 'entry-point'\r\n        unless seenAnEntryPoint\r\n          session.addGutterDecoration index, 'next-entry-point'\r\n          seenAnEntryPoint = true\r\n\r\n        # Shift pointer right based on current indentation\r\n        # TODO: tabs probably need different horizontal offsets than spaces\r\n        indent = 0\r\n        indent++ while /\\s/.test(line[indent])\r\n        indent = Math.min(16, Math.floor(indent / 4) * 4)\r\n        session.addGutterDecoration index, \"entry-point-indent-#{indent}\"\r\n\r\n      previousLine = line\r\n      previousLineHadComment = lineHasComment\r\n      previousLineHadCode = lineHasCode\r\n      previousLineWasBlank = lineIsBlank\r\n      pastIntroComments ||= lineHasCode or previousLineWasBlank\r\n\r\n  onAnnotationClick: ->\r\n    # @ is the gutter element\r\n    Backbone.Mediator.publish 'tome:jiggle-problem-alert', {}\r\n\r\n  onGutterClick: =>\r\n    @ace.clearSelection()\r\n\r\n  onDisableControls: (e) -> @toggleControls e, false\r\n  onEnableControls: (e) -> @toggleControls e, @writable\r\n  toggleControls: (e, enabled) ->\r\n    return if @destroyed\r\n    return if e?.controls and not ('editor' in e.controls)\r\n    return if enabled is @controlsEnabled\r\n    @controlsEnabled = enabled and @writable\r\n    disabled = not enabled\r\n    wasFocused = @ace.isFocused()\r\n    @ace.setReadOnly disabled\r\n    @ace[if disabled then 'setStyle' else 'unsetStyle'] 'disabled'\r\n    @toggleBackground()\r\n    $('body').focus() if disabled and wasFocused\r\n\r\n  toggleBackground: =>\r\n    # TODO: make the background an actual background and do the CSS trick\r\n    # used in spell-top-bar-view.sass for disabling\r\n    background = @$el.find('img.code-background')[0]\r\n    if background.naturalWidth is 0  # not loaded yet\r\n      return _.delay @toggleBackground, 100\r\n    filters.revertImage background, 'span.code-background' if @controlsEnabled\r\n    filters.darkenImage background, 'span.code-background', 0.8 unless @controlsEnabled\r\n\r\n  onSpellBeautify: (e) ->\r\n    return unless @spellThang and (@ace.isFocused() or e.spell is @spell)\r\n    ugly = @getSource()\r\n    pretty = @spellThang.aether.beautify(ugly.replace /\\bloop\\b/g, 'while (__COCO_LOOP_CONSTRUCT__)').replace /while \\(__COCO_LOOP_CONSTRUCT__\\)/g, 'loop'\r\n    @ace.setValue pretty\r\n\r\n  onMaximizeToggled: (e) ->\r\n    _.delay (=> @resize()), 500 + 100  # Wait $level-resize-transition-time, plus a bit.\r\n\r\n  onWindowResize: (e) =>\r\n    @spellPaletteHeight = null\r\n    #$('#spell-palette-view').css 'height', 'auto'  # Let it go back to controlling its own height\r\n    _.delay (=> @resize?()), 500 + 100  # Wait $level-resize-transition-time, plus a bit.\r\n\r\n  resize: ->\r\n    @ace?.resize true\r\n    @lastScreenLineCount = null\r\n    @updateLines()\r\n\r\n  onChangeEditorConfig: (e) ->\r\n    aceConfig = me.get('aceConfig') ? {}\r\n    @ace.setDisplayIndentGuides aceConfig.indentGuides # default false\r\n    @ace.setShowInvisibles aceConfig.invisibles # default false\r\n    @ace.setKeyboardHandler @keyBindings[aceConfig.keyBindings ? 'default']\r\n    @updateAutocomplete(aceConfig.liveCompletion ? false)\r\n\r\n  onChangeLanguage: (e) ->\r\n    return unless @spell.canWrite()\r\n    @aceSession.setMode utils.aceEditModes[e.language]\r\n    @autocomplete?.set 'language', utils.aceEditModes[e.language].substr('ace/mode/')\r\n    wasDefault = @getSource() is @spell.originalSource\r\n    @spell.setLanguage e.language\r\n    @reloadCode true if wasDefault\r\n\r\n  onInsertSnippet: (e) ->\r\n    snippetCode = null\r\n    if e.doc.snippets?[e.language]?.code\r\n      snippetCode = e.doc.snippets[e.language].code\r\n    else if (e.formatted.type isnt 'snippet') and e.formatted.shortName?\r\n      snippetCode = e.formatted.shortName\r\n    return unless snippetCode?\r\n    snippetManager = ace.require('ace/snippets').snippetManager\r\n    snippetManager.insertSnippet @ace, snippetCode\r\n    return\r\n\r\n  dismiss: ->\r\n    @spell.hasChangedSignificantly @getSource(), null, (hasChanged) =>\r\n      @recompile() if hasChanged\r\n\r\n  onScriptStateChange: (e) ->\r\n    @scriptRunning = if e.currentScript is null then false else true\r\n\r\n  onPlaybackEndedChanged: (e) ->\r\n    $(@ace?.container).toggleClass 'playback-ended', e.ended\r\n\r\n  checkRequiredCode: =>\r\n    return if @destroyed\r\n    source = @getSource().replace @singleLineCommentRegex(), ''\r\n    requiredCodeFragments = @options.level.get 'requiredCode'\r\n    for requiredCodeFragment in requiredCodeFragments\r\n      # Could make this obey regular expressions like suspectCode if needed\r\n      if source.indexOf(requiredCodeFragment) is -1\r\n        @warnedCodeFragments ?= {}\r\n        unless @warnedCodeFragments[requiredCodeFragment]\r\n          Backbone.Mediator.publish 'tome:required-code-fragment-deleted', codeFragment: requiredCodeFragment\r\n        @warnedCodeFragments[requiredCodeFragment] = true\r\n\r\n  checkSuspectCode: =>\r\n    return if @destroyed\r\n    source = @getSource().replace @singleLineCommentRegex(), ''\r\n    suspectCodeFragments = @options.level.get 'suspectCode'\r\n    detectedSuspectCodeFragmentNames = []\r\n    for suspectCodeFragment in suspectCodeFragments\r\n      pattern = new RegExp suspectCodeFragment.pattern, 'm'\r\n      if pattern.test source\r\n        @warnedCodeFragments ?= {}\r\n        unless @warnedCodeFragments[suspectCodeFragment.name]\r\n          Backbone.Mediator.publish 'tome:suspect-code-fragment-added', codeFragment: suspectCodeFragment.name, codeLanguage: @spell.language\r\n        @warnedCodeFragments[suspectCodeFragment.name] = true\r\n        detectedSuspectCodeFragmentNames.push suspectCodeFragment.name\r\n    for lastDetectedSuspectCodeFragmentName in @lastDetectedSuspectCodeFragmentNames ? []\r\n      unless lastDetectedSuspectCodeFragmentName in detectedSuspectCodeFragmentNames\r\n        Backbone.Mediator.publish 'tome:suspect-code-fragment-deleted', codeFragment: lastDetectedSuspectCodeFragmentName, codeLanguage: @spell.language\r\n    @lastDetectedSuspectCodeFragmentNames = detectedSuspectCodeFragmentNames\r\n\r\n  destroy: ->\r\n    $(@ace?.container).find('.ace_gutter').off 'click', '.ace_error, .ace_warning, .ace_info', @onAnnotationClick\r\n    $(@ace?.container).find('.ace_gutter').off 'click', @onGutterClick\r\n    @firepad?.dispose()\r\n    @ace?.commands.removeCommand command for command in @aceCommands\r\n    @ace?.destroy()\r\n    @aceDoc?.off 'change', @onCodeChangeMetaHandler\r\n    @aceSession?.selection.off 'changeCursor', @onCursorActivity\r\n    @destroyAceEditor(@ace)\r\n    @debugView?.destroy()\r\n    @translationView?.destroy()\r\n    @toolbarView?.destroy()\r\n    @autocomplete?.addSnippets [], @editorLang if @editorLang?\r\n    $(window).off 'resize', @onWindowResize\r\n    window.clearTimeout @saveSpadeTimeout\r\n    @saveSpadeTimeout = null\r\n    super()\r\n\r\n# Note: These need to be double-escaped for insertion into regexes\r\ncommentStarts =\r\n  javascript: '//'\r\n  python: '#'\r\n  coffeescript: '#'\r\n  lua: '--'\r\n  java: '//'\r\n  html: '<!--'\r\n  css: '/\\\\*'\r\n"]}