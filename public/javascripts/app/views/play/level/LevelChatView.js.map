{"version":3,"sources":["app/views/play/level/LevelChatView.coffee"],"names":[],"mappings":"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","file":"public/javascripts/app/views/play/level/LevelChatView.js","sourcesContent":["CocoView = require 'views/core/CocoView'\r\ntemplate = require 'templates/play/level/chat'\r\n{me} = require 'core/auth'\r\nLevelBus = require 'lib/LevelBus'\r\n\r\nmodule.exports = class LevelChatView extends CocoView\r\n  id: 'level-chat-view'\r\n  template: template\r\n  open: false\r\n\r\n  events:\r\n    'keypress textarea': 'onChatKeydown'\r\n    'click i': 'onIconClick'\r\n\r\n  subscriptions:\r\n    'bus:new-message': 'onNewMessage'\r\n\r\n  constructor: (options) ->\r\n    @levelID = options.levelID\r\n    @session = options.session\r\n    # TODO: we took out session.multiplayer, so this will not fire. If we want to resurrect it, we'll of course need a new way of activating chat.\r\n    @listenTo(@session, 'change:multiplayer', @updateMultiplayerVisibility)\r\n    @sessionID = options.sessionID\r\n    @bus = LevelBus.get(@levelID, @sessionID)\r\n    super()\r\n    @regularlyClearOldMessages()\r\n    @playNoise = _.debounce(@playNoise, 100)\r\n\r\n  updateMultiplayerVisibility: ->\r\n    return unless @$el?\r\n    try\r\n      @$el.toggle Boolean @session.get('multiplayer')\r\n    catch e\r\n      console.error \"Couldn't toggle the style on the LevelChatView to #{Boolean @session.get('multiplayer')} because of an error:\", e\r\n\r\n  afterRender: ->\r\n    @chatTables = $('table', @$el)\r\n    @updateMultiplayerVisibility()\r\n\r\n  regularlyClearOldMessages: ->\r\n    @clearOldMessagesInterval = setInterval(@clearOldMessages, 5000)\r\n\r\n  clearOldMessages: =>\r\n    rows = $('.closed-chat-area tr')\r\n    for row in rows\r\n      row = $(row)\r\n      added = row.data('added')\r\n      if new Date().getTime() - added > 60 * 1000\r\n        row.fadeOut(1000, -> $(this).remove())\r\n\r\n  onNewMessage: (e) ->\r\n    @$el.show() unless e.message.system\r\n    @addOne(e.message)\r\n    @trimClosedPanel()\r\n    @playNoise() if e.message.authorID isnt me.id\r\n\r\n  playNoise: ->\r\n    @playSound 'chat_received'\r\n\r\n  messageObjectToJQuery: (message) ->\r\n    td = $('<td></td>')\r\n    content = message.content\r\n    content = _.string.escapeHTML(content)\r\n    content = content.replace(/\\n/g, '<br/>')\r\n    content = content.replace(RegExp('  ', 'g'), '&nbsp; ') # coffeescript can't compile '/  /g'\r\n    if _.string.startsWith(content, '/me')\r\n      content = message.authorName + content.slice(3)\r\n\r\n    if message.system\r\n      td.append($('<span class=\"system\"></span>').html(content))\r\n\r\n    else if _.string.startsWith(content, '/me')\r\n      td.append($('<span class=\"action\"></span>').html(content))\r\n\r\n    else\r\n      td.append($('<strong></strong>').text(message.authorName+': '))\r\n      td.append($('<span></span>').html(content))\r\n\r\n    tr = $('<tr></tr>')\r\n    tr.addClass('me') if message.authorID is me.id\r\n    tr.append(td)\r\n\r\n  addOne: (message) ->\r\n    return if message.system and message.authorID is me.id\r\n    if @open\r\n      openPanel = $('.open-chat-area', @$el)\r\n      height = openPanel.outerHeight()\r\n      distanceFromBottom = openPanel[0].scrollHeight - height - openPanel[0].scrollTop\r\n      doScroll = distanceFromBottom < 10\r\n    tr = @messageObjectToJQuery(message)\r\n    tr.data('added', new Date().getTime())\r\n    @chatTables.append(tr)\r\n    @scrollDown() if doScroll\r\n\r\n  trimClosedPanel: ->\r\n    closedPanel = $('.closed-chat-area', @$el)\r\n    limit = 5\r\n    rows = $('tr', closedPanel)\r\n    for row, i in rows\r\n      break if rows.length - i <= limit\r\n      row.remove()\r\n\r\n  onChatKeydown: (e) ->\r\n    if key.isPressed('enter')\r\n      message = _.string.strip($(e.target).val())\r\n      return false unless message\r\n      @bus.sendMessage(message)\r\n      $(e.target).val('')\r\n      return false\r\n\r\n  onIconClick: ->\r\n    @open = not @open\r\n    openPanel = $('.open-chat-area', @$el).toggle @open\r\n    closedPanel = $('.closed-chat-area', @$el).toggle not @open\r\n    @scrollDown() if @open\r\n    if window.getSelection?\r\n      sel = window.getSelection()\r\n      sel.empty?()\r\n      sel.removeAllRanges?()\r\n    else\r\n      document.selection.empty()\r\n\r\n  scrollDown: ->\r\n    openPanel = $('.open-chat-area', @$el)[0]\r\n    openPanel.scrollTop = openPanel.scrollHeight or 1000000\r\n\r\n  destroy: ->\r\n    key.deleteScope('level')\r\n    clearInterval @clearOldMessagesInterval if @clearOldMessagesInterval\r\n    super()\r\n"]}