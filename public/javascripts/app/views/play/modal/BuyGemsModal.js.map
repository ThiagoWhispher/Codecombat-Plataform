{"version":3,"sources":["app/templates/play/modal/buy-gems-modal.jade","app/views/play/modal/BuyGemsModal.coffee"],"names":[],"mappings":"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","file":"public/javascripts/app/views/play/modal/BuyGemsModal.js","sourcesContent":["var __templateData = function anonymous(locals\n/**/) {\nvar buf = [];\nvar locals_ = (locals || {}),view = locals_.view,me = locals_.me;buf.push(\"<div class=\\\"modal-dialog\\\"><div class=\\\"modal-content\\\"> \");\nif ( view.state === 'purchasing')\n{\nbuf.push(\"<div data-i18n=\\\"buy_gems.purchasing\\\" class=\\\"alert alert-info\\\"></div>\");\n}\nelse if ( view.state === 'retrying')\n{\nbuf.push(\"<div id=\\\"retrying-alert\\\" data-i18n=\\\"buy_gems.retrying\\\" class=\\\"alert alert-danger\\\"></div>\");\n}\nelse\n{\nif ( (me.get('preferredLanguage',true) || 'en-US').split('-')[0] == 'nl')\n{\nbuf.push(\"<img src=\\\"/images/pages/play/modal/lang-nl/buy-gems-background-NL.png\\\" id=\\\"buy-gems-background\\\"/>\");\n}\nelse\n{\nbuf.push(\"<img src=\\\"/images/pages/play/modal/buy-gems-background.png\\\" id=\\\"buy-gems-background\\\"/>\");\n}\nbuf.push(\"<h1 data-i18n=\\\"play.buy_gems\\\"> </h1><div id=\\\"products\\\">\");\nif ( view.supermodel.finished())\n{\n// iterate view.products.models\n;(function(){\n  var $$obj = view.products.models;\n  if ('number' == typeof $$obj.length) {\n\n    for (var $index = 0, $$l = $$obj.length; $index < $$l; $index++) {\n      var product = $$obj[$index];\n\nbuf.push(\"<div class=\\\"product\\\"><h4>x\" + (jade.escape((jade.interp = product.get('gems')) == null ? '' : jade.interp)) + \"</h4><h3\" + (jade.attrs({ 'data-i18n':(product.get('i18n')) }, {\"data-i18n\":true})) + \"></h3><button\" + (jade.attrs({ 'value':(product.get('name')), \"class\": [('btn'),('btn-illustrated'),('btn-lg')] }, {\"value\":true})) + \"><span>\" + (jade.escape(null == (jade.interp = product.get('priceString')) ? \"\" : jade.interp)) + \"</span></button></div>\");\n    }\n\n  } else {\n    var $$l = 0;\n    for (var $index in $$obj) {\n      $$l++;      var product = $$obj[$index];\n\nbuf.push(\"<div class=\\\"product\\\"><h4>x\" + (jade.escape((jade.interp = product.get('gems')) == null ? '' : jade.interp)) + \"</h4><h3\" + (jade.attrs({ 'data-i18n':(product.get('i18n')) }, {\"data-i18n\":true})) + \"></h3><button\" + (jade.attrs({ 'value':(product.get('name')), \"class\": [('btn'),('btn-illustrated'),('btn-lg')] }, {\"value\":true})) + \"><span>\" + (jade.escape(null == (jade.interp = product.get('priceString')) ? \"\" : jade.interp)) + \"</span></button></div>\");\n    }\n\n  }\n}).call(this);\n\nif ( (me.get('preferredLanguage',true) || 'en-US').split('-')[0] == 'nl')\n{\nbuf.push(\"<div class=\\\"product\\\"><h4 class=\\\"subscription-gem-amount\\\">x{{gems}} / mo</h4><h3> \\n1, 3, 6 OF 12 <br/>MAANDEN</h3><a href=\\\"http://www.codecombat.nl/kopen\\\" target=\\\"_blank\\\"><button class=\\\"btn btn-ideal btn-illustrated btn-lg btn-succes\\\">PREPAID CODES</button></a></div>\");\n}\nbuf.push(\"<div class=\\\"product\\\"><h4 class=\\\"subscription-gem-amount\\\">x{{gems}} / mo</h4><h3 data-i18n=\\\"account.subscription\\\"></h3>\");\nif ( me.hasSubscription())\n{\nbuf.push(\"<button class=\\\"disabled start-subscription-button btn btn-lg btn-illustrated btn-success\\\">âœ“ <span data-i18n=\\\"account.subscribed\\\"></span></button>\");\n}\nelse\n{\nbuf.push(\"<button data-i18n=\\\"subscribe.subscribe_title\\\" class=\\\"start-subscription-button btn btn-lg btn-illustrated btn-success\\\">Subscribe</button>\");\n}\nbuf.push(\"</div>\");\n}\nbuf.push(\"</div>\");\nif ( view.state === 'declined')\n{\nbuf.push(\"<div id=\\\"declined-alert\\\" class=\\\"alert alert-danger alert-dismissible\\\"><span data-i18n=\\\"buy_gems.declined\\\"></span><button type=\\\"button\\\" data-dismiss=\\\"alert\\\" class=\\\"close\\\"><span aria-hidden=\\\"true\\\">&times;      </span></button></div>\");\n}\nif ( view.state === 'unknown_error')\n{\nbuf.push(\"<div id=\\\"error-alert\\\" class=\\\"alert alert-danger alert-dismissible\\\"><button type=\\\"button\\\" data-dismiss=\\\"alert\\\" class=\\\"close\\\"><span aria-hidden=\\\"true\\\">&times;</span></button><p data-i18n=\\\"loading_error.unknown\\\"></p><p>\" + (jade.escape(null == (jade.interp = view.stateMessage) ? \"\" : jade.interp)) + \"</p></div>\");\n}\nif ( view.state === 'recovered_charge')\n{\nbuf.push(\"<div id=\\\"recovered-alert\\\" class=\\\"alert alert-danger alert-dismissible\\\"><span data-i18n=\\\"buy_gems.recovered\\\"></span><button type=\\\"button\\\" data-dismiss=\\\"alert\\\" class=\\\"close\\\"><span aria-hidden=\\\"true\\\">&times;</span></button></div>\");\n}\nbuf.push(\"<div id=\\\"close-modal\\\"><span class=\\\"glyphicon glyphicon-remove\\\"></span></div>\");\n}\nbuf.push(\"</div></div>\");;return buf.join(\"\");\n};\nif (typeof define === 'function' && define.amd) {\n  define([], function() {\n    return __templateData;\n  });\n} else if (typeof module === 'object' && module && module.exports) {\n  module.exports = __templateData;\n} else {\n  __templateData;\n}","ModalView = require 'views/core/ModalView'\r\ntemplate = require 'templates/play/modal/buy-gems-modal'\r\nstripeHandler = require 'core/services/stripe'\r\nutils = require 'core/utils'\r\nSubscribeModal = require 'views/core/SubscribeModal'\r\nProducts = require 'collections/Products'\r\n\r\nmodule.exports = class BuyGemsModal extends ModalView\r\n  id: \r\n    if (me.get('preferredLanguage',true) || 'en-US').split('-')[0] == 'nl'\r\n      'buy-gems-modal-nl'\r\n    else\r\n      'buy-gems-modal'\r\n  template: template\r\n  plain: true\r\n\r\n  subscriptions:\r\n    'ipad:products': 'onIPadProducts'\r\n    'ipad:iap-complete': 'onIAPComplete'\r\n    'stripe:received-token': 'onStripeReceivedToken'\r\n\r\n  events:\r\n    'click .product button:not(.start-subscription-button)': 'onClickProductButton'\r\n    'click #close-modal': 'hide'\r\n    'click .start-subscription-button': 'onClickStartSubscription'\r\n\r\n  constructor: (options) ->\r\n    super(options)\r\n    @timestampForPurchase = new Date().getTime()\r\n    @state = 'standby'\r\n    @products = new Products()\r\n    @products.comparator = 'amount'\r\n    if application.isIPadApp\r\n      @products = []\r\n      Backbone.Mediator.publish 'buy-gems-modal:update-products'\r\n    else\r\n      @supermodel.loadCollection(@products, 'products')\r\n      $.post '/db/payment/check-stripe-charges', (something, somethingElse, jqxhr) =>\r\n        if jqxhr.status is 201\r\n          @state = 'recovered_charge'\r\n          @render()\r\n\r\n  onLoaded: ->\r\n    @basicProduct = @products.findWhere { name: 'basic_subscription' }\r\n    if countrySpecificProduct = @products.findWhere { name: \"#{me.get('country')}_basic_subscription\" }\r\n      @basicProduct = countrySpecificProduct\r\n    @products.reset @products.filter (product) -> _.string.startsWith(product.get('name'), 'gems_')\r\n    super()\r\n\r\n  afterRender: ->\r\n    super()\r\n    return unless @supermodel.finished()\r\n    @playSound 'game-menu-open'\r\n    if @basicProduct\r\n      @$el.find('.subscription-gem-amount').text $.i18n.t('buy_gems.price').replace('{{gems}}', @basicProduct.get('gems'))\r\n\r\n  onHidden: ->\r\n    super()\r\n    @playSound 'game-menu-close'\r\n\r\n  onIPadProducts: (e) ->\r\n    # TODO: Update to handle new products collection\r\n#    newProducts = []\r\n#    for iapProduct in e.products\r\n#      localProduct = _.find @originalProducts, { id: iapProduct.id }\r\n#      continue unless localProduct\r\n#      localProduct.price = iapProduct.price\r\n#      newProducts.push localProduct\r\n#    @products = _.sortBy newProducts, 'gems'\r\n#    @render()\r\n\r\n  onClickProductButton: (e) ->\r\n    @playSound 'menu-button-click'\r\n    productID = $(e.target).closest('button').val()\r\n    # Don't throw error when product is not found\r\n    if productID.length == 0\r\n      return\r\n    product = @products.findWhere { name: productID }\r\n\r\n    if application.isIPadApp\r\n      Backbone.Mediator.publish 'buy-gems-modal:purchase-initiated', { productID: productID }\r\n\r\n    else\r\n      application.tracker?.trackEvent 'Started gem purchase', { productID: productID }\r\n      stripeHandler.open({\r\n        description: $.t(product.get('i18n'))\r\n        amount: product.get('amount')\r\n        bitcoin: true\r\n        alipay: if me.get('country') is 'china' or (me.get('preferredLanguage') or 'en-US')[...2] is 'zh' then true else 'auto'\r\n      })\r\n\r\n    @productBeingPurchased = product\r\n\r\n  onStripeReceivedToken: (e) ->\r\n    data = {\r\n      productID: @productBeingPurchased.get('name')\r\n      stripe: {\r\n        token: e.token.id\r\n        timestamp: @timestampForPurchase\r\n      }\r\n    }\r\n    @state = 'purchasing'\r\n    @render()\r\n    jqxhr = $.post('/db/payment', data)\r\n    jqxhr.done(=>\r\n      application.tracker?.trackEvent 'Finished gem purchase',\r\n        productID: @productBeingPurchased.get('name')\r\n        value: @productBeingPurchased.get('amount')\r\n      document.location.reload()\r\n    )\r\n    jqxhr.fail(=>\r\n      if jqxhr.status is 402\r\n        @state = 'declined'\r\n        @stateMessage = arguments[2]\r\n      else if jqxhr.status is 500\r\n        @state = 'retrying'\r\n        f = _.bind @onStripeReceivedToken, @, e\r\n        _.delay f, 2000\r\n      else\r\n        @state = 'unknown_error'\r\n        @stateMessage = \"#{jqxhr.status}: #{jqxhr.responseText}\"\r\n      @render()\r\n    )\r\n\r\n  onIAPComplete: (e) ->\r\n    product = @products.findWhere { name: e.productID }\r\n    purchased = me.get('purchased') ? {}\r\n    purchased = _.clone purchased\r\n    purchased.gems ?= 0\r\n    purchased.gems += product.gems\r\n    me.set('purchased', purchased)\r\n    @hide()\r\n\r\n  onClickStartSubscription: (e) ->\r\n    @openModalView new SubscribeModal()\r\n    window.tracker?.trackEvent 'Show subscription modal', category: 'Subscription', label: 'buy gems modal'\r\n"]}