{"version":3,"sources":["app/templates/play/modal/poll-modal.jade","app/views/play/modal/PollModal.coffee"],"names":[],"mappings":"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","file":"public/javascripts/app/views/play/modal/PollModal.js","sourcesContent":["var __templateData = function anonymous(locals\n/**/) {\nvar buf = [];\nvar locals_ = (locals || {}),view = locals_.view,i18n = locals_.i18n,poll = locals_.poll,marked = locals_.marked,me = locals_.me;buf.push(\"<div class=\\\"modal-dialog game\\\"><div class=\\\"background-wrapper\\\"><div class=\\\"modal-content\\\"><div class=\\\"modal-header\\\">\");\nif ( view.closeButton)\n{\nbuf.push(\"<div type=\\\"button\\\" data-dismiss=\\\"modal\\\" aria-hidden=\\\"true\\\" class=\\\"button close\\\">&times;</div>\");\n}\nbuf.push(\"<h1><span>\" + (jade.escape(null == (jade.interp = i18n(poll.attributes, \"name\")) ? \"\" : jade.interp)) + \"</span></h1></div><div class=\\\"modal-body\\\"><div class=\\\"description\\\">\");\nif ( poll.get(\"description\"))\n{\nbuf.push(\"<div>\" + (null == (jade.interp = marked(i18n(poll.attributes, \"description\"))) ? \"\" : jade.interp) + \"</div>\");\n}\nelse\n{\nbuf.push(\"<div>&nbsp;</div>\");\n}\nbuf.push(\"</div><div class=\\\"answers-container-wrapper\\\"><div class=\\\"answers-container\\\"><table class=\\\"table table-hover\\\">\");\n// iterate poll.get(\"answers\") || []\n;(function(){\n  var $$obj = poll.get(\"answers\") || [];\n  if ('number' == typeof $$obj.length) {\n\n    for (var $index = 0, $$l = $$obj.length; $index < $$l; $index++) {\n      var answer = $$obj[$index];\n\nbuf.push(\"<tr\" + (jade.attrs({ 'data-answer':(answer.key), \"class\": [(\"answer\")] }, {\"class\":true,\"data-answer\":true})) + \"><td>\" + (null == (jade.interp = marked(i18n(answer, \"text\"))) ? \"\" : jade.interp) + \"</td><td class=\\\"graph-cell\\\"><div class=\\\"progress\\\"><div class=\\\"progress-bar\\\"></div></div></td><td class=\\\"votes-cell\\\"><span class=\\\"badge vote-percentage\\\"></span></td>\");\nif ( me.isAdmin())\n{\nbuf.push(\"<td class=\\\"votes-cell\\\"><span class=\\\"badge vote-count\\\"></span></td>\");\n}\nbuf.push(\"</tr>\");\n    }\n\n  } else {\n    var $$l = 0;\n    for (var $index in $$obj) {\n      $$l++;      var answer = $$obj[$index];\n\nbuf.push(\"<tr\" + (jade.attrs({ 'data-answer':(answer.key), \"class\": [(\"answer\")] }, {\"class\":true,\"data-answer\":true})) + \"><td>\" + (null == (jade.interp = marked(i18n(answer, \"text\"))) ? \"\" : jade.interp) + \"</td><td class=\\\"graph-cell\\\"><div class=\\\"progress\\\"><div class=\\\"progress-bar\\\"></div></div></td><td class=\\\"votes-cell\\\"><span class=\\\"badge vote-percentage\\\"></span></td>\");\nif ( me.isAdmin())\n{\nbuf.push(\"<td class=\\\"votes-cell\\\"><span class=\\\"badge vote-count\\\"></span></td>\");\n}\nbuf.push(\"</tr>\");\n    }\n\n  }\n}).call(this);\n\nbuf.push(\"</table></div></div><div class=\\\"random-gems-container-wrapper\\\"><div class=\\\"random-gems-container\\\"><code class=\\\"random-gems-code\\\"><span>randomNumber = Math.random()                   </span><span id=\\\"random-number-comment\\\" class=\\\"comment\\\"></span></code><code class=\\\"random-gems-code\\\"><span>gems = Math.ceil(2 * randomNumber * me.level)  </span><span id=\\\"random-gems-comment\\\" class=\\\"comment\\\"></span></code><code class=\\\"random-gems-code\\\"><span>me.gems += gems                                </span><span id=\\\"total-gems-comment\\\" class=\\\"comment\\\"></span></code></div></div></div><div class=\\\"modal-body wait secret\\\"><h3>Reticulating Splines...</h3><div class=\\\"progress progress-striped active\\\"><div class=\\\"progress-bar\\\"></div></div></div><div class=\\\"modal-footer\\\"><button data-dismiss=\\\"modal\\\" aria-hidden=\\\"true\\\" data-i18n=\\\"play_level.done\\\" class=\\\"btn btn-illustrated btn-lg done-button\\\">Done</button></div></div></div></div>\");;return buf.join(\"\");\n};\nif (typeof define === 'function' && define.amd) {\n  define([], function() {\n    return __templateData;\n  });\n} else if (typeof module === 'object' && module && module.exports) {\n  module.exports = __templateData;\n} else {\n  __templateData;\n}","ModalView = require 'views/core/ModalView'\r\ntemplate = require 'templates/play/modal/poll-modal'\r\nutils = require 'core/utils'\r\nUserPollsRecord = require 'models/UserPollsRecord'\r\n\r\nmodule.exports = class PollModal extends ModalView\r\n  id: 'poll-modal'\r\n  template: template\r\n\r\n  subscriptions: {}\r\n\r\n  events:\r\n    'click #close-modal': 'hide'\r\n    'click .answer:not(.selected)': 'onClickAnswer'\r\n\r\n  constructor: (options) ->\r\n    super options\r\n    @poll = options.poll\r\n    @userPollsRecord = options.userPollsRecord\r\n    @previousAnswer = (@userPollsRecord.get('polls') ? {})[@poll.id]\r\n    @previousReward = (@userPollsRecord.get('rewards') ? {})[@poll.id]\r\n\r\n  getRenderData: (c) ->\r\n    c = super c\r\n    c.poll = @poll\r\n    c.i18n = utils.i18n\r\n    c.marked = marked\r\n    c\r\n\r\n  afterRender: ->\r\n    super()\r\n    @playSound 'game-menu-open'\r\n    @updateAnswers()\r\n\r\n  onHidden: ->\r\n    super()\r\n    @playSound 'game-menu-close'\r\n\r\n  updateAnswers: (answered) ->\r\n    myAnswer = (@userPollsRecord.get('polls') ? {})[@poll.id]\r\n    answered = myAnswer?\r\n    @$el.find('table, .random-gems-container-wrapper').toggleClass 'answered', answered\r\n    return unless answered\r\n    @awardRandomGems()\r\n\r\n    # Count total votes and find the answer with the most votes.\r\n    [maxVotes, totalVotes] = [0, 0]\r\n    for answer in @poll.get('answers') or []\r\n      votes = answer.votes or 0\r\n      --votes if answer.key is @previousAnswer\r\n      ++votes if answer.key is myAnswer\r\n      answer.votes = votes\r\n      totalVotes += votes\r\n      maxVotes = Math.max maxVotes, votes or 0\r\n    @previousAnswer = myAnswer\r\n    @poll.set 'answers', @poll.get('answers')  # Update vote count locally (won't save to server).\r\n\r\n    # Update each answer cell according to its share of max and total votes.\r\n    for answer in @poll.get 'answers'\r\n      $answer = @$el.find(\".answer[data-answer='#{answer.key}']\")\r\n      $answer.toggleClass 'selected', answer.key is myAnswer\r\n      votes = answer.votes or 0\r\n      votes = maxVotes = totalVotes = 1 unless totalVotes  # If no votes yet, just pretend we voted for the first one.\r\n\r\n      widthPercentage = (100 * votes / maxVotes) + '%'\r\n      votePercentage = Math.round(100 * votes / totalVotes) + '%'\r\n      $answer.find('.progress-bar').css('width', '0%').animate({width: widthPercentage}, 'slow')\r\n      $answer.find('.vote-percentage').text votePercentage\r\n      $answer.find('.vote-count').text votes if me.isAdmin()\r\n\r\n    @trigger 'vote-updated'\r\n\r\n  onClickAnswer: (e) ->\r\n    $selectedAnswer = $(e.target).closest('.answer')\r\n    pollVotes = @userPollsRecord.get('polls') ? {}\r\n    pollVotes[@poll.id] = $selectedAnswer.data('answer').toString()\r\n    @userPollsRecord.set 'polls', pollVotes\r\n    @updateAnswers true\r\n    @userPollsRecord.save {polls: pollVotes}, {success: => @awardRandomGems?()}\r\n\r\n  awardRandomGems: ->\r\n    return unless reward = (@userPollsRecord.get('rewards') ? {})[@poll.id]\r\n    @$randomNumber = @$el.find('#random-number-comment').empty()\r\n    @$randomGems = @$el.find('#random-gems-comment').hide()\r\n    @$totalGems = @$el.find('#total-gems-comment').hide()\r\n    commentStart = commentStarts[me.get('aceConfig')?.language ? 'python']\r\n    randomNumber = reward.random\r\n    randomGems = Math.ceil 2 * randomNumber * reward.level\r\n    totalGems = if @previousReward then me.gems() else Math.round me.gems() + randomGems\r\n    playSound = @playSound\r\n\r\n    if @previousReward\r\n      utils.replaceText @$randomNumber.show(), commentStart + randomNumber.toFixed(7)\r\n      utils.replaceText @$randomGems.show(), commentStart + randomGems\r\n      utils.replaceText @$totalGems.show(), commentStart + totalGems\r\n    else\r\n      gemNoisesPlayed = 0\r\n      for i in [0 .. 1000] by 25\r\n        do (i) =>\r\n          @$randomNumber.queue ->\r\n            number = if i is 1000 then randomNumber else Math.random()\r\n            utils.replaceText $(@), commentStart + number.toFixed(7)\r\n            $(@).dequeue()\r\n            if Math.random() < randomGems / 40\r\n              gemTrigger = 'gem-' + (gemNoisesPlayed % 4)  # 4 gem sounds\r\n              ++gemNoisesPlayed\r\n              playSound gemTrigger, (0.475 + i / 2000)\r\n          @$randomNumber.delay 25\r\n      @$randomGems.delay(1100).queue ->\r\n        utils.replaceText $(@), commentStart + randomGems\r\n        $(@).show()\r\n        $(@).dequeue()\r\n      @$totalGems.delay(1200).queue ->\r\n        utils.replaceText $(@), commentStart + totalGems\r\n        $(@).show()\r\n        $(@).dequeue()\r\n\r\n      @previousReward = reward\r\n      _.delay (=>\r\n        return if @destroyed\r\n        earned = me.get('earned') ? {}\r\n        earned.gems += randomGems\r\n        me.set 'earned', earned\r\n        me.trigger 'change:earned'\r\n      ), 1200\r\n\r\n\r\ncommentStarts =\r\n  javascript: '// '\r\n  python: '# '\r\n  coffeescript: '# '\r\n  lua: '-- '\r\n  java: '// '\r\n"]}