{"version":3,"sources":["app/views/play/common/LadderSubmissionView.coffee"],"names":[],"mappings":";AAAA;EAAA;;;AAAA,WAAW,QAAQ,qBAAR;;AACX,WAAW,QAAQ,yCAAR;;AACV,sBAAuB,QAAQ,kBAAR,EAAvB;;AACD,eAAe,QAAQ,qBAAR;;AAEf,MAAM,CAAC,OAAP,GAAuB;;;iCACrB,YAAW;;iCACX,WAAU;;iCAEV,SACE;IAAA,sBAAsB,aAAtB;IACA,wBAAwB,gBADxB;;;EAGW,8BAAC,OAAD;IACX,sDAAM,OAAN;IACA,IAAC,QAAD,GAAW,OAAO,CAAC;IACnB,IAAC,cAAD,GAAiB,OAAO,CAAC;IACzB,IAAC,MAAD,GAAS,OAAO,CAAC;EAJN;;iCAMb,gBAAe;AACb;IAAA,MAAM;IACN,GAAG,CAAC,WAAJ,qCAA0B,CAAE,WAAV;IAClB,GAAG,CAAC,SAAJ,uCAAwB,CAAE,GAAV,CAAc,WAAd;IAChB,GAAG,CAAC,WAAJ,GAAkB,kBAAe,CAAC,IAAC,MAAK,CAAC,GAAP,CAAW,MAAX,CAAD,CAAf,GAAmC;IACrD,IAAoD,iDAAqB,CAAE,GAAV,CAAc,YAAd,UAAjE;MAAA,GAAG,CAAC,aAAJ,GAAoB,OAAO,UAAP,CAAkB,CAAC,OAAnB,GAApB;;WACA;EANa;;iCAQf,cAAa;IACX;IACA,KAAc,IAAC,WAAU,CAAC,QAAZ,EAAd;AAAA;;IACA,IAAC,WAAD,GAAc,IAAC,IAAG,CAAC,IAAL,CAAU,cAAV;WACd,IAAC,aAAD;EAJW;;iCAMb,eAAc;AACZ;IAAA,eAAe;IACf,sCAAW,CAAE,WAAV,WAAH;MACE,eAAe,OADjB;KAAA,MAEK,wCAAW,CAAE,GAAV,CAAc,WAAd,UAAH;MACH,eAAe,UADZ;;WAEL,IAAC,qBAAD,CAAsB,YAAtB;EANY;;iCAQd,uBAAsB,SAAC,SAAD;AACpB;IAAA,IAAC,WAAU,CAAC,IAAZ,CAAiB,MAAjB,CAAwB,CAAC,IAAzB;IACA,IAAC,WAAU,CAAC,IAAZ,CAAiB,MAAI,SAArB,CAAiC,CAAC,IAAlC;IACA,IAAC,WAAU,CAAC,WAAZ,CAAwB,UAAxB,EAAoC,cAAe,MAAnD;IACA,eAAe,cAAc,WAAd,kBAA2B;IAC1C,IAAC,IAAG,CAAC,IAAL,CAAU,gBAAV,CAA2B,CAAC,MAA5B,CAAmC,YAAnC,EAAiD,MAAjD;IACA,oBAAoB,CAAI,CAAC,cAAc,YAAf;WACxB,IAAC,IAAG,CAAC,IAAL,CAAU,iBAAV,CAA4B,CAAC,MAA7B,CAAoC,iBAApC;EAPoB;;iCAStB,4BAA2B;AACzB;IAAA,qBAAqB,QAAQ,+BAAR;WACrB,IAAC,cAAD,CAAmB,uBAAmB;MAAC,mBAAmB,IAApB;KAAnB,CAAnB;EAFyB;;iCAI3B,cAAa,SAAC,CAAD;AACX;IAAA,KAAc,IAAC,QAAO,CAAC,WAAT,EAAd;AAAA;;IACA,IAAuC,EAAE,CAAC,GAAH,CAAO,WAAP,CAAvC;AAAA,aAAO,IAAC,0BAAD,GAAP;;IACA,IAAC,UAAD,CAAW,mBAAX;IACA,IAAC,qBAAD,CAAsB,YAAtB;IACA,UAAU;aAAA;QACR,KAAyC,KAAC,UAA1C;UAAA,KAAC,qBAAD,CAAsB,WAAtB;;eACA,QAAQ,CAAC,QAAQ,CAAC,OAAlB,CAA0B,uBAA1B,EAAmD;UAAA,SAAS,KAAC,QAAV;UAAmB,OAAO,KAAC,MAA3B;SAAnD;MAFQ;IAAA;IAGV,UAAU;aAAA,SAAC,KAAD,EAAQ,UAAR,EAAoB,WAApB;QACR,OAAO,CAAC,GAAR,CAAY,KAAK,CAAC,YAAlB;QACA,KAAsC,KAAC,UAAvC;iBAAA,KAAC,qBAAD,CAAsB,QAAtB;;MAFQ;IAAA;WAGV,IAAC,QAAO,CAAC,IAAT,CAAc,IAAd,EAAoB;MAAA,SAAS;eAAA;AAC3B;UAAA,WACE;YAAA,SAAS,KAAC,QAAO,CAAC,EAAlB;YACA,SAAS,KAAC,MAAK,CAAC,EADhB;YAEA,iBAAiB,KAAC,MAAK,CAAC,GAAP,CAAW,UAAX,CAFjB;YAGA,mBAAmB,KAAC,MAAK,CAAC,GAAP,CAAW,SAAX,CAAqB,CAAC,KAHzC;;UAIF,cACE;YAAA,MAAM,MAAN;YACA,MAAM,QADN;YAEA,SAAS,OAFT;YAGA,OAAO,OAHP;;UAIF,IAAG,KAAC,cAAD,IAAmB,KAAC,cAAa,CAAC,GAAf,CAAmB,eAAnB,CAAtB;YAEE,iBAAiB,CAAC,CAAC,KAAF,CAAQ,QAAR;YACjB,cAAc,CAAC,OAAf,GAAyB,KAAC,cAAa,CAAC;YACxC,aAAa,KAAC,cAAa,CAAC,GAAf,CAAmB,MAAnB;YACb,IAAG,KAAC,QAAO,CAAC,GAAT,CAAa,MAAb,MAAwB,QAA3B;cACE,UAAW,sBAAX,GAAmC,KAAC,QAAO,CAAC,GAAT,CAAa,MAAb,CAAqB,qBAD1D;aAAA;cAGE,UAAW,oBAAX,GAAiC,KAAC,QAAO,CAAC,GAAT,CAAa,MAAb,CAAqB,uBAHxD;;YAIA,oBAAoB,CAAC,CAAC,KAAF,CAAQ,WAAR;YACpB,iBAAiB,CAAC,IAAlB,GAAyB;YACzB,WAAW,CAAC,OAAZ,GAAsB;AACpB;cAAA,QAAQ;gBAAA,MAAM,UAAN;gBAAkB,cAAc,KAAC,QAAO,CAAC,GAAT,CAAa,cAAb,CAAhC;;cACR,cAAkB,iBAAa;gBAAA,KAAK,KAAC,cAAa,CAAC,EAApB;eAAb;qBAClB,WAAW,CAAC,IAAZ,CAAiB,KAAjB,EAAwB;gBAAA,OAAO,IAAP;gBAAa,MAAM,KAAnB;gBAA0B,SAAS;yBACzD,CAAC,CAAC,IAAF,CAAO,gBAAP,EAAyB,iBAAzB;gBADyD,CAAnC;eAAxB;YAHoB,EAXxB;;iBAiBA,CAAC,CAAC,IAAF,CAAO,gBAAP,EAAyB,WAAzB;QA5B2B;MAAA,QAAT;KAApB;EAXW;;iCAyCb,iBAAgB;IACd,IAAC,UAAD,CAAW,mBAAX;WACA,EAAE,qBAAF,CAAwB,CAAC,GAAzB,CAA6B,MAA7B;EAFc;;;;GA1FkC","file":"public/javascripts/app/views/play/common/LadderSubmissionView.js","sourcesContent":["CocoView = require 'views/core/CocoView'\r\ntemplate = require 'templates/play/common/ladder_submission'\r\n{createAetherOptions} = require 'lib/aether_utils'\r\nLevelSession = require 'models/LevelSession'\r\n\r\nmodule.exports = class LadderSubmissionView extends CocoView\r\n  className: 'ladder-submission-view'\r\n  template: template\r\n\r\n  events:\r\n    'click .rank-button': 'rankSession'\r\n    'click .help-simulate': 'onHelpSimulate'\r\n\r\n  constructor: (options) ->\r\n    super options\r\n    @session = options.session\r\n    @mirrorSession = options.mirrorSession\r\n    @level = options.level\r\n\r\n  getRenderData: ->\r\n    ctx = super()\r\n    ctx.readyToRank = @session?.readyToRank()\r\n    ctx.isRanking = @session?.get('isRanking')\r\n    ctx.simulateURL = \"/play/ladder/#{@level.get('slug')}#simulate\"\r\n    ctx.lastSubmitted = moment(submitDate).fromNow() if submitDate = @session?.get('submitDate')\r\n    ctx\r\n\r\n  afterRender: ->\r\n    super()\r\n    return unless @supermodel.finished()\r\n    @rankButton = @$el.find('.rank-button')\r\n    @updateButton()\r\n\r\n  updateButton: ->\r\n    rankingState = 'unavailable'\r\n    if @session?.readyToRank()\r\n      rankingState = 'rank'\r\n    else if @session?.get 'isRanking'\r\n      rankingState = 'ranking'\r\n    @setRankingButtonText rankingState\r\n\r\n  setRankingButtonText: (spanClass) ->\r\n    @rankButton.find('span').hide()\r\n    @rankButton.find(\".#{spanClass}\").show()\r\n    @rankButton.toggleClass 'disabled', spanClass isnt 'rank'\r\n    helpSimulate = spanClass in ['submitted', 'ranking']\r\n    @$el.find('.help-simulate').toggle(helpSimulate, 'slow')\r\n    showLastSubmitted = not (spanClass in ['submitting'])\r\n    @$el.find('.last-submitted').toggle(showLastSubmitted)\r\n\r\n  showApologeticSignupModal: ->\r\n    CreateAccountModal = require 'views/core/CreateAccountModal'\r\n    @openModalView(new CreateAccountModal({showRequiredError: true}))\r\n\r\n  rankSession: (e) ->\r\n    return unless @session.readyToRank()\r\n    return @showApologeticSignupModal() if me.get('anonymous')\r\n    @playSound 'menu-button-click'\r\n    @setRankingButtonText 'submitting'\r\n    success = =>\r\n      @setRankingButtonText 'submitted' unless @destroyed\r\n      Backbone.Mediator.publish 'ladder:game-submitted', session: @session, level: @level\r\n    failure = (jqxhr, textStatus, errorThrown) =>\r\n      console.log jqxhr.responseText\r\n      @setRankingButtonText 'failed' unless @destroyed\r\n    @session.save null, success: =>\r\n      ajaxData =\r\n        session: @session.id\r\n        levelID: @level.id\r\n        originalLevelID: @level.get('original')\r\n        levelMajorVersion: @level.get('version').major\r\n      ajaxOptions =\r\n        type: 'POST'\r\n        data: ajaxData\r\n        success: success\r\n        error: failure\r\n      if @mirrorSession and @mirrorSession.get('submittedCode')\r\n        # Also submit the mirrorSession after the main session submits successfully.\r\n        mirrorAjaxData = _.clone ajaxData\r\n        mirrorAjaxData.session = @mirrorSession.id\r\n        mirrorCode = @mirrorSession.get('code')\r\n        if @session.get('team') is 'humans'\r\n          mirrorCode['hero-placeholder-1'] = @session.get('code')['hero-placeholder']\r\n        else\r\n          mirrorCode['hero-placeholder'] = @session.get('code')['hero-placeholder-1']\r\n        mirrorAjaxOptions = _.clone ajaxOptions\r\n        mirrorAjaxOptions.data = mirrorAjaxData\r\n        ajaxOptions.success = =>\r\n          patch = code: mirrorCode, codeLanguage: @session.get('codeLanguage')\r\n          tempSession = new LevelSession _id: @mirrorSession.id\r\n          tempSession.save patch, patch: true, type: 'PUT', success: ->\r\n            $.ajax '/queue/scoring', mirrorAjaxOptions\r\n\r\n      $.ajax '/queue/scoring', ajaxOptions\r\n\r\n  onHelpSimulate: ->\r\n    @playSound 'menu-button-click'\r\n    $('a[href=\"#simulate\"]').tab('show')\r\n"]}