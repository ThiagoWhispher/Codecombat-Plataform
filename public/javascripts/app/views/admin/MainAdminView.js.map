{"version":3,"sources":["app/views/admin/MainAdminView.coffee"],"names":[],"mappings":"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","file":"public/javascripts/app/views/admin/MainAdminView.js","sourcesContent":["{backboneFailure, genericFailure} = require 'core/errors'\r\nerrors = require 'core/errors'\r\nRootView = require 'views/core/RootView'\r\ntemplate = require 'templates/admin'\r\nAdministerUserModal = require 'views/admin/AdministerUserModal'\r\nforms = require 'core/forms'\r\n\r\nCampaigns = require 'collections/Campaigns'\r\nClassroom = require 'models/Classroom'\r\nCocoCollection = require 'collections/CocoCollection'\r\nCourse = require 'models/Course'\r\nCourses = require 'collections/Courses'\r\nLevelSessions = require 'collections/LevelSessions'\r\nUser = require 'models/User'\r\nUsers = require 'collections/Users'\r\n\r\nmodule.exports = class MainAdminView extends RootView\r\n  id: 'admin-view'\r\n  template: template\r\n  lastUserSearchValue: ''\r\n\r\n  events:\r\n    'submit #espionage-form': 'onSubmitEspionageForm'\r\n    'submit #user-search-form': 'onSubmitUserSearchForm'\r\n    'click #stop-spying-btn': 'onClickStopSpyingButton'\r\n    'click #increment-button': 'incrementUserAttribute'\r\n    'click .user-spy-button': 'onClickUserSpyButton'\r\n    'click #user-search-result': 'onClickUserSearchResult'\r\n    'click #create-free-sub-btn': 'onClickFreeSubLink'\r\n    'click #terminal-create': 'onClickTerminalSubLink'\r\n    'click .classroom-progress-csv': 'onClickExportProgress'\r\n    'click #clear-feature-mode-btn': 'onClickClearFeatureModeButton'\r\n\r\n  getTitle: -> return $.i18n.t('account_settings.admin')\r\n\r\n  initialize: ->\r\n    if window.serverSession.amActually\r\n      @amActually = new User({_id: window.serverSession.amActually})\r\n      @amActually.fetch()\r\n      @supermodel.trackModel(@amActually)\r\n    @featureMode = window.serverSession.featureMode\r\n    super()\r\n\r\n  onClickStopSpyingButton: ->\r\n    button = @$('#stop-spying-btn')\r\n    forms.disableSubmit(button)\r\n    me.stopSpying({\r\n      success: -> document.location.reload()\r\n      error: ->\r\n        forms.enableSubmit(button)\r\n        errors.showNotyNetworkError(arguments...)\r\n    })\r\n\r\n  onClickClearFeatureModeButton: (e) ->\r\n    e.preventDefault()\r\n    application.featureMode.clear()\r\n\r\n  onSubmitEspionageForm: (e) ->\r\n    e.preventDefault()\r\n    button = @$('#enter-espionage-mode')\r\n    userNameOrEmail = @$el.find('#espionage-name-or-email').val().toLowerCase()\r\n    forms.disableSubmit(button)\r\n    me.spy(userNameOrEmail, {\r\n      success: -> window.location.reload()\r\n      error: ->\r\n        forms.enableSubmit(button)\r\n        errors.showNotyNetworkError(arguments...)\r\n    })\r\n\r\n  onClickUserSpyButton: (e) ->\r\n    e.stopPropagation()\r\n    userID = $(e.target).closest('tr').data('user-id')\r\n    button = $(e.currentTarget)\r\n    forms.disableSubmit(button)\r\n    me.spy(userID, {\r\n      success: -> window.location.reload()\r\n      error: ->\r\n        forms.enableSubmit(button)\r\n        errors.showNotyNetworkError(arguments...)\r\n    })\r\n\r\n  onSubmitUserSearchForm: (e) ->\r\n    e.preventDefault()\r\n    searchValue = @$el.find('#user-search').val()\r\n    return if searchValue is @lastUserSearchValue\r\n    return @onSearchRequestSuccess [] unless @lastUserSearchValue = searchValue.toLowerCase()\r\n    forms.disableSubmit(@$('#user-search-button'))\r\n    q = @lastUserSearchValue\r\n    role = undefined\r\n    q = q.replace /role:([^ ]+)/, (dummy, m1) ->\r\n      role = m1\r\n      return ''\r\n\r\n    data = {search: q}\r\n    data.role = role if role?\r\n    $.ajax\r\n      type: 'POST',\r\n      url: '/db/user/-/admin_search'\r\n      data: data\r\n      success: @onSearchRequestSuccess\r\n      error: @onSearchRequestFailure\r\n\r\n  onSearchRequestSuccess: (users) =>\r\n    forms.enableSubmit(@$('#user-search-button'))\r\n    result = ''\r\n    if users.length\r\n      result = (\"<tr data-user-id='#{user._id}'><td><code>#{user._id}</code></td><td>#{_.escape(user.name or 'Anonymous')}</td><td>#{_.escape(user.email)}</td><td><button class='user-spy-button'>Spy</button></td></tr>\" for user in users)\r\n      result = \"<table class=\\\"table\\\">#{result.join('\\n')}</table>\"\r\n    @$el.find('#user-search-result').html(result)\r\n\r\n  onSearchRequestFailure: (jqxhr, status, error) =>\r\n    return if @destroyed\r\n    forms.enableSubmit(@$('#user-search-button'))\r\n    console.warn \"There was an error looking up #{@lastUserSearchValue}:\", error\r\n\r\n  incrementUserAttribute: (e) ->\r\n    val = $('#increment-field').val()\r\n    me.set(val, me.get(val) + 1)\r\n    me.save()\r\n\r\n  onClickUserSearchResult: (e) ->\r\n    userID = $(e.target).closest('tr').data('user-id')\r\n    @openModalView new AdministerUserModal({}, userID) if userID\r\n\r\n  onClickFreeSubLink: (e) =>\r\n    delete @freeSubLink\r\n    return unless me.isAdmin()\r\n    options =\r\n      url: '/db/prepaid/-/create'\r\n      data: {type: 'subscription', maxRedeemers: 1}\r\n      method: 'POST'\r\n    options.success = (model, response, options) =>\r\n      # TODO: Don't hardcode domain.\r\n      if application.isProduction()\r\n        @freeSubLink = \"https://codecombat.com/account/subscription?_ppc=#{model.code}\"\r\n      else\r\n        @freeSubLink = \"http://localhost:3000/account/subscription?_ppc=#{model.code}\"\r\n      @render?()\r\n    options.error = (model, response, options) =>\r\n      console.error 'Failed to create prepaid', response\r\n    @supermodel.addRequestResource('create_prepaid', options, 0).load()\r\n\r\n  onClickTerminalSubLink: (e) =>\r\n    @freeSubLink = ''\r\n    return unless me.isAdmin()\r\n\r\n    options =\r\n      url: '/db/prepaid/-/create'\r\n      method: 'POST'\r\n      data:\r\n        type: 'terminal_subscription'\r\n        maxRedeemers: parseInt($(\"#users\").val())\r\n        months: parseInt($(\"#months\").val())\r\n\r\n    options.success = (model, response, options) =>\r\n      # TODO: Don't hardcode domain.\r\n      if application.isProduction()\r\n        @freeSubLink = \"https://codecombat.com/account/prepaid?_ppc=#{model.code}\"\r\n      else\r\n        @freeSubLink = \"http://localhost:3000/account/prepaid?_ppc=#{model.code}\"\r\n      @render?()\r\n    options.error = (model, response, options) =>\r\n      console.error 'Failed to create prepaid', response\r\n    @supermodel.addRequestResource('create_prepaid', options, 0).load()\r\n\r\n  afterRender: ->\r\n    super()\r\n    @$el.find('.search-help-toggle').click () =>\r\n      @$el.find('.search-help').toggle()\r\n\r\n  onClickExportProgress: ->\r\n    $('.classroom-progress-csv').prop('disabled', true)\r\n    classCode = $('.classroom-progress-class-code').val()\r\n    classroom = null\r\n    courses = null\r\n    courseLevels = []\r\n    sessions = null\r\n    users = null\r\n    userMap = {}\r\n    Promise.resolve(new Classroom().fetchByCode(classCode))\r\n    .then (model) =>\r\n      classroom = new Classroom({ _id: model.data._id })\r\n      Promise.resolve(classroom.fetch())\r\n    .then (model) =>\r\n      courses = new Courses()\r\n      Promise.resolve(courses.fetch())\r\n    .then (models) =>\r\n      for course, index in classroom.get('courses')\r\n        for level in course.levels\r\n          courseLevels.push\r\n            courseIndex: index + 1\r\n            levelID: level.original\r\n            slug: level.slug\r\n            courseSlug: courses.get(course._id).get('slug')\r\n      users = new Users()\r\n      Promise.resolve($.when(users.fetchForClassroom(classroom)...))\r\n    .then (models) =>\r\n      userMap[user.id] = user for user in users.models\r\n      sessions = new LevelSessions()\r\n      Promise.resolve($.when(sessions.fetchForAllClassroomMembers(classroom)...))\r\n    .then (models) =>\r\n      userLevelPlaytimeMap = {}\r\n      for session in sessions.models\r\n        continue unless session.get('state')?.complete\r\n        levelID = session.get('level').original\r\n        userID = session.get('creator')\r\n        userLevelPlaytimeMap[userID] ?= {}\r\n        userLevelPlaytimeMap[userID][levelID] ?= {}\r\n        userLevelPlaytimeMap[userID][levelID] = session.get('playtime')\r\n\r\n      userPlaytimes = []\r\n      for userID, user of userMap\r\n        playtimes = [user.get('name') ? 'Anonymous']\r\n        for level in courseLevels\r\n          if userLevelPlaytimeMap[userID]?[level.levelID]?\r\n            rawSeconds = parseInt(userLevelPlaytimeMap[userID][level.levelID])\r\n            hours = Math.floor(rawSeconds / 60 / 60)\r\n            minutes = Math.floor(rawSeconds / 60 - hours * 60)\r\n            seconds = Math.round(rawSeconds - hours * 60 - minutes * 60)\r\n            hours = \"0#{hours}\" if hours < 10\r\n            minutes = \"0#{minutes}\" if minutes < 10\r\n            seconds = \"0#{seconds}\" if seconds < 10\r\n            playtimes.push \"#{hours}:#{minutes}:#{seconds}\"\r\n          else\r\n            playtimes.push 'Incomplete'\r\n        userPlaytimes.push(playtimes)\r\n\r\n      columnLabels = \"Username\"\r\n      currentLevel = 1\r\n      courseLabelIndexes = CS: 1, GD: 0, WD: 0\r\n      lastCourseIndex = 1\r\n      lastCourseLabel = 'CS1'\r\n      for level in courseLevels\r\n        unless level.courseIndex is lastCourseIndex\r\n          currentLevel = 1\r\n          lastCourseIndex = level.courseIndex\r\n          acronym = switch\r\n            when /game-dev/.test(level.courseSlug) then 'GD'\r\n            when /web-dev/.test(level.courseSlug) then 'WD'\r\n            else 'CS'\r\n          lastCourseLabel = acronym + ++courseLabelIndexes[acronym]\r\n        columnLabels += \",#{lastCourseLabel}.#{currentLevel++} #{level.slug}\"\r\n      csvContent = \"data:text/csv;charset=utf-8,#{columnLabels}\\n\"\r\n      for studentRow in userPlaytimes\r\n        csvContent += studentRow.join(',') + \"\\n\"\r\n      csvContent = csvContent.substring(0, csvContent.length - 1)\r\n      encodedUri = encodeURI(csvContent)\r\n      window.open(encodedUri)\r\n      $('.classroom-progress-csv').prop('disabled', false)\r\n\r\n    .catch (error) ->\r\n      $('.classroom-progress-csv').prop('disabled', false)\r\n      console.error error\r\n      throw error\r\n"]}