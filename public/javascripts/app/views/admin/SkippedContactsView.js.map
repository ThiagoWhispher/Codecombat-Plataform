{"version":3,"sources":["app/views/admin/SkippedContactsView.coffee"],"names":[],"mappings":"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","file":"public/javascripts/app/views/admin/SkippedContactsView.js","sourcesContent":["RootView = require 'views/core/RootView'\r\ntemplate = require 'templates/base-flat'\r\nSkippedContacts = require 'collections/SkippedContacts'\r\nUser = require 'models/User'\r\nrequire('vendor/co')\r\nrequire('vendor/vue')\r\nrequire('vendor/vuex')\r\n\r\nskippedContactApi =\r\n  setArchived: (_id, archived) ->\r\n    $.ajax({\r\n      url: '/db/skipped-contact/' + _id\r\n      type: 'PUT'\r\n      data: {\r\n        _id\r\n        archived\r\n      }\r\n    })\r\n\r\nSkippedContactInfo =\r\n  template: require('templates/admin/skipped-contacts/skipped-contact-info')()\r\n  props:\r\n    skippedContact:\r\n      type: Object\r\n      default: -> {}\r\n    user:\r\n      type: Object\r\n      default: -> undefined\r\n  computed:\r\n    noteData: ->\r\n      # TODO: Clean this up; it's hastily copied/modified from updateCloseIoLeads.js\r\n      # TODO: Figure out how to make this less redundant with that script\r\n      noteData = \"\"\r\n      @skippedContact\r\n      if @skippedContact.trialRequest.properties\r\n        props = @skippedContact.trialRequest.properties\r\n        if (props.name)\r\n          noteData += \"#{props.name}\\n\"\r\n        if (props.email)\r\n          noteData += \"demo_email: #{props.email.toLowerCase()}\\n\"\r\n        if (@skippedContact.trialRequest.created)\r\n          noteData += \"demo_request: #{@skippedContact.trialRequest.created}\\n\"\r\n        if (props.educationLevel)\r\n          noteData += \"demo_educationLevel: #{props.educationLevel.join(', ')}\\n\"\r\n        for prop in props\r\n          continue if (['email', 'educationLevel', 'created'].indexOf(prop) >= 0)\r\n          noteData += \"demo_#{prop}: #{props[prop]}\\n\"\r\n      noteData += \"intercom_url: #{@skippedContact.intercomUrl}\\n\" if (@skippedContact.intercomUrl)\r\n      noteData += \"intercom_lastSeen: #{@skippedContact.intercomLastSeen}\\n\" if (@skippedContact.intercomLastSeen)\r\n      noteData += \"intercom_sessionCount: #{@skippedContact.intercomSessionCount}\\n\" if (@skippedContact.intercomSessionCount)\r\n\r\n      if @user\r\n        noteData += \"coco_userID: #{@user._id}\\n\"\r\n        noteData += \"coco_firstName: #{@user.firstName}\\n\" if (@user.firstName)\r\n        noteData += \"coco_lastName: #{@user.lastName}\\n\" if (@user.lastName)\r\n        noteData += \"coco_name: #{@user.name}\\n\" if (@user.name)\r\n        noteData += \"coco_email: #{@user.emailLower}\\n\" if (@user.emaillower)\r\n        noteData += \"coco_gender: #{@user.gender}\\n\" if (@user.gender)\r\n        noteData += \"coco_lastLevel: #{@user.lastLevel}\\n\" if (@user.lastLevel)\r\n        noteData += \"coco_role: #{@user.role}\\n\" if (@user.role)\r\n        noteData += \"coco_schoolName: #{@user.schoolName}\\n\" if (@user.schoolName)\r\n        noteData += \"coco_gamesCompleted: #{@user.stats.gamesCompleted}\\n\" if (@user.stats && @user.stats.gamesCompleted)\r\n        noteData += \"coco_preferredLanguage: #{@user.preferredLanguage || 'en-US'}\\n\"\r\n      if (@numClassrooms) # TODO compute this\r\n        noteData += \"coco_numClassrooms: #{skippedContact.numClassrooms}\\n\"\r\n      if (@numStudents) # TODO compute this\r\n        noteData += \"coco_numStudents: #{skippedContact.numStudents}\\n\"\r\n      return noteData\r\n\r\n    queryString: ->\r\n      if @skippedContact.trialRequest\r\n        trialRequest = @skippedContact.trialRequest\r\n        leadName = trialRequest.properties.nces_name or trialRequest.properties.organization or trialRequest.properties.school or trialRequest.properties.district or trialRequest.properties.nces_district or trialRequest.properties.email\r\n        query = \"name:\\\"#{leadName}\\\"\"\r\n        if (trialRequest.properties.nces_school_id)\r\n          query = \"custom.demo_nces_id:\\\"#{trialRequest.properties.nces_school_id}\\\"\"\r\n        else if (trialRequest.properties.nces_district_id)\r\n          query = \"custom.demo_nces_district_id:\\\"#{trialRequest.properties.nces_district_id}\\\" custom.demo_nces_id:\\\"\\\" custom.demo_nces_name:\\\"\\\"\"\r\n        return query\r\n\r\n    queryURL: ->\r\n      \"https://app.close.io/search/\" + encodeURIComponent(@queryString)\r\n\r\n  methods:\r\n    onClickArchiveContact: (e) ->\r\n      archived = true\r\n      @$store.dispatch('archiveContact', {@skippedContact, archived})\r\n      # @$emit('archiveContact', @skippedContact, archived)\r\n    onClickUnarchiveContact: (e) ->\r\n      archived = false\r\n      @$store.dispatch('archiveContact', {@skippedContact, archived})\r\n      # @$emit('archiveContact', @skippedContact, archived)\r\n\r\nSkippedContactsComponent = Vue.extend\r\n  template: require('templates/admin/skipped-contacts/skipped-contacts-view')()\r\n  data: ->\r\n    sortOrder: 'date (ascending)'\r\n    showArchived: true\r\n  computed:\r\n    _.assign({},\r\n      Vuex.mapState(['skippedContacts', 'users']),\r\n      Vuex.mapGetters(['numArchivedUsers']),\r\n      sortedContacts: (state) ->\r\n        switch state.sortOrder\r\n          when 'date (ascending)'\r\n            return _(state.skippedContacts).sortBy((s) -> s.trialRequest.created).value()\r\n          when 'date (descending)'\r\n            return _(state.skippedContacts).sortBy((s) -> s.trialRequest.created).reverse().value()\r\n          when 'email'\r\n            return _(state.skippedContacts).sortBy((s) -> s.trialRequest.properties.email).value()\r\n          when 'archived'\r\n            return _(state.skippedContacts).sortBy((s) -> !!s.archived).reverse().value()\r\n          when 'unarchived'\r\n            return _(state.skippedContacts).sortBy((s) -> !!s.archived).value()\r\n          else\r\n            return state.skippedContacts\r\n    )\r\n  components:\r\n    'skipped-contact-info': SkippedContactInfo\r\n  created: co.wrap ->\r\n    skippedContacts = new SkippedContacts()\r\n    yield skippedContacts.fetch()\r\n    skippedContacts = skippedContacts.toJSON()\r\n    @$store.commit('loadContacts', skippedContacts)\r\n    yield skippedContacts.map co.wrap (skippedContact) =>\r\n      user = new User({ _id: skippedContact.trialRequest.applicant })\r\n      index = _.findIndex(@skippedContacts, (s) -> s._id is skippedContact._id)\r\n      yield user.fetch()\r\n      @$store.commit('addUser', { skippedContact , user: user.toJSON() })\r\n\r\nmodule.exports = class SkippedContactsView extends RootView\r\n  id: 'skipped-contacts-view'\r\n  template: template\r\n\r\n  initialize: ->\r\n    super(arguments...)\r\n    # Vuex Store\r\n    @store = new Vuex.Store({\r\n      state:\r\n        skippedContacts: []\r\n        users: {}\r\n      actions:\r\n        archiveContact: ({ commit, state }, {skippedContact, archived}) ->\r\n          skippedContactApi.setArchived(skippedContact._id, archived).then ->\r\n            commit('archiveContact', {skippedContact, archived})\r\n      strict: not application.isProduction()\r\n      mutations:\r\n        archiveContact: (state, { skippedContact, archived }) ->\r\n          index = _.findIndex(state.skippedContacts, (s) -> s._id is skippedContact._id)\r\n          oldContact = state.skippedContacts[index]\r\n          Vue.set(state.skippedContacts, index, _.assign({}, oldContact, { archived }))\r\n        addUser: (state, { skippedContact, user }) ->\r\n          Vue.set(state.users, skippedContact._id, user)\r\n        loadContacts: (state, skippedContacts) ->\r\n          state.skippedContacts = skippedContacts\r\n      getters:\r\n        numArchivedUsers: (state) ->\r\n          _.countBy(state.skippedContacts, (contact) -> contact.archived)[true]\r\n    })\r\n\r\n\r\n  afterRender: ->\r\n    @vueComponent?.$destroy() # TODO: Don't recreate this component every time things update\r\n    @vueComponent = new SkippedContactsComponent({\r\n      el: @$el.find('#site-content-area')[0]\r\n      store: @store\r\n    })\r\n\r\n    super(arguments...)\r\n"]}