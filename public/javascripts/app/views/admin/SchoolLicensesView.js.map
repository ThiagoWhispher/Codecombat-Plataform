{"version":3,"sources":["app/views/admin/SchoolLicensesView.coffee"],"names":[],"mappings":"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","file":"public/javascripts/app/views/admin/SchoolLicensesView.js","sourcesContent":["RootView = require 'views/core/RootView'\r\nCocoCollection = require 'collections/CocoCollection'\r\nPrepaid = require 'models/Prepaid'\r\nTrialRequests = require 'collections/TrialRequests'\r\n\r\n# TODO: year ranges hard-coded\r\n\r\nmodule.exports = class SchoolLicensesView extends RootView\r\n  id: 'admin-school-licenses-view'\r\n  template: require 'templates/admin/school-licenses'\r\n\r\n  initialize: ->\r\n    return super() unless me.isAdmin()\r\n    @startDateRange = new Date()\r\n    @endDateRange = new Date()\r\n    @endDateRange.setUTCFullYear(@endDateRange.getUTCFullYear() + 2)\r\n    @supermodel.addRequestResource({\r\n      url: '/db/prepaid/-/active-schools'\r\n      method: 'GET'\r\n      success: ({prepaidActivityMap, schoolPrepaidsMap}) =>\r\n        @updateSchools(prepaidActivityMap, schoolPrepaidsMap)\r\n    }, 0).load()\r\n    super()\r\n\r\n  updateSchools: (prepaidActivityMap, schoolPrepaidsMap) ->\r\n    timeStart = @startDateRange.getTime()\r\n    time2017 = new Date('2017').getTime()\r\n    time2018 = new Date('2018').getTime()\r\n    timeEnd = @endDateRange.getTime()\r\n    rangeMilliseconds = timeEnd - timeStart\r\n    @rangeKeys = [\r\n      {name :'Today', color: 'blue', startScale: 0, width: Math.round((time2017 - timeStart) / rangeMilliseconds * 100)}\r\n      {name: '2017', color: 'red', startScale: Math.round((time2017 - timeStart) / rangeMilliseconds * 100), width: Math.round((time2018 - time2017) / rangeMilliseconds * 100)}\r\n      {name: '2018', color: 'yellow', startScale: Math.round((time2018 - timeStart) / rangeMilliseconds * 100), width: Math.round((timeEnd - time2018) / rangeMilliseconds * 100)}\r\n    ]\r\n\r\n    @schools = []\r\n    for school, prepaids of schoolPrepaidsMap\r\n      activity = 0\r\n      schoolMax = 0\r\n      schoolUsed = 0\r\n      collapsedPrepaids = []\r\n      for prepaid in prepaids\r\n        activity += prepaidActivityMap[prepaid._id] ? 0\r\n        startDate = prepaid.startDate\r\n        endDate = prepaid.endDate\r\n        max = parseInt(prepaid.maxRedeemers)\r\n        used = parseInt(prepaid.redeemers?.length ? 0)\r\n        schoolMax += max\r\n        schoolUsed += used\r\n        foundIdenticalDates = false\r\n        for collapsedPrepaid in collapsedPrepaids\r\n          if collapsedPrepaid.startDate.substring(0, 10) is startDate.substring(0, 10) and collapsedPrepaid.endDate.substring(0, 10) is endDate.substring(0, 10)\r\n            collapsedPrepaid.max += parseInt(prepaid.maxRedeemers)\r\n            collapsedPrepaid.used += parseInt(prepaid.redeemers?.length ? 0)\r\n            foundIdenticalDates = true\r\n            break\r\n        unless foundIdenticalDates\r\n          collapsedPrepaids.push({startDate, endDate, max, used})\r\n\r\n      for collapsedPrepaid in collapsedPrepaids\r\n        collapsedPrepaid.startScale = (new Date(collapsedPrepaid.startDate).getTime() - @startDateRange.getTime()) / rangeMilliseconds * 100\r\n        if collapsedPrepaid.startScale < 0\r\n          collapsedPrepaid.startScale = 0\r\n          collapsedPrepaid.rangeScale = (new Date(collapsedPrepaid.endDate).getTime() - @startDateRange.getTime()) / rangeMilliseconds * 100\r\n        else\r\n          collapsedPrepaid.rangeScale = (new Date(collapsedPrepaid.endDate).getTime() - new Date(collapsedPrepaid.startDate).getTime()) / rangeMilliseconds * 100\r\n        collapsedPrepaid.rangeScale = 100 - collapsedPrepaid.startScale if collapsedPrepaid.rangeScale + collapsedPrepaid.startScale > 100\r\n      @schools.push {name: school, activity, max: schoolMax, used: schoolUsed, prepaids: collapsedPrepaids, startDate: collapsedPrepaids[0].startDate, endDate: collapsedPrepaids[0].endDate}\r\n\r\n    @schools.sort (a, b) ->\r\n      b.activity - a.activity or new Date(a.endDate).getTime() - new Date(b.endDate).getTime() or b.max - a.max or b.used - a.used or b.prepaids.length - a.prepaids.length or b.name.localeCompare(a.name)\r\n\r\n    @render()\r\n"]}